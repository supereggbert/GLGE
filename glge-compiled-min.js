/*!
GLGE WebGL Graphics Engine
Copyright (c) 2010, Paul Brunt
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
    * Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of GLGE nor the
      names of its contributors may be used to endorse or promote products
      derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL PAUL BRUNT BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
if(typeof GLGE=="undefined"){GLGE={}}(function(e){function n(){var t=e.Vec([1,2,3,4]);var n=e.Vec4(e.getVec4(t,3),e.get1basedVec4(t,3),e.getVec4(t,1),e.getVec4(t,0));var r=e.identMatrix();var i=e.mulMat4Vec4(r,n);if(e.getVec4(i,0)!=4||e.getVec4(i,1)!=3||e.getVec4(i,2)!=2||e.getVec4(i,3)!=1){throw"Unit Test 1 failed MatVecMul "+i}var s=e.Mat4([3,4,5,0,.5,.75,0,0,.75,.5,0,0,.25,.25,1,1]);var o=e.Mat4([2,1,8,2,1,4,3,2,1,.5,6.5,2,8,3,1,.25]);var u=e.mulMat4(s,o);var a=e.Mat4([15,21.5,68.5,24,1.75,3.5,6.25,2.5,2,2.75,7.5,2.5,9.75,4.75,10.25,3.25]);for(var f=0;f<4;++f){for(var l=0;l<4;++l){var c=e.getMat4(u,f,l)-e.getMat4(a,f,l);if(c<1e-6&&c>-1e-6){}else{throw"Unit Test 1 failed Multiplication "+e.getMat4(u,f,l)+" != "+e.getMat4(a,f,l)}}}var h=e.inverseMat4(s);var p=e.mulMat4(s,h);var d=e.mulMat4(h,s);for(var f=0;f<4;++f){for(var l=0;l<4;++l){var c=e.getMat4(p,f,l)-e.getMat4(r,f,l);if(c<1e-4&&c>-1e-4){}else{throw"Unit Test 1 failed Inverse "+e.getMat4(p,f,l)+" != "+e.getMat4(r,f,l)}}}}var t=[];e.reuseMatrix4=function(e){};e.matrix4=function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){if(t.length==0){var g=[e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m]}else{var g=t.shift();g[0]=e;g[1]=n;g[2]=r;g[3]=i;g[4]=s;g[5]=o;g[6]=u;g[7]=a;g[8]=f;g[9]=l;g[10]=c;g[11]=h;g[12]=p;g[13]=d;g[14]=v;g[15]=m}return g};e.Vec=function(e){return e.slice(0)};e.Vec3=function(e,t,n){return[e,t,n]};e.Vec4=function(e,t,n,r){return[e,t,n,r]};e.get1basedVec4=function(e,t){return e[t-1]};e.get1basedVec3=function(e,t){return e[t-1]};e.getVec4=function(e,t){return e[t]};e.getVec3=function(e,t){return e[t]};e.addVec4=function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3]]};e.addVec3=function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]};e.subVec4=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3]]};e.subVec3=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]};e.negVec4=function(e){return[-e[0],-e[1],-e[2],-e[3]]};e.negVec3=function(e){return[-e[0],-e[1],-e[2]]};e.dotVec3=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};e.dotVec4=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]};e.scaleVec4=function(e,t){return[e[0]*t,e[1]*t,e[2]*t,e[3]*t]};e.scaleVec3=function(e,t){return[e[0]*t,e[1]*t,e[2]*t]};e.crossVec3=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]};e.toUnitVec3=function(e){var t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];var n=1;if(t>0){n=Math.pow(t,.5)}return[e[0]/n,e[1]/n,e[2]/n]};e.toUnitVec4=function(e){var t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3];var n=1;if(t>0){n=Math.pow(t,.5)}return[e[0]/n,e[1]/n,e[2]/n,e[3]/n]};e.lengthVec3=function(e){return Math.pow(e[0]*e[0]+e[1]*e[1]+e[2]*e[2],.5)};e.distanceVec3=function(t,n){return e.lengthVec3(e.subVec3(t,n))};e.lengthVec4=function(e,t){return Math.pow(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3],.5)};e.distanceVec4=function(t,n){return e.lengthVec4(e.subVec4(t,n))};e.angleVec3=function(t,n){t=e.toUnitVec3(t);n=e.toUnitVec3(n);d=e.dotVec3(t,n);if(d<-1)d=-1;if(d>1)d=1;return Math.acos(d)};e.angleVec4=function(t,n){t=e.toUnitVec4(t);n=e.toUnitVec4(n);d=e.dotVec4(t,n);if(d<-1)d=-1;if(d>1)d=1;return Math.acos(d)};GLGE_math_use_webgl_float=false;e.Mat3=GLGE_math_use_webgl_float?function(e){if(e.length==9){return new Float32Array(e)}else if(e.length==16){return new Float32Array([e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]])}else{throw"invalid matrix length"}}:function(e){var t;if(e.length==9){t=e.slice(0)}else if(e.length==16){t=[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]}else{throw"invalid matrix length"}t.get=function(e){return this[e]};return t};e.Mat=GLGE_math_use_webgl_float?function(e){return new Float32Array(e)}:function(e){var t=e.slice(0);t.get=function(e){return this[e]};return t};e.Mat4=function(e){var t;if(e.length==9){t=[e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,0,0,0,1]}else if(e.length==16){if(e.slice)t=e.slice(0);else t=e.subarray(0)}else{throw"invalid matrix length"}t.get=function(e){return this[e]};return t};e.determinantMat4=function(e){return e[12]*e[9]*e[6]*e[3]-e[8]*e[13]*e[6]*e[3]-e[12]*e[5]*e[10]*e[3]+e[4]*e[13]*e[10]*e[3]+e[8]*e[5]*e[14]*e[3]-e[4]*e[9]*e[14]*e[3]-e[12]*e[9]*e[2]*e[7]+e[8]*e[13]*e[2]*e[7]+e[12]*e[1]*e[10]*e[7]-e[0]*e[13]*e[10]*e[7]-e[8]*e[1]*e[14]*e[7]+e[0]*e[9]*e[14]*e[7]+e[12]*e[5]*e[2]*e[11]-e[4]*e[13]*e[2]*e[11]-e[12]*e[1]*e[6]*e[11]+e[0]*e[13]*e[6]*e[11]+e[4]*e[1]*e[14]*e[11]-e[0]*e[5]*e[14]*e[11]-e[8]*e[5]*e[2]*e[15]+e[4]*e[9]*e[2]*e[15]+e[8]*e[1]*e[6]*e[15]-e[0]*e[9]*e[6]*e[15]-e[4]*e[1]*e[10]*e[15]+e[0]*e[5]*e[10]*e[15]};e.inverseMat4=function(t){var n=t[0],r=t[1],i=t[2],s=t[3];var o=t[4],u=t[5],a=t[6],f=t[7];var l=t[8],c=t[9],h=t[10],p=t[11];var d=t[12],v=t[13],m=t[14],g=t[15];var y=d*c*a*s-l*v*a*s-d*u*h*s+o*v*h*s+l*u*m*s-o*c*m*s-d*c*i*f+l*v*i*f+d*r*h*f-n*v*h*f-l*r*m*f+n*c*m*f+d*u*i*p-o*v*i*p-d*r*a*p+n*v*a*p+o*r*m*p-n*u*m*p-l*u*i*g+o*c*i*g+l*r*a*g-n*c*a*g-o*r*h*g+n*u*h*g;return e.matrix4((c*m*f-v*h*f+v*a*p-u*m*p-c*a*g+u*h*g)/y,(v*h*s-c*m*s-v*i*p+r*m*p+c*i*g-r*h*g)/y,(u*m*s-v*a*s+v*i*f-r*m*f-u*i*g+r*a*g)/y,(c*a*s-u*h*s-c*i*f+r*h*f+u*i*p-r*a*p)/y,(d*h*f-l*m*f-d*a*p+o*m*p+l*a*g-o*h*g)/y,(l*m*s-d*h*s+d*i*p-n*m*p-l*i*g+n*h*g)/y,(d*a*s-o*m*s-d*i*f+n*m*f+o*i*g-n*a*g)/y,(o*h*s-l*a*s+l*i*f-n*h*f-o*i*p+n*a*p)/y,(l*v*f-d*c*f+d*u*p-o*v*p-l*u*g+o*c*g)/y,(d*c*s-l*v*s-d*r*p+n*v*p+l*r*g-n*c*g)/y,(o*v*s-d*u*s+d*r*f-n*v*f-o*r*g+n*u*g)/y,(l*u*s-o*c*s-l*r*f+n*c*f+o*r*p-n*u*p)/y,(d*c*a-l*v*a-d*u*h+o*v*h+l*u*m-o*c*m)/y,(l*v*i-d*c*i+d*r*h-n*v*h-l*r*m+n*c*m)/y,(d*u*i-o*v*i-d*r*a+n*v*a+o*r*m-n*u*m)/y,(o*c*i-l*u*i+l*r*a-n*c*a-o*r*h+n*u*h)/y)};e.mulMat4Vec3=function(t,n){return e.Vec3(t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3],t[4]*n[0]+t[5]*n[1]+t[6]*n[2]+t[7],t[8]*n[0]+t[9]*n[1]+t[10]*n[2]+t[11])};e.mulMat4Vec4=function(t,n){return e.Vec4(t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3],t[4]*n[0]+t[5]*n[1]+t[6]*n[2]+t[7]*n[3],t[8]*n[0]+t[9]*n[1]+t[10]*n[2]+t[11]*n[3],t[12]*n[0]+t[13]*n[1]+t[14]*n[2]+t[15]*n[3])};e.scaleMat4=function(t,n){return e.matrix4([t[0]*n,t[1]*n,t[2]*n,t[3]*n,t[4]*n,t[5]*n,t[6]*n,t[7]*n,t[8]*n,t[9]*n,t[10]*n,t[11]*n,t[12]*n,t[13]*n,t[14]*n,t[15]*n])};e.scaleInPlaceMat4=function(e,t){e.set(0,e[0]*t);e.set(1,e[1]*t);e.set(2,e[2]*t);e.set(3,e[3]*t);e.set(4,e[4]*t);e.set(5,e[5]*t);e.set(6,e[6]*t);e.set(7,e[7]*t);e.set(8,e[8]*t);e.set(9,e[9]*t);e.set(10,e[10]*t);e.set(11,e[11]*t);e.set(12,e[12]*t);e.set(13,e[13]*t);e.set(14,e[14]*t);e.set(15,e[15]*t);return e};e.addInPlaceMat4=function(e,t){e.set(0,e[0]+t[0]);e.set(1,e[1]+t[1]);e.set(2,e[2]+t[2]);e.set(3,e[3]+t[3]);e.set(4,e[4]+t[4]);e.set(5,e[5]+t[5]);e.set(6,e[6]+t[6]);e.set(7,e[7]+t[7]);e.set(8,e[8]+t[8]);e.set(9,e[9]+t[9]);e.set(10,e[10]+t[10]);e.set(11,e[11]+t[11]);e.set(12,e[12]+t[12]);e.set(13,e[13]+t[13]);e.set(14,e[14]+t[14]);e.set(15,e[15]+t[15]);return e};e.addMat4=function(t,n){return e.Mat([t[0]+n[0],t[1]+n[1],t[2]+n[2],t[3]+n[3],t[4]+n[4],t[5]+n[5],t[6]+n[6],t[7]+n[7],t[8]+n[8],t[9]+n[9],t[10]+n[10],t[11]+n[11],t[12]+n[12],t[13]+n[13],t[14]+n[14],t[15]+n[15]]);return t};e.subInPlaceMat4=function(e,t){e.set(0,e[0]-t[0]);e.set(1,e[1]-t[1]);e.set(2,e[2]-t[2]);e.set(3,e[3]-t[3]);e.set(4,e[4]-t[4]);e.set(5,e[5]-t[5]);e.set(6,e[6]-t[6]);e.set(7,e[7]-t[7]);e.set(8,e[8]-t[8]);e.set(9,e[9]-t[9]);e.set(10,e[10]-t[10]);e.set(11,e[11]-t[11]);e.set(12,e[12]-t[12]);e.set(13,e[13]-t[13]);e.set(14,e[14]-t[14]);e.set(15,e[15]-t[15]);return e};e.subMat4=function(t,n){return e.Mat([t[0]-n[0],t[1]-n[1],t[2]-n[2],t[3]-n[3],t[4]-n[4],t[5]-n[5],t[6]-n[6],t[7]-n[7],t[8]-n[8],t[9]-n[9],t[10]-n[10],t[11]-n[11],t[12]-n[12],t[13]-n[13],t[14]-n[14],t[15]-n[15]]);return t};e.mulMat4=function(t,n){var r=n[0],i=n[1],s=n[2],o=n[3];var u=n[4],a=n[5],f=n[6],l=n[7];var c=n[8],h=n[9],p=n[10],d=n[11];var v=n[12],m=n[13],g=n[14],y=n[15];var b=t[0],w=t[1],E=t[2],S=t[3];var x=t[4],T=t[5],N=t[6],C=t[7];var k=t[8],L=t[9],A=t[10],O=t[11];var M=t[12],_=t[13],D=t[14],P=t[15];return e.matrix4(b*r+w*u+E*c+S*v,b*i+w*a+E*h+S*m,b*s+w*f+E*p+S*g,b*o+w*l+E*d+S*y,x*r+T*u+N*c+C*v,x*i+T*a+N*h+C*m,x*s+T*f+N*p+C*g,x*o+T*l+N*d+C*y,k*r+L*u+A*c+O*v,k*i+L*a+A*h+O*m,k*s+L*f+A*p+O*g,k*o+L*l+A*d+O*y,M*r+_*u+D*c+P*v,M*i+_*a+D*h+P*m,M*s+_*f+D*p+P*g,M*o+_*l+D*d+P*y)};e.transposeInPlaceMat4=function(e){var t=e[1];e.set(1,e[4]);e.set(4,t);t=e[8];e.set(8,e[2]);e.set(2,t);t=e[3];e.set(3,e[12]);e.set(12,t);t=e[9];e.set(9,e[6]);e.set(6,t);t=e[13];e.set(13,e[7]);e.set(7,t);t=e[14];e.set(14,e[11]);e.set(11,t)};e.transposeMat4=function(t){return e.matrix4(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])};e.mat4gl=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]};e.set1basedMat4=function(e,t,n,r){e[(t-1)*4+(n-1)]=r;if(e.glData!==undefined){delete e.glData}};e.setMat4=function(e,t,n,r){e[t*4+n]=r;if(e.glData!==undefined){delete e.glData}};e.get1basedMat4=function(e,t,n){return e.get((t-1)*4+(n-1))};e.getMat4=function(e,t,n){return e[t*4+n]};e.glDataMat4=function(e){e.glArray=new Float32Array(e);return e.glArray};e.identMatrix=function(){return e.matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};e.translateMatrix=function(t){var n;var r;var i;if(arguments.length==3){n=arguments[0];r=arguments[1];i=arguments[2]}else if(t.data){n=t.data[0];r=t.data[1];i=t.data[2]}else if(t instanceof Array){n=t[0];r=t[1];i=t[2]}return e.matrix4(1,0,0,n,0,1,0,r,0,0,1,i,0,0,0,1)};e.scaleMatrix=function(t){var n;var r;var i;if(arguments.length==3){n=arguments[0];r=arguments[1];i=arguments[2]}else if(t.data){n=t.data[0];r=t.data[1];i=t.data[2]}else if(t instanceof Array){n=t[0];r=t[1];i=t[2]}return e.matrix4(n,0,0,0,0,r,0,0,0,0,i,0,0,0,0,1)};e.ROT_XYZ=1;e.ROT_XZY=2;e.ROT_YXZ=3;e.ROT_YZX=4;e.ROT_ZXY=5;e.ROT_ZYX=6;e.rotateMatrix=function(t,n){var r;var i;var s;if(arguments.length>2){r=arguments[0];i=arguments[1];s=arguments[2];n=arguments[3]}else if(t.data){r=t.data[0];i=t.data[1];s=t.data[2]}else if(t instanceof Array){r=t[0];i=t[1];s=t[2]}if(!n)n=e.ROT_XYZ;var o=Math.cos(r);var u=Math.sin(r);var a=Math.cos(i);var f=Math.sin(i);var l=Math.cos(s);var c=Math.sin(s);var h=e.matrix4(1,0,0,0,0,o,-u,0,0,u,o,0,0,0,0,1);var p=e.matrix4(a,0,f,0,0,1,0,0,-f,0,a,0,0,0,0,1);var d=e.matrix4(l,-c,0,0,c,l,0,0,0,0,1,0,0,0,0,1);switch(n){case e.ROT_XYZ:return e.mulMat4(h,e.mulMat4(p,d));break;case e.ROT_XZY:return e.mulMat4(h,e.mulMat4(d,p));break;case e.ROT_YXZ:return e.mulMat4(p,e.mulMat4(h,d));break;case e.ROT_YZX:return e.mulMat4(p,e.mulMat4(d,h));break;case e.ROT_ZXY:return e.mulMat4(d,e.mulMat4(h,p));break;case e.ROT_ZYX:return e.mulMat4(d,e.mulMat4(p,h));break}};e.angleAxis=function(t,n){var r,i,s,o,u,a,f,l,c;n=[n[0],n[1],n[2],0];var h=n[0];var p=n[1];var d=n[2];var v=Math.cos(t);var m=1-v;var g=Math.sin(t);f=h*g;l=p*g;c=d*g;r=h*h;i=p*p;s=d*d;o=h*p;u=p*d;a=d*h;var y=e.matrix4(m*r+v,m*o-c,m*a+l,0,m*o+c,m*i+v,m*u-f,0,m*a-l,m*u+f,m*s+v,0,0,0,0,1);return e.Mat(y)};e.quatFromAxisAngle=function(e,t){var n=[];var r=t*.5;var i=Math.sin(r);var s=Math.cos(r);n[0]=e[0]*i;n[1]=e[1]*i;n[2]=e[2]*i;n[3]=s;return n};e.mulQuat=function(e,t){var n=[];var r=e[0];var i=e[1];var s=e[2];var o=e[3];var u=t[0];var a=t[1];var f=t[2];var l=t[3];var c=i*f-s*a;var h=s*u-r*f;var p=r*a-i*u;var d=r*u+i*a+s*f;n[0]=r*l+u*o+c;n[1]=i*l+a*o+h;n[2]=s*l+f*o+p;n[3]=o*l-d;return n};e.mat4FromQuat=function(e){var t=e[0]*e[0];var n=e[1]*e[1];var r=e[2]*e[2];var i=e[0]*e[1];var s=e[2]*e[3];var o=e[2]*e[0];var u=e[1]*e[3];var a=e[1]*e[2];var f=e[0]*e[3];var l=[];l[0]=1-2*(n+r);l[1]=2*(i+s);l[2]=2*(o-u);l[3]=0;l[4]=2*(i-s);l[5]=1-2*(r+t);l[6]=2*(a+f);l[7]=0;l[8]=2*(o+u);l[9]=2*(a-f);l[10]=1-2*(n+t);l[11]=0;l[12]=0;l[13]=0;l[14]=0;l[15]=1;return l};e.quatRotation=function(t,n,r,i){return e.matrix4(1-2*n*n-2*r*r,2*t*n-2*r*i,2*t*r+2*n*i,0,2*t*n+2*r*i,1-2*t*t-2*r*r,2*n*r-2*t*i,0,2*t*r-2*n*i,2*n*r+2*t*i,1-2*t*t-2*n*n,0,0,0,0,1)};e.makeOrtho=function(t,n,r,i,s,o){var u=-(n+t)/(n-t);var a=-(i+r)/(i-r);var f=-(o+s)/(o-s);return e.matrix4(2/(n-t),0,0,u,0,2/(i-r),0,a,0,0,-2/(o-s),f,0,0,0,1)};e.makeFrustum=function(t,n,r,i,s,o){var u=2*s/(n-t);var a=2*s/(i-r);var f=(n+t)/(n-t);var l=(i+r)/(i-r);var c=-(o+s)/(o-s);var h=-2*o*s/(o-s);return e.matrix4(u,0,f,0,0,a,l,0,0,0,c,h,0,0,-1,0)};e.makePerspective=function(t,n,r,i){var s=r*Math.tan(t*.00872664625972);var o=-s;var u=o*n;var a=s*n;return e.makeFrustum(u,a,o,s,r,i)};e.makePerspectiveX=function(t,n,r,i){var s=r*Math.tan(t*.00872664625972);var o=-s;var u=o/n;var a=s/n;return e.makeFrustum(o,s,u,a,r,i)};e.matrix2Scale=function(e){var t=e[0];var n=e[1];var r=e[2];var i=e[4];var s=e[5];var o=e[6];var u=e[8];var a=e[9];var f=e[10];var l=Math.sqrt(t*t+n*n+r*r);var c=Math.sqrt(i*i+s*s+o*o);var h=Math.sqrt(u*u+a*a+f*f);return[l,c,h]};e.rotationMatrix2Quat=function(e){var t=e[0]+e[5]+e[10]+1;var n,r,i,s,o;if(t>0){n=.5/Math.sqrt(t);o=.25/n;r=(e[9]-e[6])*n;i=(e[2]-e[8])*n;s=(e[4]-e[1])*n}else if(e[0]>e[5]&&e[0]>e[10]){n=Math.sqrt(1+e[0]-e[5]-e[10])*2;o=(e[9]-e[6])/n;r=.25/n;i=(e[1]+e[4])/n;s=(e[2]+e[8])/n}else if(e[5]>e[10]){n=Math.sqrt(1+e[5]-e[0]-e[10])*2;o=(e[2]-e[8])/n;r=(e[1]+e[4])/n;i=.25/n;s=(e[6]+e[9])/n}else{n=Math.sqrt(1+e[10]-e[0]-e[5])*2;o=(e[4]-e[1])/n;r=(e[2]+e[8])/n;i=(e[6]+e[9])/n;s=.25/n}var u=Math.sqrt(r*r+i*i+s*s+o*o);return[r/u,i/u,s/u,o/u]};e.rayToPlane=function(t,n){var r=e.toUnitVec3(n);return[r[0],r[1],r[2],e.dotVec3(t,r)]};e.rayIntersectPlane=function(t,n,r){var i=[r[0],r[1],r[2]];var s=r[3];var o=e.dotVec3(i,n);if(o<=0){return false}var u=-(e.dotVec3(i,t)+s);var a=u/o;if(a<=0){return false}return e.addVec3(t,e.scaleVec3(n,a))};e.screenToDirection=function(t,n,r,i,s){xcoord=-(2*t/r-1)/s[0];ycoord=(2*n/i-1)/s[5];zcoord=1;return e.toUnitVec3([xcoord,ycoord,zcoord])};e.BoundingVolume=function(e,t,n,r,i,s){this.limits=[e,t,n,r,i,s];this.calcProps()};e.BoundingVolume.prototype.getCornerPoints=function(){return this.points};e.BoundingVolume.prototype.getSphereRadius=function(){return this.radius};e.BoundingVolume.prototype.getCenter=function(){return this.center};e.BoundingVolume.prototype.isNull=function(){return this.limits[0]==0&&this.limits[1]==0&&this.limits[2]==0&&this.limits[3]==0&&this.limits[4]==0&&this.limits[5]==0};e.BoundingVolume.prototype.addBoundingVolume=function(e){if(this.isNull()){this.limits[0]=e.limits[0];this.limits[1]=e.limits[1];this.limits[2]=e.limits[2];this.limits[3]=e.limits[3];this.limits[4]=e.limits[4];this.limits[5]=e.limits[5]}else if(!e.isNull()){this.limits[0]=Math.min(e.limits[0],this.limits[0]);this.limits[2]=Math.min(e.limits[2],this.limits[2]);this.limits[4]=Math.min(e.limits[4],this.limits[4]);this.limits[1]=Math.max(e.limits[1],this.limits[1]);this.limits[3]=Math.max(e.limits[3],this.limits[3]);this.limits[5]=Math.max(e.limits[5],this.limits[5])}this.calcProps()};e.BoundingVolume.prototype.applyMatrix=function(t){var n=e.mulMat4Vec4(t,[this.limits[0],this.limits[2],this.limits[4],1]);var r=e.mulMat4Vec4(t,[this.limits[1],this.limits[2],this.limits[4],1]);var i=e.mulMat4Vec4(t,[this.limits[0],this.limits[3],this.limits[4],1]);var s=e.mulMat4Vec4(t,[this.limits[1],this.limits[3],this.limits[4],1]);var o=e.mulMat4Vec4(t,[this.limits[0],this.limits[2],this.limits[5],1]);var u=e.mulMat4Vec4(t,[this.limits[1],this.limits[2],this.limits[5],1]);var a=e.mulMat4Vec4(t,[this.limits[0],this.limits[3],this.limits[5],1]);var f=e.mulMat4Vec4(t,[this.limits[1],this.limits[3],this.limits[5],1]);this.limits[0]=Math.min(n[0],r[0],i[0],s[0],o[0],u[0],a[0],f[0]);this.limits[1]=Math.max(n[0],r[0],i[0],s[0],o[0],u[0],a[0],f[0]);this.limits[2]=Math.min(n[1],r[1],i[1],s[1],o[1],u[1],a[1],f[1]);this.limits[3]=Math.max(n[1],r[1],i[1],s[1],o[1],u[1],a[1],f[1]);this.limits[4]=Math.min(n[2],r[2],i[2],s[2],o[2],u[2],a[2],f[2]);this.limits[5]=Math.max(n[2],r[2],i[2],s[2],o[2],u[2],a[2],f[2]);this.calcProps()};e.BoundingVolume.prototype.calcProps=function(){var e=this.limits[0];var t=this.limits[1];var n=this.limits[2];var r=this.limits[3];var i=this.limits[4];var s=this.limits[5];this.points=[[e,n,i],[t,n,i],[e,r,i],[t,r,i],[e,n,s],[t,n,s],[e,r,s],[t,r,s]];this.center=[(this.limits[1]-this.limits[0])/2+this.limits[0],(this.limits[3]-this.limits[2])/2+this.limits[2],(this.limits[5]-this.limits[4])/2+this.limits[4]];var o=this.limits[0]-this.center[0];var u=this.limits[2]-this.center[1];var a=this.limits[4]-this.center[2];this.radius=Math.sqrt(o*o+u*u+a*a)};e.BoundingVolume.prototype.clone=function(){return new e.BoundingVolume(this.limits[0],this.limits[1],this.limits[2],this.limits[3],this.limits[4],this.limits[5])};e.BoundingVolume.prototype.toString=function(){return this.limits.toString()};e.cameraViewProjectionToPlanes=function(t){var n=e.inverseMat4(t);var r=e.mulMat4Vec4;var i=e.subVec3;var s=e.crossVec3;var o=e.toUnitVec3;var u=e.dotVec3;var a=r(n,[-1,-1,-1,1]);var f=r(n,[1,-1,-1,1]);var l=r(n,[-1,-1,1,1]);var c=r(n,[1,1,-1,1]);var h=r(n,[1,1,1,1]);var p=r(n,[-1,1,1,1]);a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];f=[f[0]/f[3],f[1]/f[3],f[2]/f[3]];l=[l[0]/l[3],l[1]/l[3],l[2]/l[3]];c=[c[0]/c[3],c[1]/c[3],c[2]/c[3]];h=[h[0]/h[3],h[1]/h[3],h[2]/h[3]];p=[p[0]/p[3],p[1]/p[3],p[2]/p[3]];var d=o(s(i(c,f),i(a,f)));var v=o(s(i(p,l),i(h,l)));var m=o(s(i(a,l),i(p,l)));var g=o(s(i(h,c),i(c,f)));var y=o(s(i(p,c),i(c,h)));var b=o(s(i(a,f),i(l,a)));d.push(u(d,a));v.push(u(v,l));m.push(u(m,a));g.push(u(g,f));y.push(u(y,h));b.push(u(b,a));return[d,v,m,g,y,b]};e.sphereInFrustumPlanes=function(e,t){var n=e[0];var r=e[1];var i=e[2];var s=e[3];var o=t[0];var u=t[1];var a=t[2];var f=t[3];var l=t[4];var c=t[5];if(n*o[0]+r*o[1]+i*o[2]-o[3]-s>0||n*u[0]+r*u[1]+i*u[2]-u[3]-s>0||n*a[0]+r*a[1]+i*a[2]-a[3]-s>0||n*f[0]+r*f[1]+i*f[2]-f[3]-s>0||n*l[0]+r*l[1]+i*l[2]-l[3]-s>0||n*c[0]+r*c[1]+i*c[2]-c[3]-s>0){return false}else{return true}};e.pointsInFrustumPlanes=function(e,t){var n=t[0];var r=t[1];var i=t[2];var s=t[3];var o=t[4];var u=t[5];var a,f,l;for(var c=0;c<e.length;c++){a=e[c][0];f=e[c][1];l=e[c][2];if(a*n[0]+f*n[1]+l*n[2]-n[3]>0&&a*r[0]+f*r[1]+l*r[2]-r[3]>0&&a*i[0]+f*i[1]+l*i[2]-s[3]>0&&a*s[0]+f*s[1]+l*s[2]-o[3]>0&&a*o[0]+f*o[1]+l*o[2]-o[3]>0&&a*u[0]+f*u[1]+l*u[2]-u[3]>0){return false}}return true};e.getDirLightProjection=function(t,n,r,i){var s=e.mulMat4(n,e.inverseMat4(t));var o=[0,0,0];var u=[0,0,0];for(var a=0;a<2;a++){for(var f=0;f<2;f++){for(var l=0;l<2;l++){var c=e.mulMat4Vec4(s,[a*2-1,f*2-1,l*2-1,1]);c[0]=c[0]/c[3];c[1]=c[1]/c[3];c[2]=c[2]/c[3];o[0]=o[0]>c[0]?c[0]:o[0];o[1]=o[1]>c[1]?c[1]:o[1];u[0]=u[0]<c[0]?c[0]:u[0];u[1]=u[1]<c[1]?c[1]:u[1];u[2]=u[2]<c[2]?c[2]:u[2]}}}var h=e.makeOrtho(o[0],u[0],o[1],u[1],.01,+i);return h};n()})(GLGE);if(typeof GLGE=="undefined"){GLGE={}}(function(e){var t=function(e){if(typeof e!="number")return parseFloat(e);else return e};e.augment=function(e,t){t.prototype.baseclass=e;for(var n in e.prototype){if(!t.prototype[n])t.prototype[n]=e.prototype[n];else t.prototype.baseclass[n]=e.prototype[n]}};e.makeGlobal=function(){for(var t in e){window[t]=e[t]}};e.New=function(t){if(e[t].prototype.className!=""){return new e[t]}else{return false}};e.TRUE=1;e.FALSE=0;e.GLOBAL=0;e.LOCAL=1;e.DRAW_TRIS=1;e.DRAW_LINES=2;e.DRAW_LINELOOPS=3;e.DRAW_LINESTRIPS=4;e.DRAW_POINTS=5;e.DRAW_TRIANGLESTRIP=6;e.RENDER_DEFAULT=0;e.RENDER_SHADOW=1;e.RENDER_PICK=2;e.RENDER_NORMAL=3;e.RENDER_EMIT=4;e.RENDER_DEPTH=5;e.RENDER_NULL=6;e.TEXT_BOXPICK=1;e.TEXT_TEXTPICK=2;e.P_EULER=1;e.P_QUAT=2;e.P_MATRIX=3;e.NONE=0;e.XAXIS=1;e.YAXIS=2;e.ZAXIS=3;e.POS_XAXIS=1;e.NEG_XAXIS=2;e.POS_YAXIS=3;e.NEG_YAXIS=4;e.POS_ZAXIS=5;e.NEG_ZAXIS=6;e.ZERO="ZERO";e.ONE="ONE";e.SRC_COLOR="SRC_COLOR";e.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR";e.SRC_ALPHA="SRC_ALPHA";e.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA";e.DST_ALPHA="DST_ALPHA";e.ONE_MINUS_DST_ALPHA="ONE_MINUS_DST_ALPHA";e.LINEAR_BLEND=function(e){return e};e.QUAD_BLEND=function(e){return e*e};e.SPECIAL_BLEND=function(e){e=e*(2-e);return e*e};e.error=function(e){if(console&&console.log)console.log("GLGE error: "+e)};e.warning=function(e){if(console&&console.log)console.log("GLGE warning: "+e)};e.Assets={};e.Assets.assets={};e.REGISTER_ASSETS=false;e.Assets.createUUID=function(){var e=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];var t=["8","9","A","B"];uuid="";for(var n=0;n<38;n++){switch(n){case 8:uuid=uuid+"-";break;case 13:uuid=uuid+"-";break;case 18:uuid=uuid+"-";break;case 14:uuid=uuid+"4";break;case 19:uuid=uuid+t[Math.round(Math.random()*3)];break;default:uuid=uuid+e[Math.round(Math.random()*15)];break}}return uuid};e.Assets.registerAsset=function(t,n){if(typeof n=="object"){if(t._)t._(n);n=n.uid}if(!n){n=e.Assets.createUUID()}t.uid=n;if(e.REGISTER_ASSETS){e.Assets.assets[n]=t}};e.Assets.unregisterAsset=function(t){delete e.Assets.assets[t]};e.Assets.get=function(t){var n=e.Assets.assets[t];if(n){return n}else{return false}};e.DJBHash=function(e){var t=5381;for(var n=0;n<e.length;n++){t=(t<<5)+t+e.charCodeAt(n)}return t};e.getGLShader=function(t,n,r){var i=e.DJBHash(r);if(!t.shaderCache)t.shaderCache={};if(!t.shaderCache[i]){var s=t.createShader(n);t.shaderSource(s,r);t.compileShader(s);if(!t.getShaderParameter(s,t.COMPILE_STATUS)){try{e.error(t.getShaderInfoLog(s));return}catch(o){}}t.shaderCache[i]=s}return t.shaderCache[i]};var n=0;e.getGLProgram=function(t,r,i){if(!t.programCache)t.programCache=[];var s=t.programCache;for(var o=0;o<s.length;o++){if(s[o].fShader==i&&s[o].vShader==r){return s[o].program}}var u=t.createProgram();u.progIdx=n++;t.attachShader(u,r);t.attachShader(u,i);t.linkProgram(u);if(!t.getProgramParameter(u,t.LINK_STATUS)){e.error("Couldn't link shader: "+t.getProgramInfoLog(u))}s.push({vShader:r,fShader:i,program:u});if(!u.uniformDetails){u.uniformDetails={};var a=t.getProgramParameter(u,t.ACTIVE_UNIFORMS);for(var o=0;o<a;++o){var f=t.getActiveUniform(u,o);u.uniformDetails[f.name]={loc:e.getUniformLocation(t,u,f.name),info:f}}}return u};e.getUniformLocation=function(e,t,n){if(!t.uniformCache)t.uniformCache={};if(!t.uniformChecked)t.uniformChecked={};if(!t.uniformChecked[n]){t.uniformCache[n]=e.getUniformLocation(t,n);t.uniformChecked[n]=true}return t.uniformCache[n]};e.setUniform=function(e,t,n,r){if(typeof r=="string")r=+r;if(n!=null)e["uniform"+t](n,r)};e.setUniform3=function(e,t,n,r,i,s){if(typeof r=="string")r=+r;if(typeof i=="string")i=+i;if(typeof s=="string")s=+s;if(n!=null)e["uniform"+t](n,r,i,s)};e.setUniform2=function(e,t,n,r,i){if(typeof r=="string")r=+r;if(typeof i=="string")i=+i;if(n!=null)e["uniform"+t](n,r,i)};e.setUniform4=function(e,t,n,r,i,s,o){if(n!=null)e["uniform"+t](n,r,i,s,o)};e.setUniformMatrix=function(e,t,n,r,i){if(n!=null)e["uniform"+t](n,r,i)};e.getAttribLocation=function(e,t,n){if(!t.attribCache)t.attribCache={};if(t.attribCache[n]==undefined){t.attribCache[n]=e.getAttribLocation(t,n)}return t.attribCache[n]};e.colorParse=function(e){var t,n,r,i;var s={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};if(s[e])e="#"+s[e];if(e.substr&&e.substr(0,1)=="#"){e=e.substr(1);if(e.length==8){t=parseInt("0x"+e.substr(0,2))/255;n=parseInt("0x"+e.substr(2,2))/255;r=parseInt("0x"+e.substr(4,2))/255;i=parseInt("0x"+e.substr(6,2))/255}else if(e.length==4){t=parseInt("0x"+e.substr(0,1))/15;n=parseInt("0x"+e.substr(1,1))/15;r=parseInt("0x"+e.substr(2,1))/15;i=parseInt("0x"+e.substr(3,1))/15}else if(e.length==6){t=parseInt("0x"+e.substr(0,2))/255;n=parseInt("0x"+e.substr(2,2))/255;r=parseInt("0x"+e.substr(4,2))/255;i=1}else if(e.length==3){t=parseInt("0x"+e.substr(0,1))/15;n=parseInt("0x"+e.substr(1,1))/15;r=parseInt("0x"+e.substr(2,1))/15;i=1}}else if(e.substr&&e.substr(0,4)=="rgb("){var o=e.substr(4).split(",");t=parseInt(o[0])/255;n=parseInt(o[1])/255;r=parseInt(o[2])/255;i=1}else if(e.substr&&e.substr(0,5)=="rgba("){var o=e.substr(4).split(",");t=parseInt(o[0])/255;n=parseInt(o[1])/255;r=parseInt(o[2])/255;i=parseInt(o[3])/255}else{t=0;n=0;r=0;i=0}return{r:t,g:n,b:r,a:i}}})(GLGE);(function(e){e.Events=function(){};e.Events.prototype.fireEvent=function(e,t){if(this.events&&this.events[e]){var n=this.events[e];for(var r=0;r<n.length;r++){if(n[r]&&n[r].call)n[r].call(this,t)}}};e.Events.prototype.addEventListener=function(e,t){if(!this.events)this.events={};if(!this.events[e])this.events[e]=[];this.events[e].push(t)};e.Events.prototype.removeEventListener=function(e,t){if(!this.events[e])return;var n=this.events[e].indexOf(t);if(n!=-1)this.events[e].splice(n,1)}})(GLGE);(function(e){e.QuickNotation=function(){};e.QuickNotation.prototype._=function(){var e;for(var t=0;t<arguments.length;t++){e=arguments[t];if(typeof e=="object"){if(e.className&&this["add"+e.className]){this["add"+e.className](e)}else{for(var n in e){if(this["set"+n]){this["set"+n](e[n])}}}}}return this}})(GLGE);(function(e){e.Animatable=function(){};e.augment(e.Events,e.Animatable);e.Animatable.prototype.animationStart=null;e.Animatable.prototype.animation=null;e.Animatable.prototype.blendStart=0;e.Animatable.prototype.blendTime=0;e.Animatable.prototype.lastFrame=null;e.Animatable.prototype.frameRate=30;e.Animatable.prototype.loop=e.TRUE;e.Animatable.prototype.paused=e.FALSE;e.Animatable.prototype.pausedTime=null;e.Animatable.prototype.blendFunction=e.LINEAR_BLEND;e.Animatable.prototype.blendTo=function(t,n,r){if(!r)r=e.LINEAR_BLEND;var i=new e.AnimationVector;var s;var o;for(var u in t){s=new e.AnimationCurve;s.setChannel(u);o=new e.LinearPoint;o.setX(1);o.setY(t[u]);s.addPoint(o);i.addAnimationCurve(s)}this.setBlendFunction(r);this.setAnimation(i,n);return this};e.Animatable.prototype.setBlendFunction=function(e){this.blendFunction=e;return this};e.Animatable.prototype.getBlendFunction=function(){return this.blendFunction};e.Animatable.prototype.setName=function(e){this.name=e;return this};e.Animatable.prototype.getName=function(){return this.name};e.Animatable.prototype.getFrameNumber=function(e){if(!this.startFrame)this.startFrame=this.animation.startFrame;if(!this.animFrames)this.animFrames=this.animation.frames;var t;if(!e)e=parseInt((new Date).getTime());if(this.animFrames>1){if(this.loop){t=(parseFloat(e)-parseFloat(this.animationStart))/1e3*this.frameRate%(this.animFrames-1)+1+this.startFrame}else{t=(parseFloat(e)-parseFloat(this.animationStart))/1e3*this.frameRate+1+this.startFrame;if(t>=this.animFrames+this.startFrame){t=this.animFrames}}}else{t=1}return Math.round(t)};e.Animatable.prototype.setStartFrame=function(e,t,n){this.loop=n;var r=parseInt((new Date).getTime());if(!t)t=0;if(t>0){if(this.animation){this.blendInitValues=this.getInitialValues(this.animation,r);this.blendTime=t}}this.animationStart=r;this.lastFrame=null;this.animFinished=false;this.startFrame=e;if(this.children){for(var i=0;i<this.children.length;i++){if(this.children[i].setStartFrame){this.children[i].setStartFrame(e,t,n)}}}return this};e.Animatable.prototype.setFrames=function(e){this.animFrames=e;if(this.children){for(var t=0;t<this.children.length;t++){if(this.children[t].setFrames){this.children[t].setFrames(e)}}}return this;l};e.Animatable.prototype.getInitialValues=function(e,t){var n={};if(this.animation){this.lastFrame=null;this.animate(t,true)}for(var r in e.curves){if(this["get"+r]){n[r]=this["get"+r]()}}return n};e.Animatable.prototype.animate=function(e,t){if(!this.paused&&this.animation){if(!e)e=parseInt((new Date).getTime());var n=this.getFrameNumber(e);if(!this.animation.animationCache)this.animation.animationCache={};if(n!=this.lastFrame||this.blendTime!=0){this.lastFrame=n;if(this.blendTime==0){if(!this.animation.animationCache[n]||t){this.animation.animationCache[n]=[];if(this.animation.curves["LocX"]&&this.animation.curves["LocY"]&&this.animation.curves["LocZ"]&&this.animation.curves["ScaleX"]&&this.animation.curves["ScaleY"]&&this.animation.curves["ScaleZ"]&&this.animation.curves["QuatX"]&&this.animation.curves["QuatY"]&&this.animation.curves["QuatZ"]&&this.animation.curves["QuatW"]){for(var r in this.animation.curves){if(this["set"+r]){var i=this.animation.curves[r].getValue(parseFloat(n));switch(r){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"LocX":case"LocY":case"LocZ":case"ScaleX":case"ScaleY":case"ScaleZ":break;default:this.animation.animationCache[n].push({property:r,value:i});break}this["set"+r](i)}}this.animation.animationCache[n].push({property:"StaticMatrix",value:this.getLocalMatrix()})}else{for(r in this.animation.curves){if(this["set"+r]){var i=this.animation.curves[r].getValue(parseFloat(n));switch(r){case"QuatX":case"QuatY":case"QuatZ":case"QuatW":case"RotX":case"RotY":case"RotZ":var s=true;break;default:this.animation.animationCache[n].push({property:r,value:i});break}this["set"+r](i)}}if(s){i=this.getRotMatrix();this.animation.animationCache[n].push({property:"RotMatrix",value:i})}}}else{var o=this.animation.animationCache[n];for(var u=0;u<o.length;u++){if(this["set"+o[u].property])this["set"+o[u].property](o[u].value)}}}else{var a=e-this.animationStart;if(a<this.blendTime){var f=a/this.blendTime;f=this.blendFunction(f);for(r in this.animation.curves){if(this["set"+r]){var i=this.animation.curves[r].getValue(parseFloat(n));i=i*f+this.blendInitValues[r]*(1-f);this["set"+r](i)}}}else{this.blendTime=0}}}}if(this.children){for(var u=0;u<this.children.length;u++){if(this.children[u].animate){this.children[u].animate(e,t)}}}if(this.animation&&!this.animFinished&&this.blendTime==0&&this.animation.frames==n&&!t){this.animFinished=true;this.fireEvent("animFinished",{})}};e.Animatable.prototype.setAnimation=function(e,t,n){if(n==null)n=parseInt((new Date).getTime());if(!t)t=0;if(t>0){this.blendInitValues=this.getInitialValues(e,n);this.blendTime=t}this.animFrames=null;this.startFrame=null;this.animationStart=n;this.lastFrame=null;this.animation=e;this.animFinished=false;return this};e.Animatable.prototype.getAnimation=function(){return this.animation};e.Animatable.prototype.setFrameRate=function(e){this.frameRate=e;if(this.children){for(var t=0;t<this.children.length;t++){if(this.children[t].setFrameRate){this.children[t].setFrameRate(e)}}}return this};e.Animatable.prototype.getFrameRate=function(){return this.frameRate};e.Animatable.prototype.setLoop=function(e){this.loop=e;return this};e.Animatable.prototype.getLoop=function(){return this.loop};e.Animatable.prototype.isLooping=e.Animatable.prototype.getLoop;e.Animatable.prototype.setPaused=function(e){if(e)this.pauseTime=parseInt((new Date).getTime());else this.animationStart=this.animationStart+(parseInt((new Date).getTime())-this.pauseTime);this.paused=e;return this};e.Animatable.prototype.getPaused=function(){return this.paused};e.Animatable.prototype.togglePaused=function(){this.setPaused(!this.getPaused());return this.paused}})(GLGE);(function(e){e.Document=function(){this.listeners=[];this.documents=[]};e.Document.prototype.listeners=null;e.Document.prototype.documents=null;e.Document.prototype.rootURL=null;e.Document.prototype.loadCount=0;e.Document.prototype.version=0;e.Document.prototype.preloader=null;e.Document.prototype.getElementById=function(e){var t=this.getElementsByTagName("*");for(var n=0;n<t.length;n++){if(t[n].getAttribute("id")==e){return t[n];break}}return null};e.Document.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,8)=="https://"){return e}else{if(!t){t=window.location.href}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(var o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.Document.prototype.load=function(e,t){if(t)this.usePreloader(t);this.documents=[];this.rootURL=e;this.loadDocument(e,null)};e.Document.prototype.loadDocument=function(t,n){this.loadCount++;t=this.getAbsolutePath(t,n);if(this.preloader){this.preloader.loadXMLFile(t)}else{var r=new XMLHttpRequest;if(r){r.docurl=t;r.docObj=this;r.overrideMimeType("text/xml");r.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){this.responseXML.getElementById=this.docObj.getElementById;this.docObj.loaded(this.docurl,this.responseXML)}else{e.error("Error loading Document: "+this.docurl+" status "+this.status)}}};r.open("GET",t,true);r.send("")}}};e.Document.prototype.loaded=function(e,t){this.loadCount--;this.documents[e]={xml:t,url:e};var n=t.getElementsByTagName("glge");if(n[0]&&n[0].hasAttribute("version"))this.version=parseFloat(n[0].getAttribute("version"));var r=t.getElementsByTagName("import");for(var i=0;i<r.length;i++){if(!this.documents[this.getAbsolutePath(r[i].getAttribute("url"),e)]){this.documents[this.getAbsolutePath(r[i].getAttribute("url"),e)]={};this.loadDocument(r[i].getAttribute("url"),e)}}if(this.loadCount==0){this.finishedLoading()}};e.Document.prototype.finishedLoading=function(){for(var e=0;e<this.listeners.length;e++){this.listeners[e](this.rootURL)}this["onLoad"]()};e.Document.prototype["onLoad"]=function(){};e.Document.prototype.usePreloader=function(t){this.preloader=new e.DocumentPreloader(this,t);var n=this;this.addLoadListener(function(e){n.preloadImages.call(n)})};e.Document.prototype.preloadImages=function(){var e=[];var t=[];for(var n in this.documents){if(this.documents[n].xml){e.push(this.documents[n].xml.getElementsByTagName("texture"));t.push(this.documents[n].url)}}for(var r in e){for(var i=0;i<e[r].length;i++){var s=e[r][i].getAttribute("src");if(s)this.preloader.addImage(this.getAbsolutePath(s,t[r]))}}this.preloader.loadImages()};e.Document.prototype.classString=function(e){if(!e)return false;var t=e.split("_");var n="";for(var r=0;r<t.length;r++){n=n+t[r][0].toUpperCase()+t[r].substr(1)}return n};e.Document.prototype.setProperties=function(t){var n;var r;var i;for(var s=0;s<t.attributes.length;s++){i=false;n="set"+this.classString(t.attributes[s].nodeName);if(t.attributes[s].value[0]=="#"){i=this.getElement(t.attributes[s].value.substr(1),true)}if(!i){if(typeof e[t.attributes[s].value]!="undefined"){i=e[t.attributes[s].value]}else{i=t.attributes[s].value}}if(t.object[n])t.object[n](i==parseFloat(i)?parseFloat(i):i);if(t.attributes[s].nodeName=="uid"){e.Assets.unregisterAsset(t.object.uid);t.object.uid=t.attributes[s].value;e.Assets.registerAsset(t.object,t.attributes[s].value)}}};e.Document.prototype.addChildren=function(e){var t;var n=e.firstChild;while(n){t="add"+this.classString(n.tagName);if(e.object[t])e.object[t](this.getElement(n));n=n.nextSibling}};e.Document.prototype.getElement=function(t,n){var r,i;if(typeof t=="string"){for(var i in this.documents){if(this.documents[i].xml){r=this.documents[i].xml.getElementById(t);if(r){t=r;break}}}}if(typeof t=="string"){if(!n)e.error("Element "+t+" not found in document");return false}else{if(this["get"+this.classString(t.tagName)]){return this["get"+this.classString(t.tagName)](t)}else{return this.getDefault(t)}}};e.Document.prototype.getData=function(t){if(!t.object){t.object=this.parseArray(t);if(t.hasAttribute("type")){var n=t.getAttribute("type");switch(n){case"matrix":for(var r=0;r<t.object.length;r++){t.object[r]=e.Mat4(t.object[r].split(" "))}break;case"links":for(var r=0;r<t.object.length;r++){t.object[r]=this.getElement(t.object[r].substr(1))}break}}}return t.object};e.Document.prototype.getDefault=function(t){if(!t.object){if(e[this.classString(t.tagName)]){t.object=new(e[this.classString(t.tagName)]);this.setProperties(t);this.addChildren(t)}else{e.error("XML Parse Error: GLGE Object not found")}}return t.object};e.Document.prototype.getTexture=function(t){if(!t.object){var n=this.getAbsolutePath(this.rootURL,null);t.object=new(e[this.classString(t.tagName)]);t.object.setSrc(this.getAbsolutePath(t.getAttribute("src"),n));t.removeAttribute("src");this.setProperties(t)}return t.object};e.Document.prototype.getTextureVideo=e.Document.prototype.getTexture;e.Document.prototype.parseArray=function(e){var t=e.firstChild;var n="";var r=[];var i;var s;while(t){i=(n+t.nodeValue).split(",");t=t.nextSibling;if(i[0]=="")i.unshift();if(t)n=i.pop();for(var s=0;s<i.length;s++)r.push(i[s])}return r};e.Document.prototype.getMesh=function(t){if(this.version>0)return this.getDefault(t);if(!t.object){t.object=new e.Mesh;this.setProperties(t);var n=t.firstChild;while(n){switch(n.tagName){case"positions":t.object.setPositions(this.parseArray(n));break;case"normals":t.object.setNormals(this.parseArray(n));break;case"uv1":t.object.setUV(this.parseArray(n));break;case"uv2":t.object.setUV2(this.parseArray(n));break;case"faces":t.object.setFaces(this.parseArray(n));break;case"color":t.object.setVertexColors(this.parseArray(n));break;case"joint_names":var r=this.parseArray(n);var i=[];for(var s=0;s<r.length;s++){if(r[s].substr(0,1)=="#"){i.push(this.getElement(r[s].substr(1)))}else{i.push(r[s])}}t.object.setJoints(i);break;case"bind_matrix":var o=this.parseArray(n);var u=[];for(var s=0;s<o.length;s++){u.push(e.Mat4(o[s].split(" ")))}t.object.setInvBindMatrix(u);break;case"joints":t.object.setVertexJoints(this.parseArray(n),n.getAttribute("count"));break;case"weights":t.object.setVertexWeights(this.parseArray(n),n.getAttribute("count"));break}n=n.nextSibling}}return t.object};e.Document.prototype.addLoadListener=function(e){this.listeners.push(e)};e.Document.prototype.removeLoadListener=function(e){for(var t=0;t<this.listeners.length;t++){if(this.listeners[t]===e)this.listeners.splice(t,1)}};e.Document.prototype.parseScript=function(e){this.rootURL=window.location.toString();var t=document.getElementById(e);if(!t){return null}var n="";var r=t.firstChild;while(r){if(r.nodeType==3){n+=r.textContent}r=r.nextSibling}var i=new DOMParser;var s=i.parseFromString(n,"text/xml");s.getElementById=this.getElementById;this.documents["#"+e]={xml:s};var o=s.getElementsByTagName("import");for(var u=0;u<o.length;u++){if(!this.documents[this.getAbsolutePath(o[u].getAttribute("url"),url)]){this.documents[this.getAbsolutePath(o[u].getAttribute("url"),url)]={};this.loadDocument(o[u].getAttribute("url"))}}if(this.loadCount==0){this.finishedLoading()}}})(GLGE);(function(e){e.ZUP=[0,0,1];e.YUP=[0,1,0];e.XUP=[1,0,0];e.Placeable=function(){};e.Placeable.prototype.locX=0;e.Placeable.prototype.locY=0;e.Placeable.prototype.locZ=0;e.Placeable.prototype.dLocX=0;e.Placeable.prototype.dLocY=0;e.Placeable.prototype.dLocZ=0;e.Placeable.prototype.quatX=0;e.Placeable.prototype.quatY=0;e.Placeable.prototype.quatZ=0;e.Placeable.prototype.quatW=0;e.Placeable.prototype.rotX=0;e.Placeable.prototype.rotY=0;e.Placeable.prototype.rotZ=0;e.Placeable.prototype.dRotX=0;e.Placeable.prototype.dRotY=0;e.Placeable.prototype.dRotZ=0;e.Placeable.prototype.scaleX=1;e.Placeable.prototype.scaleY=1;e.Placeable.prototype.scaleZ=1;e.Placeable.prototype.dScaleX=0;e.Placeable.prototype.dScaleY=0;e.Placeable.prototype.dScaleZ=0;e.Placeable.prototype.matrix=null;e.Placeable.prototype.rotOrder=e.ROT_XYZ;e.Placeable.prototype.lookAt=null;e.Placeable.prototype.mode=e.P_EULER;e.Placeable.prototype.upAxis=e.ZUP;e.Placeable.prototype.getRoot=function(){if(this.type==e.G_ROOT){return this}else if(this.parent){var t=this.parent.getRoot();if(!t)return this;else return t}else{return this}};e.Placeable.prototype.getRef=function(){if(this.id){return this.id}else if(this.parent){return this.parent.getRef()}else{return null}};e.Placeable.prototype.setId=function(e){this.id=e;return this};e.Placeable.prototype.getId=function(){return this.id};e.Placeable.prototype.getLookat=function(){return this.lookAt};e.Placeable.prototype.setLookat=function(e){this.lookAt=e;return this};e.Placeable.prototype.getUpAxis=function(){return this.upAxis};e.Placeable.prototype.setUpAxis=function(e){this.upAxis=e;return this};e.Placeable.prototype.Lookat=function(t){var n;var r=this.getPosition();if(t.getPosition){n=t.getPosition()}else{n={x:t[0],y:t[1],z:t[2]}}var i=[r.x-n.x,r.y-n.y,r.z-n.z];var s=e.toUnitVec3(i);var o=e.toUnitVec3(e.crossVec3(this.upAxis,s));if(o[0]==0&&o[1]==0&&o[2]==0)o[1]=1;var u=e.toUnitVec3(e.crossVec3(s,o));this.setRotMatrix(e.Mat4([o[0],u[0],s[0],0,o[1],u[1],s[1],0,o[2],u[2],s[2],0,0,0,0,1]))};e.Placeable.prototype.setTransformMode=function(e){this.mode=e;this.matrix=null;return this};e.Placeable.prototype.getRotOrder=function(){return this.rotOrder};e.Placeable.prototype.setRotOrder=function(e){this.rotOrder=e;this.matrix=null;this.rotmatrix=null;return this};e.Placeable.prototype.getRotMatrix=function(){if(!this.rotmatrix){var t=this.getRotation();if(this.mode==e.P_EULER)this.rotmatrix=e.rotateMatrix(t.x,t.y,t.z,this.rotOrder);if(this.mode==e.P_QUAT)this.rotmatrix=e.quatRotation(t.x,t.y,t.z,t.w)}return this.rotmatrix};e.Placeable.prototype.setRotMatrix=function(t){this.mode=e.P_MATRIX;this.rotmatrix=t;this.updateMatrix();return this};e.Placeable.prototype.setLocX=function(e){this.locX=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setLocY=function(e){this.locY=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setLocZ=function(e){this.locZ=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setLoc=function(e,t,n){this.locX=e;this.locY=t;this.locZ=n;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDLocX=function(e){this.dLocX=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDLocY=function(e){this.dLocY=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDLocZ=function(e){this.dLocZ=e;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDLoc=function(e,t,n){this.dLocX=e;this.dLocY=t;this.dLocZ=n;this.translateMatrix=null;this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setQuatX=function(t){this.mode=e.P_QUAT;this.quatX=parseFloat(t);this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setQuatY=function(t){this.mode=e.P_QUAT;this.quatY=parseFloat(t);this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setQuatZ=function(t){this.mode=e.P_QUAT;this.quatZ=parseFloat(t);this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setQuatW=function(t){this.mode=e.P_QUAT;this.quatW=parseFloat(t);this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setQuat=function(t,n,r,i){this.mode=e.P_QUAT;this.quatX=t;this.quatY=n;this.quatZ=r;this.quatW=i;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setRotX=function(t){this.mode=e.P_EULER;this.rotX=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setRotY=function(t){this.mode=e.P_EULER;this.rotY=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setRotZ=function(t){this.mode=e.P_EULER;this.rotZ=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setRot=function(t,n,r){this.mode=e.P_EULER;this.rotX=t;this.rotY=n;this.rotZ=r;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDRotX=function(t){this.mode=e.P_EULER;this.dRotX=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDRotY=function(t){this.mode=e.P_EULER;this.dRotY=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDRotZ=function(t){this.mode=e.P_EULER;this.dRotZ=t;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDRot=function(t,n,r){this.mode=e.P_EULER;this.dRotX=t;this.dRotY=n;this.dRotZ=r;this.staticMatrix=null;this.rotmatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setScaleX=function(e){if(this.ScaleX==e)return this;this.scaleX=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setScaleY=function(e){if(this.ScaleY==e)return this;this.scaleY=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setScaleZ=function(e){if(this.ScaleZ==e)return this;this.scaleZ=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setScale=function(e,t,n){if(!t){t=e;n=e}this.scaleX=e;this.scaleY=t;this.scaleZ=n;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDScaleX=function(e){if(this.dScaleX==e)return this;this.dScaleX=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDScaleY=function(e){if(this.dScaleY==e)return this;this.dScaleY=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDScaleZ=function(e){if(this.dScaleZ==e)return this;this.dScaleZ=e;this.staticMatrix=null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.setDScale=function(e,t,n){this.dScaleX=e;this.dScaleY=t;this.dScaleZ=n;this.staticMatrix==null;this.scaleMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.getLocX=function(){return parseFloat(this.locX)};e.Placeable.prototype.getLocY=function(){return parseFloat(this.locY)};e.Placeable.prototype.getLocZ=function(){return parseFloat(this.locZ)};e.Placeable.prototype.getLoc=function(){return new e.Vec3(parseFloat(this.locX),parseFloat(this.locY),parseFloat(this.locZ))};e.Placeable.prototype.getDLocX=function(){return this.dLocX};e.Placeable.prototype.getDLocY=function(){return this.dLocY};e.Placeable.prototype.getDLocZ=function(){return this.dLocZ};e.Placeable.prototype.getQuatX=function(){return this.quatX};e.Placeable.prototype.getQuatY=function(){return this.quatY};e.Placeable.prototype.getQuatZ=function(){return this.quatZ};e.Placeable.prototype.getQuatW=function(){return this.quatW};e.Placeable.prototype.getRotX=function(){return this.rotX};e.Placeable.prototype.getRotY=function(){return this.rotY};e.Placeable.prototype.getRotZ=function(){return this.rotZ};e.Placeable.prototype.getDRotX=function(){return this.dRotX};e.Placeable.prototype.getDRotY=function(){return this.dRotY};e.Placeable.prototype.getDRotZ=function(){return this.dRotZ};e.Placeable.prototype.getScaleX=function(){return this.scaleX};e.Placeable.prototype.getScaleY=function(){return this.scaleY};e.Placeable.prototype.getScaleZ=function(){return this.scaleZ};e.Placeable.prototype.getDScaleX=function(){return this.dScaleX};e.Placeable.prototype.getDScaleY=function(){return this.dScaleY};e.Placeable.prototype.getDScaleZ=function(){return this.dScaleZ};e.Placeable.prototype.getPosition=function(){var e={};e.x=parseFloat(this.locX)+parseFloat(this.dLocX);e.y=parseFloat(this.locY)+parseFloat(this.dLocY);e.z=parseFloat(this.locZ)+parseFloat(this.dLocZ);return e};e.Placeable.prototype.getRotation=function(){var t={};if(this.mode==e.P_EULER){t.x=parseFloat(this.rotX)+parseFloat(this.dRotX);t.y=parseFloat(this.rotY)+parseFloat(this.dRotY);t.z=parseFloat(this.rotZ)+parseFloat(this.dRotZ)}if(this.mode==e.P_QUAT){t.x=parseFloat(this.quatX);t.y=parseFloat(this.quatY);t.z=parseFloat(this.quatZ);t.w=parseFloat(this.quatW)}return t};e.Placeable.prototype.getScale=function(){var e={};e.x=parseFloat(this.scaleX)+parseFloat(this.dScaleX);e.y=parseFloat(this.scaleY)+parseFloat(this.dScaleY);e.z=parseFloat(this.scaleZ)+parseFloat(this.dScaleZ);return e};e.Placeable.prototype.getScaleMatrix=function(){if(!this.scaleMatrix){this.scaleMatrix=e.scaleMatrix(parseFloat(this.scaleX)+parseFloat(this.dScaleX),parseFloat(this.scaleY)+parseFloat(this.dScaleY),parseFloat(this.scaleZ)+parseFloat(this.dScaleZ))}return this.scaleMatrix};e.Placeable.prototype.getTranslateMatrix=function(){if(!this.tmatrix)this.tmatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];if(!this.translateMatrix){this.tmatrix[3]=+this.locX+this.dLocX;this.tmatrix[7]=+this.locY+this.dLocY;this.tmatrix[11]=+this.locZ+this.dLocZ;this.translateMatrix=this.tmatrix}return this.translateMatrix};e.Placeable.prototype.getLocalMatrix=function(){this.getModelMatrix();return this.localMatrix};e.Placeable.prototype.setStaticMatrix=function(e){this.staticMatrix=e;this.updateMatrix();return this};e.Placeable.prototype.clearStaticMatrix=function(){this.staticMatrix=null;this.updateMatrix();return this};e.Placeable.prototype.updateMatrix=function(){this.matrix=null;if(this.children){for(var e=0;e<this.children.length;e++){this.children[e].updateMatrix()}}var t=obj=this;obj.fireEvent("matrixUpdate",{obj:t});if(obj=obj.parent)obj.fireEvent("childMatrixUpdate",{obj:t})};e.Placeable.prototype.getModelMatrix=function(){if(!this.matrix){e.reuseMatrix4(this.invmatrix);e.reuseMatrix4(this.transmatrix);e.reuseMatrix4(this.transinvmatrix);this.invmatrix=null;this.transmatrix=null;this.transinvmatrix=null;if(this.staticMatrix){var t=this.staticMatrix;this.localMatrix=this.staticMatrix;if(this.parent)t=e.mulMat4(this.parent.getModelMatrix(),t);this.matrix=t}else{var n=this.getTranslateMatrix();var r=this.getScaleMatrix();var i=e.mulMat4(this.getRotMatrix(),r);var t=e.mulMat4(n,i);this.localMatrix=t;if(this.parent)t=e.mulMat4(this.parent.getModelMatrix(),t);this.matrix=t}}return this.matrix};e.Placeable.prototype.getInverseModelMatrix=function(){if(!this.matrix){this.getModelMatrix()}if(!this.invmatrix){this.invmatrix=e.transposeMat4(this.matrix)}return this.invmatrix};e.Placeable.prototype.getTransposeModelMatrix=function(){if(!this.matrix){this.getModelMatrix()}if(!this.transmatrix){this.transmatrix=e.transposeMat4(this.matrix)}return this.transmatrix};e.Placeable.prototype.getTransposeInverseModelMatrix=function(){if(!this.matrix){this.getModelMatrix()}if(!this.transinvmatrix){this.invtransmatrix=e.transposeMat4(this.getInverseModelMatrix())}return this.transinvmatrix};e.Placeable.prototype.move=function(t,n){if(!n)n=e.GLOBAL;switch(n){case e.GLOBAL:this.setLocX(+this.locX+t[0]);this.setLocY(+this.locY+t[1]);this.setLocZ(+this.locZ+t[2]);break;case e.LOCAL:var r=this.getModelMatrix();var i=e.toUnitVec3([r[0],r[1],r[2]]);var s=e.toUnitVec3([r[4],r[5],r[6]]);var o=e.toUnitVec3([r[8],r[9],r[10]]);var u=i[0]*t[0]+i[1]*t[1]+i[2]*t[2];var a=s[0]*t[0]+s[1]*t[1]+s[2]*t[2];var f=o[0]*t[0]+o[1]*t[1]+o[2]*t[2];this.setLocX(+this.locX+u);this.setLocY(+this.locY+a);this.setLocZ(+this.locZ+f);break}return this}})(GLGE);(function(e){e.JSONLoader=function(){};e.JSONLoader.prototype.downloadPriority=0;e.JSONLoader.prototype.setJSONSrc=function(t){var n=this;e.Message.messageLoader(t,function(e){n.setJSONString(e)},this.downloadPriority)};e.JSONLoader.prototype.setJSONString=function(t){var n=JSON.parse(t);if(n.type==this.className){n.uid=this.uid;n.command="update";e.Message.parseMessage(n)}};e.JSONLoader.prototype.setDownloadPriority=function(e){this.downloadPriority=e};e.JSONLoader.prototype.getDownloadPriority=function(){return this.downloadPriority}})(GLGE);(function(e){e.G_NODE=1;e.G_ROOT=2;e.Group=function(t){this.children=[];var n=this;this.downloadComplete=function(){if(n.isComplete())n.fireEvent("downloadComplete")};e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.Group);e.augment(e.Animatable,e.Group);e.augment(e.QuickNotation,e.Group);e.augment(e.JSONLoader,e.Group);e.Group.prototype.children=null;e.Group.prototype.className="Group";e.Group.prototype.type=e.G_NODE;e.Group.prototype.visible=true;e.Group.prototype.pickable=true;e.Group.prototype.setVisible=function(e){this.visible=e;return this};e.Group.prototype.getVisible=function(){return this.visible};e.Group.prototype.isComplete=function(){for(var e=0;e<this.children.length;e++){if(this.children[e].isComplete&&!this.children[e].isComplete()){return false}}return true};e.Group.prototype.setAction=function(e,t,n){e.start(t,n,this.getNames());return this};e.Group.prototype.getNames=function(e){if(!e)e={};var t=this.getName();if(t!="")e[t]=this;for(var n=0;n<this.children.length;n++){if(this.children[n].getNames){this.children[n].getNames(e)}}return e};e.Group.prototype.getBoundingVolume=function(t){this.boundingVolume=null;for(var n=0;n<this.children.length;n++){if(this.children[n].getBoundingVolume){if(!this.boundingVolume){this.boundingVolume=this.children[n].getBoundingVolume(true).clone()}else{this.boundingVolume.addBoundingVolume(this.children[n].getBoundingVolume(true))}}}if(!this.boundingVolume)this.boundingVolume=new e.BoundingVolume(0,0,0,0,0,0);if(t){this.boundingVolume.applyMatrix(this.getLocalMatrix())}else{this.boundingVolume.applyMatrix(this.getModelMatrix())}return this.boundingVolume};e.Group.prototype.getObjects=function(e){if(this.lookAt)this.Lookat(this.lookAt);if(this.animation)this.animate();if(!e)e=[];for(var t=0;t<this.children.length;t++){if(this.children[t].className=="Object"||this.children[t].className=="Text"||this.children[t].toRender){if(this.children[t].visible||this.children[t].visible==undefined){if(this.children[t].renderFirst)e.unshift(this.children[t]);else e.push(this.children[t])}}else if(this.children[t].getObjects){if(this.children[t].visible||this.children[t].visible==undefined){this.children[t].getObjects(e)}}}return e};e.Group.prototype.getLights=function(e){if(!e)e=[];for(var t=0;t<this.children.length;t++){if(this.children[t].className=="Light"){e.push(this.children[t])}else if(this.children[t].getLights){this.children[t].getLights(e)}}return e};e.Group.prototype.updateAllPrograms=function(){var e=this.getObjects();for(var t=0;t<e.length;t++){if(e[t].updateProgram)e[t].updateProgram()}};e.Group.prototype.addChild=function(t){if(t.parent)t.parent.removeChild(t);if(this.noCastShadows!=null&&t.noCastShadows==null&&t.setCastShadows)t.setCastShadows(!this.noCastShadows);e.reuseMatrix4(t.matrix);t.matrix=null;t.parent=this;this.children.push(t);if(t.getLights&&t.getLights().length>0||t.className=="Light"){var n=t;while(n.parent)n=n.parent;n.updateAllPrograms()}if(t.addEventListener){t.addEventListener("shaderupdate",function(){var e=this;while(e.parent)e=e.parent;e.updateAllPrograms()});t.addEventListener("downloadComplete",this.downloadComplete)}this.fireEvent("childAdded",{obj:t});if(t.fireEvent)t.fireEvent("appened",{obj:this});this.fireEvent("childAdded",{obj:t});var r=this;while(r=r.parent)r.fireEvent("childAdded",{obj:t,target:this});return this};e.Group.prototype.addObject=e.Group.prototype.addChild;e.Group.prototype.addObjectInstance=e.Group.prototype.addChild;e.Group.prototype.addGroup=e.Group.prototype.addChild;e.Group.prototype.addLight=e.Group.prototype.addChild;e.Group.prototype.addText=e.Group.prototype.addChild;e.Group.prototype.addSkeleton=e.Group.prototype.addChild;e.Group.prototype.addCamera=e.Group.prototype.addChild;e.Group.prototype.addWavefront=e.Group.prototype.addChild;e.Group.prototype.removeChild=function(e){var t;if(typeof e=="object"){for(var n=0;n<this.children.length;n++){if(this.children[n]==e){e=n;t=e;break}}}else{if(this.children.length<=e)return;t=this.children[e]}if(this.children[e].removeEventListener){this.children[e].removeEventListener("downloadComplete",this.downloadComplete)}this.children.splice(e,1);if(this.scene&&this.scene["remove"+t.className]){this.scene["remove"+t.className](t)}if(t.fireEvent)t.fireEvent("removed",{obj:this});this.fireEvent("childRemoved",{obj:t});var r=this;while(r=r.parent)r.fireEvent("childRemoved",{obj:t,target:this})};e.Group.prototype.getChildren=function(){return this.children};e.Group.prototype.GLInit=function(e){this.gl=e;for(var t=0;t<this.children.length;t++){if(this.children[t].GLInit){this.children[t].GLInit(e)}}};e.Group.prototype.getPickable=function(){return this.pickable};e.Group.prototype.setPickable=function(e){for(var t=0;t<this.children.length;t++){if(this.children[t].setPickable){this.children[t].setPickable(e)}}this.pickable=e;return this}})(GLGE);(function(e){e.Message={};e.Message.parseMessage=function(t){switch(t.command){case"create":var n=new e[t.type](t.uid);this.setAttributes(n,t.attributes);if(t.children)e.Message.addChildren(n,t.children);return n;break;case"update":var n=e.Assets.get(t.uid);this.setAttributes(n,t.attributes);if(t.add)e.Message.addChildren(n,t.add);if(t.remove)e.Message.removeChildren(n,t.remove);return n;break}return null};e.Message.setAttributes=function(t,n){if(n){for(var r in n){if(t["set"+r]){if(n[r].command){n[r]=e.Message.parseMessage(n[r])}t["set"+r](n[r])}}}return this};e.Message.addChildren=function(t,n){if(!(n instanceof Array))n=[n];for(var r=0;r<n.length;r++){if(n[r].command){var i=e.Message.parseMessage(n[r])}else{var i=e.Assets.get(n[r])}t["add"+i.className](i)}};e.Message.removeChildren=function(t,n){if(!(n instanceof Array))n=[n];for(var r=0;r<n.length;r++){var i=e.Assets.get(n[r]);t["add"+i.className](i)}};e.Message.toLoad=[];e.Message.messageLoader=function(t,n,r){e.Message.toLoad.push([t,n,r]);if(e.Message.toLoad.length==1)e.Message.loadMessages()};e.Message.loadMessages=function(){var t=e.Message.toLoad.pop();var n=new XMLHttpRequest;n.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){t[1](this.responseText)}else{e.error("Error loading Document: "+t[0]+" status "+this.status)}}};n.open("GET",t[0],true);n.send("");if(e.Message.toLoad.length>0)e.Message.loadMessages()}})(GLGE);(function(e){e.Action=function(t){this.channels=[];e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.Action);e.augment(e.JSONLoader,e.Action);e.augment(e.Events,e.Action);e.Action.prototype.start=function(e,t,n){if(!t)t=false;if(!e)e=0;var r=this.channels;var i=(new Date).getTime();this.animFinished=false;for(var s=0;s<r.length;s++){var o=r[s].getAnimation();var u=this;var a=r[s];var f=a.getTarget();if(typeof f=="string"){if(n&&n[f]){f=n[f]}}var l={};l.finishEvent=function(e){f.removeEventListener("animFinished",l.finishEvent);if(!u.animFinished&&f.animation==o){u.fireEvent("animFinished",{});u.animFinished=true}};f.addEventListener("animFinished",l.finishEvent);f.setAnimation(o,e,i);f.setLoop(t)}};e.Action.prototype.setStartFrame=function(e){for(var t=0;t<this.channels.length;t++){this.channels[t].getAnimation().setStartFrame(e)}return this};e.Action.prototype.setFrames=function(e){for(var t=0;t<this.channels.length;t++){this.channels[t].getAnimation().setFrames(e)}return this};e.Action.prototype.addActionChannel=function(e){this.channels.push(e);return this};e.Action.prototype.removeActionChannel=function(e){for(var t=0;t<this.channels.length;t++){if(this.channels[t]==channels){this.channels.splice(t,1);break}}}})(GLGE);(function(e){e.ActionChannel=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.ActionChannel);e.augment(e.JSONLoader,e.ActionChannel);e.ActionChannel.prototype.setTarget=function(e){this.target=e};e.ActionChannel.prototype.setAnimation=function(e){this.animation=e};e.ActionChannel.prototype.getTarget=function(){return this.target};e.ActionChannel.prototype.getAnimation=function(){return this.animation}})(GLGE);(function(e){e.AnimationCurve=function(t){this.keyFrames=[];this.solutions={};this.caches={};e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.AnimationCurve);e.augment(e.JSONLoader,e.AnimationCurve);e.AnimationCurve.prototype.className="AnimationCurve";e.AnimationCurve.prototype.keyFrames=null;e.AnimationCurve.prototype.addPoint=function(e){this.keyFrames.push(e);return this.keyFrames.length-1};e.AnimationCurve.prototype.addStepPoint=e.AnimationCurve.prototype.addPoint;e.AnimationCurve.prototype.addLinearPoint=e.AnimationCurve.prototype.addPoint;e.AnimationCurve.prototype.addBezTriple=e.AnimationCurve.prototype.addPoint;e.AnimationCurve.prototype.coord=function(e,t){return{x:e,y:t}};e.AnimationCurve.prototype.setChannel=function(e){this.channel=e};e.AnimationCurve.prototype.getValue=function(t){if(this.keyFrames.length==0)return 0;if(this.caches[t])return this.caches[t];var n;var r;var i;var s;if(t<this.keyFrames[0].x)return this.keyFrames[0].y;for(var o=0;o<this.keyFrames.length;o++){if(this.keyFrames[o].x==t){return this.keyFrames[o].y}if(this.keyFrames[o].x<=t&&(n==undefined||this.keyFrames[o].x>this.keyFrames[n].x)){i=n;n=o}else if(this.keyFrames[o].x<=t&&(i==undefined||this.keyFrames[o].x>this.keyFrames[i].x)){i=o}if(this.keyFrames[o].x>t&&(r==undefined||this.keyFrames[o].x<=this.keyFrames[r].x)){s=r;r=o}else if(this.keyFrames[o].x>t&&(s==undefined||this.keyFrames[o].x<=this.keyFrames[s].x)){s=o}}if(n==undefined){n=r;r=s}if(r==undefined){r=n;n=i}if(this.keyFrames[n]instanceof e.BezTriple&&this.keyFrames[r]instanceof e.BezTriple){var u=this.coord(this.keyFrames[n].x,this.keyFrames[n].y);var a=this.coord(this.keyFrames[n].x3,this.keyFrames[n].y3);var f=this.coord(this.keyFrames[r].x1,this.keyFrames[r].y1);var l=this.coord(this.keyFrames[r].x,this.keyFrames[r].y);return this.atX(t,u,a,f,l).y}if(this.keyFrames[n]instanceof e.LinearPoint&&this.keyFrames[r]instanceof e.BezTriple){var u=this.coord(this.keyFrames[n].x,this.keyFrames[n].y);var a=this.coord(this.keyFrames[r].x1,this.keyFrames[r].y1);var f=this.coord(this.keyFrames[r].x1,this.keyFrames[r].y1);var l=this.coord(this.keyFrames[r].x,this.keyFrames[r].y);return this.atX(t,u,a,f,l).y}if(this.keyFrames[n]instanceof e.BezTriple&&this.keyFrames[r]instanceof e.LinearPoint){var u=this.coord(this.keyFrames[n].x,this.keyFrames[n].y);var a=this.coord(this.keyFrames[n].x3,this.keyFrames[n].y3);var f=this.coord(this.keyFrames[n].x3,this.keyFrames[n].y3);var l=this.coord(this.keyFrames[r].x,this.keyFrames[r].y);return this.atX(t,u,a,f,l).y}if(this.keyFrames[n]instanceof e.LinearPoint&&this.keyFrames[r]instanceof e.LinearPoint){var c=(t-this.keyFrames[n].x)*(this.keyFrames[r].y-this.keyFrames[n].y)/(this.keyFrames[r].x-this.keyFrames[n].x)+this.keyFrames[n].y;return c}if(this.keyFrames[n]instanceof e.StepPoint){return this.keyFrames[n].y}if(!this.keyFrames.preStartKey)this.keyFrames.preStartKey=this.keyFrames[0].y;this.caches[t]=this.keyFrames.preStartKey;return this.caches[t]};e.AnimationCurve.prototype.B1=function(e){return e*e*e};e.AnimationCurve.prototype.B2=function(e){return 3*e*e*(1-e)};e.AnimationCurve.prototype.B3=function(e){return 3*e*(1-e)*(1-e)};e.AnimationCurve.prototype.B4=function(e){return(1-e)*(1-e)*(1-e)};e.AnimationCurve.prototype.getBezier=function(e,t,n,r,i){var s={};s.x=t.x*this.B1(e)+n.x*this.B2(e)+r.x*this.B3(e)+i.x*this.B4(e);s.y=t.y*this.B1(e)+n.y*this.B2(e)+r.y*this.B3(e)+i.y*this.B4(e);return s};e.AnimationCurve.prototype.Quad3Solve=function(e,t,n,r){ref=e+"-"+t+"-"+"-"+n+"-"+r;if(this.solutions[ref]){return this.solutions[ref]}else{t/=e;n/=e;r/=e;var i,s,o,u,a,f,l;i=(3*n-t*t)/9;s=-(27*r)+t*(9*n-2*t*t);s/=54;f=t/3;discrim=i*i*i+s*s;result=[];if(discrim>0){u=s+Math.sqrt(discrim);u=u<0?-Math.pow(-u,1/3):Math.pow(u,1/3);a=s-Math.sqrt(discrim);a=a<0?-Math.pow(-a,1/3):Math.pow(a,1/3);result[0]=-f+u+a;f=f+(u+a)/2;result[1]=result[2]=-f;f=Math.sqrt(3)*(-a+u)/2}else if(discrim==0){l=s<0?-Math.pow(-s,1/3):Math.pow(s,1/3);result[1]=-f+2*l;result[1]=result[2]=-(l+f)}else{i=-i;o=i*i*i;o=Math.acos(s/Math.sqrt(1));l=2*Math.sqrt(i);result[0]=-f+l*Math.cos(o/3);result[1]=-f+l*Math.cos((o+2*Math.PI)/3);result[2]=-f+l*Math.cos((o+4*Math.PI)/3)}var c=false;if(result[0]>=0&&result[0]<=1)c=result[0];if(!c&&result[1]>=0&&result[1]<=1)c=result[1];if(!c&&result[2]>=0&&result[2]<=1)c=result[2];this.solutions[ref]=c;return c}};e.AnimationCurve.prototype.atX=function(e,t,n,r,i){a=t.x-n.x*3+r.x*3-i.x;b=n.x*3-r.x*6+i.x*3;c=r.x*3-i.x*3;d=i.x-e;return this.getBezier(this.Quad3Solve(a,b,c,d),t,n,r,i)}})(GLGE);(function(e){e.AnimationVector=function(t){this.curves={};e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.AnimationVector);e.augment(e.JSONLoader,e.AnimationVector);e.AnimationVector.prototype.curves={};e.AnimationVector.prototype.frames=250;e.AnimationVector.prototype.startFrame=0;e.AnimationVector.prototype.addAnimationCurve=function(e){this.curves[e.channel]=e;return this};e.AnimationVector.prototype.removeAnimationCurve=function(e){delete this.curves[e]};e.AnimationVector.prototype.setFrames=function(e){this.frames=e;return this};e.AnimationVector.prototype.getFrames=function(){return this.frames};e.AnimationVector.prototype.setStartFrame=function(e){this.startFrame=e;return this};e.AnimationVector.prototype.getStartFrame=function(){return this.startFrame}})(GLGE);(function(e){e.BezTriple=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.BezTriple);e.augment(e.JSONLoader,e.BezTriple);e.BezTriple.prototype.className="BezTriple";e.BezTriple.prototype.setX1=function(e){this.x1=parseFloat(e);return this};e.BezTriple.prototype.setY1=function(e){this.y1=parseFloat(e);return this};e.BezTriple.prototype.setX2=function(e){this.x=parseFloat(e);return this};e.BezTriple.prototype.setY2=function(e){this.y=parseFloat(e);return this};e.BezTriple.prototype.setX3=function(e){this.x3=parseFloat(e);return this};e.BezTriple.prototype.setY3=function(e){this.y3=parseFloat(e);return this};e.LinearPoint=function(e){};e.augment(e.QuickNotation,e.LinearPoint);e.augment(e.JSONLoader,e.LinearPoint);e.LinearPoint.prototype.className="LinearPoint";e.LinearPoint.prototype.x=0;e.LinearPoint.prototype.y=0;e.LinearPoint.prototype.setX=function(e){this.x=parseFloat(e);return this};e.LinearPoint.prototype.setY=function(e){this.y=parseFloat(e);return this};e.StepPoint=function(e,t){this.x=parseFloat(e);this.y=t}})(GLGE);(function(e){e.Mesh=function(t,n){this.GLbuffers=[];this.buffers=[];this.framePositions=[];this.frameNormals=[];this.frameTangents=[];this.UV=[];this.boneWeights=[];this.setBuffers=[];this.faces={};if(n!==undefined)this.windingOrder=n;else this.windingOrder=e.Mesh.WINDING_ORDER_UNKNOWN;e.Assets.registerAsset(this,t)};e.Mesh.WINDING_ORDER_UNKNOWN=2;e.Mesh.WINDING_ORDER_CLOCKWISE=1;e.Mesh.WINDING_ORDER_COUNTER=0;e.augment(e.QuickNotation,e.Mesh);e.augment(e.JSONLoader,e.Mesh);e.augment(e.Events,e.Mesh);e.Mesh.prototype.gl=null;e.Mesh.prototype.className="Mesh";e.Mesh.prototype.GLbuffers=null;e.Mesh.prototype.buffers=null;e.Mesh.prototype.setBuffers=null;e.Mesh.prototype.GLfaces=null;e.Mesh.prototype.faces=null;e.Mesh.prototype.UV=null;e.Mesh.prototype.joints=null;e.Mesh.prototype.invBind=null;e.Mesh.prototype.loaded=false;e.Mesh.prototype.getBoundingVolume=function(){if(!this.positions)return new e.BoundingVolume(0,0,0,0,0,0);if(!this.boundingVolume){var t,n,r,i,s,o;var u=this.positions;for(var a=0;a<u.length;a=a+3){if(a==0){t=n=u[a];r=i=u[a+1];s=o=u[a+2]}else{t=Math.min(t,u[a]);n=Math.max(n,u[a]);r=Math.min(r,u[a+1]);i=Math.max(i,u[a+1]);s=Math.min(s,u[a+2]);o=Math.max(o,u[a+2])}}this.boundingVolume=new e.BoundingVolume(t,n,r,i,s,o)}return this.boundingVolume};e.Mesh.prototype.setJoints=function(e){this.joints=e;this.fireEvent("shaderupdate",{});return this};e.Mesh.prototype.setInvBindMatrix=function(e){this.invBind=e;this.fireEvent("shaderupdate",{});return this};e.Mesh.prototype.setVertexJoints=function(e,t){if(!t){t=e.length*3/this.positions.length}if(t<5){this.setBuffer("joints1",e,t)}else{var n=[];var r=[];for(var i=0;i<e.length;i++){if(i%t<4){n.push(e[i])}else{r.push(e[i])}}this.setBuffer("joints1",n,4);this.setBuffer("joints2",r,t-4)}this.fireEvent("shaderupdate",{});return this};e.Mesh.prototype.setVertexWeights=function(e,t){if(!t){t=e.length*3/this.positions.length}for(var n=0;n<e.length;n=n+parseInt(t)){var r=0;for(var i=0;i<t;i++){r+=parseFloat(e[n+i])}if(r==0)r=1;for(var i=0;i<t;i++){e[n+i]=e[n+i]/r}}if(t<4){this.setBuffer("weights1",e,t)}else{var s=[];var o=[];for(var n=0;n<e.length;n++){if(n%t<4){s.push(e[n])}else{o.push(e[n])}}this.setBuffer("weights1",s,4);this.setBuffer("weights2",o,t-4)}this.fireEvent("shaderupdate",{});return this};e.Mesh.prototype.clearBuffers=function(){this.GLFaces=null;delete this.GLFaces;for(var e in this.buffers){this.buffers[e]=null;delete this.buffers[e]}this.buffers=[];this.loaded=false};e.Mesh.prototype.setUV=function(e){this.uv1set=e;var t=0;for(var n=0;n<e.length;n=n+2){this.UV[t]=e[n];this.UV[t+1]=e[n+1];if(!this.UV[t+2])this.UV[t+2]=e[n];if(!this.UV[t+3])this.UV[t+3]=e[n+1];t=t+4}this.setBuffer("UV",this.UV,4);return this};e.Mesh.prototype.setUV2=function(e){this.uv2set=e;var t=0;for(var n=0;n<e.length;n=n+2){if(!this.UV[t])this.UV[t]=e[n];if(!this.UV[t+1])this.UV[t+1]=e[n+1];this.UV[t+2]=e[n];this.UV[t+3]=e[n+1];t=t+4}this.setBuffer("UV",this.UV,4);return this};e.Mesh.prototype.setPositions=function(e,t){if(!t)t=0;this.loaded=true;if(t==0)this.positions=e;this.framePositions[t]=e;this.setBuffer("position"+t,e,3,true);this.boundingVolume=null;this.fireEvent("updatebound");return this};e.Mesh.prototype.setVertexColors=function(e){this.colors=e;this.setBuffer("color",e,4);return this};e.Mesh.prototype.setNormals=function(e,t){if(!t)t=0;if(t==0)this.normals=e;this.frameNormals[t]=e;this.setBuffer("normal"+t,e,3,true);return this};e.Mesh.prototype.setTangents=function(e,t){if(!t)t=0;if(t==0)this.tangents=e;this.frameTangents[t]=e;this.setBuffer("tangent"+t,e,3,true);return this};e.Mesh.prototype.setBuffer=function(e,t,n,r){if(typeof t[0]!="number")for(var i=0;i<t.length;i++)t[i]=parseFloat(t[i]);var s;for(var i=0;i<this.buffers.length;i++){if(this.buffers[i].name==e)s=i}if(!s){this.buffers.push({name:e,data:t,size:n,GL:false,exclude:r})}else{this.buffers[s]={name:e,data:t,size:n,GL:false,exclude:r}}return this};e.Mesh.prototype.tangentFromUV=function(t,n,r,i,s,o,u){var a=e.toUnitVec3;var f=e.subVec3;var l=e.scaleVec3;var c=e.dotVec3;var h=e.crossVec3;uv21=[s[0]-i[0],s[1]-i[1]];uv31=[o[0]-i[0],o[1]-i[1]];p21=e.subVec3(n,t);p31=e.subVec3(r,t);var p=uv21[0]*uv31[1]-uv31[0]*uv21[1];if(p!=0){p=1/p;var d=f(l(p21,uv31[1]*p),l(p31,uv21[1]*p));var v=f(l(p31,uv21[0]*p),l(p21,uv31[0]*p))}else{d=[0,0,0];v=[0,0,0]}if(e.dotVec3(e.crossVec3(p21,p31),u)>0){d=l(d,-1);v=l(v,-1)}return[d,v]};e.Mesh.prototype.setFaces=function(e){this.faces={data:e,GL:false};if(!this.normals)this.calcNormals();if(!this.tangents&&this.UV.length>0)this.calcTangents();return this};e.Mesh.prototype.calcTangents=function(){for(var t=0;t<this.framePositions.length;t++){var n=this.framePositions[t];var r=this.frameNormals[t];var i=this.UV;var s=[];var o={};var u;for(var a=0;a<n.length;a++){s[a]=0}for(var a=0;a<this.faces.data.length;a=a+3){var f=parseInt(this.faces.data[a]);var l=parseInt(this.faces.data[a+1]);var c=parseInt(this.faces.data[a+2]);var h=[n[f*3],n[f*3+1],n[f*3+2]];var p=[n[l*3],n[l*3+1],n[l*3+2]];var d=[n[c*3],n[c*3+1],n[c*3+2]];var v=[r[f*3],r[f*3+1],r[f*3+2]];var m=[r[l*3],r[l*3+1],r[l*3+2]];var g=[r[c*3],r[c*3+1],r[c*3+2]];var y=[i[f*4],i[f*4+1]];var b=[i[l*4],i[l*4+1]];var w=[i[c*4],i[c*4+1]];var E=this.tangentFromUV(p,h,d,b,y,w,m);var S=[h[0],h[1],h[2],y[0],y[1],v[0],v[1],v[2]].join(",");if(!o[S]){o[S]=E}else{o[S][0][0]+=E[0][0];o[S][0][1]+=E[0][1];o[S][0][2]+=E[0][2];o[S][1][0]+=E[1][0];o[S][1][1]+=E[1][1];o[S][1][2]+=E[1][2]}S=[p[0],p[1],p[2],b[0],b[1],m[0],m[1],m[2]].join(",");if(!o[S]){o[S]=E}else{o[S][0][0]+=E[0][0];o[S][0][1]+=E[0][1];o[S][0][2]+=E[0][2];o[S][1][0]+=E[1][0];o[S][1][1]+=E[1][1];o[S][1][2]+=E[1][2]}S=[d[0],d[1],d[2],w[0],w[1],g[0],g[1],g[2]].join(",");if(!o[S]){o[S]=E}else{o[S][0][0]+=E[0][0];o[S][0][1]+=E[0][1];o[S][0][2]+=E[0][2];o[S][1][0]+=E[1][0];o[S][1][1]+=E[1][1];o[S][1][2]+=E[1][2]}}for(var a=0;a<n.length/3;a++){var h=[n[a*3],n[a*3+1],n[a*3+2]];var v=[r[a*3],r[a*3+1],r[a*3+2]];var y=[i[a*4],i[a*4+1]];try{var x=e.toUnitVec3(o[[h[0],h[1],h[2],y[0],y[1],v[0],v[1],v[2]].join(",")][0]);var T=e.toUnitVec3(o[[h[0],h[1],h[2],y[0],y[1],v[0],v[1],v[2]].join(",")][1])}catch(N){}if(x){s[a*3]=x[0];s[a*3+1]=x[1];s[a*3+2]=x[2]}}this.setTangents(s,t)}};e.Mesh.prototype.GLSetFaceBuffer=function(e){if(!this.GLfaces)this.GLfaces=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.GLfaces);e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces.data),e.STATIC_DRAW);this.GLfaces.itemSize=1;this.GLfaces.numItems=this.faces.data.length};e.Mesh.prototype.GLSetBuffer=function(e,t,n,r){if(!this.GLbuffers[t])this.GLbuffers[t]=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.GLbuffers[t]);if(!n.byteLength)n=new Float32Array(n);e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW);this.GLbuffers[t].itemSize=r;this.GLbuffers[t].numItems=n.length/r};e.Mesh.prototype.calcNormals=function(){for(var t=0;t<this.framePositions.length;t++){var n=[];var r=this.framePositions[t];var i=this.faces.data;if(!i){i=[];for(var s=0;s<r.length/3;s++)i[s]=s}for(var s=0;s<i.length;s=s+3){var o=[r[i[s]*3],r[i[s]*3+1],r[i[s]*3+2]];var u=[r[i[s+1]*3],r[i[s+1]*3+1],r[i[s+1]*3+2]];var a=[r[i[s+2]*3],r[i[s+2]*3+1],r[i[s+2]*3+2]];var f=e.subVec3(u,o);var l=e.subVec3(a,o);var c=e.toUnitVec3(e.crossVec3(f,l));if(n[i[s]]==undefined)n[i[s]]=[];n[i[s]].push(c);if(n[i[s+1]]==undefined)n[i[s+1]]=[];n[i[s+1]].push(c);if(n[i[s+2]]==undefined)n[i[s+2]]=[];n[i[s+2]].push(c)}var h=[];for(s=0;s<n.length;s++){var p=0,d=0,v=0;if(n[s]!=undefined){for(var m=0;m<n[s].length;m++){p+=n[s][m][0];d+=n[s][m][1];v+=n[s][m][2]}p/=n[s].length;d/=n[s].length;v/=n[s].length;h[s*3]=p;h[s*3+1]=d;h[s*3+2]=v}}this.setNormals(h,t)}};e.Mesh.prototype.calcFauxAO=function(){this.optimize();var t=this.positions;var n=this.faces.data;var r=this.normals;var i=[];var s=t.length/3;for(var o=0;o<s;o++){i.push([])}for(var o=0;o<n.length;o=o+3){i[n[o]].push(n[o+1]);i[n[o]].push(n[o+2]);i[n[o+1]].push(n[o]);i[n[o+1]].push(n[o+2]);i[n[o+2]].push(n[o]);i[n[o+2]].push(n[o+1])}var u=[];for(var o=0;o<s;o++){var a=0;var f=[r[o*3],r[o*3+1],r[o*3+2]];for(var l=0;l<i[o].length;l++){var c=i[o][l];var h=[t[c*3]-t[o*3],t[c*3+1]-t[o*3+1],t[c*3+2]-t[o*3+2]];h=e.toUnitVec3(h);a+=h[0]*f[0]+h[1]*f[1]+h[2]*f[2]}a/=i[o].length;a=1-(a+1)*.5;u.push(a);u.push(a);u.push(a);u.push(1)}this.setVertexColors(u)};e.Mesh.prototype.optimize=function(){var e=this.positions;var t=this.normals;var n=this.faces.data;var r=this.tangents;var i=this.uv1set;var s=this.uv2set;var o=[];var u=[];var a=[];var f=[];var l=[];if(n){for(var c=0;c<n.length;c++){o.push(e[n[c]*3]);o.push(e[n[c]*3+1]);o.push(e[n[c]*3+2]);u.push(t[n[c]*3]);u.push(t[n[c]*3+1]);u.push(t[n[c]*3+2]);if(r&&r.length>0){l.push(r[n[c]*3]);l.push(r[n[c]*3+1]);l.push(r[n[c]*3+2])}if(i){a.push(i[n[c]*2]);a.push(i[n[c]*2+1])}if(s){f.push(s[n[c]*2]);f.push(s[n[c]*2+1])}}}else{o=e;u=t;l=r;a=i;f=s}var h=[];var p=[];var d=[];var v=[];var m=[];var g=[];var y=[];for(var c=0;c<o.length;c=c+3){if(i&&s){var b=[o[c],o[c+1],o[c+2],u[c],u[c+1],u[c+2],a[c/3*2],a[c/3*2+1]].join(" ")}else if(i){var b=[o[c],o[c+1],o[c+2],u[c],u[c+1],u[c+2],a[c/3*2],a[c/3*2+1]].join(" ")}else{var b=[o[c],o[c+1],o[c+2],u[c],u[c+1],u[c+2]].join(" ")}var w=y.indexOf(b);if(w<0){y.push(b);w=y.length-1;h.push(o[c]);h.push(o[c+1]);h.push(o[c+2]);p.push(u[c]);p.push(u[c+1]);p.push(u[c+2]);if(r&&r.length>0){g.push(l[c]);g.push(l[c+1]);g.push(l[c+2])}if(i){v.push(a[c/3*2]);v.push(a[c/3*2+1])}if(s){m.push(f[c/3*2]);m.push(f[c/3*2+1])}}d.push(w)}this.setPositions(h).setNormals(p).setFaces(d).setUV(v).setUV2(m).setTangents(g)};e.Mesh.prototype.GLAttributes=function(t,n,r,i){this.gl=t;if(!r)r=0;if(!this.normals)this.calcNormals();for(var s=0;s<8;s++)t.disableVertexAttribArray(s);if(!this.faces.GL&&this.faces.data&&this.faces.data.length>0){this.GLSetFaceBuffer(t);this.faces.GL=true}for(s=0;s<this.buffers.length;s++){if(!this.buffers[s].GL){this.GLSetBuffer(t,this.buffers[s].name,this.buffers[s].data,this.buffers[s].size);this.buffers[s].GL=true}attribslot=e.getAttribLocation(t,n,this.buffers[s].name);if(attribslot>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers[this.buffers[s].name]);t.enableVertexAttribArray(attribslot);t.vertexAttribPointer(attribslot,this.GLbuffers[this.buffers[s].name].itemSize,t.FLOAT,false,0,0)}}var o=e.getAttribLocation(t,n,"position");if(o>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["position"+r]);t.enableVertexAttribArray(o);t.vertexAttribPointer(o,this.GLbuffers["position"+r].itemSize,t.FLOAT,false,0,0)}var u=e.getAttribLocation(t,n,"normal");if(u>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["normal"+r]);t.enableVertexAttribArray(u);t.vertexAttribPointer(u,this.GLbuffers["normal"+r].itemSize,t.FLOAT,false,0,0)}var a=e.getAttribLocation(t,n,"tangent");if(a>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["tangent"+r]);t.enableVertexAttribArray(a);t.vertexAttribPointer(a,this.GLbuffers["tangent"+r].itemSize,t.FLOAT,false,0,0)}if(i!=undefined){var f=e.getAttribLocation(t,n,"position2");if(f>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["position"+i]);t.enableVertexAttribArray(f);t.vertexAttribPointer(f,this.GLbuffers["position"+i].itemSize,t.FLOAT,false,0,0)}var l=e.getAttribLocation(t,n,"normal2");if(l>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["normal"+i]);t.enableVertexAttribArray(l);t.vertexAttribPointer(l,this.GLbuffers["normal"+i].itemSize,t.FLOAT,false,0,0)}var c=e.getAttribLocation(t,n,"tangent2");if(c>-1){t.bindBuffer(t.ARRAY_BUFFER,this.GLbuffers["tangent"+i]);t.enableVertexAttribArray(c);t.vertexAttribPointer(c,this.GLbuffers["tangent"+i].itemSize,t.FLOAT,false,0,0)}}}})(GLGE);(function(e){e.Sphere=function(t){this.vertical=10;this.horizontal=10;this.radius=1;this.dirtySphere=false;e.Mesh.apply(this,arguments);this.generateMeshData()};e.augment(e.Mesh,e.Sphere);e.Sphere.prototype.generateMeshData=function(){var t=this.vertical;var n=this.horizontal;var r=this.radius;var i,s,o,u,a,f,s,l;var c=[];var h=[];var p=[];for(u=0;u<=t;u++){i=u/t*Math.PI;s=Math.cos(i)*r;o=Math.sin(i)*r;for(a=0;a<n;a++){l=a/n*2*Math.PI;f=Math.sin(l)*o;z=Math.cos(l)*o;c.push(f,s,z);var d=e.toUnitVec3([f,s,z]);if(this.insideNormals){h.push(-d[0],-d[1],-d[2])}else{h.push(d[0],d[1],d[2])}}if(u>0){for(a=0;a<n;a++){var v=u*n+a;var m=(u-1)*n+a;var g=u*n+(a+1)%n;var y=(u-1)*n+(a+1)%n;p.push(v,g,y,v,y,m)}}}this.setPositions(c);this.setNormals(h);this.setFaces(p);this.dirtySphere=false};e.Sphere.prototype.setInsideNormals=function(e){this.insideNormals=e;this.dirtySphere=true;return this};e.Sphere.prototype.getInsideNormals=function(){return this.insideNormals};e.Sphere.prototype.setRadius=function(e){this.radius=e;this.dirtySphere=true;return this};e.Sphere.prototype.getRadius=function(){return this.radius};e.Sphere.prototype.setVertical=function(e){this.vertical=e;this.dirtySphere=true;return this};e.Sphere.prototype.getRadius=function(){return this.vertical};e.Sphere.prototype.setHorizontal=function(e){this.horizontal=e;this.dirtySphere=true;return this};e.Sphere.prototype.getRadius=function(){return this.horizontal};e.Sphere.prototype.GLAttributes=function(){if(this.dirtySphere)this.generateMeshData();e.Mesh.prototype.GLAttributes.apply(this,arguments)}})(GLGE);(function(e){var t=0;e.Material=function(n){this.layers=[];this.layerlisteners=[];this.textures=[];this.lights=[];this.color={r:1,g:1,b:1,a:1};this.specColor={r:1,g:1,b:1};this.reflect=.8;this.shine=10;this.specular=1;this.emit={r:0,g:0,b:0};this.alpha=1;this.translucency=0;this.materialIdx=t++;e.Assets.registerAsset(this,n)};e.augment(e.Animatable,e.Material);e.augment(e.QuickNotation,e.Material);e.augment(e.JSONLoader,e.Material);e.augment(e.Events,e.Material);e.M_COLOR=1;e.M_NOR=2;e.M_ALPHA=4;e.M_SPECCOLOR=8;e.M_SPECULAR=16;e.M_SHINE=32;e.M_REFLECT=64;e.M_EMIT=128;e.M_ALPHA=256;e.M_MSKR=512;e.M_MSKG=1024;e.M_MSKB=2048;e.M_MSKA=4096;e.M_HEIGHT=8192;e.M_AMBIENT=16384;e.M_STEEP=32768;e.UV1=0;e.UV2=1;e.MAP_NORM=3;e.MAP_OBJ=4;e.MAP_REF=5;e.MAP_ENV=6;e.MAP_VIEW=7;e.MAP_POINT=8;e.MAP_GLOBAL=9;e.BL_MIX=0;e.BL_MUL=1;e.VC_NONE=0;e.VC_BASE=1;e.VC_MUL=2;e.VC_AMB=3;e.VC_AMBMUL=4;e.Material.prototype.layers=null;e.Material.prototype.className="Material";e.Material.prototype.textures=null;e.Material.prototype.color=null;e.Material.prototype.specColor=null;e.Material.prototype.specular=null;e.Material.prototype.emit={r:0,g:0,b:0};e.Material.prototype.shine=null;e.Material.prototype.reflect=null;e.Material.prototype.lights=null;e.Material.prototype.alpha=null;e.Material.prototype.ambient={r:0,g:0,b:0};e.Material.prototype.shadow=true;e.Material.prototype.shadeless=false;e.Material.prototype.downloadComplete=false;e.Material.prototype.fadeDistance=0;e.Material.prototype.vertexColorMode=e.VC_BASE;e.Material.prototype.setFadeDistance=function(e){this.fadeDistance=parseFloat(e);this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getFadeDistance=function(e){return this.fadeDistance};e.Material.prototype.setVertexColorMode=function(e){this.vertexColorMode=e;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getVertexColorMode=function(e){return this.vertexColorMode};e.Material.prototype.setFallback=function(e){this.fallback=e;return this};e.Material.prototype.getFallback=function(e){return this.fallback};e.Material.prototype.setShadeless=function(e){this.shadeless=e;return this};e.Material.prototype.getShadeless=function(e){return this.shadeless};e.Material.prototype.setShadow=function(e){this.shadow=e;return this};e.Material.prototype.getShadow=function(e){return this.shadow};e.Material.prototype.setColor=function(t){if(t.r==undefined){t=e.colorParse(t)}this.color={r:t.r,g:t.g,b:t.b};return this};e.Material.prototype.setColorR=function(e){this.color={r:e,g:this.color.g,b:this.color.b,a:this.color.a};return this};e.Material.prototype.setColorG=function(e){this.color={r:this.color.r,g:e,b:this.color.b,a:this.color.a};return this};e.Material.prototype.setColorB=function(e){this.color={r:this.color.r,g:this.color.g,b:e,a:this.color.a};return this};e.Material.prototype.getColorR=function(e){return this.color.r};e.Material.prototype.getColorG=function(e){return this.color.g};e.Material.prototype.getColorB=function(e){return this.color.b};e.Material.prototype.getColor=function(){return this.color};e.Material.prototype.setSpecularColor=function(t){if(t.r==undefined){t=e.colorParse(t)}this.specColor={r:parseFloat(t.r),g:parseFloat(t.g),b:parseFloat(t.b)};this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getAmbient=function(){return this.ambient};e.Material.prototype.setAmbient=function(t){if(!t.r){t=e.colorParse(t)}this.ambient={r:parseFloat(t.r),g:parseFloat(t.g),b:parseFloat(t.b)};this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getSpecularColor=function(){return this.specColor};e.Material.prototype.setTranslucency=function(e){this.translucency=parseFloat(e);this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getTranslucency=function(){return this.translucency};e.Material.prototype.setAlpha=function(e){this.alpha=e;return this};e.Material.prototype.getAlpha=function(){return this.alpha};e.Material.prototype.setSpecular=function(e){this.specular=e;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getSpecular=function(){return this.specular};e.Material.prototype.setShininess=function(e){if(e<=0)e=.001;this.shine=e;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getShininess=function(){return this.shine};e.Material.prototype.setEmit=function(t){if(t>0)t={r:t,g:t,b:t};if(!t.r){t=e.colorParse(t)}this.emit={r:parseFloat(t.r),g:parseFloat(t.g),b:parseFloat(t.b)};this.fireEvent("shaderupdate",{});return this};e.Material.prototype.setEmitR=function(e){this.emit.r=parseFloat(e);return this};e.Material.prototype.setEmitG=function(e){this.emit.g=parseFloat(e);return this};e.Material.prototype.setEmitB=function(e){this.emit.b=parseFloat(e);return this};e.Material.prototype.getEmitR=function(e){return this.emit.r};e.Material.prototype.getEmitG=function(e){return this.emit.g};e.Material.prototype.getEmitB=function(e){return this.emit.b};e.Material.prototype.getEmit=function(){return this.emit};e.Material.prototype.setReflectivity=function(e){this.reflect=e;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getReflectivity=function(){return this.reflect};e.Material.prototype.setBinaryAlpha=function(e){this.binaryAlpha=e;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.getBinaryAlpha=function(){return this.binaryAlpha};e.Material.prototype.addMaterialLayer=function(t){if(typeof t=="string")t=e.Assets.get(t);this.layers.push(t);var n=this;var r=function(e){n.fireEvent("shaderupdate",{})};this.layerlisteners.push(r);t.addEventListener("shaderupdate",r);this.fireEvent("shaderupdate",{});return this};e.Material.prototype.removeMaterialLayer=function(e){var t=this.layers.indexOf(e);if(t>=0){this.layers.splice(t,1);e.removeEventListener("shaderupdate",this.layerlisteners[t]);this.layerlisteners.splice(t,1);this.fireEvent("shaderupdate",{})}return this};e.Material.prototype.getLayers=function(){return this.layers};e.Material.prototype.getLayerCoords=function(t){var n=[];n.push("vec4 texturePos;\n");for(var r=0;r<this.layers.length;r++){n.push("textureCoords"+r+"=vec3(0.0,0.0,0.0);\n");if(this.layers[r].mapinput==e.UV1||this.layers[r].mapinput==e.UV2){n.push("texturePos=vec4(vec2(UVCoord["+this.layers[r].mapinput*2+"],(1.0-UVCoord["+(this.layers[r].mapinput*2+1)+"])),1.0,1.0);\n")}if(this.layers[r].mapinput==e.MAP_NORM){n.push("texturePos=vec4(normalize(n.xyz),1.0);\n")}if(this.layers[r].mapinput==e.MAP_OBJ){n.push("texturePos=vec4(normalize(OBJCoord.xyz),1.0);\n")}if(this.layers[r].mapinput==e.MAP_GLOBAL){n.push("texturePos=vec4(OBJCoord.xyz,1.0);\n")}if(this.layers[r].mapinput==e.MAP_REF){n.push("texturePos=vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n")}if(this.layers[r].mapinput==e.MAP_ENV){n.push("texturePos=envMat * vec4(reflect(normalize(eyevec.xyz),normalize(n.xyz)),1.0);\n")}n.push("textureCoords"+r+"=(layer"+r+"Matrix * texturePos).xyz;\n");if(t&&~t.indexOf("GLGE_Texcoord")){n.push("textureCoords"+r+"=GLGE_Texcoord("+r+",textureCoords"+r+");\n")}}return n.join("")};e.Material.prototype.getVertexVarying=function(){var e=[];for(var t=0;t<this.layers.length;t++){e.push("uniform mat4 layer"+t+"Matrix;\n");e.push("varying vec3 textureCoords"+t+";\n")}return e.join("")};e.Material.prototype.registerPasses=function(e,t){for(var n=0;n<this.textures.length;n++){if(this.textures[n].registerPasses)this.textures[n].registerPasses(e,t)}};e.Material.prototype.getFragmentShader=function(t,n,r,i){var s="#ifdef GL_ES\nprecision highp float;\n#endif\n#define GLGE_FRAGMENT\n";if(i){s=s+"uniform float distance;\n";s=s+"uniform bool shadowtype;\n"}if(r)s+=r;var o=false;for(var u=0;u<t.length;u++){if(t[u].type==e.L_POINT||t[u].type==e.L_SPOT||t[u].type==e.L_DIR){s=s+"varying vec3 lightvec"+u+";\n";s=s+"varying float lightdist"+u+";\n"}}s=s+"varying vec3 n;\n";s=s+"varying vec3 t;\n";s=s+"varying vec4 UVCoord;\n";s=s+"varying vec3 eyevec;\n";s=s+"varying vec3 OBJCoord;\n";if(n)s=s+"varying vec4 vcolor;\n";for(var u=0;u<this.textures.length;u++){if(this.textures[u].className=="Texture")s=s+"uniform sampler2D TEXTURE"+u+";\n";if(this.textures[u].className=="TextureCanvas")s=s+"uniform sampler2D TEXTURE"+u+";\n";if(this.textures[u].className=="TextureCanvasCube")s=s+"uniform samplerCube TEXTURE"+u+";\n";if(this.textures[u].className=="TextureVideo")s=s+"uniform sampler2D TEXTURE"+u+";\n";if(this.textures[u].className=="TextureCube")s=s+"uniform samplerCube TEXTURE"+u+";\n"}var a=1;var f=[];var l;for(var u=0;u<t.length;u++){if(t[u].type==e.L_OFF)continue;s=s+"uniform vec3 lightcolor"+u+";\n";s=s+"uniform vec3 lightAttenuation"+u+";\n";s=s+"uniform float spotCosCutOff"+u+";\n";s=s+"uniform float spotExp"+u+";\n";s=s+"uniform mediump vec3 lightdir"+u+";\n";s=s+"uniform mediump mat4 lightmat"+u+";\n";s=s+"uniform float shadowbias"+u+";\n";s=s+"uniform int shadowsamples"+u+";\n";s=s+"uniform float shadowsoftness"+u+";\n";s=s+"uniform bool castshadows"+u+";\n";s=s+"uniform vec2 shadowoffset"+u+";\n";if(t[u].getCastShadows()&&this.shadow){s=s+"varying vec4 spotcoord"+u+";\n";l=this.textures.length+a++;s=s+"uniform sampler2D TEXTURE"+l+";\n";f[u]=l}}for(u=0;u<this.layers.length;u++){s=s+"varying vec3 textureCoords"+u+";\n";s=s+"uniform float layeralpha"+u+";\n";if(this.layers[u].mapinput==e.MAP_VIEW){s=s+"uniform mat4 layer"+u+"Matrix;\n"}if((this.layers[u].mapto&e.M_HEIGHT)==e.M_HEIGHT||(this.layers[u].mapto&e.M_STEEP)==e.M_STEEP){s=s+"uniform float layerheight"+u+";\n"}}s=s+"uniform sampler2D sky;\n";s=s+"uniform vec4 baseColor;\n";s=s+"uniform vec3 specColor;\n";s=s+"uniform float shine;\n";s=s+"uniform float specular;\n";s=s+"uniform float reflective;\n";s=s+"uniform vec3 emit;\n";s=s+"uniform float alpha;\n";s=s+"uniform vec3 amb;\n";s=s+"uniform float fognear;\n";s=s+"uniform float fogfar;\n";s=s+"uniform int fogtype;\n";s=s+"uniform vec3 fogcolor;\n";s=s+"uniform float far;\n";s=s+"uniform mediump mat4 worldInverseTranspose;\n";s=s+"uniform mediump mat4 projection;\n";s=s+"uniform bool emitpass;\n";s=s+"uniform bool shadeless;\n";s=s+"void main(void)\n";s=s+"{\n";s=s+"float att;\n";s=s+"int texture;\n";s=s+"float mask=1.0;\n";s=s+"float spec=specular;\n";s=s+"vec3 specC=specColor;\n";s=s+"vec4 view;\n";s=s+"vec3 textureCoords=vec3(0.0,0.0,0.0);\n";s=s+"float ref=reflective;\n";s=s+"float sh=shine;\n";s=s+"vec3 em=emit;\n";s=s+"float al=alpha;\n";s=s+"vec3 amblight=vec3(1.0,1.0,1.0);\n";s=s+"vec4 normalmap= vec4(n,0.0);\n";if(n&&this.vertexColorMode==e.VC_BASE){s=s+"vec4 color= vcolor;";s=s+"al = vcolor.a;"}else{s=s+"vec4 color = baseColor;"}s=s+"float pheight=0.0;\n";s=s+"vec3 textureHeight=vec3(0.0,0.0,0.0);\n";s=s+"vec3 normal = normalize(n);\n";s=s+"vec3 b = vec3(0.0,0.0,0.0);\n";var c=0;var h=false;for(u=0;u<this.layers.length;u++){s=s+"textureCoords=textureCoords"+u+"+textureHeight;\n";s=s+"mask=layeralpha"+u+"*mask;\n";if(this.layers[u].mapinput==e.MAP_VIEW){s=s+"view=projection * vec4(-eyevec,1.0);\n";s=s+"textureCoords=view.xyz/view.w*0.5+0.5;\n";s=s+"textureCoords=(layer"+u+"Matrix*vec4(textureCoords,1.0)).xyz+textureHeight;\n"}if(this.layers[u].mapinput==e.MAP_POINT){s=s+"textureCoords=vec3(gl_PointCoord,1.0);\n"}if(this.layers[u].getTexture().className=="Texture"||this.layers[u].getTexture().className=="TextureCanvas"||this.layers[u].getTexture().className=="TextureVideo"){var p="xy";var d="2D"}else{var p="xyz";var d="Cube"}if((this.layers[u].mapto&e.M_COLOR)==e.M_COLOR){c=u;if(this.layers[u].blendMode==e.BL_MUL){s=s+"color = color*(1.0-mask) + color*texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+")*mask;\n"}else{s=s+"color = color*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+")*mask;\n"}}if((this.layers[u].mapto&e.M_HEIGHT)==e.M_HEIGHT){s=s+"pheight = texture2D(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").x;\n";s=s+"textureHeight =vec3((layerheight"+u+"* (pheight-0.5)  * normalize(eyevec).xy*vec2(1.0,-1.0)),0.0);\n"}if((this.layers[u].mapto&e.M_STEEP)==e.M_STEEP){s=s+"b=normalize(cross(t.xyz,n));\n";s=s+"vec3 neye=normalize(eyevec.xyz);";s=s+"neye = vec3(dot(neye,t),dot(neye,b),dot(neye,n));";s=s+"neye = normalize(neye);";s=s+"float stepheight"+u+"=layerheight"+u+";";s=s+"float steepstep"+u+"=(1.0/8.0)*stepheight"+u+"/neye.z;";s=s+"float steepdisplace"+u+"=0.0;";s=s+"for(int steepcount"+u+"=0;steepcount"+u+"<8;steepcount"+u+"++){";s=s+"pheight = texture2D(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+"+vec2(neye.x,neye.y)*steepdisplace"+u+").x;\n";s=s+"if(pheight*stepheight"+u+">neye.z*steepdisplace"+u+"){";s=s+"textureHeight=vec3(vec2(neye.x,neye.y)*steepdisplace"+u+",0.0);";s=s+"}else{";s=s+"steepdisplace"+u+"-=steepstep"+u+";";s=s+"steepstep"+u+"*=0.5;";s=s+"}";s=s+"steepdisplace"+u+"+=steepstep"+u+";";s=s+"}"}if((this.layers[u].mapto&e.M_SPECCOLOR)==e.M_SPECCOLOR){s=s+"specC = specC*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").rgb*mask;\n"}if((this.layers[u].mapto&e.M_MSKR)==e.M_MSKR){s=s+"mask = texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").r;\n"}if((this.layers[u].mapto&e.M_MSKG)==e.M_MSKG){s=s+"mask = texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").g;\n"}if((this.layers[u].mapto&e.M_MSKB)==e.M_MSKB){s=s+"mask = texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").b;\n"}if((this.layers[u].mapto&e.M_MSKA)==e.M_MSKA){s=s+"mask = texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").a;\n"}if((this.layers[u].mapto&e.M_SPECULAR)==e.M_SPECULAR){s=s+"spec = spec*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").r*mask;\n"}if((this.layers[u].mapto&e.M_REFLECT)==e.M_REFLECT){s=s+"ref = ref*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").g*mask;\n"}if((this.layers[u].mapto&e.M_SHINE)==e.M_SHINE){s=s+"sh = sh*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").b*mask*255.0;\n"}if((this.layers[u].mapto&e.M_EMIT)==e.M_EMIT){s=s+"em = em*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").rgb*mask;\n"}if((this.layers[u].mapto&e.M_NOR)==e.M_NOR){s=s+"normalmap = normalmap*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+")*mask;\n";s=s+"normal = normalmap.rgb;\n";s=s+"normal = 2.0*(vec3(normal.r, -normal.g, normal.b) - vec3(0.5, -0.5, 0.5));";s=s+"b=normalize(cross(t.xyz,n));\n";s=s+"normal = normal.x*t + normal.y*b + normal.z*n;";s=s+"normal = normalize(normal);"}if((this.layers[u].mapto&e.M_ALPHA)==e.M_ALPHA){h=true;s=s+"al = al*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").a*mask;\n"}if((this.layers[u].mapto&e.M_AMBIENT)==e.M_AMBIENT){s=s+"amblight = amblight*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[u].texture.idx+", textureCoords."+p+").rgb*mask;\n"}}s=s+"amblight *= amb;\n";if(!h&&this.layers.length){if(this.layers[c].getTexture().className=="Texture"||this.layers[c].getTexture().className=="TextureCanvas"||this.layers[c].getTexture().className=="TextureVideo"){var p="xy";var d="2D"}else{var p="xyz";var d="Cube"}s=s+"al = al*(1.0-mask) + texture"+d+"(TEXTURE"+this.layers[c].texture.idx+", textureCoords."+p+").a*al*mask;\n"}if(n&&this.vertexColorMode==e.VC_MUL){s=s+"color *= vcolor;"}if(this.binaryAlpha){s=s+"if(al<0.5) discard;\n";s=s+"al=1.0;\n"}else{s=s+"if(al==0.0) discard;\n"}s=s+"vec3 lightvalue=amblight;\n";if(n&&this.vertexColorMode==e.VC_AMB){s=s+"lightvalue = vcolor.rgb;"}if(n&&this.vertexColorMode==e.VC_AMBMUL){s=s+"lightvalue *= vcolor.rgb;"}s=s+"float dotN,spotEffect;";s=s+"vec3 lightvec=vec3(0.0,0.0,0.0);";s=s+"vec3 viewvec=vec3(0.0,0.0,0.0);";s=s+"vec3 specvalue=vec3(0.0,0.0,0.0);";s=s+"vec2 scoord=vec2(0.0,0.0);";s=s+"float sDepth=0.0;";s=s+"float d1=0.0;";s=s+"float d2=0.0;";s=s+"float spotmul=0.0;";s=s+"float rnd=0.0;";s=s+"float spotsampleX=0.0;";s=s+"float spotsampleY=0.0;";s=s+"float totalweight=0.0;";s=s+"int cnt=0;";s=s+"float specularSmoothStepValue=.125;\n";s=s+"vec2 spotoffset=vec2(0.0,0.0);";s=s+"float dp=0.0;";s=s+"vec4 dist;float depth,m1,m2,prob,variance;\n";s=s+"if (normal.z<0.0) {normal.z=0.0;}\n";s=s+"float fogfact=1.0;";s=s+"if(fogtype=="+e.FOG_QUADRATIC+" || fogtype=="+e.FOG_SKYQUADRATIC+") fogfact=clamp(pow(max((fogfar - length(eyevec)) / (fogfar - fognear),0.0),2.0),0.0,1.0);\n";s=s+"if(fogtype=="+e.FOG_LINEAR+" || fogtype=="+e.FOG_SKYLINEAR+") fogfact=clamp((fogfar - length(eyevec)) / (fogfar - fognear),0.0,1.0);\n";if(!i){s=s+"if (emitpass) {gl_FragColor=vec4(em,1.0);} else if (shadeless) {\n";s=s+"gl_FragColor=vec4(color.rgb,al);\n";if(this.fadeDistance>0){s=s+"gl_FragColor.a=gl_FragColor.a*(1.0-min(1.0,"+this.fadeDistance.toFixed(5)+"/length(eyevec)));\n"}s=s+"} else {\n";for(var u=0;u<t.length;u++){if(t[u].type==e.L_OFF)continue;s=s+"lightvec=lightvec"+u+";\n";s=s+"viewvec=eyevec;\n";if(t[u].type==e.L_POINT){if(this.translucency==0){s=s+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n"}else{s=s+"dotN=dot(normal,normalize(-lightvec));\n";s=s+"if (dotN<0.0) dotN*=-"+this.translucency.toFixed(2)+";\n"}s=s+"att = 1.0 / (lightAttenuation"+u+"[0] + lightAttenuation"+u+"[1] * lightdist"+u+" + lightAttenuation"+u+"[2] * lightdist"+u+" * lightdist"+u+");\n";s=s+"if(dotN>0.0){\n";if(t[u].diffuse){s=s+"lightvalue += att * dotN * lightcolor"+u+";\n"}s=s+"}\n";if(t[u].specular){s=s+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN)*att * specC * lightcolor"+u+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3*sh);\n"}}s=s+"spotEffect = 0.0;\n";if(t[u].type==e.L_SPOT){s=s+"spotEffect = dot(normalize(lightdir"+u+"), normalize(-lightvec"+u+"));";s=s+"if (spotEffect > spotCosCutOff"+u+""+(!this.spotCutOff?" || spotEffect>0.0":"")+") {\n";s=s+"spotEffect = pow(spotEffect, spotExp"+u+");";if(t[u].getCastShadows()&&this.shadow){s=s+"scoord=(((spotcoord"+u+".xy)/spotcoord"+u+".w)+1.0)/2.0;\n";s=s+"if(scoord.x>0.0 && scoord.x<1.0 && scoord.y>0.0 && scoord.y<1.0){\n";s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord);\n";if(t[u].spotSoftness==0){s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0))*"+t[u].distance+".0;\n";s=s+"if(depth<length(lightvec"+u+")) spotmul=1.0; else spotmul=0.0;\n"}else{s=s+"m1 = pow(dot(dist, vec4(0.00390625,1.0,0.0,0.0)),2.0);\n";s=s+"m2 = dot(dist, vec4(0.0,0.0,0.00390625,1.0));\n";s=s+"variance = min(max(m1-m2*m2, 0.0) + 0.000002, 1.0);;\n";s=s+"depth=length(lightvec"+u+")/"+t[u].distance+".0-m2;\n";s=s+"prob=variance /(  variance + depth*depth );\n";s=s+"prob=smoothstep("+t[u].spotSoftnessDistance.toFixed(2)+",1.0,prob);\n";s=s+"if (depth<=0.0) prob=1.0;\n";s=s+"spotmul=1.0-prob;\n"}s=s+"spotEffect=spotEffect*(1.0-spotmul);\n";s=s+"spotEffect="+this.translucency.toFixed(2)+"+"+(1-this.translucency).toFixed(2)+"*spotEffect;\n";s=s+"}\n"}if(this.translucency==0){s=s+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n"}else{s=s+"dotN=dot(normal,normalize(-lightvec));\n";s=s+"if (dotN<0.0) dotN*=-"+this.translucency.toFixed(2)+";\n"}if(t[u].negativeShadow){s=s+"if(dotN>0.0){\n";if(t[u].diffuse){s=s+"lightvalue -= (1.0-spotEffect) / (lightAttenuation"+u+"[0] + lightAttenuation"+u+"[1] * lightdist"+u+" + lightAttenuation"+u+"[2] * lightdist"+u+" * lightdist"+u+");\n"}s=s+"}\n"}else{s=s+"att = spotEffect / (lightAttenuation"+u+"[0] + lightdist"+u+"*(lightAttenuation"+u+"[1]  + lightAttenuation"+u+"[2] * lightdist"+u+"));\n";s=s+"if(dotN>0.0){\n";if(t[u].diffuse){s=s+"lightvalue += att * dotN * lightcolor"+u+";\n"}s=s+"}\n";if(t[u].specular){s=s+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * att * specC * lightcolor"+u+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n"}}s=s+"}\n"}if(t[u].type==e.L_DIR){if(this.translucency==0){s=s+"dotN=max(dot(normal,normalize(-lightvec)),0.0);\n"}else{s=s+"dotN=dot(normal,normalize(-lightvec));\n";s=s+"if (dotN<0.0) dotN*=-"+this.translucency.toFixed(2)+";\n"}if(t[u].getCastShadows()&&this.shadow){s=s+"float shadowfact"+u+" = 0.0;\n";s=s+"scoord=((spotcoord"+u+".xy)/spotcoord"+u+".w+1.0)/2.0;\n";var v=1/t[u].bufferWidth;var m=1/t[u].bufferHeight;s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord );\n";s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));\n";s=s+"d1 = depth;\n";s=s+"d2 = depth*depth;\n";s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord+vec2("+v.toFixed(5)+","+m.toFixed(5)+") );\n";s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));\n";s=s+"d1 += depth;\n";s=s+"d2 += depth*depth;\n";s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord+vec2(-"+v.toFixed(5)+","+m.toFixed(5)+"));\n";s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));\n";s=s+"d1 += depth;\n";s=s+"d2 += depth*depth;\n";s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord+vec2("+v.toFixed(5)+",-"+m.toFixed(5)+"));\n";s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));\n";s=s+"d1 += depth;\n";s=s+"d2 += depth*depth;\n";s=s+"dist=texture2D(TEXTURE"+f[u]+", scoord+vec2(-"+v.toFixed(5)+",-"+m.toFixed(5)+"));\n";s=s+"depth = dot(dist, vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));\n";s=s+"d1 += depth;\n";s=s+"d2 += depth*depth;\n";s=s+"d1 *= 0.2;\n";s=s+"d2 *= 0.2;\n";s=s+"sDepth = max(0.0, ((spotcoord"+u+".z/spotcoord"+u+".w)+1.0)/2.0-d1-"+t[u].shadowBias+");\n";s=s+"variance = min(max(d2-d1*d1, 0.0)+"+t[u].varianceMin+", 1.0);\n";s=s+"prob=variance /(  variance + sDepth*sDepth );\n";s=s+"prob=smoothstep("+t[u].bleedCutoff.toFixed(2)+",1.0,prob);\n";s=s+"shadowfact"+u+"=prob;\n"}else{s=s+"float shadowfact"+u+" = 1.0;\n"}if(t[u].diffuse){if(t[u].negativeShadow){s=s+"lightvalue -= lightcolor"+u+"-(dotN * lightcolor"+u+" * shadowfact"+u+");\n"}else{s=s+"shadowfact"+u+"="+this.translucency.toFixed(2)+"+"+(1-this.translucency).toFixed(2)+"*shadowfact"+u+";\n";s=s+"lightvalue += dotN * lightcolor"+u+" * shadowfact"+u+";\n"}}if(t[u].specular){s=s+"specvalue += smoothstep(-specularSmoothStepValue,specularSmoothStepValue,dotN) * specC * lightcolor"+u+" * spec  * pow(max(dot(reflect(normalize(lightvec), normal),normalize(viewvec)),0.0), 0.3 * sh);\n"}}}s=s+"lightvalue = (lightvalue)*ref;\n";s=s+"vec3 fc=fogcolor.rgb;\n";s=s+"if(fogtype=="+e.FOG_SKYLINEAR+" || fogtype=="+e.FOG_SKYQUADRATIC+"){";s=s+"vec4 view=projection * vec4(-eyevec,1.0);\n";s=s+"vec2 fogCoords=view.xy/view.w*0.5+0.5;\n";s=s+"fc=texture2D(sky,fogCoords.xy).rgb;\n";s=s+"}\n";s=s+"vec4 finalColor =vec4(specvalue.rgb+color.rgb*lightvalue.rgb+em.rgb,al)*fogfact+vec4(fc,al)*(1.0-fogfact);\n";if(r&&~r.indexOf("GLGE_FragColor")){s=s+"finalColor=GLGE_FragColor(finalColor);\n"}if(this.fadeDistance>0){s=s+"finalColor.a=finalColor.a*(1.0-min(1.0,"+this.fadeDistance.toFixed(5)+"/length(eyevec)));\n"}if(this.fadeDistance<0){s=s+"finalColor.a=finalColor.a*(min(1.0,"+(-this.fadeDistance).toFixed(5)+"/length(eyevec)));\n"}s=s+"gl_FragColor = finalColor;";if(e.DEBUGNORMALS)s=s+"gl_FragColor = vec4(normal.rgb,1.0);";if(e.DEBUGCOORD0)s=s+"gl_FragColor = vec4(textureCoords0.rg,0.0,1.0);";s=s+"}\n"}else{s=s+"float shadowdepth = gl_FragCoord.z;\n";s=s+"if(shadowtype) shadowdepth=length(eyevec)/distance;\n";s=s+"vec4 rgba=fract(shadowdepth * vec4(16777216.0, 65536.0, 256.0, 1.0));\n";s=s+"gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);\n"}s=s+"}\n";return s};e.Material.prototype.textureUniforms=function(t,n,r,i){if(this.animation)this.animate();var s=n.caches;if(!s.baseColor||s.baseColor.r!=this.color.r||s.baseColor.g!=this.color.g||s.baseColor.b!=this.color.b||s.baseColor.a!=this.color.a){if(!this.ccache||this.ccache.r!=this.color.r||this.ccache.g!=this.color.g||this.ccache.b!=this.color.b||this.ccache.a!=this.color.a){this.ccache=this.color;this.glColor=new Float32Array([this.color.r,this.color.g,this.color.b,this.color.a])}t.uniform4fv(e.getUniformLocation(t,n,"baseColor"),this.glColor);s.baseColor=this.color}if(s.specColor!=this.specColor){if(this.sccache!=this.specColor){this.sccache=this.specColor;this.glspecColor=new Float32Array([this.specColor.r,this.specColor.g,this.specColor.b])}t.uniform3fv(e.getUniformLocation(t,n,"specColor"),this.glspecColor);s.specColor=this.specColor}if(s.emit!=this.emit){t.uniform3f(e.getUniformLocation(t,n,"emit"),this.emit.r,this.emit.g,this.emit.b);s.emit=this.emit}if(s.specular!=this.specular){e.setUniform(t,"1f",e.getUniformLocation(t,n,"specular"),this.specular);s.specular=this.specular}if(s.shine!=this.shine){e.setUniform(t,"1f",e.getUniformLocation(t,n,"shine"),this.shine);s.shine=this.shine}if(s.reflect!=this.reflect){e.setUniform(t,"1f",e.getUniformLocation(t,n,"reflective"),this.reflect);s.reflect=this.reflect}if(s.alpha!=this.alpha){e.setUniform(t,"1f",e.getUniformLocation(t,n,"alpha"),this.alpha);s.alpha=this.alpha}if(s.shadeless==undefined||s.shadeless!=this.shadeless){e.setUniform(t,"1i",e.getUniformLocation(t,n,"shadeless"),this.shadeless);s.shadeless=this.shadeless}var o=1;var u=0;if(!s["lightcolor"]){s["lightcolor"]=[];s["lightAttenuation"]=[];s["spotCosCutOff"]=[];s["spotExponent"]=[];s["shadowbias"]=[];s["castshadows"]=[];s["shadowsamples"]=[];s["shadowsoftness"]=[]}if(r){for(var a=0;a<r.length;a++){if(r[a].type==e.L_OFF)continue;if(s["lightcolor"][a]!=r[a].color){e.setUniform3(t,"3f",e.getUniformLocation(t,n,"lightcolor"+a),r[a].color.r,r[a].color.g,r[a].color.b);s["lightcolor"][a]={r:r[a].color.r,g:r[a].color.g,b:r[a].color.b}}if(s["lightAttenuation"][a]!=r[a].constantAttenuation){e.setUniform3(t,"3f",e.getUniformLocation(t,n,"lightAttenuation"+a),r[a].constantAttenuation,r[a].linearAttenuation,r[a].quadraticAttenuation);s["lightAttenuation"][a]=r[a].constantAttenuation}if(s["spotCosCutOff"][a]!=r[a].spotCosCutOff){e.setUniform(t,"1f",e.getUniformLocation(t,n,"spotCosCutOff"+a),r[a].spotCosCutOff);s["spotCosCutOff"][a]=r[a].spotCosCutOff}if(s["spotExponent"][a]!=r[a].spotExponent){e.setUniform(t,"1f",e.getUniformLocation(t,n,"spotExp"+a),r[a].spotExponent);s["spotExponent"][a]=r[a].spotExponent}if(s["shadowbias"][a]!=r[a].shadowBias){e.setUniform(t,"1f",e.getUniformLocation(t,n,"shadowbias"+a),r[a].shadowBias);s["shadowbias"][a]=r[a].shadowBias}if(s["shadowsoftness"][a]!=r[a].softness){e.setUniform(t,"1f",e.getUniformLocation(t,n,"shadowsoftness"+a),r[a].softness);s["shadowsoftness"][a]=r[a].softness}if(r[a].getCastShadows()&&this.shadow){u=this.textures.length+o++;t.activeTexture(t["TEXTURE"+u]);t.bindTexture(t.TEXTURE_2D,r[a].texture);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);e.setUniform(t,"1i",e.getUniformLocation(t,n,"TEXTURE"+u),u)}}}if(!n.glarrays.layermat)n.glarrays.layermat=[];var f,l;for(a=0;a<this.layers.length;a++){if(this.layers[a].animation)this.layers[a].animate();f=this.layers[a].getScale();l=this.layers[a].getOffset();if(!n.glarrays.layermat[a])n.glarrays.layermat[a]=new Float32Array(this.layers[a].getMatrix());else e.mat4gl(this.layers[a].getMatrix(),n.glarrays.layermat[a]);try{e.setUniformMatrix(t,"Matrix4fv",e.getUniformLocation(t,n,"layer"+a+"Matrix"),true,n.glarrays.layermat[a])}catch(c){}e.setUniform(t,"1f",e.getUniformLocation(t,n,"layeralpha"+a),this.layers[a].getAlpha());e.setUniform(t,"1f",e.getUniformLocation(t,n,"layerheight"+a),this.layers[a].getHeight())}for(var a=0;a<this.textures.length;a++){t.activeTexture(t["TEXTURE"+(a+1)]);if(this.textures[a].doTexture(t,i)){}e.setUniform(t,"1i",e.getUniformLocation(t,n,"TEXTURE"+a),a+1)}if(t.scene.skyTexture){t.activeTexture(t["TEXTURE0"]);t.bindTexture(t.TEXTURE_2D,t.scene.skyTexture);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);e.setUniform(t,"1i",e.getUniformLocation(t,n,"sky"),0)}};e.Material.prototype.isComplete=function(){for(var e=0;e<this.textures.length;e++){if(!this.textures[e].isComplete)continue;if(!this.textures[e].isComplete())return false}return true};e.Material.prototype.addTexture=function(t){if(typeof t=="string")t=e.Assets.get(t);var n=this;t.addEventListener("downloadComplete",function(){if(n.isComplete())n.fireEvent("downloadComplete")});this.textures.push(t);t.idx=this.textures.length-1;this.fireEvent("shaderupdate",{});return this};e.Material.prototype.addTextureCube=e.Material.prototype.addTexture;e.Material.prototype.addTextureCamera=e.Material.prototype.addTexture;e.Material.prototype.addTextureCameraCube=e.Material.prototype.addTexture;e.Material.prototype.addTextureCanvas=e.Material.prototype.addTexture;e.Material.prototype.addTextureVideo=e.Material.prototype.addTexture;e.DEFAULT_MATERIAL=new e.Material})(GLGE);(function(e){e.MaterialLayer=function(t){this.blendMode=e.BL_MIX;e.Assets.registerAsset(this,t)};e.augment(e.Animatable,e.MaterialLayer);e.augment(e.QuickNotation,e.MaterialLayer);e.augment(e.JSONLoader,e.MaterialLayer);e.augment(e.Events,e.MaterialLayer);e.MaterialLayer.prototype.className="MaterialLayer";e.MaterialLayer.prototype.texture=null;e.MaterialLayer.prototype.blendMode=null;e.MaterialLayer.prototype.mapto=e.M_COLOR;e.MaterialLayer.prototype.mapinput=e.UV1;e.MaterialLayer.prototype.scaleX=1;e.MaterialLayer.prototype.offsetX=0;e.MaterialLayer.prototype.rotX=0;e.MaterialLayer.prototype.scaleY=1;e.MaterialLayer.prototype.offsetY=0;e.MaterialLayer.prototype.rotY=0;e.MaterialLayer.prototype.scaleZ=1;e.MaterialLayer.prototype.offsetZ=0;e.MaterialLayer.prototype.rotZ=0;e.MaterialLayer.prototype.dScaleX=0;e.MaterialLayer.prototype.dOffsetX=0;e.MaterialLayer.prototype.dRotX=0;e.MaterialLayer.prototype.dScaleY=0;e.MaterialLayer.prototype.dOffsetY=0;e.MaterialLayer.prototype.dRotY=0;e.MaterialLayer.prototype.dScaleZ=0;e.MaterialLayer.prototype.dOffsetZ=0;e.MaterialLayer.prototype.dRotZ=0;e.MaterialLayer.prototype.alpha=1;e.MaterialLayer.prototype.height=.05;e.MaterialLayer.prototype.matrix=null;e.MaterialLayer.prototype.getMatrix=function(){if(!this.matrix){var t=this.getOffset();var n=this.getScale();var r=this.getRotation();this.matrix=e.mulMat4(e.mulMat4(e.translateMatrix(t.x,t.y,t.z),e.scaleMatrix(n.x,n.y,n.z)),e.rotateMatrix(r.x,r.y,r.z))}return this.matrix};e.MaterialLayer.prototype.setHeight=function(e){this.height=e;return this};e.MaterialLayer.prototype.getHeight=function(){return this.height};e.MaterialLayer.prototype.setAlpha=function(e){this.alpha=e;return this};e.MaterialLayer.prototype.getAlpha=function(){return this.alpha};e.MaterialLayer.prototype.setTexture=function(t){if(typeof t=="string")t=e.Assets.get(t);this.texture=t;this.fireEvent("shaderupdate",{});return this};e.MaterialLayer.prototype.getTexture=function(){return this.texture};e.MaterialLayer.prototype.setMapto=function(e){this.mapto=e;this.fireEvent("shaderupdate",{});return this};e.MaterialLayer.prototype.getMapto=function(){return this.mapto};e.MaterialLayer.prototype.setMapinput=function(e){this.mapinput=e;this.fireEvent("shaderupdate",{});return this};e.MaterialLayer.prototype.getMapinput=function(){return this.mapinput};e.MaterialLayer.prototype.getOffset=function(){var e={};e.x=parseFloat(this.getOffsetX())+parseFloat(this.getDOffsetX());e.y=parseFloat(this.getOffsetY())+parseFloat(this.getDOffsetY());e.z=parseFloat(this.getOffsetZ())+parseFloat(this.getDOffsetZ());return e};e.MaterialLayer.prototype.getRotation=function(){var e={};e.x=parseFloat(this.getRotX())+parseFloat(this.getDRotX());e.y=parseFloat(this.getRotY())+parseFloat(this.getDRotY());e.z=parseFloat(this.getRotZ())+parseFloat(this.getDRotZ());return e};e.MaterialLayer.prototype.getScale=function(){var e={};e.x=parseFloat(this.getScaleX())+parseFloat(this.getDScaleX());e.y=parseFloat(this.getScaleY())+parseFloat(this.getDScaleY());e.z=parseFloat(this.getScaleZ())+parseFloat(this.getDScaleZ());return e};e.MaterialLayer.prototype.setOffsetX=function(e){this.matrix=null;this.offsetX=e;return this};e.MaterialLayer.prototype.getOffsetX=function(){return this.offsetX};e.MaterialLayer.prototype.setOffsetY=function(e){this.matrix=null;this.offsetY=e;return this};e.MaterialLayer.prototype.getOffsetY=function(){return this.offsetY};e.MaterialLayer.prototype.setOffsetZ=function(e){this.matrix=null;this.offsetZ=e;return this};e.MaterialLayer.prototype.getOffsetZ=function(){return this.offsetZ};e.MaterialLayer.prototype.setDOffsetX=function(e){this.matrix=null;this.dOffsetX=e;return this};e.MaterialLayer.prototype.getDOffsetX=function(){return this.dOffsetX};e.MaterialLayer.prototype.setDOffsetY=function(e){this.matrix=null;this.dOffsetY=e;return this};e.MaterialLayer.prototype.getDOffsetY=function(){return this.dOffsetY};e.MaterialLayer.prototype.setDOffsetZ=function(e){this.matrix=null;this.dOffsetZ=e;return this};e.MaterialLayer.prototype.getDOffsetZ=function(){return this.dOffsetZ};e.MaterialLayer.prototype.setScaleX=function(e){this.matrix=null;this.scaleX=e;return this};e.MaterialLayer.prototype.getScaleX=function(){return this.scaleX};e.MaterialLayer.prototype.setScaleY=function(e){this.matrix=null;this.scaleY=e;return this};e.MaterialLayer.prototype.getScaleY=function(){return this.scaleY};e.MaterialLayer.prototype.setScaleZ=function(e){this.matrix=null;this.scaleZ=e;return this};e.MaterialLayer.prototype.getScaleZ=function(){return this.scaleZ};e.MaterialLayer.prototype.setDScaleX=function(e){this.matrix=null;this.dScaleX=e;return this};e.MaterialLayer.prototype.getDScaleX=function(){return this.dScaleX};e.MaterialLayer.prototype.setDScaleY=function(e){this.matrix=null;this.dScaleY=e;return this};e.MaterialLayer.prototype.getDScaleY=function(){return this.dScaleY};e.MaterialLayer.prototype.setDScaleZ=function(e){this.matrix=null;this.dScaleZ=e;return this};e.MaterialLayer.prototype.getDScaleZ=function(){return this.dScaleZ};e.MaterialLayer.prototype.setRotX=function(e){this.matrix=null;this.rotX=e;return this};e.MaterialLayer.prototype.getRotX=function(){return this.rotX};e.MaterialLayer.prototype.setRotY=function(e){this.matrix=null;this.rotY=e;return this};e.MaterialLayer.prototype.getRotY=function(){return this.rotY};e.MaterialLayer.prototype.setRotZ=function(e){this.matrix=null;this.rotZ=e;return this};e.MaterialLayer.prototype.getRotZ=function(){return this.rotZ};e.MaterialLayer.prototype.setDRotX=function(e){this.matrix=null;this.dRotX=e;return this};e.MaterialLayer.prototype.getDRotX=function(){return this.dRotX};e.MaterialLayer.prototype.setDRotY=function(e){this.matrix=null;this.dRotY=e;return this};e.MaterialLayer.prototype.getDRotY=function(){return this.dRotY};e.MaterialLayer.prototype.setDRotZ=function(e){this.matrix=null;this.dRotZ=e;return this};e.MaterialLayer.prototype.getDRotZ=function(){return this.dRotZ};e.MaterialLayer.prototype.setBlendMode=function(e){this.blendMode=e;this.fireEvent("shaderupdate",{});return this};e.MaterialLayer.prototype.getBlendMode=function(){return this.blendMode}})(GLGE);(function(e){e.MultiMaterial=function(t){var n=this;this.downloadComplete=function(){if(n.isComplete())n.fireEvent("downloadComplete")};this.boundUpdate=function(){n.fireEvent("boundupdate")};this.lods=[new e.ObjectLod];this.lods[0].addEventListener("downloadComplete",this.downloadComplete);this.lods[0].addEventListener("boundupdate",this.boundUpdate);e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.MultiMaterial);e.augment(e.JSONLoader,e.MultiMaterial);e.augment(e.Events,e.MultiMaterial);e.MultiMaterial.prototype.className="MultiMaterial";e.MultiMaterial.prototype.oneLod=true;e.MultiMaterial.prototype.isComplete=function(){for(var e=0;e<this.lods.length;e++){if(!this.lods[e].isComplete())return false}return true};e.MultiMaterial.prototype.setMesh=function(e){this.lods[0].setMesh(e);return this};e.MultiMaterial.prototype.getMesh=function(){return this.lods[0].getMesh()};e.MultiMaterial.prototype.setMaterial=function(e){this.lods[0].setMaterial(e);return this};e.MultiMaterial.prototype.getMaterial=function(){return this.lods[0].getMaterial()};e.MultiMaterial.prototype.getLOD=function(e){var t=0;var n=this.lods[0];if(this.lods.length>1){for(var r=1;r<this.lods.length;r++){var i=this.lods[r].pixelSize;if(i>t&&i<e&&this.lods[r].mesh&&this.lods[r].mesh.loaded){t=i;n=this.lods[r]}}}return n};e.MultiMaterial.prototype.addObjectLod=function(e){if(this.oneLod){this.oneLod=false;this.lods=[]}this.lods.push(e);e.addEventListener("downloadComplete",this.downloadComplete);return this};e.MultiMaterial.prototype.updateProgram=function(){for(var e=0;e<this.lods.length;e++){this.lods[e].GLShaderProgram=null}return this};e.MultiMaterial.prototype.removeObjectLod=function(e){var t=this.lods.indexOf(e);lods[t].removeEventListener("downloadComplete",this.downloadComplete);if(t)this.lods.splice(t,1);return this}})(GLGE);(function(e){e.Texture=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.Texture);e.augment(e.JSONLoader,e.Texture);e.augment(e.Events,e.Texture);e.Texture.prototype.className="Texture";e.Texture.prototype.image=null;e.Texture.prototype.glTexture=null;e.Texture.prototype.url=null;e.Texture.prototype.state=0;e.Texture.prototype.anisotropy=8;e.Texture.prototype.preAlpha=true;e.Texture.prototype.getPreMuliplyAlpha=function(){return this.preAlpha};e.Texture.prototype.setPreMuliplyAlpha=function(e){this.preAlpha=e;return this};e.Texture.prototype.getSrc=function(){return this.url};e.Texture.prototype.setSrc=function(e){this.url=e;this.state=0;this.image=new Image;var t=this;this.image.onload=function(){t.state=1;t.fireEvent("downloadComplete")};this.image.src=e;if(this.glTexture&&this.gl){this.glTexture=null}return this};e.Texture.prototype.doTexture=function(e){this.gl=e;if(!e.urlTextures)e.urlTextures={};if(e.urlTextures[this.url]){this.glTexture=e.urlTextures[this.url];this.state=2}if(!this.image)this.setSrc(this.url);if(!this.glTexture)this.glTexture=e.createTexture();if(this.state==1){e.bindTexture(e.TEXTURE_2D,this.glTexture);var t=Math.pow(2,Math.round(Math.log(this.image.width)/Math.log(2)));var n=Math.pow(2,Math.round(Math.log(this.image.height)/Math.log(2)));var r;if(t==this.image.width&&n==this.image.height)r=this.image;else{r=document.createElement("canvas");r.width=t;r.height=n;var i=r.getContext("2d");i.drawImage(this.image,0,0,t,n)}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r);e.urlTextures[this.url]=this.glTexture;e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,null);this.state=2}if(this.state==2){e.bindTexture(e.TEXTURE_2D,this.glTexture);if(this.preAlpha){e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR);if(e.af)e.texParameterf(e.TEXTURE_2D,e.af.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropy);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)}else{e.bindTexture(e.TEXTURE_2D,null)}if(this.state==2)return true;else return false};e.Texture.prototype.isComplete=function(){return this.state>0}})(GLGE);(function(e){e.TextureCamera=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.TextureCamera);e.augment(e.JSONLoader,e.TextureCamera);e.augment(e.Events,e.TextureCamera);e.TextureCamera.prototype.className="Texture";e.TextureCamera.prototype.texture=null;e.TextureCamera.prototype.glTexture=null;e.TextureCamera.prototype.object=null;e.TextureCamera.prototype.camera=null;e.TextureCamera.prototype.bufferHeight=0;e.TextureCamera.prototype.bufferWidth=0;e.TextureCamera.prototype.planeOffset=0;e.TextureCamera.prototype.mirrorAxis=e.NONE;e.TextureCamera.prototype.clipAxis=e.NONE;e.TextureCamera.prototype.autoUpdate=true;e.TextureCamera.prototype.rendered=false;e.TextureCamera.prototype.render=function(){this.rendered=false;return this};e.TextureCamera.prototype.setAutoUpdate=function(e){this.autoUpdate=e;return this};e.TextureCamera.prototype.getAutoUpdate=function(){return this.autoUpdate};e.TextureCamera.prototype.setPlaneOffset=function(e){this.planeOffset=e;return this};e.TextureCamera.prototype.getPlaneOffset=function(){return this.planeOffset};e.TextureCamera.prototype.setBufferWidth=function(e){this.bufferWidth=e;this.update=true;return this};e.TextureCamera.prototype.getBufferWidth=function(){return this.bufferWidth};e.TextureCamera.prototype.setBufferHeight=function(e){this.bufferHeight=e;this.update=true;return this};e.TextureCamera.prototype.getBufferHeight=function(){return this.bufferHeight};e.TextureCamera.prototype.setClipAxis=function(e){this.clipAxis=e;return this};e.TextureCamera.prototype.getClipAxis=function(){return this.clipAxis};e.TextureCamera.prototype.setMirrorAxis=function(e){this.mirrorAxis=e;return this};e.TextureCamera.prototype.getMirrorAxis=function(){return this.mirrorAxis};e.TextureCamera.prototype.setCamera=function(e){this.camera=e;return this};e.TextureCamera.prototype.getCamera=function(){return this.camera};e.TextureCamera.prototype.doTexture=function(t,n){if(this.camera){if(this.autoRender||!this.rendered||true){this.rendered=true;this.gl=t;var r=n.getModelMatrix();var i=this.camera.pMatrix;var s=this.camera.matrix;this.camera.pMatrix=null;this.camera.matrix=null;var o=this.camera.getProjectionMatrix().slice(0);var u=this.camera.getViewMatrix().slice(0);this.camera.pMatrix=i;this.camera.matrix=s;var a;if(this.mirrorAxis){switch(this.mirrorAxis){case e.XAXIS:a=e.mulMat4(e.mulMat4(e.mulMat4(u,r),e.scaleMatrix(-1,1,1)),e.inverseMat4(r));break;case e.YAXIS:a=e.mulMat4(e.mulMat4(e.mulMat4(u,r),e.scaleMatrix(1,-1,1)),e.inverseMat4(r));break;case e.ZAXIS:a=e.mulMat4(e.mulMat4(e.mulMat4(u,r),e.scaleMatrix(1,1,-1)),e.inverseMat4(r));break}}else{a=u}if(this.clipAxis){var f;switch(this.clipAxis){case e.NEG_XAXIS:var l=e.toUnitVec3([-r[0],-r[4],-r[8]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break;case e.POS_XAXIS:var l=e.toUnitVec3([r[0],r[4],r[8]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break;case e.NEG_YAXIS:var l=e.toUnitVec3([-r[1],-r[5],-r[9]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break;case e.POS_YAXIS:var l=e.toUnitVec3([r[1],r[5],r[9]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break;case e.NEG_ZAXIS:var l=e.toUnitVec3([-r[2],-r[6],-r[10]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break;case e.POS_ZAXIS:var l=e.toUnitVec3([r[2],r[6],r[10]]);f=[l[0],l[1],l[2],-e.dotVec3([r[3],r[7],r[11]],l)-this.planeOffset];break}var c=e.transposeMat4(e.inverseMat4(e.mulMat4(o,a)));f=e.mulMat4Vec4(c,f);f=e.scaleVec4(f,o[10]);f[3]-=1;if(f[2]<0)e.scaleVec4(f,-1);var h=[1,0,0,0,0,1,0,0,f[0],f[1],f[2],f[3],0,0,0,1];o=e.mulMat4(h,o)}var p=!this.bufferHeight?t.scene.renderer.canvas.height:this.bufferHeight;var d=!this.bufferWidth?t.scene.renderer.canvas.width:this.bufferWidth;if(!this.glTexture||this.update){this.createFrameBuffer(t);t.scene.addRenderPass(this.frameBuffer,a,t.scene.camera.getProjectionMatrix(),d,p,n,this.mirrorAxis?true:false);t.bindTexture(t.TEXTURE_2D,this.glTexture);this.update=false;return false}else{t.bindTexture(t.TEXTURE_2D,this.glTexture);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);t.scene.addRenderPass(this.frameBuffer,a,o,d,p,n,this.mirrorAxis?true:false);return true}}else{t.bindTexture(t.TEXTURE_2D,this.glTexture)}}else{return false}};e.TextureCamera.prototype.registerPasses=e.TextureCamera.prototype.doTexture;e.TextureCamera.prototype.createFrameBuffer=function(e){var t=!this.bufferHeight?e.scene.renderer.canvas.height:this.bufferHeight;var n=!this.bufferWidth?e.scene.renderer.canvas.width:this.bufferWidth;if(!this.frameBuffer)this.frameBuffer=e.createFramebuffer();if(!this.renderBuffer)this.renderBuffer=e.createRenderbuffer();if(!this.glTexture)this.glTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.glTexture);var r=new Uint8Array(n*t*4);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,r);e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer);e.bindRenderbuffer(e.RENDERBUFFER,this.renderBuffer);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,n,t);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.renderBuffer);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.glTexture,0);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindTexture(e.TEXTURE_2D,null)}})(GLGE);(function(e){e.TextureCameraCube=function(t){e.Assets.registerAsset(this,t);this.cubeBuffers=[]};e.augment(e.QuickNotation,e.TextureCameraCube);e.augment(e.JSONLoader,e.TextureCameraCube);e.augment(e.Events,e.TextureCameraCube);e.TextureCameraCube.prototype.className="TextureCube";e.TextureCameraCube.prototype.texture=null;e.TextureCameraCube.prototype.glTexture=null;e.TextureCameraCube.prototype.object=null;e.TextureCameraCube.prototype.autoUpdate=false;e.TextureCameraCube.prototype.rendered=false;e.TextureCameraCube.prototype.bufferHeight=512;e.TextureCameraCube.prototype.bufferWidth=512;e.TextureCameraCube.prototype.offsetX=0;e.TextureCameraCube.prototype.offsetY=0;e.TextureCameraCube.prototype.offsetZ=0;e.TextureCameraCube.prototype.cameraMatries=[[0,0,-1,0,0,1,0,0,-1,0,0,0,0,0,0,1],[0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,1],[-1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],[-1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1],[1,0,0,0,0,1,0,0,0,0,-1,0,0,0,0,1],[-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]];e.TextureCameraCube.prototype.pMatrix=e.makePerspective(90,1,1e-4,1e3);e.TextureCameraCube.prototype.render=function(){this.rendered=false;return this};e.TextureCameraCube.prototype.setOffsetX=function(e){this.offsetX=e;return this};e.TextureCameraCube.prototype.getOffsetX=function(){return this.offsetX};e.TextureCameraCube.prototype.setOffsetY=function(e){this.offsetY=e;return this};e.TextureCameraCube.prototype.getOffsetY=function(){return this.offsetY};e.TextureCameraCube.prototype.setOffsetZ=function(e){this.offsetZ=e;return this};e.TextureCameraCube.prototype.getOffsetZ=function(){return this.offsetZ};e.TextureCameraCube.prototype.setAutoUpdate=function(e){this.autoUpdate=e;return this};e.TextureCameraCube.prototype.getAutoUpdate=function(){return this.autoUpdate};e.TextureCameraCube.prototype.setBufferWidth=function(e){this.bufferWidth=e;this.update=true;return this};e.TextureCameraCube.prototype.getBufferWidth=function(){return this.bufferWidth};e.TextureCameraCube.prototype.setBufferHeight=function(e){this.bufferHeight=e;this.update=true;return this};e.TextureCameraCube.prototype.getBufferHeight=function(){return this.bufferHeight};e.TextureCameraCube.prototype.doTexture=function(t,n){this.gl=t;var r=n.getModelMatrix();var i=this.bufferHeight;var s=this.bufferWidth;if(!this.cubeBuffers.length||this.update){this.createFrameBuffers(t);this.update=false;return false}t.bindTexture(t.TEXTURE_CUBE_MAP,this.glTexture);if(!this.rendered||this.autoUpdate){for(var o=0;o<6;o++){var u=this.cameraMatries[o].slice(0);var a=e.mulMat4(u,r);var f=e.mulMat4Vec3(a,[this.offsetX,this.offsetY,this.offsetZ,1]);u[3]=-f[0];u[7]=-f[1];u[11]=-f[2];t.scene.addRenderPass(this.cubeBuffers[o],u,this.pMatrix,s,i,n,true)}this.rendered=true}return true};e.TextureCameraCube.prototype.registerPasses=e.TextureCameraCube.prototype.doTexture;e.TextureCameraCube.prototype.createFrameBuffers=function(e){var t=this.bufferHeight;var n=this.bufferWidth;var r=e.createRenderbuffer();this.glTexture=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,this.glTexture);e.bindRenderbuffer(e.RENDERBUFFER,r);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,n,t);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.RGBA,n,t,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var i;i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_NEGATIVE_X,this.glTexture,0);this.cubeBuffers.push(i);i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X,this.glTexture,0);this.cubeBuffers.push(i);i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,this.glTexture,0);this.cubeBuffers.push(i);i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_Y,this.glTexture,0);this.cubeBuffers.push(i);i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,this.glTexture,0);this.cubeBuffers.push(i);i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_Z,this.glTexture,0);this.cubeBuffers.push(i);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindTexture(e.TEXTURE_CUBE_MAP,null)}})(GLGE);(function(e){e.TextureCanvas=function(t){this.canvas=document.createElement("canvas");this.t=document.createElement("canvas");this.t.width=1;this.t.height=1;e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.TextureCanvas);e.augment(e.JSONLoader,e.TextureCanvas);e.augment(e.Events,e.TextureCanvas);e.TextureCanvas.prototype.className="TextureCanvas";e.TextureCanvas.prototype.glTexture=null;e.TextureCanvas.prototype.autoUpdate=true;e.TextureCanvas.prototype.getAutoUpdate=function(){return this.autoUpdate};e.TextureCanvas.prototype.setAutoUpdate=function(e){this.autoUpdate=e;return this};e.TextureCanvas.prototype.getCanvas=function(){return this.canvas};e.TextureCanvas.prototype.setCanvas=function(e){this.canvas=e;return this};e.TextureCanvas.prototype.setHeight=function(e){this.canvas.height=e;return this};e.TextureCanvas.prototype.setWidth=function(e){this.canvas.width=e;return this};e.TextureCanvas.prototype.getHeight=function(){return this.canvas.height};e.TextureCanvas.prototype.getWidth=function(){return this.canvas.width};e.TextureCanvas.prototype.doTexture=function(e){this.gl=e;if(!this.glTexture){this.glTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.glTexture);this.updateCanvas(e)}else{e.bindTexture(e.TEXTURE_2D,this.glTexture);if(this.autoUpdate||this.doUpdate)this.updateCanvas(e)}this.doUpdate=false;return true};e.TextureCanvas.prototype.update=function(){this.doUpdate=true};e.TextureCanvas.prototype.updateCanvas=function(e){var t=this.canvas;e.bindTexture(e.TEXTURE_2D,this.glTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.t);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.generateMipmap(e.TEXTURE_2D)}})(GLGE);(function(e){e.TextureCube=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.TextureCube);e.augment(e.JSONLoader,e.TextureCube);e.augment(e.Events,e.TextureCube);e.TextureCube.prototype.className="TextureCube";e.TextureCube.prototype.posX=null;e.TextureCube.prototype.negX=null;e.TextureCube.prototype.posY=null;e.TextureCube.prototype.negY=null;e.TextureCube.prototype.posZ=null;e.TextureCube.prototype.negZ=null;e.TextureCube.prototype.texture=null;e.TextureCube.prototype.glTexture=null;e.TextureCube.prototype.loadState=0;e.TextureCube.prototype.setSrc=function(e,t,n){this.url=e;this.state=0;this[t]=new Image;var r=this;this[t].onload=function(){r.loadState+=n};this[t].src=e;if(this.glTexture&&this.gl){this.gl.deleteTexture(this.glTexture);this.glTexture=null}return this};e.TextureCube.prototype.setSrcPosX=function(e){this.setSrc(e,"posX",1);return this};e.TextureCube.prototype.setSrcNegX=function(e){this.setSrc(e,"negX",2);return this};e.TextureCube.prototype.setSrcPosY=function(e){this.setSrc(e,"posY",4);return this};e.TextureCube.prototype.setSrcNegY=function(e){if(typeof e!="string"){this.negY=e;this.loadState+=8}else{this.setSrc(e,"negY",8)}return this};e.TextureCube.prototype.setSrcPosZ=function(e){this.setSrc(e,"posZ",16);return this};e.TextureCube.prototype.setSrcNegZ=function(e){this.setSrc(e,"negZ",32);return this};e.TextureCube.prototype.doTexture=function(e,t){this.gl=e;if(!this.glTexture)this.glTexture=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,this.glTexture);if(this.loadState==63&&this.state==0){e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.posX);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.negX);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.posY);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.negY);e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.posZ);e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.negZ);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.generateMipmap(e.TEXTURE_CUBE_MAP);e.bindTexture(e.TEXTURE_CUBE_MAP,null);this.state=1}e.bindTexture(e.TEXTURE_CUBE_MAP,this.glTexture);if(this.state==1)return true;else return false}})(GLGE);(function(e){e.TextureVideo=function(t){this.video=document.createElement("video");this.video.style.display="none";this.video.setAttribute("loop","loop");this.video.autoplay=true;this.video.addEventListener("ended",function(){this.play()},true);document.getElementsByTagName("body")[0].appendChild(this.video);this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.TextureVideo);e.augment(e.JSONLoader,e.TextureVideo);e.augment(e.Events,e.TextureVideo);e.TextureVideo.prototype.className="TextureVideo";e.TextureVideo.prototype.glTexture=null;e.TextureVideo.prototype.getVideo=function(){return this.video};e.TextureVideo.prototype.setVideo=function(e){this.video=e;return this};e.TextureVideo.prototype.setSrc=function(e){this.video.src=e;return this};e.TextureVideo.prototype.getSrc=function(e){return this.video.src};e.TextureVideo.prototype.doTexture=function(e){this.gl=e;if(!this.glTexture){this.glTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.glTexture);this.updateTexture(e)}else{e.bindTexture(e.TEXTURE_2D,this.glTexture);this.updateTexture(e)}return true};e.TextureVideo.prototype.updateTexture=function(e){var t=this.video;e.bindTexture(e.TEXTURE_2D,this.glTexture);if(t.readyState>0){if(t.height<=0){t.style.display="";t.height=t.offsetHeight;t.width=t.offsetWidth;t.style.display="none"}this.canvas.height=t.height;this.canvas.width=t.width;this.ctx.drawImage(t,0,0);try{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.canvas)}catch(n){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.canvas,null)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.generateMipmap(e.TEXTURE_2D)}}})(GLGE);(function(e){e.ObjectLod=function(t){this.setMaterial(e.DEFAULT_MATERIAL);e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.ObjectLod);e.augment(e.JSONLoader,e.ObjectLod);e.augment(e.Events,e.ObjectLod);e.ObjectLod.prototype.mesh=null;e.ObjectLod.prototype.className="ObjectLod";e.ObjectLod.prototype.material=null;e.ObjectLod.prototype.program=null;e.ObjectLod.prototype.GLShaderProgramPick=null;e.ObjectLod.prototype.GLShaderProgramShadow=null;e.ObjectLod.prototype.GLShaderProgram=null;e.ObjectLod.prototype.pixelSize=0;e.ObjectLod.prototype.setMesh=function(t){if(typeof t=="string")t=e.Assets.get(t);if(this.mesh){this.mesh.removeEventListener("shaderupdate",this.meshupdated);this.mesh.removeEventListener("boundupdate",this.boundupdated)}var n=this;this.meshupdated=function(e){n.GLShaderProgram=null};this.boundupdated=function(e){n.fireEvent("boundupdate",{})};t.addEventListener("shaderupdate",this.meshupdated);t.addEventListener("boundupdate",this.boundupdated);this.GLShaderProgram=null;this.mesh=t;return this};e.ObjectLod.prototype.isComplete=function(){return this.material.isComplete()};e.ObjectLod.prototype.getMesh=function(){return this.mesh};e.ObjectLod.prototype.setMaterial=function(t){if(typeof t=="string")t=e.Assets.get(t);if(this.material){this.material.removeEventListener("shaderupdate",this.materialupdated);this.material.removeEventListener("downloadComplete",this.downloadComplete)}var n=this;this.materialupdated=function(e){n.GLShaderProgram=null};t.addEventListener("shaderupdate",this.materialupdated);this.downloadComplete=function(){n.fireEvent("downloadComplete")};t.addEventListener("downloadComplete",this.downloadComplete);this.GLShaderProgram=null;this.material=t;return this};e.ObjectLod.prototype.getMaterial=function(){return this.material};e.ObjectLod.prototype.getPixelSize=function(){return this.pixelSize};e.ObjectLod.prototype.setPixelSize=function(e){this.pixelSize=parseFloat(e)}})(GLGE);(function(e){e.Object=function(t){this.multimaterials=[];this.renderCaches=[];var n=this;this.downloadComplete=function(){if(n.isComplete())n.fireEvent("downloadComplete")};e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.Object);e.augment(e.Animatable,e.Object);e.augment(e.QuickNotation,e.Object);e.augment(e.JSONLoader,e.Object);e.Object.prototype.className="Object";e.Object.prototype.mesh=null;e.Object.prototype.skeleton=null;e.Object.prototype.scene=null;e.Object.prototype.transformMatrix=e.identMatrix();e.Object.prototype.material=null;e.Object.prototype.gl=null;e.Object.prototype.multimaterials=null;e.Object.prototype.zTrans=false;e.Object.prototype.renderCaches=null;e.Object.prototype.id="";e.Object.prototype.pickable=true;e.Object.prototype.drawType=e.DRAW_TRIS;e.Object.prototype.pointSize=1;e.Object.prototype.lineWidth=1;e.Object.prototype.cull=true;e.Object.prototype.culled=true;e.Object.prototype.visible=true;e.Object.prototype.depthTest=true;e.Object.prototype.meshFrame1=0;e.Object.prototype.meshFrame2=0;e.Object.prototype.meshBlendFactor=0;e.Object.prototype.noCastShadows=null;e.Object.prototype.noDepthMask=false;e.Object.prototype.shadowAlpha=true;e.Object.prototype.blending=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];var t=[];t.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");t.push("uniform float distance;\n");t.push("uniform bool shadowtype;\n");t.push("varying vec3 eyevec;\n");t.push("void main(void)\n  ");t.push("{\n");t.push("float depth = gl_FragCoord.z;\n");t.push("if(shadowtype) depth=length(eyevec)/distance;\n");t.push("vec4 rgba=fract(depth * vec4(16777216.0, 65536.0, 256.0, 1.0));\n");t.push("gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);\n");t.push("}\n");e.Object.prototype.shfragStr=t.join("");var n=[];n.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");n.push("varying vec3 n;\n");n.push("void main(void)\n");n.push("{\n");n.push("float depth = gl_FragCoord.z / gl_FragCoord.w;\n");n.push("gl_FragColor=vec4(normalize(n)/2.0+0.5,depth/1000.0);\n");n.push("}\n");e.Object.prototype.nfragStr=n.join("");var r=[];r.push("#ifdef GL_ES\nprecision highp float;\n#endif\n");r.push("uniform float far;\n");r.push("uniform vec3 pickcolor;\n");r.push("varying vec3 n;\n");r.push("varying vec4 UVCoord;\n");r.push("void main(void)\n");r.push("{\n");r.push("float Xcoord = gl_FragCoord.x+0.5;\n");r.push("if(Xcoord>0.0) gl_FragColor = vec4(pickcolor,1.0);\n");r.push("if(Xcoord>1.0) gl_FragColor = vec4(n,1.0);\n");r.push("if(Xcoord>2.0){");r.push("vec3 rgb=fract((gl_FragCoord.z/gl_FragCoord.w) * vec3(65536.0, 256.0, 1.0));\n");r.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");r.push("}");r.push("if(Xcoord>3.0){");r.push("vec3 rgb=fract(UVCoord.x * vec3(65536.0, 256.0, 1.0));\n");r.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");r.push("}");r.push("if(Xcoord>4.0){");r.push("vec3 rgb=fract(UVCoord.y * vec3(65536.0, 256.0, 1.0));\n");r.push("gl_FragColor=vec4(rgb-rgb.rrg*vec3(0.0,0.00390625,0.00390625),1.0);\n");r.push("}");r.push("}\n");e.Object.prototype.pkfragStr=r.join("");e.Object.prototype.noDepthMask;e.Object.prototype.setDepthMask=function(e){this.noDepthMask=!e;return this};e.Object.prototype.getDepthMask=function(){return!this.noDepthMask};e.Object.prototype.setVisible=function(e){this.visible=e;return this};e.Object.prototype.getVisible=function(){return this.visible};e.Object.prototype.setBlending=function(e){this.blending=e;return this};e.Object.prototype.getBlending=function(){return this.blending};e.Object.prototype.setMeshFrame1=function(e){this.meshFrame1=e;return this};e.Object.prototype.setMeshFrame2=function(e){this.meshFrame2=e;return this};e.Object.prototype.setMeshBlendFactor=function(e){this.meshBlendFactor=e;return this};e.Object.prototype.getMeshBlendFactor=function(){return this.meshBlendFactor};e.Object.prototype.getPickable=function(){return this.pickable};e.Object.prototype.setPickable=function(e){this.pickable=e;return this};e.Object.prototype.getDepthTest=function(){return this.depthTest};e.Object.prototype.setDepthTest=function(e){this.depthTest=e;return this};e.Object.prototype.getCull=function(){return this.cull};e.Object.prototype.setCull=function(e){this.cull=e;return this};e.Object.prototype.getDrawType=function(){return this.drawType};e.Object.prototype.setDrawType=function(e){this.drawType=e;return this};e.Object.prototype.getPointSize=function(){return this.pointSize};e.Object.prototype.setPointSize=function(e){this.pointSize=parseFloat(e);return this};e.Object.prototype.getLineWidth=function(){return this.lineWidth};e.Object.prototype.setLineWidth=function(e){this.lineWidth=parseFloat(e);return this};e.Object.prototype.setUniform=function(e,t,n){if(!this.uniforms)this.uniforms={};this.uniforms[t]={type:e,value:n}};e.Object.prototype.getUniform=function(e){if(!this.uniforms)this.uniforms={};return this.uniforms[e].value};e.Object.prototype.getUniformType=function(e){if(!this.uniforms)this.uniforms={};return this.uniforms[e].type};e.Object.prototype.setVertexShaderInjection=function(e){this.shaderVertexInjection=e;this.updateProgram();return this};e.Object.prototype.getVertexShaderInjection=function(e){return this.shaderVertexInjection};e.Object.prototype.getSkeleton=function(){return this.skeleton};e.Object.prototype.setSkeleton=function(e){this.skeleton=e;this.bones=null;return this};e.Object.prototype.getBoundingVolume=function(t){if(!t)t=0;if(!this.boundingVolume)this.boundingVolume=[];if(!this.boundmatrix)this.boundmatrix=[];var n=this.getModelMatrix();if(n!=this.boundmatrix[t]||!this.boundingVolume[t]){var r=this.multimaterials;var i;for(var s=0;s<r.length;s++){if(r[s].lods[0].mesh){if(!i){i=r[s].lods[0].mesh.getBoundingVolume().clone()}else{i.addBoundingVolume(r[s].lods[0].mesh.getBoundingVolume())}}}if(!i)i=new e.BoundingVolume(0,0,0,0,0,0);if(t){i.applyMatrix(this.getLocalMatrix())}else{i.applyMatrix(this.getModelMatrix())}this.boundingVolume[t]=i}this.boundmatrix[t]=n;return this.boundingVolume[t]};e.Object.prototype.setCastShadows=function(e){this.noCastShadows=!e;return this};e.Object.prototype.getCastShadows=function(){return!this.noCastShadows};e.Object.prototype.setZtransparent=function(e){this.zTrans=e;return this};e.Object.prototype.isZtransparent=function(){return this.zTrans};e.Object.prototype.isComplete=function(){for(var e=0;e<this.multimaterials.length;e++){if(!this.multimaterials[e].isComplete())return false}return true};e.Object.prototype.setMaterial=function(t,n){if(typeof t=="string")t=e.Assets.get(t);if(!n)n=0;if(!this.multimaterials[n]){this.multimaterials[n]=new e.MultiMaterial;this.multimaterials[n].addEventListener("downloadComplete",this.downloadComplete)}if(this.multimaterials[n].getMaterial()!=t){this.multimaterials[n].setMaterial(t);this.updateProgram()}return this};e.Object.prototype.getMaterial=function(e){if(!e)e=0;if(this.multimaterials[e]){return this.multimaterials[e].getMaterial()}else{return false}};e.Object.prototype.setMesh=function(t,n){if(typeof t=="string")t=e.Assets.get(t);if(!n)n=0;if(!this.multimaterials[n]){var r=this;this.multimaterials[n]=new e.MultiMaterial;this.multimaterials[n].addEventListener("downloadComplete",this.downloadComplete);this.multimaterials[n].addEventListener("boundupdate",function(){r.boundingVolume=null})}this.multimaterials[n].setMesh(t);this.boundingVolume=null;return this};e.Object.prototype.getMesh=function(e){if(!e)e=0;if(this.multimaterials[e]){return this.multimaterials[e].getMesh()}else{return false}};e.Object.prototype.GLInit=function(e){this.gl=e};e.Object.prototype.GLDestory=function(e){};e.Object.prototype.updateProgram=function(){for(var e=0;e<this.multimaterials.length;e++){this.multimaterials[e].updateProgram()}};e.Object.prototype.addMultiMaterial=function(t){if(typeof t=="string")t=e.Assets.get(t);this.multimaterials.push(t);t.addEventListener("downloadComplete",this.downloadComplete);var n=this;t.addEventListener("boundupdate",function(){n.boundingVolume=null});this.boundingVolume=null;return this};e.Object.prototype.getMultiMaterials=function(){return this.multimaterials};e.Object.prototype.GLGenerateShader=function(n){var r=UV=joints1=joints2=false;var i=n.lights;var s=["#define GLGE_VERTEX\n"];var o=false;if(!this.mesh.normals)this.mesh.calcNormals();s.push("attribute vec3 position;\n");s.push("attribute vec3 normal;\n");for(var u=0;u<this.mesh.buffers.length;u++){if(this.mesh.buffers[u].name=="tangent0")o=true;if(this.mesh.buffers[u].exclude)continue;if(this.mesh.buffers[u].size>1){s.push("attribute vec"+this.mesh.buffers[u].size+" "+this.mesh.buffers[u].name+";\n")}else{s.push("attribute float "+this.mesh.buffers[u].name+";\n")}if(this.mesh.buffers[u].name=="UV")UV=true;if(this.mesh.buffers[u].name=="color")r=true;if(this.mesh.buffers[u].name=="joints1")joints1=this.mesh.buffers[u];if(this.mesh.buffers[u].name=="joints2")joints2=this.mesh.buffers[u]}if(this.mesh.framePositions.length>1){var a=true;s.push("attribute vec3 position2;\n");s.push("attribute vec3 normal2;\n");s.push("uniform float framesBlend;\n");if(o)s.push("attribute vec3 tangent2;\n")}if(o)s.push("attribute vec3 tangent;\n");s.push("uniform mediump mat4 worldView;\n");s.push("uniform mediump mat4 projection;\n");s.push("uniform mediump mat4 worldInverseTranspose;\n");s.push("uniform mediump mat4 envMat;\n");s.push("uniform float cascadeLevel;\n");for(var u=0;u<i.length;u++){if(i[u].type==e.L_OFF)continue;s.push("uniform vec3 lightpos"+u+";\n");s.push("uniform mediump vec3 lightdir"+u+";\n");if((i[u].type==e.L_SPOT||i[u].type==e.L_DIR)&&i[u].getCastShadows()){s.push("uniform mediump mat4 lightmat"+u+";\n");s.push("varying vec4 spotcoord"+u+";\n")}}s.push("varying vec3 eyevec;\n");for(var u=0;u<i.length;u++){if(i[u].type==e.L_OFF)continue;s.push("varying vec3 lightvec"+u+";\n");s.push("varying float lightdist"+u+";\n")}if(this.mesh.joints&&this.mesh.joints.length>0){s.push("uniform vec4 jointMat["+3*this.mesh.joints.length+"];\n")}if(this.material)s.push(this.material.getVertexVarying(s));s.push("varying vec3 n;\n");s.push("varying vec3 t;\n");if(r)s.push("varying vec4 vcolor;\n");s.push("varying vec4 UVCoord;\n");s.push("varying vec3 OBJCoord;\n");if(this.shaderVertexInjection){s.push(this.shaderVertexInjection)}s.push("void main(void)\n");s.push("{\n");if(r)s.push("vcolor=color;\n");if(UV)s.push("UVCoord=UV;\n");else s.push("UVCoord=vec4(0.0,0.0,0.0,0.0);\n");s.push("OBJCoord = position;\n");s.push("vec3 tang;\n");s.push("vec4 pos = vec4(0.0, 0.0, 0.0, 1.0);\n");s.push("vec4 norm = vec4(0.0, 0.0, 0.0, 1.0);\n");if(o)s.push("vec4 tang4 = vec4(0.0, 0.0, 0.0, 1.0);\n");if(joints1){if(joints1.size==1){s.push("pos += vec4(dot(jointMat[int(3.0*joints1)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints1+1.0)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints1+2.0)],vec4(position,1.0)),1.0)*weights1;\n");s.push("norm += vec4(dot(jointMat[int(3.0*joints1)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints1+1.0)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints1+2.0)].xyz,normal),1.0)*weights1;\n");if(o)s.push("tang4 += vec4(dot(jointMat[int(3.0*joints1)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints1+1.0)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints1+2.0)].xyz,tangent),1.0)*weights1;\n")}else{for(var u=0;u<joints1.size;u++){s.push("pos += vec4(dot(jointMat[int(3.0*joints1["+u+"])],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints1["+u+"]+1.0)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints1["+u+"]+2.0)],vec4(position,1.0)),1.0)*weights1["+u+"];\n");s.push("norm += vec4(dot(jointMat[int(3.0*joints1["+u+"])].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints1["+u+"]+1.0)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints1["+u+"]+2.0)].xyz,normal),1.0)*weights1["+u+"];\n");if(o)s.push("tang4 += vec4(dot(jointMat[int(3.0*joints1["+u+"])].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints1["+u+"]+1.0)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints1["+u+"]+2.0)].xyz,tangent),1.0)*weights1["+u+"];\n")}}if(joints2){if(joints2.size==1){s.push("pos += vec4(dot(jointMat[int(3.0*joints2)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints2+1.0)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints2+2.0)],vec4(position,1.0)),1.0)*weights2;\n");s.push("norm += vec4(dot(jointMat[int(3.0*joints2)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints2+1.0)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints2+2.0)].xyz,normal),1.0)*weights2;\n");if(o)s.push("tang4 += vec4(dot(jointMat[int(3.0*joints2)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints2+1.0)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints2+2.0)].xyz,tangent),1.0)*weights2;\n")}else{for(var u=0;u<joints2.size;u++){s.push("pos += vec4(dot(jointMat[int(3.0*joints2["+u+"])],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints2["+u+"]+1.0)],vec4(position,1.0)),\n"+"              dot(jointMat[int(3.0*joints2["+u+"]+2.0)],vec4(position,1.0)),1.0)*weights2["+u+"];\n");s.push("norm += vec4(dot(jointMat[int(3.0*joints2["+u+"])].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints2["+u+"]+1.0)].xyz,normal),\n"+"               dot(jointMat[int(3.0*joints2["+u+"]+2.0)].xyz,normal),1.0)*weights2["+u+"];\n");if(o)s.push("tang4 += vec4(dot(jointMat[int(3.0*joints2["+u+"])].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints2["+u+"]+1.0)].xyz,tangent),\n"+"               dot(jointMat[int(3.0*joints2["+u+"]+2.0)].xyz,tangent),1.0)*weights2["+u+"];\n")}}}for(var u=0;u<i.length;u++){if(i[u].type==e.L_OFF)continue;if((i[u].type==e.L_SPOT||i[u].type==e.L_DIR)&&i[u].getCastShadows()){s.push("spotcoord"+u+"=lightmat"+u+"*vec4(pos.xyz,1.0);\n")}}if(this.shaderVertexInjection&&this.shaderVertexInjection.indexOf("GLGE_Position")>-1){s.push("pos=GLGE_Position(vec4(pos.xyz, 1.0));\n")}s.push("pos = worldView * vec4(pos.xyz, 1.0);\n");s.push("norm = worldInverseTranspose * vec4(norm.xyz, 1.0);\n");if(o)s.push("tang = (worldInverseTranspose*vec4(tang4.xyz,1.0)).xyz;\n")}else{if(a){s.push("vec4 pos4=vec4(mix(position,position2,framesBlend),1.0);\n")}else{s.push("vec4 pos4=vec4(position,1.0);\n")}if(this.shaderVertexInjection&&this.shaderVertexInjection.indexOf("GLGE_Position")>-1){s.push("pos4=GLGE_Position(pos4);\n")}for(var u=0;u<i.length;u++){if(i[u].type==e.L_OFF)continue;if((i[u].type==e.L_SPOT||i[u].type==e.L_DIR)&&i[u].getCastShadows()){s.push("spotcoord"+u+"=lightmat"+u+"*pos4;\n")}}s.push("pos = worldView * pos4;\n");if(a){s.push("norm = worldInverseTranspose * vec4(mix(normal,normal2,framesBlend), 1.0);\n");if(o)s.push("tang = (worldInverseTranspose*vec4(mix(tangent,tangent2,framesBlend),1.0)).xyz;\n")}else{s.push("norm = worldInverseTranspose * vec4(normal, 1.0);\n");if(o)s.push("tang = (worldInverseTranspose*vec4(tangent,1.0)).xyz;\n")}}s.push("eyevec = -pos.xyz;\n");if(o)s.push("t = normalize(tang);");else s.push("t = vec3(0.0,0.0,0.0);");s.push("n = normalize(norm.rgb);");for(var u=0;u<i.length;u++){if(i[u].type==e.L_OFF)continue;if(i[u].getType()==e.L_DIR){s.push("lightvec"+u+" = -lightdir"+u+";\n")}else{s.push("lightvec"+u+" = pos.xyz-lightpos"+u+";\n")}s.push("lightdist"+u+" = length(lightpos"+u+".xyz-pos.xyz);\n")}if(this.material)s.push(this.material.getLayerCoords(this.shaderVertexInjection));s.push("gl_Position = projection * pos;\n");s.push("gl_PointSize="+this.pointSize.toFixed(5)+";\n");s.push("}\n");s=s.join("");fragStr=this.material.getFragmentShader(i,r,this.shaderVertexInjection,false);if(this.shadowAlpha){t=this.material.getFragmentShader(i,r,this.shaderVertexInjection,true)}else{t=this.shfragStr}this.GLFragmentShaderNormal=e.getGLShader(n,n.FRAGMENT_SHADER,this.nfragStr);this.GLFragmentShaderShadow=e.getGLShader(n,n.FRAGMENT_SHADER,t);this.GLFragmentShaderPick=e.getGLShader(n,n.FRAGMENT_SHADER,this.pkfragStr);this.GLFragmentShader=e.getGLShader(n,n.FRAGMENT_SHADER,fragStr);this.GLVertexShader=e.getGLShader(n,n.VERTEX_SHADER,s+"//default");this.GLVertexShaderShadow=e.getGLShader(n,n.VERTEX_SHADER,s+"//shadow");this.GLVertexShaderPick=e.getGLShader(n,n.VERTEX_SHADER,s+"//pick");this.GLVertexShaderNormal=e.getGLShader(n,n.VERTEX_SHADER,s+"//normal");this.GLShaderProgramPick=e.getGLProgram(n,this.GLVertexShaderPick,this.GLFragmentShaderPick);this.GLShaderProgramNormal=e.getGLProgram(n,this.GLVertexShaderNormal,this.GLFragmentShaderNormal);this.GLShaderProgramShadow=e.getGLProgram(n,this.GLVertexShaderShadow,this.GLFragmentShaderShadow);this.GLShaderProgram=e.getGLProgram(n,this.GLVertexShaderShadow,this.GLFragmentShader);if(!n.getProgramParameter(this.GLShaderProgram,n.LINK_STATUS)){if(this.material.fallback){this.material=this.material.fallback;this.multimaterial.material=this.material;this.GLGenerateShader(n)}}};e.Object.prototype.createShaders=function(e){if(this.gl){this.mesh=e.mesh;this.material=e.material;this.multimaterial=e;this.GLGenerateShader(this.gl);e.GLShaderProgramPick=this.GLShaderProgramPick;e.GLShaderProgramShadow=this.GLShaderProgramShadow;e.GLShaderProgram=this.GLShaderProgram}};e.Object.prototype.GLUniforms=function(t,n,r){var i;switch(n){case e.RENDER_DEFAULT:i=this.GLShaderProgram;e.setUniform(t,"1i",e.getUniformLocation(t,i,"emitpass"),0);break;case e.RENDER_EMIT:i=this.GLShaderProgram;e.setUniform(t,"1i",e.getUniformLocation(t,i,"emitpass"),1);break;case e.RENDER_SHADOW:i=this.GLShaderProgramShadow;e.setUniform(t,"1i",e.getUniformLocation(t,i,"shadowtype"),1);break;case e.RENDER_DEPTH:i=this.GLShaderProgramShadow;e.setUniform(t,"1f",e.getUniformLocation(t,i,"cascadeLevel"),2);e.setUniform(t,"1i",e.getUniformLocation(t,i,"shadowtype"),0);break;case e.RENDER_NORMAL:i=this.GLShaderProgramNormal;break;case e.RENDER_PICK:i=this.GLShaderProgramPick;var s=r>>16&255;var o=r>>8&255;var u=r&255;e.setUniform3(t,"3f",e.getUniformLocation(t,i,"pickcolor"),u/255,o/255,s/255);break}t.lineWidth(this.lineWidth);for(var a in this.uniforms){var f=this.uniforms[a];if(f.type=="Matrix4fv"){e.setUniformMatrix(t,"Matrix4fv",e.getUniformLocation(t,i,a),false,f.value)}else{e.setUniform(t,f.type,e.getUniformLocation(t,i,a),f.value)}}if(!i.caches)i.caches={};if(!i.glarrays)i.glarrays={};var l=i.caches;var c=i.glarrays;var h=t.scene;var p=h.camera;if(l.far!=p.far){e.setUniform(t,"1i",e.getUniformLocation(t,i,"far"),p.far);l.far=p.far}if(n==e.RENDER_DEFAULT||n==e.RENDER_EMIT){if(l.ambientColor!=h.ambientColor){var d=h.ambientColor;e.setUniform3(t,"3f",e.getUniformLocation(t,i,"amb"),d.r,d.g,d.b);l.ambientColor=d}if(l.fogFar!=h.fogFar){e.setUniform(t,"1f",e.getUniformLocation(t,i,"fogfar"),h.fogFar);l.fogFar=h.fogFar}if(l.fogNear!=h.fogNear){e.setUniform(t,"1f",e.getUniformLocation(t,i,"fognear"),h.fogNear);l.fogNear=h.fogNear}if(l.fogType!=h.fogType){e.setUniform(t,"1i",e.getUniformLocation(t,i,"fogtype"),h.fogType);l.fogType=h.fogType}if(l.fogType!=h.fogcolor){e.setUniform3(t,"3f",e.getUniformLocation(t,i,"fogcolor"),h.fogColor.r,h.fogColor.g,h.fogColor.b);l.fogcolor=h.fogcolor}}if(l.meshBlendFactor!=this.meshBlendFactor){e.setUniform(t,"1f",e.getUniformLocation(t,i,"framesBlend"),this.meshBlendFactor);l.meshBlendFactor=this.meshBlendFactor}var v=p.getViewMatrix();var m=P=this.getModelMatrix();if(!l.mvMatrix)l.mvMatrix={cameraMatrix:null,modelMatrix:null};var g=l.mvMatrix;if(g.cameraMatrix!=v||g.modelMatrix!=P){if(!this.caches.mvMatrix)this.caches.mvMatrix=e.mulMat4(v,P);mvMatrix=this.caches.mvMatrix;if(this.mesh.joints){mvMatrix=v}var y=e.getUniformLocation(t,i,"worldView");var b=e.transposeMat4(mvMatrix);if(!c.mvMatrix){c.mvMatrixT=new Float32Array(b)}else{e.mat4gl(b,c.mvMatrixT)}c.mvMatrix=mvMatrix;e.setUniformMatrix(t,"Matrix4fv",y,false,i.glarrays.mvMatrixT);var w=e.getUniformLocation(t,i,"envMat");if(w){if(!this.caches.envMat){var E=e.inverseMat4(v);E[3]=0;E[7]=0;E[11]=0;this.caches.envMat=E}E=this.caches.envMat;b=e.transposeMat4(E);if(!i.glarrays.envMat){c.envMatT=new Float32Array(b)}else{e.mat4gl(b,c.envMatT)}c.envMat=E;e.setUniformMatrix(t,"Matrix4fv",w,false,c.envMatT)}if(!this.caches.normalMatrix){var S=e.inverseMat4(mvMatrix);this.caches.normalMatrix=S}S=this.caches.normalMatrix;var x=e.getUniformLocation(t,i,"worldInverseTranspose");if(!c.normalMatrix)c.normalMatrix=new Float32Array(S);else e.mat4gl(S,c.normalMatrix);e.setUniformMatrix(t,"Matrix4fv",x,false,c.normalMatrix);var T=e.getUniformLocation(t,i,"view");b=e.transposeMat4(v);if(!c.cameraMatrix){c.cameraMatrixT=new Float32Array(b)}else{e.mat4gl(b,c.cameraMatrixT)}c.cameraMatrix=v;e.setUniformMatrix(t,"Matrix4fv",T,false,c.cameraMatrixT);g.cameraMatrix=v;g.modelMatrix=P}var N=e.getUniformLocation(t,i,"projection");b=e.transposeMat4(p.getProjectionMatrix());if(!c.pMatrix){c.pMatrixT=new Float32Array(b)}else{e.mat4gl(b,c.pMatrixT)}c.pMatrix=p.getProjectionMatrix();e.setUniformMatrix(t,"Matrix4fv",N,false,c.pMatrixT);if(n==e.RENDER_DEFAULT||n==e.RENDER_SHADOW||n==e.RENDER_DEPTH||n==e.RENDER_EMIT){var C,k;var L=t.lights;if(!l.lights)l.lights=[];if(!c.lights)c.lights=[];if(!this.caches.lights)this.caches.lights=[];var A=l.lights;for(var O=0;O<L.length;O++){if(L[O].type==e.L_OFF)continue;if(!A[O])A[O]={modelMatrix:null,cameraMatrix:null};if(A[O].modelMatrix!=P||A[O].cameraMatrix!=v){if(!this.caches.lights[O])this.caches.lights[O]={};if(!this.caches.lights[O].pos)this.caches.lights[O].pos=e.mulMat4Vec4(e.mulMat4(v,L[O].getModelMatrix()),[0,0,0,1]);C=this.caches.lights[O].pos;e.setUniform3(t,"3f",e.getUniformLocation(t,i,"lightpos"+O),C[0],C[1],C[2]);if(!this.caches.lights[O].lpos)this.caches.lights[O].lpos=e.mulMat4Vec4(e.mulMat4(v,L[O].getModelMatrix()),[0,0,1,1]);k=this.caches.lights[O].lpos;e.setUniform3(t,"3f",e.getUniformLocation(t,i,"lightdir"+O),k[0]-C[0],k[1]-C[1],k[2]-C[2]);if(L[O].s_cache){var M=e.mulMat4(L[O].s_cache.smatrix,P);if(!c.lights[O])c.lights[O]=new Float32Array(M);else e.mat4gl(M,c.lights[O]);e.setUniformMatrix(t,"Matrix4fv",e.getUniformLocation(t,i,"lightmat"+O),true,c.lights[O]);e.setUniform2(t,"2f",e.getUniformLocation(t,i,"shadowoffset"+O),L[O].s_cache.pmatrix[3],L[O].s_cache.pmatrix[7]);A[O].modelMatrix=P;A[O].cameraMatrix=v}else{A[O].modelMatrix=P;A[O].cameraMatrix=v}}}}if(this.mesh.joints){if(!l.joints)l.joints=[];if(!c.joints)c.joints=[];if(!c.jointsT)c.jointsT=[];if(!c.jointsinv)c.jointsinv=[];if(!c.jointsCombined||c.jointsCombined.length!=this.mesh.joints.length*12)c.jointsCombined=new Float32Array(this.mesh.joints.length*12);var _=l.joints;var D=e.identMatrix();for(O=0;O<this.mesh.joints.length;O++){if(!_[O])_[O]={modelMatrix:null,invBind:null};if(typeof this.mesh.joints[O]=="string"){if(!this.bones)this.bones=this.skeleton.getNames();if(this.bones){var P=this.bones[this.mesh.joints[O]].getModelMatrix()}}else{var P=this.mesh.joints[O].getModelMatrix()}var H=this.mesh.invBind[O];if(_[O].modelMatrix!=P||_[O].invBind!=H){var B=e.mulMat4(P,H);if(!c.joints[O]){c.jointsT[O]=new Float32Array(e.transposeMat4(B))}else{e.mat4gl(e.transposeMat4(B),c.jointsT[O])}c.joints[O]=B;if(!c.jointsinv[O])c.jointsinv[O]=new Float32Array(e.inverseMat4(B));else e.mat4gl(e.inverseMat4(B),c.jointsinv[O]);var j=c.jointsT[O];var F=c.jointsCombined;F[O*12]=j[0];F[O*12+1]=j[4];F[O*12+2]=j[8];F[O*12+3]=j[12];F[O*12+4]=j[1];F[O*12+5]=j[5];F[O*12+6]=j[9];F[O*12+7]=j[13];F[O*12+8]=j[2];F[O*12+9]=j[6];F[O*12+10]=j[10];F[O*12+11]=j[14];_[O].modelMatrix=P;_[O].invBind=H}}t.uniform4fv(e.getUniformLocation(t,i,"jointMat"),c.jointsCombined)}if(this.material&&(n==e.RENDER_DEFAULT||n==e.RENDER_EMIT||this.shadowAlpha)&&t.scene.lastMaterial!=this.material){this.material.textureUniforms(t,i,L,this,n);t.scene.lastMaterial=this.material}};e.Object.prototype.GLRender=function(t,n,r,i,s){if(!t)return;if(!this.gl)this.GLInit(t);if(this.lookAt)this.Lookat(this.lookAt);if(n==e.RENDER_DEFAULT){if(this.animation)this.animate()}if(!this.renderCaches[n])this.renderCaches[n]={};var o=t.scene.camera.getViewMatrix();var u=this.getModelMatrix();if(this.renderCaches[n].cameraMatrix!=o||this.renderCaches[n].modelMatrix!=u){this.renderCaches[n]={};this.renderCaches[n].cameraMatrix=o;this.renderCaches[n].modelMatrix=u}this.caches=this.renderCaches[n];var a;if(i==undefined){var f=0;var l=this.multimaterials.length}else{var f=i;var l=i+1}for(var c=f;c<l;c++){if(this.multimaterials[c].lods.length>1&&!a){var h=t.scene.camera.getPosition();var p=this.getPosition();var d=e.lengthVec3([h.x-p.x,h.y-p.y,h.z-p.z]);d=e.mulMat4Vec4(t.scene.camera.getProjectionMatrix(),[this.getBoundingVolume().getSphereRadius(),0,-d,1]);a=d[0]/d[3]*t.scene.renderer.canvas.width}var v=this.multimaterials[c].getLOD(a);if(v.mesh&&v.mesh.loaded){if(n==e.RENDER_NULL){if(v.material)v.material.registerPasses(t,this);break}if(!v.GLShaderProgram){this.createShaders(v)}else{this.GLShaderProgramPick=v.GLShaderProgramPick;this.GLShaderProgramShadow=v.GLShaderProgramShadow;this.GLShaderProgram=v.GLShaderProgram}this.mesh=v.mesh;this.material=v.material;var m;switch(this.drawType){case e.DRAW_LINES:m=t.LINES;break;case e.DRAW_POINTS:m=t.POINTS;break;case e.DRAW_LINELOOPS:m=t.LINE_LOOP;break;case e.DRAW_LINESTRIPS:m=t.LINE_STRIP;break;case e.DRAW_TRIANGLESTRIP:m=t.TRIANGLE_STRIP;break;default:m=t.TRIANGLES;break}switch(n){case e.RENDER_DEFAULT:case e.RENDER_EMIT:if(t.program!=this.GLShaderProgram){t.useProgram(this.GLShaderProgram);t.program=this.GLShaderProgram}this.mesh.GLAttributes(t,this.GLShaderProgram,this.meshFrame1,this.meshFrame2);break;case e.RENDER_SHADOW:case e.RENDER_DEPTH:if(t.program!=this.GLShaderProgramShadow){t.useProgram(this.GLShaderProgramShadow,this.meshFrame1,this.meshFrame2);t.program=this.GLShaderProgramShadow}if(!s)s=t.scene.camera.getFar();e.setUniform(t,"1f",e.getUniformLocation(t,this.GLShaderProgramShadow,"distance"),s);this.mesh.GLAttributes(t,this.GLShaderProgramShadow,this.meshFrame1,this.meshFrame2);break;case e.RENDER_NORMAL:if(t.program!=this.GLShaderProgramNormal){t.useProgram(this.GLShaderProgramNormal);t.program=this.GLShaderProgramNormal}this.mesh.GLAttributes(t,this.GLShaderProgramNormal,this.meshFrame1,this.meshFrame2);break;case e.RENDER_PICK:if(t.program!=this.GLShaderProgramPick){t.useProgram(this.GLShaderProgramPick);t.program=this.GLShaderProgramPick}this.mesh.GLAttributes(t,this.GLShaderProgramPick,this.meshFrame1,this.meshFrame2);m=t.TRIANGLES;break}this.GLUniforms(t,n,r);switch(this.mesh.windingOrder){case e.Mesh.WINDING_ORDER_UNKNOWN:if(t.scene.renderer.cullFaces){t.cullFace(t.scene.mirror?t.FRONT:t.BACK);t.enable(t.CULL_FACE)}else{t.disable(t.CULL_FACE)}break;case e.Mesh.WINDING_ORDER_CLOCKWISE:t.cullFace(t.scene.mirror?t.FRONT:t.BACK);t.enable(t.CULL_FACE);break;case e.Mesh.WINDING_ORDER_COUNTER:t.cullFace(t.scene.mirror?t.BACK:t.FRONT);t.enable(t.CULL_FACE);default:break}if(n==e.RENDER_PICK)t.disable(t.CULL_FACE);if(this.noDepthMask)t.depthMask(false);if(this.mesh.GLfaces){t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.mesh.GLfaces);t.drawElements(m,this.mesh.GLfaces.numItems,t.UNSIGNED_SHORT,0)}else{t.drawArrays(m,0,this.mesh.positions.length/3)}t.depthMask(true);switch(this.mesh.windingOrder){case e.Mesh.WINDING_ORDER_UNKNOWN:if(t.scene.renderer.cullFaces)t.enable(t.CULL_FACE);break;case e.Mesh.WINDING_ORDER_COUNTER:t.cullFace(t.BACK);default:break}var g=this.matrix;var y=this.caches;this.matrix=g;this.caches=y}}}})(GLGE);(function(e){e.Text=function(t){this.canvas=document.createElement("canvas");this.scaleCanvas=document.createElement("canvas");this.color={r:1,g:1,b:1};e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.Text);e.augment(e.Animatable,e.Text);e.augment(e.QuickNotation,e.Text);e.augment(e.JSONLoader,e.Text);e.Text.prototype.className="Text";e.Text.prototype.zTrans=true;e.Text.prototype.canvas=null;e.Text.prototype.aspect=1;e.Text.prototype.color=null;e.Text.prototype.text="";e.Text.prototype.font="Times";e.Text.prototype.size=100;e.Text.prototype.pickType=e.TEXT_TEXTPICK;e.Text.prototype.pickable=true;e.Text.prototype.alpha=1;e.Text.prototype.dirty=true;e.Text.prototype.getPickType=function(){return this.pickType};e.Text.prototype.setPickType=function(e){this.pickType=e;return this};e.Text.prototype.getFont=function(){return this.size};e.Text.prototype.setFont=function(e){this.font=e;this.dirty=true;return this};e.Text.prototype.getSize=function(){return this.size};e.Text.prototype.setSize=function(e){this.size=e;this.dirty=true;return this};e.Text.prototype.getText=function(){return this.text};e.Text.prototype.setText=function(e){this.text=e;this.dirty=true;return this};e.Text.prototype.setColor=function(t){t=e.colorParse(t);this.color={r:t.r,g:t.g,b:t.b};return this};e.Text.prototype.setColorR=function(e){this.color.r=e;return this};e.Text.prototype.setColorG=function(e){this.color.g=e;return this};e.Text.prototype.setColorB=function(e){this.color.b=e;return this};e.Text.prototype.getColor=function(){return this.color;return this};e.Text.prototype.setAlpha=function(e){this.alpha=e;return this};e.Text.prototype.getAlpha=function(){return this.alpha};e.Text.prototype.setZtransparent=function(e){this.zTrans=e;return this};e.Text.prototype.isZtransparent=function(){return this.zTrans};e.Text.prototype.GLGenerateShader=function(t){if(this.GLShaderProgram)t.deleteProgram(this.GLShaderProgram);var n="";n+="attribute vec3 position;\n";n+="attribute vec2 uvcoord;\n";n+="varying vec2 texcoord;\n";n+="uniform mat4 Matrix;\n";n+="uniform mat4 PMatrix;\n";n+="varying vec4 pos;\n";n+="void main(void){\n";n+="texcoord=uvcoord;\n";n+="pos = Matrix * vec4(position,1.0);\n";n+="gl_Position = PMatrix * pos;\n";n+="}\n";var r="#ifdef GL_ES\nprecision highp float;\n#endif\n";r=r+"uniform sampler2D TEXTURE;\n";r=r+"varying vec2 texcoord;\n";r=r+"uniform mat4 Matrix;\n";r=r+"varying vec4 pos;\n";r=r+"uniform float far;\n";r=r+"uniform bool depthrender;\n";r=r+"uniform float distance;\n";r=r+"uniform int picktype;\n";r=r+"uniform vec3 pickcolor;\n";r=r+"uniform vec3 color;\n";r=r+"uniform float alpha;\n";r=r+"void main(void){\n";r=r+"float ob=pow(min(1.0,abs(dot(normalize(Matrix[2].rgb),vec3(0.0,0.0,1.0)))*2.0),1.5);\n";r=r+"float a=texture2D(TEXTURE,texcoord).a*alpha*ob;\n";r=r+"if(picktype=="+e.TEXT_BOXPICK+"){gl_FragColor = vec4(pickcolor,1.0);}";r=r+"else if(picktype=="+e.TEXT_TEXTPICK+"){if(alpha<1.0) discard; gl_FragColor = vec4(pickcolor,alpha);}";r=r+"else{gl_FragColor = vec4(color.rgb,a);};\n";r=r+"if (depthrender) { if(a<0.5) discard; float depth = gl_FragCoord.z / gl_FragCoord.w;\n";r=r+"vec4 rgba=fract(depth/distance * vec4(16777216.0, 65536.0, 256.0, 1.0));\n";r=r+"gl_FragColor=rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);}\n";r=r+"}\n";this.GLFragmentShader=t.createShader(t.FRAGMENT_SHADER);this.GLVertexShader=t.createShader(t.VERTEX_SHADER);t.shaderSource(this.GLFragmentShader,r);t.compileShader(this.GLFragmentShader);if(!t.getShaderParameter(this.GLFragmentShader,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(this.GLFragmentShader));return}t.shaderSource(this.GLVertexShader,n);t.compileShader(this.GLVertexShader);if(!t.getShaderParameter(this.GLVertexShader,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(this.GLVertexShader));return}this.GLShaderProgram=t.createProgram();t.attachShader(this.GLShaderProgram,this.GLVertexShader);t.attachShader(this.GLShaderProgram,this.GLFragmentShader);t.linkProgram(this.GLShaderProgram)};e.Text.prototype.GLInit=function(e){this.gl=e;this.createPlane(e);this.GLGenerateShader(e);this.glTexture=e.createTexture();this.dirty=true};e.Text.prototype.updateCanvas=function(e){var t=this.canvas;t.width=1;t.height=this.size*1.2;var n=t.getContext("2d");n.font=this.size+"px "+this.font;t.width=n.measureText(this.text).width;t.height=this.size*1.2;n=t.getContext("2d");n.textBaseline="top";n.font=(this.extra||"")+" "+this.size+"px "+this.font;this.aspect=t.width/t.height;n.fillText(this.text,0,0);var r=Math.pow(2,Math.ceil(Math.log(t.height))/Math.log(2));var i=Math.pow(2,Math.ceil(Math.log(t.width))/Math.log(2));this.scaleCanvas.height=r;this.scaleCanvas.width=i;this.scaleContext=this.scaleCanvas.getContext("2d");this.scaleContext.clearRect(0,0,i,r);this.scaleContext.drawImage(t,0,0,i,r);e.bindTexture(e.TEXTURE_2D,this.glTexture);try{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.scaleCanvas)}catch(s){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.scaleCanvas,null)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR_MIPMAP_LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,null);this.dirty=false};e.Text.prototype.GLRender=function(t,n,r){if(!this.gl){this.GLInit(t)}if(this.dirty)this.updateCanvas(t);if(n==e.RENDER_DEFAULT||n==e.RENDER_PICK||n==e.RENDER_SHADOW){if(this.lookAt)this.Lookat(this.lookAt);if(t.program!=this.GLShaderProgram){t.useProgram(this.GLShaderProgram);t.program=this.GLShaderProgram}var i;for(var s=0;s<8;s++)t.disableVertexAttribArray(s);i=e.getAttribLocation(t,this.GLShaderProgram,"position");t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer);t.enableVertexAttribArray(i);t.vertexAttribPointer(i,this.posBuffer.itemSize,t.FLOAT,false,0,0);i=e.getAttribLocation(t,this.GLShaderProgram,"uvcoord");t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer);t.enableVertexAttribArray(i);t.vertexAttribPointer(i,this.uvBuffer.itemSize,t.FLOAT,false,0,0);t.activeTexture(t["TEXTURE0"]);t.bindTexture(t.TEXTURE_2D,this.glTexture);e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"TEXTURE"),0);if(!r)r=0;var o=r>>16&255;var u=r>>8&255;var a=r&255;e.setUniform3(t,"3f",e.getUniformLocation(t,this.GLShaderProgram,"pickcolor"),a/255,u/255,o/255);if(n==e.RENDER_PICK){e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"picktype"),this.pickType)}else{e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"picktype"),0)}var f=t.scene.camera.getFar();e.setUniform(t,"1f",e.getUniformLocation(t,this.GLShaderProgram,"distance"),f);if(n==e.RENDER_SHADOW){e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"depthrender"),1)}else{e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"depthrender"),0)}if(!this.GLShaderProgram.glarrays)this.GLShaderProgram.glarrays={};var l=this.size/100;var c=e.mulMat4(t.scene.camera.getViewMatrix(),e.mulMat4(this.getModelMatrix(),e.scaleMatrix(this.aspect*l,l,l)));var h=e.getUniformLocation(t,this.GLShaderProgram,"Matrix");if(!this.GLShaderProgram.glarrays.mMatrix)this.GLShaderProgram.glarrays.mMatrix=new Float32Array(c);else e.mat4gl(c,this.GLShaderProgram.glarrays.mMatrix);e.setUniformMatrix(t,"Matrix4fv",h,true,this.GLShaderProgram.glarrays.mMatrix);var h=e.getUniformLocation(t,this.GLShaderProgram,"PMatrix");if(!this.GLShaderProgram.glarrays.pMatrix)this.GLShaderProgram.glarrays.pMatrix=new Float32Array(t.scene.camera.getProjectionMatrix());else e.mat4gl(t.scene.camera.getProjectionMatrix(),this.GLShaderProgram.glarrays.pMatrix);e.setUniformMatrix(t,"Matrix4fv",h,true,this.GLShaderProgram.glarrays.pMatrix);var p=e.getUniformLocation(t,this.GLShaderProgram,"far");e.setUniform(t,"1f",p,t.scene.camera.getFar());var d=e.getUniformLocation(t,this.GLShaderProgram,"alpha");e.setUniform(t,"1f",d,this.alpha);e.setUniform3(t,"3f",e.getUniformLocation(t,this.GLShaderProgram,"color"),this.color.r,this.color.g,this.color.b);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.GLfaces);t.drawElements(t.TRIANGLES,this.GLfaces.numItems,t.UNSIGNED_SHORT,0);t.scene.lastMaterial=null}};e.Text.prototype.createPlane=function(e){if(!this.posBuffer)this.posBuffer=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.posBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),e.STATIC_DRAW);this.posBuffer.itemSize=3;this.posBuffer.numItems=4;if(!this.uvBuffer)this.uvBuffer=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.uvBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),e.STATIC_DRAW);this.uvBuffer.itemSize=2;this.uvBuffer.numItems=4;if(!this.GLfaces)this.GLfaces=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.GLfaces);e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array([2,1,0,0,3,2]),e.STATIC_DRAW);this.GLfaces.itemSize=1;this.GLfaces.numItems=6}})(GLGE);(function(e){e.Renderer=function(t,n,r){this.viewport=[];this.canvas=t;if(!r)r={alpha:true,depth:true,stencil:true,antialias:true,premultipliedAlpha:true};try{this.gl=t.getContext("experimental-webgl",r)}catch(i){}try{if(!this.gl)this.gl=t.getContext("webgl",r)}catch(i){}if(!this.gl){console.log("GLGE err:",typeof globalNoWebGLError=="undefined");if(!n&&typeof globalNoWebGLError=="undefined"){var s=document.createElement("div");s.setAttribute("style","position: absolute; top: 10px; left: 10px; font-family: sans-serif; font-size: 14px; padding: 10px;background-color: #fcffcb;color: #800; width: 200px; border:2px solid #f00");s.innerHTML="WebGL compatible Browser Required(Firefox 4 or Chrome 9 and up) or you may need to update your graphics card driver.";document.getElementsByTagName("body")[0].appendChild(s);throw"cannot create webgl context"}else{n();throw"cannot create webgl context"}}try{this.gl.canvas=t}catch(i){}if(!this.gl.getProgramParameter){this.gl.getProgramParameter=this.gl.getProgrami}if(!this.gl.getShaderParameter){this.gl.getShaderParameter=this.gl.getShaderi}this.gl.uniformMatrix4fvX=this.gl.uniformMatrix4fv;this.gl.uniformMatrix4fv=function(t,n,r){if(!n){this.uniformMatrix4fvX(t,false,r)}else{e.mat4gl(e.transposeMat4(r),r);this.uniformMatrix4fvX(t,false,r)}};var o=this.gl;o.af=o.getExtension("MOZ_EXT_texture_filter_anisotropic")||o.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||o.getExtension("EXT_texture_filter_anisotropic");this.gl.clearDepth(1);this.gl.clearStencil(0);this.gl.enable(this.gl.DEPTH_TEST);this.gl.depthFunc(this.gl.LEQUAL);this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ZERO,this.gl.ONE)};e.augment(e.QuickNotation,e.Renderer);e.Renderer.prototype.gl=null;e.Renderer.prototype.scene=null;e.C_STENCIL=1;e.C_DEPTH=2;e.C_COLOR=4;e.C_ALL=7;e.Renderer.prototype.clearType=e.C_ALL;e.Renderer.prototype.setViewportWidth=function(e){this.viewport[0]=e;return this};e.Renderer.prototype.setViewportHeight=function(e){this.viewport[1]=e;return this};e.Renderer.prototype.setViewportOffsetX=function(e){this.viewport[2]=e;return this};e.Renderer.prototype.setViewportOffsetY=function(e){this.viewport[3]=e;return this};e.Renderer.prototype.clearViewport=function(){this.viewport=[]};e.Renderer.prototype.getViewportWidth=function(){if(this.viewport.length>0){return this.viewport[0]}else{return this.canvas.width}};e.Renderer.prototype.getViewportHeight=function(){if(this.viewport.length>0){return this.viewport[1]}else{return this.canvas.height}};e.Renderer.prototype.getViewportOffsetX=function(){if(this.viewport.length>0){return this.viewport[2]}else{return 0}};e.Renderer.prototype.getViewportOffsetY=function(){if(this.viewport.length>0){return this.viewport[3]}else{return 0}};e.Renderer.prototype.setClearType=function(e){this.clearType=e;return this};e.Renderer.prototype.getClearType=function(){return this.clearType};e.Renderer.prototype.GLClear=function(){var t=this.gl;var n=this.clearType;var r=0;if((n&e.C_COLOR)==e.C_COLOR){r=r|t.COLOR_BUFFER_BIT}if((n&e.C_DEPTH)==e.C_DEPTH){r=r|t.DEPTH_BUFFER_BIT}if((n&e.C_STENCIL)==e.C_STENCIL){r=r|t.STENCIL_BUFFER_BIT}t.clear(r)};e.Renderer.prototype.getScene=function(){return this.scene};e.Renderer.prototype.setScene=function(e){e.renderer=this;this.scene=e;if(!e.gl)e.GLInit(this.gl);e.camera.updateMatrix();return this};e.Renderer.prototype.render=function(){if(this.transitonFilter){var e=+(new Date);if(e<this.transStarted+this.transDuration){this.GLRenderTransition((e-this.transStarted)/this.transDuration);return}if(this.transStarted==1){this.GLRenderTransition(0);this.transStarted=+(new Date)}}if(this.cullFaces)this.gl.enable(this.gl.CULL_FACE);if(this.scene)this.scene.render(this.gl);if(!this.rendered&&this.scene){this.scene.render(this.gl);this.rendered=true}};e.Renderer.prototype.transitionTo=function(e,t){if(this.transitonFilter){this.transitonFilter.clearPersist(this.gl);this.oldScene=this.scene;this.transStarted=1;this.transDuration=t}this.setScene(e)};e.Renderer.prototype.createTransitionBuffers=function(){var e=this.gl;this.frameBufferTS=e.createFramebuffer();this.renderBufferTS=e.createRenderbuffer();this.textureTS=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.textureTS);this.widthTS=this.getViewportWidth();this.heightTS=this.getViewportHeight();e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.widthTS,this.heightTS,0,e.RGBA,e.UNSIGNED_BYTE,null);e.bindFramebuffer(e.FRAMEBUFFER,this.frameBufferTS);e.bindRenderbuffer(e.RENDERBUFFER,this.renderBufferTS);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.widthTS,this.heightTS);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textureTS,0);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.renderBufferTS);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindTexture(e.TEXTURE_2D,null);this.frameBufferTD=e.createFramebuffer();this.renderBufferTD=e.createRenderbuffer();this.textureTD=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.textureTD);this.widthTD=this.getViewportWidth();this.heightTD=this.getViewportHeight();e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.widthTD,this.heightTD,0,e.RGBA,e.UNSIGNED_BYTE,null);e.bindFramebuffer(e.FRAMEBUFFER,this.frameBufferTD);e.bindRenderbuffer(e.RENDERBUFFER,this.renderBufferTD);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.widthTD,this.heightTD);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.textureTD,0);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.renderBufferTD);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindTexture(e.TEXTURE_2D,null)};e.Renderer.prototype.setTransitionFilter=function(e){if(this.gl)e.getFrameBuffer(this.gl);this.transitonFilter=e;var t=this;e.textures=[{name:"GLGE_SOURCE",doTexture:function(e){e.bindTexture(e.TEXTURE_2D,t.textureTS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}},{name:"GLGE_DEST",doTexture:function(e){e.bindTexture(e.TEXTURE_2D,t.textureTD);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}}];return this};e.Renderer.prototype.GLRenderTransition=function(e){this.transitonFilter.setUniform("1f","time",e);if(!this.frameBufferTS){this.createTransitionBuffers();this.transitonFilter.getFrameBuffer(this.gl)}this.scene.transbuffer=this.frameBufferTS;this.scene.render(this.gl);this.scene.transbuffer=null;this.oldScene.transbuffer=this.frameBufferTD;this.oldScene.render(this.gl);this.oldScene.transbuffer=null;this.transitonFilter.GLRender(this.gl)}})(GLGE);(function(e){e.C_PERSPECTIVE=1;e.C_ORTHO=2;e.Camera=function(t){e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.Camera);e.augment(e.Animatable,e.Camera);e.augment(e.QuickNotation,e.Camera);e.augment(e.JSONLoader,e.Camera);e.Camera.prototype.className="Camera";e.Camera.prototype.fovy=35;e.Camera.prototype.aspect=1;e.Camera.prototype.near=.1;e.Camera.prototype.far=1e3;e.Camera.prototype.orthoscale=5;e.Camera.prototype.type=e.C_PERSPECTIVE;e.Camera.prototype.pMatrix=null;e.Camera.prototype.getOrthoScale=function(){if(this.type==e.C_ORTHO){return this.orthoscale}else{e.error("You may only get a scale for a orthographic camera");return 1}};e.Camera.prototype.setOrthoScale=function(t){if(this.type==e.C_ORTHO){this.orthoscale=t;this.pMatrix=null}else{e.error("You may only set a scale for a orthographic camera")}return this};e.Camera.prototype.getFar=function(){return this.far};e.Camera.prototype.setFar=function(e){this.pMatrix=null;this.far=+e;return this};e.Camera.prototype.getNear=function(){return this.near};e.Camera.prototype.setNear=function(e){this.pMatrix=null;this.near=+e;return this};e.Camera.prototype.getType=function(){this.pMatrix=null;return this.type};e.Camera.prototype.setType=function(t){if(t==e.C_PERSPECTIVE||t==e.C_ORTHO){this.type=t;this.pMatrix=null}else{e.error("unsuported camera type")}return this};e.Camera.prototype.getFovY=function(){if(this.type==e.C_PERSPECTIVE){return this.fovy}else{e.error("You may only get a yfov for a perspective camera");return 1}};e.Camera.prototype.setFovY=function(t){if(this.type==e.C_PERSPECTIVE){this.fovy=+t;this.ymax=null;this.pMatrix=null}else{e.error("You may only set a yfov for a perspective camera")}return this};e.Camera.prototype.getAspect=function(){if(this.type==e.C_PERSPECTIVE||this.type==e.C_ORTHO){return this.aspect}else{e.error("You may only set a aspect for a perspective or orthographic camera");return 1}};e.Camera.prototype.setAspect=function(t){if(this.type==e.C_PERSPECTIVE||this.type==e.C_ORTHO){this.aspect=+t;this.pMatrix=null}else{e.error("You may only set a aspect for a perspective or orthographic camera")}return this};e.Camera.prototype.getProjectionMatrix=function(){if(!this.pMatrix){if(this.pMatrixOveride){this.pMatrix=this.pMatrixOveride}else{switch(this.type){case e.C_PERSPECTIVE:this.pMatrix=e.makePerspective(this.fovy,this.aspect,this.near,this.far);break;case e.C_ORTHO:this.pMatrix=e.makeOrtho(-this.orthoscale*this.aspect,this.orthoscale*this.aspect,-this.orthoscale,this.orthoscale,this.near,this.far);break}}}return this.pMatrix};e.Camera.prototype.setProjectionMatrix=function(e){this.pMatrix=e;return this};e.Camera.prototype.setCustomProjectionMatrix=function(e){this.pMatrix=e;this.pMatrixOveride=e;return this};e.Camera.prototype.updateMatrix=function(){var t=this.getPosition();var n=e.translateMatrix(t.x,t.y,t.z);n=e.mulMat4(n,this.getRotMatrix());if(this.parent)n=e.mulMat4(this.parent.getModelMatrix(),n);this.location=[n[3],n[7],n[11]];this.matrix=e.inverseMat4(n)};e.Camera.prototype.getViewMatrix=function(){if(!this.matrix||!this.rotmatrix)this.updateMatrix();return this.matrix};e.Camera.prototype.getViewProjection=function(){var t=this.getProjectionMatrix();var n=this.getViewMatrix();if(t!=this.vpProjectionMatrix||n!=this.vpViewMatrix){this.cameraViewProjection=e.mulMat4(t,n);this.vpProjectionMatrix=t;this.vpViewMatrix=n}return this.cameraViewProjection}})(GLGE);(function(e){e.Light=function(t){this.color={r:1,g:1,b:1};e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.Light);e.augment(e.Animatable,e.Light);e.augment(e.QuickNotation,e.Light);e.augment(e.JSONLoader,e.Light);e.Light.prototype.className="Light";e.L_POINT=1;e.L_DIR=2;e.L_SPOT=3;e.L_OFF=4;e.Light.prototype.constantAttenuation=1;e.Light.prototype.linearAttenuation=.002;e.Light.prototype.quadraticAttenuation=8e-4;e.Light.prototype.spotCosCutOff=.95;e.Light.prototype.spotCutOff=true;e.Light.prototype.spotPMatrix=null;e.Light.prototype.spotExponent=10;e.Light.prototype.color=null;e.Light.prototype.diffuse=true;e.Light.prototype.specular=true;e.Light.prototype.type=e.L_POINT;e.Light.prototype.frameBuffer=null;e.Light.prototype.renderBuffer=null;e.Light.prototype.texture=null;e.Light.prototype.bufferHeight=512;e.Light.prototype.bufferWidth=512;e.Light.prototype.shadowBias=5e-4;e.Light.prototype.varianceMin=5e-8;e.Light.prototype.bleedCutoff=.3;e.Light.prototype.dirNear=1;e.Light.prototype.distance=1e3;e.Light.prototype.spotSoftness=0;e.Light.prototype.spotSoftnessDistance=.3;e.Light.prototype.sceneAABB=[-1e3,-1e3,-1e3,1e3,1e3,1e3];e.Light.prototype.setSceneMinX=function(e){this.sceneAABB[0]=parseFloat(e);return this};e.Light.prototype.getSceneMinX=function(){return this.sceneAABB[0]};e.Light.prototype.setSceneMaxX=function(e){this.sceneAABB[3]=parseFloat(e);return this};e.Light.prototype.getSceneMaxX=function(){return this.sceneAABB[3]};e.Light.prototype.setSceneMinY=function(e){this.sceneAABB[1]=parseFloat(e);return this};e.Light.prototype.getSceneMinY=function(){return this.sceneAABB[1]};e.Light.prototype.setSceneMaxY=function(e){this.sceneAABB[4]=parseFloat(e);return this};e.Light.prototype.getSceneMaxY=function(){return this.sceneAABB[4]};e.Light.prototype.setSceneMinZ=function(e){this.sceneAABB[2]=parseFloat(e);return this};e.Light.prototype.getSceneMinZ=function(){return this.sceneAABB[2]};e.Light.prototype.setSceneMaxY=function(e){this.sceneAABB[5]=parseFloat(e);return this};e.Light.prototype.getSceneMaxZ=function(){return this.sceneAABB[5]};e.Light.prototype.setNearShadowBias=function(e){this.dirNear=e;return this};e.Light.prototype.getNearShadowBias=function(){return this.dirNear};e.Light.prototype.setBleedCutoff=function(e){this.bleedCutoff=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getBleedCutoff=function(){return this.bleedCutoff};e.Light.prototype.setVarianceMin=function(e){this.varianceMin=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getVarianceMin=function(){return this.varianceMin};e.Light.prototype.getPMatrix=function(t,n,r,i,s){if(!this.spotPMatrix){var o;if(this.scene&&this.scene.camera)o=this.scene.camera.far;else o=1e3;if(this.type==e.L_SPOT){this.spotPMatrix=e.makePerspective(Math.acos(this.spotCosCutOff)/3.14159*360,1,.1,o)}}if(this.type==e.L_DIR){var u=this.getModelMatrix();this.spotPMatrix=this.calcDirMatrix(s,[u[2],u[6],u[10]],this,n)}return this.spotPMatrix};e.Light.prototype.calcDir=function(t,n){var r=[0,0,0];for(var i=0;i<t.length;i++){r=e.addVec3(r,e.subVec3(t[i],n))}return e.toUnitVec3(r)};e.Light.prototype.findBound=function(e,t,n){for(var r=0;r<3;r++){if(n[r]<e[r]){e[r]=n[r]}else if(n[r]>t[r]){t[r]=n[r]}}};e.Light.prototype.lightLook=function(t,n,r){var i=e.toUnitVec3(e.crossVec3(n,r));var s=e.toUnitVec3(e.crossVec3(i,n));var o=e.toUnitVec3(n);var u=[];u[0]=i[0];u[4]=s[0];u[8]=-o[0];u[12]=0;u[1]=i[1];u[5]=s[1];u[9]=-o[1];u[13]=0;u[2]=i[2];u[6]=s[2];u[10]=-o[2];u[14]=0;u[3]=-e.dotVec3(i,t);u[7]=-e.dotVec3(s,t);u[11]=e.dotVec3(o,t);u[15]=1;return u};e.Light.prototype.transformPoints=function(t,n){var r=[];for(var i=0;i<t.length;i++){var s=e.mulMat4Vec4(n,[t[i][0],t[i][1],t[i][2],1]);s[0]/=s[3];s[1]/=s[3];s[2]/=s[3];s[3]/=s[3];r.push(s)}return r};e.Light.prototype.scaleTranslateToFit=function(e,t){var n=[];n[0]=2/(t[0]-e[0]);n[1]=0;n[2]=0;n[3]=-(t[0]+e[0])/(t[0]-e[0]);n[4]=0;n[5]=2/(t[1]-e[1]);n[6]=0;n[7]=-(t[1]+e[1])/(t[1]-e[1]);n[8]=0;n[9]=0;n[10]=2/(t[2]-e[2]);n[11]=-(t[2]+e[2])/(t[2]-e[2]);n[12]=0;n[13]=0;n[14]=0;n[15]=1;return n};e.Light.prototype.calcBounds=function(e,t,n){e[0]=n[0][0];e[1]=n[0][1];e[2]=n[0][2];t[0]=n[0][0];t[1]=n[0][1];t[2]=n[0][2];for(var r=1;r<n.length;r++){this.findBound(e,t,n[r])}};e.Light.prototype.linComb=function(e,t,n){return[e[0]+n*t[0],e[1]+n*t[1],e[2]+n*t[2]]};e.Light.prototype.getEdgePlanesFromView=function(t){var n=e.inverseMat4(t);var r=[[-1,-1,-1,1],[-1,-1,1,1],[-1,1,-1,1],[-1,1,1,1],[1,-1,-1,1],[1,-1,1,1],[1,1,-1,1],[1,1,1,1]];var i=this.transformPoints(r,n);var s=e.toUnitVec3(e.crossVec3(e.subVec3(i[1],i[0]),e.subVec3(i[2],i[0])));s[3]=e.dotVec3(s,i[0]);var o=e.toUnitVec3(e.crossVec3(e.subVec3(i[6],i[4]),e.subVec3(i[5],i[4])));o[3]=e.dotVec3(o,i[4]);var u=e.toUnitVec3(e.crossVec3(e.subVec3(i[7],i[5]),e.subVec3(i[1],i[5])));u[3]=e.dotVec3(u,i[5]);var a=e.toUnitVec3(e.crossVec3(e.subVec3(i[2],i[0]),e.subVec3(i[4],i[0])));a[3]=e.dotVec3(a,i[0]);var f=e.toUnitVec3(e.crossVec3(e.subVec3(i[3],i[2]),e.subVec3(i[6],i[2])));f[3]=e.dotVec3(f,i[2]);var l=e.toUnitVec3(e.crossVec3(e.subVec3(i[4],i[0]),e.subVec3(i[1],i[0])));l[3]=e.dotVec3(l,i[0]);var c=[[i[0],i[4]],[i[4],i[6]],[i[6],i[2]],[i[2],i[0]],[i[1],i[5]],[i[5],i[7]],[i[7],i[3]],[i[3],i[1]],[i[0],i[1]],[i[3],i[2]],[i[7],i[6]],[i[5],i[4]]];return{edges:c,planes:[s,o,u,a,f,l],points:i}};e.Light.prototype.getEdgePlanesFromAABB=function(e,t,n,r,i,s){var o=[[1,0,0,e],[-1,0,0,-r],[0,1,0,t],[0,-1,0,-i],[0,0,1,n],[0,0,-1,-s]];var u=[[e,t,n],[e,t,s],[e,i,n],[e,i,s],[r,t,n],[r,t,s],[r,i,n],[r,i,s]];var a=[[u[0],u[4]],[u[4],u[6]],[u[6],u[2]],[u[2],u[0]],[u[1],u[5]],[u[5],u[7]],[u[7],u[3]],[u[3],u[1]],[u[0],u[1]],[u[3],u[2]],[u[7],u[6]],[u[5],u[4]]];return{edges:a,planes:o,points:u}};e.Light.prototype.planeEdgeIntersect=function(t,n){var r=e.dotVec3(t[0],n)-n[3];var i=e.dotVec3(t[1],n)-n[3];if(r>0&&i>0||r<0&&i<0){return false}else{var s=e.subVec3(t[1],t[0]);s=e.scaleVec3(s,-r/(i-r));return e.addVec3(t[0],s)}};e.Light.prototype.pointInPlanes=function(t,n){var r=-.001;for(var i=0;i<n.length;i++){if(e.dotVec3(t,n[i])-n[i][3]<r)return false}return true};e.Light.prototype.getViewPoints=function(e){var t=this.getEdgePlanesFromView(e);var n=this.getEdgePlanesFromAABB(this.sceneAABB[0],this.sceneAABB[1],this.sceneAABB[2],this.sceneAABB[3],this.sceneAABB[4],this.sceneAABB[5]);var r=t.planes;var i=n.planes;var s=t.edges;var o=n.edges;var u=[];var a=[];for(var f=0;f<r.length;f++){for(var l=0;l<o.length;l++){var c=this.planeEdgeIntersect(o[l],r[f]);if(c)u.push(c)}a.push(r[f])}for(var f=0;f<i.length;f++){for(var l=0;l<s.length;l++){var c=this.planeEdgeIntersect(s[l],i[f]);if(c)u.push(c)}a.push(i[f])}var h=[];for(var f=0;f<u.length;f++){if(this.pointInPlanes(u[f],a)){h.push(u[f])}}for(var f=0;f<t.points.length;f++){if(this.pointInPlanes(t.points[f],a)){h.push(t.points[f])}}for(var f=0;f<n.points.length;f++){if(this.pointInPlanes(n.points[f],a)){h.push(n.points[f])}}return h};e.Light.prototype.calcDirMatrix=function(t,n,r,i){var s=t.matrix;var o=e.inverseMat4(s);var u=t.getModelMatrix();var a=t.getProjectionMatrix();var f=t.getViewProjection();var l=this.getViewPoints(f);var c=e.scaleVec3(n,t.far);var h=l.length;for(var p=0;p<h;p++){l.push(e.addVec3(c,l[p]))}if(l.length==0)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var d=[u[8],u[9],u[10]];var v=[o[3],o[7],o[11]];var m=[],g=[];var y;var b=this.dirNear;var w=this.calcDir(l,v);var E=e.crossVec3(n,w);var S=e.crossVec3(E,n);S=e.toUnitVec3(S);var x=e.dotVec3(w,n);var T=Math.sqrt(1-x*x);var N=this.lightLook(v,n,S);var C=this.transformPoints(l,N);this.calcBounds(m,g,C);var k=1/T;var L=k*b;var A=Math.abs(g[1]-m[1]);var O=L+A*T;var M=(L+Math.sqrt(O*L))/T;var _=M+A;var D;var D=this.linComb(v,S,-(M-b));N=this.lightLook(D,n,S);var y=e.identMatrix();y[5]=(_+M)/(_-M);y[7]=-2*_*M/(_-M);y[13]=1;y[15]=0;var P=e.mulMat4(y,N);C=this.transformPoints(l,P);this.calcBounds(m,g,C);P=this.scaleTranslateToFit(m,g);P=e.mulMat4(P,y);P=e.mulMat4(P,e.mulMat4(N,e.inverseMat4(i)));return P};e.Light.prototype.setDistance=function(e){this.distance=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getDistance=function(){return this.distance};e.Light.prototype.setNegativeShadow=function(e){this.negativeShadow=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getNegative=function(){return this.negativeShadow};e.Light.prototype.setCastShadows=function(e){this.castShadows=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getCastShadows=function(){return this.castShadows;return this};e.Light.prototype.setShadowBias=function(e){this.shadowBias=e;return this};e.Light.prototype.getShadowBias=function(){return this.shadowBias};e.Light.prototype.setBufferWidth=function(e){this.bufferWidth=e;return this};e.Light.prototype.getBufferHeight=function(){return this.bufferHeight};e.Light.prototype.setBufferHeight=function(e){this.bufferHeight=e;return this};e.Light.prototype.getBufferWidth=function(){return this.bufferWidth};e.Light.prototype.setSpotCosCutOff=function(e){this.spotPMatrix=null;this.spotCosCutOff=e;return this};e.Light.prototype.getSpotCosCutOff=function(){return this.spotCosCutOff};e.Light.prototype.setSpotCutOff=function(e){this.spotCutOff=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getSpotCutOff=function(){return this.spotCutOff};e.Light.prototype.setSpotExponent=function(e){this.spotExponent=e;return this};e.Light.prototype.getSpotExponent=function(){return this.spotExponent};e.Light.prototype.getAttenuation=function(e,t,n){var r={};r.constant=this.constantAttenuation;r.linear=this.linearAttenuation;r.quadratic=this.quadraticAttenuation;return r};e.Light.prototype.setAttenuation=function(e,t,n){this.constantAttenuation=e;this.linearAttenuation=t;this.quadraticAttenuation=n;return this};e.Light.prototype.setAttenuationConstant=function(e){this.constantAttenuation=e;return this};e.Light.prototype.setAttenuationLinear=function(e){this.linearAttenuation=e;return this};e.Light.prototype.setAttenuationQuadratic=function(e){this.quadraticAttenuation=e;return this};e.Light.prototype.setColor=function(t){t=e.colorParse(t);this.color={r:t.r,g:t.g,b:t.b};return this};e.Light.prototype.setColorR=function(e){this.color.r=e;return this};e.Light.prototype.setColorG=function(e){this.color.g=e;return this};e.Light.prototype.setColorB=function(e){this.color.b=e;return this};e.Light.prototype.getColor=function(){return this.color};e.Light.prototype.getColorR=function(e){return this.color.r};e.Light.prototype.getColorG=function(e){return this.color.g};e.Light.prototype.getColorB=function(e){return this.color.b};e.Light.prototype.getType=function(){return this.type};e.Light.prototype.setType=function(e){this.type=e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getSpotSoftness=function(){return this.spotSoftness};e.Light.prototype.setSpotSoftness=function(e){this.spotSoftness=+e;if(this.gl)this.createSoftPrograms(this.gl);this.fireEvent("shaderupdate",{});return this};e.Light.prototype.getSpotSoftDistance=function(){return this.spotSoftnessDistance};e.Light.prototype.setSpotSoftDistance=function(e){this.spotSoftnessDistance=+e;this.fireEvent("shaderupdate",{});return this};e.Light.prototype.enableLight=function(){if(this.type==e.L_OFF&&this.old_type!==undefined){this.setType(this.old_type);delete this.old_type}};e.Light.prototype.disableLight=function(){if(this.type!=e.L_OFF){this.old_type=this.type;this.setType(e.L_OFF)}};e.Light.prototype.GLInit=function(t){this.gl=t;if((this.type==e.L_SPOT||this.type==e.L_DIR)&&!this.texture){this.createSpotBuffer(t);this.createSoftBuffer(t);this.createSoftPrograms(t)}};e.Light.prototype.createSpotBuffer=function(t){this.frameBuffer=t.createFramebuffer();this.renderBuffer=t.createRenderbuffer();this.texture=t.createTexture();t.bindTexture(t.TEXTURE_2D,this.texture);try{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.bufferWidth,this.bufferHeight,0,t.RGBA,t.UNSIGNED_BYTE,null)}catch(n){e.error("incompatible texture creation method");var r=parseFloat(this.bufferWidth);var i=parseFloat(this.bufferHeight);var s=new Uint8Array(r*i*4);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,i,0,t.RGBA,t.UNSIGNED_BYTE,s)}t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer);t.bindRenderbuffer(t.RENDERBUFFER,this.renderBuffer);t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.bufferWidth,this.bufferHeight);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.renderBuffer);t.bindFramebuffer(t.FRAMEBUFFER,null);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindTexture(t.TEXTURE_2D,null)};e.Light.prototype.createSoftBuffer=function(t){this.frameBufferSf=t.createFramebuffer();this.renderBufferSf=t.createRenderbuffer();this.textureSf=t.createTexture();t.bindTexture(t.TEXTURE_2D,this.textureSf);try{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.bufferWidth,this.bufferHeight,0,t.RGBA,t.UNSIGNED_BYTE,null)}catch(n){e.error("incompatible texture creation method");var r=parseFloat(this.bufferWidth);var i=parseFloat(this.bufferHeight);var s=new Uint8Array(r*i*4);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,i,0,t.RGBA,t.UNSIGNED_BYTE,s)}t.bindFramebuffer(t.FRAMEBUFFER,this.frameBufferSf);t.bindRenderbuffer(t.RENDERBUFFER,this.renderBufferSf);t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.bufferWidth,this.bufferHeight);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.textureSf,0);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.renderBufferSf);t.bindFramebuffer(t.FRAMEBUFFER,null);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindTexture(t.TEXTURE_2D,null);if(!this.posBuffer)this.posBuffer=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),t.STATIC_DRAW);this.posBuffer.itemSize=3;this.posBuffer.numItems=4;if(!this.uvBuffer)this.uvBuffer=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,1,0,0,1,0]),t.STATIC_DRAW);this.uvBuffer.itemSize=2;this.uvBuffer.numItems=4;if(!this.GLfaces)this.GLfaces=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.GLfaces);t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),t.STATIC_DRAW);this.GLfaces.itemSize=1;this.GLfaces.numItems=6};e.Light.prototype.createSoftPrograms=function(t){if(this.GLShaderProgram)t.deleteProgram(this.GLShaderProgram);var n="";n+="attribute vec3 position;\n";n+="attribute vec2 uvcoord;\n";n+="varying vec2 texCoord;\n";n+="void main(void){\n";n+="texCoord=uvcoord;\n";n+="gl_Position = vec4(position,1.0);\n";n+="}\n";var r=this.spotSoftness;var i="precision highp float;\n";i=i+"uniform sampler2D TEXTURE;\n";i=i+"varying vec2 texCoord;\n";i=i+"uniform bool xpass;\n";i=i+"float blurSize = "+(1/this.bufferWidth).toFixed(10)+";\n";i=i+"float unpack(sampler2D TEX, vec2 co){;";i=i+"float value = dot(texture2D(TEX, co), vec4(0.000000059604644775390625,0.0000152587890625,0.00390625,1.0));";i=i+"return value;";i=i+"}";i=i+"vec2 unpack2(sampler2D TEX, vec2 co){;";i=i+"vec4 color = texture2D(TEX, co);";i=i+"float value1 = dot(color.rg, vec2(0.00390625,1.0));";i=i+"float value2 = dot(color.ba, vec2(0.00390625,1.0));";i=i+"return vec2(value1,value2);";i=i+"}";i=i+"vec4 pack(float value){;";i=i+"vec4 rgba=fract(value * vec4(16777216.0, 65536.0, 256.0, 1.0));\n";i=i+"return rgba-rgba.rrgb*vec4(0.0,0.00390625,0.00390625,0.00390625);";i=i+"}";i=i+"vec2 pack2(float value){;";i=i+"vec2 rg=fract(value * vec2(256.0, 1.0));\n";i=i+"return rg-rg.rr*vec2(0.0,0.00390625);";i=i+"}";i=i+"void main(void){\n";i=i+"float value = 0.0;";i=i+"vec2 value2;";i=i+"float mean = 0.0;";i=i+"float mean2 = 0.0;";i=i+"float color = 0.0;";i=i+"if(xpass){";for(var s=-r;s<r;s++){i=i+"value = unpack(TEXTURE, vec2(texCoord.x - "+(s+.5).toFixed(1)+"*blurSize, texCoord.y));";i=i+"mean += value;";i=i+"mean2 += value*value;"}i=i+"gl_FragColor = vec4(pack2(pow(mean2/"+(r*2).toFixed(2)+",0.5)),pack2(mean/"+(r*2).toFixed(2)+"));\n";i=i+"}else{";for(var s=-r;s<r;s++){i=i+"value2 = unpack2(TEXTURE, vec2(texCoord.x, texCoord.y - "+(s+.5).toFixed(1)+"*blurSize));";i=i+"mean += value2.g;";i=i+"mean2 += pow(value2.r,2.0);"}i=i+"gl_FragColor = vec4(pack2(pow(mean2/"+(r*2).toFixed(2)+",0.5)),pack2(mean/"+(r*2).toFixed(2)+"));\n";i=i+"}";i=i+"}\n";this.GLFragmentShader=t.createShader(t.FRAGMENT_SHADER);this.GLVertexShader=t.createShader(t.VERTEX_SHADER);t.shaderSource(this.GLFragmentShader,i);t.compileShader(this.GLFragmentShader);if(!t.getShaderParameter(this.GLFragmentShader,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(this.GLFragmentShader));return}t.shaderSource(this.GLVertexShader,n);t.compileShader(this.GLVertexShader);if(!t.getShaderParameter(this.GLVertexShader,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(this.GLVertexShader));return}this.GLShaderProgram=t.createProgram();t.attachShader(this.GLShaderProgram,this.GLVertexShader);t.attachShader(this.GLShaderProgram,this.GLFragmentShader);t.linkProgram(this.GLShaderProgram)};e.Light.prototype.GLRenderSoft=function(t){if(this.spotSoftness==0)return;if(!this.gl){this.GLInit(t)}t.bindFramebuffer(t.FRAMEBUFFER,this.frameBufferSf);if(t.program!=this.GLShaderProgram){t.useProgram(this.GLShaderProgram);t.program=this.GLShaderProgram}var n;for(var r=0;r<8;r++)t.disableVertexAttribArray(r);n=e.getAttribLocation(t,this.GLShaderProgram,"position");t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer);t.enableVertexAttribArray(n);t.vertexAttribPointer(n,this.posBuffer.itemSize,t.FLOAT,false,0,0);n=e.getAttribLocation(t,this.GLShaderProgram,"uvcoord");t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer);t.enableVertexAttribArray(n);t.vertexAttribPointer(n,this.uvBuffer.itemSize,t.FLOAT,false,0,0);t.activeTexture(t["TEXTURE0"]);t.bindTexture(t.TEXTURE_2D,this.texture);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"TEXTURE"),0);e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"xpass"),1);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.GLfaces);t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT);t.drawElements(t.TRIANGLES,this.GLfaces.numItems,t.UNSIGNED_SHORT,0);t.activeTexture(t["TEXTURE0"]);t.bindTexture(t.TEXTURE_2D,this.textureSf);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"TEXTURE"),0);e.setUniform(t,"1i",e.getUniformLocation(t,this.GLShaderProgram,"xpass"),0);t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer);t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.GLfaces);t.drawElements(t.TRIANGLES,this.GLfaces.numItems,t.UNSIGNED_SHORT,0);t.bindTexture(t.TEXTURE_2D,null);t.bindFramebuffer(t.FRAMEBUFFER,null)}})(GLGE);(function(e){e.FOG_NONE=1;e.FOG_LINEAR=2;e.FOG_QUADRATIC=3;e.FOG_SKYLINEAR=4;e.FOG_SKYQUADRATIC=5;e.Scene=function(t){e.Group.call(this);this.children=[];this.camera=new e.Camera;this.backgroundColor={r:1,g:1,b:1,a:1};this.ambientColor={r:0,g:0,b:0};this.fogColor={r:.5,g:.5,b:.5};this.passes=[];e.Assets.registerAsset(this,t)};e.augment(e.Group,e.Scene);e.Scene.prototype.camera=null;e.Scene.prototype.className="Scene";e.Scene.prototype.renderer=null;e.Scene.prototype.backgroundColor=null;e.Scene.prototype.filter=null;e.Scene.prototype.fogColor=null;e.Scene.prototype.ambientColor=null;e.Scene.prototype.fogNear=10;e.Scene.prototype.fogFar=80;e.Scene.prototype.fogType=e.FOG_NONE;e.Scene.prototype.passes=null;e.Scene.prototype.transbuffer=null;e.Scene.prototype.culling=true;e.Scene.prototype.getFogType=function(){return this.fogType};e.Scene.prototype.setFogType=function(e){this.fogType=e;return this};e.Scene.prototype.getFogFar=function(){return this.fogFar};e.Scene.prototype.setFogFar=function(e){this.fogFar=e;return this};e.Scene.prototype.getFogNear=function(){return this.fogNear};e.Scene.prototype.setFogNear=function(e){this.fogNear=e;return this};e.Scene.prototype.getFogColor=function(){return this.fogColor};e.Scene.prototype.setFogColor=function(t){t=e.colorParse(t);this.fogColor={r:t.r,g:t.g,b:t.b};return this};e.Scene.prototype.getBackgroundColor=function(){return this.backgroundColor};e.Scene.prototype.setBackgroundColor=function(t){t=e.colorParse(t);this.backgroundColor={r:t.r,g:t.g,b:t.b,a:t.a};return this};e.Scene.prototype.getAmbientColor=function(){return this.ambientColor};e.Scene.prototype.setAmbientColor=function(t){t=e.colorParse(t);this.ambientColor={r:t.r,g:t.g,b:t.b};if(this.renderer){this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1)}return this};e.Scene.prototype.setAmbientColorR=function(e){this.ambientColor.r=e;return this};e.Scene.prototype.setAmbientColorG=function(e){this.ambientColor.g=e;return this};e.Scene.prototype.setAmbientColorB=function(e){this.ambientColor.b=e;return this};e.Scene.prototype.setCamera=function(t){if(typeof t=="string")t=e.Assets.get(t);this.camera=t;return this};e.Scene.prototype.getCamera=function(){return this.camera};e.Scene.prototype.setCull=function(e){this.culling=e;return this};e.Scene.prototype.getCull=function(){return this.culling};e.Scene.prototype.GLInit=function(e){this.gl=e;e.lights=this.getLights();this.camera.setAspect(this.renderer.canvas.width/this.renderer.canvas.height);this.renderer.gl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1);for(var t=0;t<this.children;t++){if(this.children[t].GLInit)children[t].GLInit(e)}};e.Scene.prototype.GLDestroy=function(e){};e.Scene.sortFunc=function(e,t){return e.zdepth-t.zdepth};e.Scene.prototype.zSort=function(t,n){var r=t.scene.camera.getViewMatrix();var i;for(var s=0;s<n.length;s++){if(n[s].object.getBoundingVolume){var o=n[s].object.getBoundingVolume().getCenter()}else{var u=n[s].object.getModelMatrix();var o=[u[3],u[7],u[11]]}n[s].zdepth=o[0]*r[8]+o[1]*r[9]+o[2]*r[10]+r[11];if(n[s].object.zDepth){n[s].zdepth=n[s].object.zDepth}}n.sort(e.Scene.sortFunc);return n};e.Scene.prototype.setFilter2d=function(e){this.filter=e;return this};e.Scene.prototype.getFilter2d=function(e){return this.filter};e.Scene.prototype.setSkyFilter=function(e){this.skyfilter=e;return this};e.Scene.prototype.getSkyFilter=function(e){return this.skyfilter};e.Scene.prototype.getFrameBuffer=function(e){if(this.filter)return this.filter.getFrameBuffer(e);return null};e.Scene.prototype.objectsInViewFrustum=function(t,n){var r;var i=[];var s=e.cameraViewProjectionToPlanes(n);for(var o=0;o<t.length;o++){r=t[o];if(r.getBoundingVolume&&r.cull){var u=r.getBoundingVolume();var a=u.getCenter();var f=u.getSphereRadius();if(e.sphereInFrustumPlanes([a[0],a[1],a[2],f],s)){var l=u.getCornerPoints();if(e.pointsInFrustumPlanes(l,s)){i.push(r);if(r.culled)r.fireEvent("willRender",{});r.culled=false}else{if(!r.culled)r.fireEvent("willCull",{});r.culled=true}}else{if(!r.culled)r.fireEvent("willCull",{});r.culled=true}}else{i.push(r)}}return i};e.Scene.prototype.unfoldRenderObject=function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];if(r.getMultiMaterials){var i=r.getMultiMaterials();for(var s=0;s<i.length;s++){var o=i[s].getMaterial();var u=i[s].getMesh();if(!o.meshIdx)o.matIdx=s;if(!o.meshIdx)o.meshIdx=s;t.push({object:r,multiMaterial:s})}}else{t.push({object:r,multiMaterial:0})}}return t};e.Scene.prototype.stateSort=function(e,t){if(!e.object.GLShaderProgram)return 1;if(!t.object.GLShaderProgram)return-1;var n=e.object.GLShaderProgram.progIdx;var r=t.object.GLShaderProgram.progIdx;if(n>r){return 1}else if(n<r){return-1}else{if(!e.object.multimaterials||!t.object.multimaterials)return-1;var n=e.object.multimaterials[e.multiMaterial].getMaterial().matIdx;var r=t.object.multimaterials[t.multiMaterial].getMaterial().matIdx;if(n>r){return 1}else if(n<r){return-1}else{var i=e.object.multimaterials[e.multiMaterial].getMesh();var s=e.object.multimaterials[e.multiMaterial].getMesh();if(!i)return-1;if(!s)return 1;var n=i.meshIdx;var r=s.meshIdx;if(n>r){return 1}else if(n<r){return-1}else{return 0}}}};e.Scene.prototype.createSkyBuffer=function(e){this.skyTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.skyTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGB,this.renderer.canvas.width,this.renderer.canvas.height,0,e.RGB,e.UNSIGNED_BYTE,null)};e.Scene.prototype.render=function(t){this.animate();if(this.camera.lookAt)this.camera.Lookat(this.camera.lookAt);t.lights=this.getLights();var n=t.lights;t.scene=this;this.lastMaterial=null;t.disable(t.BLEND);this.framebuffer=this.getFrameBuffer(t);var r=this.getObjects();var i=this.camera.getViewProjection();if(this.culling){var i=this.camera.getViewProjection();r=this.objectsInViewFrustum(r,i)}r=this.unfoldRenderObject(r);r=r.sort(this.stateSort);for(var s=0;s<n.length;s++){if(n[s].castShadows){if(!n[s].gl)n[s].GLInit(t);var o=this.camera.matrix;var u=this.camera.getProjectionMatrix();var a=0;if(n[s].getType()==e.L_DIR){var f=n[s].getModelMatrix();var l=e.inverseMat4(o);f[3]=f[2]*n[s].distance/2+l[3];f[7]=f[6]*n[s].distance/2+l[7];f[11]=f[10]*n[s].distance/2+l[11];n[s].matrix=f;var c=e.mulMat4Vec4(u,[0,0,n[s].distance,1]);a=c[3]/c[2]}t.bindFramebuffer(t.FRAMEBUFFER,n[s].frameBuffer);if(!n[s].s_cache)n[s].s_cache={};n[s].s_cache.imvmatrix=e.inverseMat4(n[s].getModelMatrix());n[s].s_cache.mvmatrix=n[s].getModelMatrix();n[s].s_cache.pmatrix=n[s].getPMatrix(i,n[s].s_cache.imvmatrix,a,this.camera.far/2,this.camera);n[s].s_cache.smatrix=e.mulMat4(n[s].s_cache.pmatrix,n[s].s_cache.imvmatrix);n[s].shadowRendered=false;t.viewport(0,0,parseFloat(n[s].bufferWidth),parseFloat(n[s].bufferHeight));t.clearDepth(1);t.clearColor(1,1,1,1);t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var h=parseFloat(n[s].bufferHeight);var p=parseFloat(n[s].bufferWidth);t.viewport(0,0,p,h);this.camera.setProjectionMatrix(n[s].s_cache.pmatrix);this.camera.matrix=n[s].s_cache.imvmatrix;for(var d=0;d<r.length;d++){if(r[d].object.getCastShadows&&!r[d].object.getCastShadows())continue;if(r[d].object.className=="ParticleSystem"){continue}if(n[s].getType()==e.L_SPOT){r[d].object.GLRender(t,e.RENDER_SHADOW,d,r[d].multiMaterial,n[s].distance)}else{r[d].object.GLRender(t,e.RENDER_DEPTH,d,r[d].multiMaterial,n[s].distance)}}n[s].s_cache.smatrix=e.mulMat4(n[s].s_cache.pmatrix,n[s].s_cache.imvmatrix);n[s].GLRenderSoft(t);this.camera.matrix=null;this.camera.setProjectionMatrix(u)}}if(this.culling){var i=this.camera.getViewProjection();r=this.objectsInViewFrustum(r,i)}t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer);if(this.camera.animation)this.camera.animate();this.getPasses(t,r);var o=this.camera.matrix;var u=this.camera.getProjectionMatrix();this.allowPasses=false;while(this.passes.length>0){var v=this.passes.pop();t.bindFramebuffer(t.FRAMEBUFFER,v.frameBuffer);this.camera.matrix=v.cameraMatrix;this.camera.setProjectionMatrix(v.projectionMatrix);this.mirror=v.mirror;this.renderPass(t,r,0,0,v.width,v.height,e.RENDER_DEFAULT,v.self)}this.mirror=false;this.camera.matrix=o;this.camera.setProjectionMatrix(u);t.bindFramebuffer(t.FRAMEBUFFER,this.filter?this.framebuffer:this.transbuffer);this.renderPass(t,r,this.renderer.getViewportOffsetX(),this.renderer.getViewportOffsetY(),this.renderer.getViewportWidth(),this.renderer.getViewportHeight());this.applyFilter(t,r,this.transbuffer);this.allowPasses=true};e.Scene.prototype.getPasses=function(t,n){for(var r=0;r<n.length;r++){n[r].object.GLRender(t,e.RENDER_NULL,0,n[r].multiMaterial)}};e.Scene.prototype.renderPass=function(t,n,r,i,s,o,u,a){t.clearDepth(1);t.depthFunc(t.LEQUAL);t.viewport(r,i,s,o);t.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a);t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT);if(!u)u=e.RENDER_DEFAULT;if(this.skyfilter&&u==e.RENDER_DEFAULT){this.skyfilter.GLRender(t);t.clear(t.DEPTH_BUFFER_BIT);if(this.skyfilter&&this.fogType==e.FOG_SKYQUADRATIC||this.fogType==e.FOG_SKYLINEAR){if(!this.skyTexture)this.createSkyBuffer(t);t.bindTexture(t.TEXTURE_2D,this.skyTexture);t.copyTexImage2D(t.TEXTURE_2D,0,t.RGB,0,0,s,o,0)}}var f=[];t.disable(t.BLEND);for(var l=0;l<n.length;l++){if((!n[l].object.zTrans||u!=e.RENDER_DEFAULT)&&n[l].object!=a)n[l].object.GLRender(t,u,0,n[l].multiMaterial);else if(n[l].object!=a)f.push(n[l])}t.enable(t.BLEND);f=this.zSort(t,f);for(var l=0;l<f.length;l++){if(f[l].object.blending){if(f[l].object.blending.length==4){t.blendFuncSeparate(t[f[l].object.blending[0]],t[f[l].object.blending[1]],t[f[l].object.blending[2]],t[f[l].object.blending[3]])}else{t.blendFunc(t[f[l].object.blending[0]],t[f[l].object.blending[1]])}}if(f[l].object.depthTest===false){t.disable(this.gl.DEPTH_TEST)}else{t.enable(this.gl.DEPTH_TEST)}if(n[l]!=a)f[l].object.GLRender(t,u,0,f[l].multiMaterial)}};e.Scene.prototype.applyFilter=function(t,n,r){if(this.filter&&this.filter.renderDepth){t.clearDepth(1);t.depthFunc(t.LEQUAL);t.bindFramebuffer(t.FRAMEBUFFER,this.filter.getDepthBuffer(t));this.renderPass(t,n,0,0,this.filter.getDepthBufferWidth(),this.filter.getDepthBufferHeight(),e.RENDER_SHADOW)}if(this.filter&&this.filter.renderEmit){t.clearDepth(1);t.depthFunc(t.LEQUAL);t.bindFramebuffer(t.FRAMEBUFFER,this.filter.getEmitBuffer(t));this.renderPass(t,n,0,0,this.filter.getEmitBufferWidth(),this.filter.getEmitBufferHeight(),e.RENDER_EMIT)}if(this.filter&&this.filter.renderNormal){t.clearDepth(1);t.depthFunc(t.LEQUAL);t.bindFramebuffer(t.FRAMEBUFFER,this.filter.getNormalBuffer(t));this.renderPass(t,n,0,0,this.filter.getNormalBufferWidth(),this.filter.getNormalBufferHeight(),e.RENDER_NORMAL)}if(this.filter)this.filter.GLRender(t,r)};e.Scene.prototype.addRenderPass=function(e,t,n,r,i,s,o){if(this.allowPasses)this.passes.push({frameBuffer:e,cameraMatrix:t,projectionMatrix:n,height:i,width:r,self:s,mirror:o});return this};e.Scene.prototype.ray=function(t,n){var r=this.renderer.gl;var i=this.camera.matrix;var s=this.camera.pMatrix;this.camera.matrix=e.inverseMat4(e.Mat4([n[2],n[1],n[0],t[0],n[0],n[2],n[1],t[1],n[1],n[0],n[2],t[2],0,0,0,1]));if(!this.pickPMatrix)this.pickPMatrix=e.makeOrtho(-1e-4,1e-4,-1e-4,1e-4,this.camera.near,this.camera.far);this.camera.pMatrix=this.pickPMatrix;r.viewport(0,0,8,1);r.clear(r.DEPTH_BUFFER_BIT);r.disable(r.BLEND);r.scene=this;var o=this.getObjects();for(var u=0;u<o.length;u++){if(o[u].pickable)o[u].GLRender(r,e.RENDER_PICK,u+1)}var a=new Uint8Array(8*1*4);r.readPixels(0,0,8,1,r.RGBA,r.UNSIGNED_BYTE,a);var f=[a[4]/255,a[5]/255,a[6]/255];var l=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2])*.5;f=[f[0]/l-1,f[1]/l-1,f[2]/l-1];var c=o[a[0]+a[1]*256+a[2]*65536-1];var h=(a[10]/255+.00390625*a[9]/255+152587890625e-16*a[8]/255)*this.camera.far;var p=[];p[0]=a[14]/255+.00390625*a[13]/255+152587890625e-16*a[12]/255;p[1]=a[18]/255+.00390625*a[17]/255+152587890625e-16*a[16]/255;r.bindFramebuffer(r.FRAMEBUFFER,null);r.viewport(0,0,this.renderer.canvas.width,this.renderer.canvas.height);this.camera.matrix=i;this.camera.pMatrix=s;if(c){return{object:c,distance:h,coord:[t[0]-n[0]*h,t[1]-n[1]*h,t[2]-n[2]*h],normal:f,texture:p}}return null};e.Scene.prototype.pick=function(e,t){var n=this.makeRay(e,t);if(!n){return null}return this.ray(n.origin,n.coord)};e.Scene.prototype.makeRay=function(t,n){if(!this.camera){e.error("No camera set for picking");return null}else if(this.camera.matrix&&this.camera.pMatrix){var r=this.renderer.canvas;t=t/r.offsetWidth*r.width;n=n/r.offsetHeight*r.height;var i=this.renderer.getViewportHeight();var s=this.renderer.getViewportWidth();var o=this.renderer.getViewportOffsetX();var u=this.renderer.getViewportHeight()-this.renderer.canvas.height+this.renderer.getViewportOffsetY();var a=((t-o)/s-.5)*2;var f=-((n+u)/i-.5)*2;var l=e.mulMat4(e.inverseMat4(this.camera.matrix),e.inverseMat4(this.camera.pMatrix));var c=e.mulMat4Vec4(l,[a,f,-1,1]);c=[c[0]/c[3],c[1]/c[3],c[2]/c[3]];var h=e.mulMat4Vec4(l,[a,f,1,1]);h=[-(h[0]/h[3]-c[0]),-(h[1]/h[3]-c[1]),-(h[2]/h[3]-c[2])];h=e.toUnitVec3(h);return{origin:c,coord:h}}else{return null}}})(GLGE);(function(e){e.ParticleSystem=function(t){this.startTime=(new Date).getTime();this.texture={};this.startMaxVelocity={x:0,y:0,z:0};this.startMinVelocity={x:0,y:0,z:0};this.startMaxAcceleration={x:0,y:0,z:0};this.endMaxAcceleration={x:0,y:0,z:0};this.startMinAcceleration={x:0,y:0,z:0};this.endMinAcceleration={x:0,y:0,z:0};this.startColor={r:0,g:0,b:0,a:1};this.endColor={r:0,g:0,b:0,a:1};e.Assets.registerAsset(this,t)};e.augment(e.Placeable,e.ParticleSystem);e.augment(e.Animatable,e.ParticleSystem);e.ParticleSystem.prototype.depthTest=true;e.ParticleSystem.prototype.zTrans=true;e.ParticleSystem.prototype.blending=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA","SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];e.ParticleSystem.prototype.setBlend=function(e){switch(e){case"ADD":this.blending=["SRC_ALPHA","ONE","SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];break;case"MIX":this.blending=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA","SRC_ALPHA","ONE_MINUS_SRC_ALPHA"];break}return this};e.ParticleSystem.prototype.setBlending=function(e){this.blending=e;return this};e.ParticleSystem.prototype.getBlending=function(){return this.blending};e.ParticleSystem.prototype.setMaxVelX=function(e){this.startMaxVelocity.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxVelY=function(e){this.startMaxVelocity.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxVelZ=function(e){this.startMaxVelocity.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxVelocity=function(e,t,n){this.startMaxVelocity={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setMinVelX=function(e){this.startMinVelocity.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinVelY=function(e){this.startMinVelocity.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinVelZ=function(e){this.startMinVelocity.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinVelocity=function(e,t,n){this.startMinVelocity={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setVelX=function(e){this.startMaxVelocity.x=parseFloat(e);this.startMinVelocity.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setVelY=function(e){this.startMaxVelocity.y=parseFloat(e);this.startMinVelocity.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setVelZ=function(e){this.startMaxVelocity.z=parseFloat(e);this.startMinVelocity.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setVelocity=function(e,t,n){this.startMaxVelocity={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.startMinVelocity={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setMaxStartAccX=function(e){this.startMaxAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxStartAccY=function(e){this.startMaxAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxStartAccZ=function(e){this.startMaxAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxStartAccelertaion=function(e,t,n){this.startMaxAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setMinStartAccX=function(e){this.startMinAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinStartAccY=function(e){this.startMinAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinStartAccZ=function(e){this.startMinAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinStartAccelertaion=function(e,t,n){this.startMinAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setStartAccX=function(e){this.startMaxAcceleration.x=parseFloat(e);this.startMinAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setStartAccY=function(e){this.startMaxAcceleration.y=parseFloat(e);this.startMinAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setStartAccZ=function(e){this.startMaxAcceleration.z=parseFloat(e);this.startMinAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setStartAccelertaion=function(e,t,n){this.startMaxAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.startMinAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setMaxEndAccX=function(e){this.endMaxAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxEndAccY=function(e){this.endMaxAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxEndAccZ=function(e){this.endMaxAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxEndAccelertaion=function(e,t,n){this.endMaxAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setMinEndAccX=function(e){this.endMinAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinEndAccY=function(e){this.endMinAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinEndAccZ=function(e){this.endMinAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinEndAccelertaion=function(e,t,n){this.endMinAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setEndAccX=function(e){this.endMinAcceleration.x=parseFloat(e);this.endMaxAcceleration.x=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setEndAccY=function(e){this.endMinAcceleration.y=parseFloat(e);this.endMaxAcceleration.y=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setEndAccZ=function(e){this.endMinAcceleration.z=parseFloat(e);this.endMaxAcceleration.z=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setEndAccelertaion=function(e,t,n){this.endMinAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.endMaxAcceleration={x:parseFloat(e),y:parseFloat(t),z:parseFloat(n)};this.attribute=null};e.ParticleSystem.prototype.setStartColor=function(t){var n=e.colorParse(t);this.startColor=n;this.attribute=null};e.ParticleSystem.prototype.setEndColor=function(t){var n=e.colorParse(t);this.endColor=n;this.attribute=null};e.ParticleSystem.prototype.setStartSize=function(e){this.startSize=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setEndSize=function(e){this.endSize=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setLifeTime=function(e){this.maxLifeTime=parseFloat(e);this.minLifeTime=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMaxLifeTime=function(e){this.maxLifeTime=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setMinLifeTime=function(e){this.minLifeTime=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.setNumParticles=function(e){this.numParticles=parseFloat(e);this.attribute=null};e.ParticleSystem.prototype.velocityFunction=function(e){return[(this.startMaxVelocity.x-this.startMinVelocity.x)*Math.random()+this.startMinVelocity.x,(this.startMaxVelocity.y-this.startMinVelocity.y)*Math.random()+this.startMinVelocity.y,(this.startMaxVelocity.z-this.startMinVelocity.z)*Math.random()+this.startMinVelocity.z]};e.ParticleSystem.prototype.accelerationFunction=function(e){return[[(this.startMaxAcceleration.x-this.startMinAcceleration.x)*Math.random()+this.startMinAcceleration.x,(this.startMaxAcceleration.y-this.startMinAcceleration.y)*Math.random()+this.startMinAcceleration.y,(this.startMaxAcceleration.z-this.startMinAcceleration.z)*Math.random()+this.startMinAcceleration.z],[(this.endMaxAcceleration.x-this.endMinAcceleration.x)*Math.random()+this.endMinAcceleration.x,(this.endMaxAcceleration.y-this.endMinAcceleration.y)*Math.random()+this.endMinAcceleration.y,(this.endMaxAcceleration.z-this.endMinAcceleration.z)*Math.random()+this.endMinAcceleration.z]]};e.ParticleSystem.prototype.colorFunction=function(e){return[[this.startColor.r,this.startColor.g,this.startColor.b,this.startColor.a],[this.endColor.r,this.endColor.g,this.endColor.b,this.endColor.a]]};e.ParticleSystem.prototype.positionFunction=function(e){return[0,0,0]};e.ParticleSystem.prototype.sizeFunction=function(e){return[this.startSize,this.endSize]};e.ParticleSystem.prototype.lifeTimeFunction=function(e){return(this.maxLifeTime-this.minLifeTime)*Math.random()+this.minLifeTime};e.ParticleSystem.prototype.minLifeTime=2e3;e.ParticleSystem.prototype.maxLifeTime=2e3;e.ParticleSystem.prototype.numParticles=200;e.ParticleSystem.prototype.startTime=0;e.ParticleSystem.prototype.startSize=0;e.ParticleSystem.prototype.endSize=1;e.ParticleSystem.prototype.toRender=true;e.ParticleSystem.prototype.renderFirst=true;e.ParticleSystem.prototype.className="ParticleSystem";e.ParticleSystem.prototype.zTrans=true;e.ParticleSystem.prototype.velocity=null;e.ParticleSystem.prototype.loop=1;e.ParticleSystem.prototype.setVelocityFunction=function(e){this.velocityFunction=e;this.particles=null};e.ParticleSystem.prototype.setAccelerationFunction=function(e){this.accelerationFunction=e;this.particles=null};e.ParticleSystem.prototype.setPositionFunction=function(e){this.colorFunction=e;this.particles=null};e.ParticleSystem.prototype.setColorFunction=function(e){this.positionFunction=e;this.particles=null};e.ParticleSystem.prototype.setSizeFunction=function(e){this.sizeFunction=e;this.particles=null};e.ParticleSystem.prototype.generateParticles=function(e){var t=this.numParticles;this.attribute={initPos:[],initAcc:[],endAcc:[],initVel:[],initColor:[],endColor:[],sizeAndOffset:[]};this.faces=[];for(var n=0;n<t;n++){var r=this.positionFunction(n);var i=this.velocityFunction(n);var s=this.accelerationFunction(n);var o=this.colorFunction(n);var u=this.sizeFunction(n);var a=this.lifeTimeFunction(n);var f=Math.floor(Math.random()*a);for(var l=-1;l<=1;l=l+2){for(var c=-1;c<=1;c=c+2){this.attribute.initPos.push(parseFloat(r[0])+c,parseFloat(r[1])+l,parseFloat(r[2]));this.attribute.initAcc.push(s[0][0],s[0][1],s[0][2]);this.attribute.endAcc.push(s[1][0],s[1][1],s[1][2]);this.attribute.initVel.push(i[0],i[1],i[2]);this.attribute.initColor.push(o[0][0],o[0][1],o[0][2],o[0][3]);this.attribute.endColor.push(o[1][0],o[1][1],o[1][2],o[1][3]);this.attribute.sizeAndOffset.push(u[0],u[1],f,a)}}}for(var n=0;n<t;n=n+4){this.faces.push(0+n,1+n,2+n);this.faces.push(1+n,2+n,3+n)}this.facesGL=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesGL);e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.faces),e.STATIC_DRAW);this.facesGL.num=this.faces.length;this.attribute.initPosGL=this.createBuffer(e,this.attribute.initPos);this.attribute.initAccGL=this.createBuffer(e,this.attribute.initAcc);this.attribute.endAccGL=this.createBuffer(e,this.attribute.endAcc);this.attribute.initVelGL=this.createBuffer(e,this.attribute.initVel);this.attribute.initColorGL=this.createBuffer(e,this.attribute.initColor);this.attribute.endColorGL=this.createBuffer(e,this.attribute.endColor);this.attribute.sizeAndOffsetGL=this.createBuffer(e,this.attribute.sizeAndOffset)};e.ParticleSystem.prototype.setLoop=function(e){this.loop=e};e.ParticleSystem.prototype.reset=function(){this.startTime=(new Date).getTime()};e.ParticleSystem.prototype.generateProgram=function(t){var n=["attribute vec3 position;","attribute vec3 initVel;","attribute vec3 initAcc;","attribute vec3 endAcc;","attribute vec4 initColor;","attribute vec4 endColor;","attribute vec4 sizeTimeLife;","uniform float time;","uniform bool loop;","uniform mat4 mvMatrix;","uniform mat4 pMatrix;","varying vec2 UV;","varying vec4 color;","void main(){","UV = (position.xy+1.0)/2.0;","if((time>sizeTimeLife[2] && (time-sizeTimeLife[2])<sizeTimeLife[3]) || loop){","float localTime = mod((time - sizeTimeLife[2]), sizeTimeLife[3]);","color = (endColor-initColor)/sizeTimeLife[3]*localTime+initColor;","float size = (sizeTimeLife[1]-sizeTimeLife[0])/sizeTimeLife[3]*localTime+sizeTimeLife[0];","vec3 pos = (endAcc-initAcc)*(localTime*log(localTime)-localTime)+0.5*initAcc*localTime*localTime+initVel*localTime;","pos = (mvMatrix*vec4(pos,1.0)).xyz;","vec3 positions = pos+(position*size);","gl_Position = pMatrix*vec4(positions,1.0);","}else{","gl_Position = vec4(0.0,0.0,0.0,1.0);","}","}"].join("");frgShader=["#ifdef GL_ES\nprecision highp float;\n#endif\n","uniform sampler2D texture;","varying vec2 UV;","varying vec4 color;","void main(){","gl_FragColor=texture2D(texture,UV)*color;","}"].join("");var r=t.createShader(t.VERTEX_SHADER);var i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(r,n);t.compileShader(r);if(!t.getShaderParameter(r,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(r));return}t.shaderSource(i,frgShader);t.compileShader(i);if(!t.getShaderParameter(i,t.COMPILE_STATUS)){e.error(t.getShaderInfoLog(i));return}if(this.program)t.deleteProgram(this.Program);this.program=t.createProgram();t.attachShader(this.program,r);t.attachShader(this.program,i);t.linkProgram(this.program)};e.ParticleSystem.prototype.createBuffer=function(e,t){var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n);e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW);return n};e.ParticleSystem.prototype.setUniforms=function(t){var n=this.program;if(!n.glarrays)n.glarrays={};var r=t.scene.camera.getViewMatrix();var i=this.getPosition();var s=e.mulMat4(r,[1,0,0,i.x,0,1,0,i.y,0,0,1,i.z,0,0,0,1]);var o=e.getUniformLocation(t,n,"mvMatrix");if(!n.glarrays.mvMatrix)n.glarrays.mvMatrix=new Float32Array(s);else e.mat4gl(s,n.glarrays.mvMatrix);t.uniformMatrix4fv(o,true,n.glarrays.mvMatrix);var u=e.getUniformLocation(t,n,"pMatrix");if(!n.glarrays.pMatrix)n.glarrays.pMatrix=new Float32Array(t.scene.camera.getProjectionMatrix());else e.mat4gl(t.scene.camera.getProjectionMatrix(),n.glarrays.pMatrix);t.uniformMatrix4fv(u,true,n.glarrays.pMatrix);t.uniform1f(e.getUniformLocation(t,n,"time"),(new Date).getTime()-this.startTime);t.uniform1i(e.getUniformLocation(t,n,"loop"),this.loop);t.activeTexture(t.TEXTURE0);if(!this.glTexture)this.glTexture=t.createTexture();if(this.texture.state==1){t.bindTexture(t.TEXTURE_2D,this.glTexture);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.texture.image);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);t.generateMipmap(t.TEXTURE_2D);t.bindTexture(t.TEXTURE_2D,null);this.texture.state=2;n.texture=true}t.bindTexture(t.TEXTURE_2D,this.glTexture);if(n.texture){t.uniform1i(e.getUniformLocation(t,n,"texture"),0)}};e.ParticleSystem.prototype.setImage=function(e){var t=this.texture;t.image=new Image;t.image.onload=function(e){t.state=1};t.image.src=e};e.ParticleSystem.prototype.setAttributes=function(t){for(var n=0;n<8;n++)t.disableVertexAttribArray(n);var r=e.getAttribLocation(t,this.program,"position");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.initPosGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,3,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"initAcc");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.initAccGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,3,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"endAcc");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.endAccGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,3,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"initColor");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.initColorGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,4,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"endColor");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.endColorGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,4,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"sizeTimeLife");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.sizeAndOffsetGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,4,t.FLOAT,false,0,0)}var r=e.getAttribLocation(t,this.program,"initVel");if(r>-1){t.bindBuffer(t.ARRAY_BUFFER,this.attribute.initVelGL);t.enableVertexAttribArray(r);t.vertexAttribPointer(r,3,t.FLOAT,false,0,0)}};e.ParticleSystem.prototype.GLRender=function(e){if(!this.attribute)this.generateParticles(e);if(!this.program)this.generateProgram(e);e.program=this.program;e.useProgram(this.program);this.setAttributes(e);this.setUniforms(e);e.depthMask(false);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.facesGL);e.drawElements(e.TRIANGLES,this.facesGL.num,e.UNSIGNED_SHORT,0);e.depthMask(true);e.scene.lastMaterial=null};e.Scene.prototype.addParticleSystem=e.Scene.prototype.addGroup;e.Group.prototype.addParticleSystem=e.Group.prototype.addGroup})(GLGE);(function(e){e.MD2=function(t){this.MD2Started=+(new Date);this.setAnimation(new e.AnimationVector);e.Object.call(this,t)};e.augment(e.Object,e.MD2);e.MD2.prototype.loadingCache={};e.MD2.prototype.headersCache={};e.MD2.prototype.meshCache={};e.MD2.prototype.MD2Animations={};e.MD2.prototype.MD2StartFrame=0;e.MD2.prototype.MD2EndFrame=0;e.MD2.prototype.MD2Loop=true;e.MD2.prototype.MD2AnimFinished=false;e.MD2.prototype.headerNames=["ident","version","skinwidth","skinheight","framesize","num_skins","num_xyz","num_st","num_tris","num_glcmds","num_frames","ofs_skins","ofs_st","ofs_tris","ofs_frames","ofs_glcmds","ofs_end"];e.MD2.prototype.preNormals=[[-.525731,0,.850651],[-.442863,.238856,.864188],[-.295242,0,.955423],[-.309017,.5,.809017],[-.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-.681718,.147621,.716567],[-.809017,.309017,.5],[-.587785,.425325,.688191],[-.850651,.525731,0],[-.864188,.442863,.238856],[-.716567,.681718,.147621],[-.688191,.587785,.425325],[-.5,.809017,.309017],[-.238856,.864188,.442863],[-.425325,.688191,.587785],[-.716567,.681718,-.147621],[-.5,.809017,-.309017],[-.525731,.850651,0],[0,.850651,-.525731],[-.238856,.864188,-.442863],[0,.955423,-.295242],[-.262866,.951056,-.16246],[0,1,0],[0,.955423,.295242],[-.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-.442863],[.262866,.951056,-.16246],[.5,.809017,-.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-.525731,0],[.955423,-.295242,0],[.864188,-.442863,.238856],[.951056,-.16246,.262866],[.809017,-.309017,.5],[.681718,-.147621,.716567],[.850651,0,.525731],[.864188,.442863,-.238856],[.809017,.309017,-.5],[.951056,.16246,-.262866],[.525731,0,-.850651],[.681718,.147621,-.716567],[.681718,-.147621,-.716567],[.850651,0,-.525731],[.809017,-.309017,-.5],[.864188,-.442863,-.238856],[.951056,-.16246,-.262866],[.147621,.716567,-.681718],[.309017,.5,-.809017],[.425325,.688191,-.587785],[.442863,.238856,-.864188],[.587785,.425325,-.688191],[.688191,.587785,-.425325],[-.147621,.716567,-.681718],[-.309017,.5,-.809017],[0,.525731,-.850651],[-.525731,0,-.850651],[-.442863,.238856,-.864188],[-.295242,0,-.955423],[-.16246,.262866,-.951056],[0,0,-1],[.295242,0,-.955423],[.16246,.262866,-.951056],[-.442863,-.238856,-.864188],[-.309017,-.5,-.809017],[-.16246,-.262866,-.951056],[0,-.850651,-.525731],[-.147621,-.716567,-.681718],[.147621,-.716567,-.681718],[0,-.525731,-.850651],[.309017,-.5,-.809017],[.442863,-.238856,-.864188],[.16246,-.262866,-.951056],[.238856,-.864188,-.442863],[.5,-.809017,-.309017],[.425325,-.688191,-.587785],[.716567,-.681718,-.147621],[.688191,-.587785,-.425325],[.587785,-.425325,-.688191],[0,-.955423,-.295242],[0,-1,0],[.262866,-.951056,-.16246],[0,-.850651,.525731],[0,-.955423,.295242],[.238856,-.864188,.442863],[.262866,-.951056,.16246],[.5,-.809017,.309017],[.716567,-.681718,.147621],[.525731,-.850651,0],[-.238856,-.864188,-.442863],[-.5,-.809017,-.309017],[-.262866,-.951056,-.16246],[-.850651,-.525731,0],[-.716567,-.681718,-.147621],[-.716567,-.681718,.147621],[-.525731,-.850651,0],[-.5,-.809017,.309017],[-.238856,-.864188,.442863],[-.262866,-.951056,.16246],[-.864188,-.442863,.238856],[-.809017,-.309017,.5],[-.688191,-.587785,.425325],[-.681718,-.147621,.716567],[-.442863,-.238856,.864188],[-.587785,-.425325,.688191],[-.309017,-.5,.809017],[-.147621,-.716567,.681718],[-.425325,-.688191,.587785],[-.16246,-.262866,.951056],[.442863,-.238856,.864188],[.16246,-.262866,.951056],[.309017,-.5,.809017],[.147621,-.716567,.681718],[0,-.525731,.850651],[.425325,-.688191,.587785],[.587785,-.425325,.688191],[.688191,-.587785,.425325],[-.955423,.295242,0],[-.951056,.16246,.262866],[-1,0,0],[-.850651,0,.525731],[-.955423,-.295242,0],[-.951056,-.16246,.262866],[-.864188,.442863,-.238856],[-.951056,.16246,-.262866],[-.809017,.309017,-.5],[-.864188,-.442863,-.238856],[-.951056,-.16246,-.262866],[-.809017,-.309017,-.5],[-.681718,.147621,-.716567],[-.681718,-.147621,-.716567],[-.850651,0,-.525731],[-.688191,.587785,-.425325],[-.587785,.425325,-.688191],[-.425325,.688191,-.587785],[-.425325,-.688191,-.587785],[-.587785,-.425325,-.688191],[-.688191,-.587785,-.425325]];e.MD2.prototype.MD2FrameRate=6;e.MD2.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,7)=="https://"){return e}else{if(!t){t=window.location.href}if(t.indexOf("://")==-1){return t.slice(0,t.lastIndexOf("/"))+"/"+e}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(var o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.MD2.prototype.setMD2FrameRate=function(e){this.MD2FrameRate=e;return this};e.MD2.prototype.setAutoTangents=function(e){this.doTangents=e;return this};e.MD2.prototype.setMD2Animation=function(e,t){this.MD2Anim=e;this.MD2AnimFinished=false;if(t!=undefined)this.MD2Loop=t;this.MD2Started=+(new Date);if(this.MD2Animations[this.url]&&this.MD2Animations[this.url][e]){this.MD2LastAnimFrame=this.lastMD2Frame;var n=this.MD2Animations[this.url][e];this.MD2StartFrame=n[0];this.MD2EndFrame=n[1]}return this};e.MD2.prototype.getAnimations=function(){var e=[];for(var t in this.MD2Animations[this.url])e.push(t);return e};e.MD2.prototype.setMD2Frame=function(e){var t=this.MD2EndFrame-this.MD2StartFrame+1;if(t==1)return;if(this.MD2Loop){e=e%t;var n=(Math.floor(e)+1)%t}else{e=Math.min(t-1,e);n=Math.min(t-1,Math.floor(e)+1);if(e==t-1&&!this.MD2AnimFinished){this.MD2AnimFinished=true;this.fireEvent("md2AnimFinished",{})}}var r=e%1;if(e<1&&this.MD2LastAnimFrame!=undefined){e=this.MD2LastAnimFrame-this.MD2StartFrame}else{this.MD2LastAnimFrame=null;this.lastMD2Frame=Math.floor(e)+this.MD2StartFrame}this.setMeshFrame1(Math.floor(e)+this.MD2StartFrame);this.setMeshFrame2(n+this.MD2StartFrame);this.setMeshBlendFactor(r)};e.MD2.prototype.animate=function(t,n){if(!t)t=+(new Date);if(this.header){var r=(t-this.MD2Started)/1e3*this.MD2FrameRate;this.setMD2Frame(r)}e.Object.prototype.animate.call(this,t,n)};e.MD2.prototype.setSrc=function(e,t){if(t)e=this.getAbsolutePath(e,t);this.url=e;if(this.loadingCache[this.url]&&!this.headersCache[e]){var n=this;setTimeout(function(){n.setSrc(e)},15);return}this.loadingCache[this.url]=true;if(this.headersCache[e]){this.header=this.headersCache[e];this.setMesh(this.meshCache[e]);if(this.MD2Anim)this.setMD2Animation(this.MD2Anim);this.fireEvent("loaded",{url:this.url});return}var n=this;var r=new XMLHttpRequest;r.overrideMimeType("text/plain; charset=x-user-defined");r.open("GET",e,true);r.send(null);this.verts=[];this.normals=[];r.onreadystatechange=function(e){if(r.readyState==4){if(r.status==200||r.status==0){response=r.responseText;if(response){var t=new ArrayBuffer(response.length);var i=new Uint8Array(t);var i=[];for(var s=0;s<response.length;s++){i[s]=response.charCodeAt(s)&255}n.bufferLoaded(i)}}else{alert("Error loading page\n")}}}};e.MD2.prototype.bufferLoaded=function(e){this.byteArray=e;this.parseHeader();this.parseFrames();this.parseUVs();this.parseFaces();if(this.MD2Anim)this.setMD2Animation(this.MD2Anim,this.MD2Loop)};e.MD2.prototype.parseHeader=function(){this.header={};for(var e=0;e<this.headerNames.length;e++){this.header[this.headerNames[e]]=this.getUint16At(e*4)}this.headersCache[this.url]=this.header};e.MD2.prototype.getUint16At=function(e){return this.byteArray[e]+this.byteArray[e+1]*256};e.MD2.prototype.getFloat32At=function(e){var t=this.byteArray[e];var n=this.byteArray[e+1];var r=this.byteArray[e+2];var i=this.byteArray[e+3];sign=1-2*(i>>7),exponent=(i<<1&255|r>>7)-127,mantissa=(r&127)<<16|n<<8|t;if(mantissa==0&&exponent==-127){return 0}if(exponent==-127){return sign*mantissa*Math.pow(2,-126-23)}return sign*(1+mantissa*Math.pow(2,-23))*Math.pow(2,exponent)};e.MD2.prototype.parseFrames=function(){var e=this.byteArray;var t=0;var n={};for(var r=0;r<this.header.num_frames;r++){var i=[this.getFloat32At(this.header.ofs_frames+r*this.header.framesize),this.getFloat32At(this.header.ofs_frames+4+r*this.header.framesize),this.getFloat32At(this.header.ofs_frames+8+r*this.header.framesize),this.getFloat32At(this.header.ofs_frames+12+r*this.header.framesize),this.getFloat32At(this.header.ofs_frames+16+r*this.header.framesize),this.getFloat32At(this.header.ofs_frames+20+r*this.header.framesize)];var s=[];var o=[];var u=this.header.ofs_frames+24+r*this.header.framesize;var a="";for(var f=u;f<u+16;f++){if(e[f]==0)break;a+=String.fromCharCode(e[f])}a=a.replace(/[0-9]/g,"");if(l&&a!=l){n[l]=[t,r-1];t=r}var l=a;u=this.header.ofs_frames+40+r*this.header.framesize;for(var f=u;f<u+this.header.framesize-40;f=f+12){s.push(e[f]*i[0]+i[3]);s.push(e[f+1]*i[1]+i[4]);s.push(e[f+2]*i[2]+i[5]);s.push(e[f+4]*i[0]+i[3]);s.push(e[f+5]*i[1]+i[4]);s.push(e[f+6]*i[2]+i[5]);s.push(e[f+8]*i[0]+i[3]);s.push(e[f+9]*i[1]+i[4]);s.push(e[f+10]*i[2]+i[5]);var c=this.preNormals[e[f+3]];if(!c)c=[0,0,1];o.push(c[0]);o.push(c[1]);o.push(c[2]);c=this.preNormals[e[f+7]];if(!c)c=[0,0,1];o.push(c[0]);o.push(c[1]);o.push(-c[2]);c=this.preNormals[e[f+11]];if(!c)c=[0,0,1];o.push(c[0]);o.push(c[1]);o.push(c[2])}this.verts[r]=s;this.normals[r]=o}n[l]=[t,r-2];this.MD2Animations[this.url]=n};e.MD2.prototype.parseUVs=function(){var e=[];var t=this.byteArray;var n=this.header.ofs_st;for(var r=n;r<n+this.header.num_st*4;r=r+4){e.push(this.getUint16At(r)/this.header.skinwidth);e.push(1-this.getUint16At(r+2)/this.header.skinheight)}this.globaluvs=e};e.MD2.prototype.parseFaces=function(){var e=this.header.ofs_tris;var t=e+this.header.num_tris*12;var n=[];var r=[];var i=[];var s=[];var o=0;for(var u=e;u<t;u=u+12){n.push(o++);n.push(o++);n.push(o++);var a=this.getUint16At(u);var f=this.getUint16At(u+2);var l=this.getUint16At(u+4);for(var c=0;c<this.verts.length;c++){if(!i[c]){i[c]=[];s[c]=[]}var h=this.verts[c];var p=this.normals[c];i[c].push(h[a*3]);i[c].push(h[a*3+1]);i[c].push(h[a*3+2]);s[c].push(p[a*3]);s[c].push(p[a*3+1]);s[c].push(p[a*3+2]);i[c].push(h[f*3]);i[c].push(h[f*3+1]);i[c].push(h[f*3+2]);s[c].push(p[f*3]);s[c].push(p[f*3+1]);s[c].push(p[f*3+2]);i[c].push(h[l*3]);i[c].push(h[l*3+1]);i[c].push(h[l*3+2]);s[c].push(p[l*3]);s[c].push(p[l*3+1]);s[c].push(p[l*3+2])}r.push(this.globaluvs[this.getUint16At(u+6)*2]);r.push(this.globaluvs[this.getUint16At(u+6)*2+1]);r.push(this.globaluvs[this.getUint16At(u+8)*2]);r.push(this.globaluvs[this.getUint16At(u+8)*2+1]);r.push(this.globaluvs[this.getUint16At(u+10)*2]);r.push(this.globaluvs[this.getUint16At(u+10)*2+1])}this.normals=s;this.verts=i;this.uvs=r;this.faces=n;this.createMesh()};e.MD2.prototype.createMesh=function(){var t=new e.Mesh;var n=this.verts;var r=this.normals;var i=this.uvs;var s=this.faces;for(var o=0;o<n.length;o++){t.setPositions(n[o],o).setNormals(r[o],o)}if(this.doTangents){t.setUV(i).setFaces(s)}else{t.setFaces(s).setUV(i)}this.setMesh(t);this.meshCache[this.url]=t;this.fireEvent("loaded",{url:this.url})};e.Group.prototype.addMD2=e.Group.prototype.addObject;e.Scene.prototype.addMD2=e.Scene.prototype.addObject})(GLGE);(function(e){e.MD3=function(t){this.MD3Started=+(new Date);this.MD3Materials=[];this.surfaces=[];this.MD3Children=[];this.loaded=false;this.setAnimation(new e.AnimationVector);e.Group.call(this,t)};e.augment(e.Group,e.MD3);e.MD3.prototype.MD3FrameRate=10;e.MD3.prototype.MD3Animations={};e.MD3.prototype.MD3Tags={};e.MD3.prototype.MD3StartFrame=0;e.MD3.prototype.MD3EndFrame=0;e.MD3.prototype.MD3Loop=true;e.MD3.prototype.headerNames=["NUM_FRAMES","NUM_TAGS","NUM_SURFACES","NUM_SKINS","OFS_FRAMES","OFS_TAGS","OFS_SURFACES","OFS_EOF"];e.MD3.prototype.surfaceHeaderNames=["NUM_FRAMES","NUM_SHADERS","NUM_VERTS","NUM_TRIANGLES","OFS_TRIANGLES","OFS_SHADERS","OFS_ST","OFS_XYZNORMAL","OFS_END"];e.MD3.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,7)=="https://"){return e}else{if(!t){t=window.location.href}if(t.indexOf("://")==-1){return t.slice(0,t.lastIndexOf("/"))+"/"+e}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(var o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.MD3.prototype.setSrc=function(e,t){if(t)e=this.getAbsolutePath(e,t);this.url=e;var n=this;var r=new XMLHttpRequest;r.overrideMimeType("text/plain; charset=x-user-defined");r.open("GET",e,true);r.send(null);this.verts=[];this.normals=[];r.onreadystatechange=function(e){if(r.readyState==4){if(r.status==200||r.status==0){response=r.responseText;if(response){var t=new ArrayBuffer(response.length);var i=new Uint8Array(t);var i=[];for(var s=0;s<response.length;s++){i[s]=response.charCodeAt(s)&255}n.bufferLoaded(i)}}else{alert("Error loading page\n")}}}};e.MD3.prototype.setMD3FrameRate=function(e){this.MD3FrameRate=e;return this};e.MD3.prototype.setTag=function(e){this.MD3Tag=e;return this};e.MD3.prototype.bufferLoaded=function(e){this.byteArray=e;this.parseHeader();this.parseFrames();this.parseTags();this.createTags();this.parseSurfaces();this.addSurfaces();if(this.MD3Anim)this.setMD3Animation(this.MD3Anim,this.MD3Loop);if(this.MD3Children.length>0)this.addMD3Childred();this.loaded=true;this.fireEvent("loaded",{url:this.url})};e.MD3.prototype.addMD3Childred=function(){for(var e=0;e<this.MD3Children.length;e++){this.addMD3(this.MD3Children[e])}};e.MD3.prototype.addSurfaces=function(){for(var e=0;e<this.surfaces.length;e++){if(this.MD3Tag){t=this.MD3Tags[this.url][this.MD3Tag];this.surfaces[e].setLocX(t[0][0]).setLocY(t[0][1]).setLocX(t[0][1]).setRotMatrix(t[1])}this.addObject(this.surfaces[e])}return this};e.MD3.prototype.getAnimations=function(){var e=[];for(var t in this.MD3Animations[this.url])e.push(t);return e};e.MD3.prototype.setMD3Animation=function(e,t){this.MD3Anim=e;if(t!=undefined)this.MD3Loop=t;this.MD3Started=+(new Date);if(this.MD3Animations[this.url]&&this.MD3Animations[this.url][e]){this.MD3LastAnimFrame=this.lastMD2Frame;var n=this.MD3Animations[this.url][e];this.MD3StartFrame=n[0];this.MD3EndFrame=n[1]}return this};e.MD3.prototype.createTags=function(){var t=this.MD3Tags[this.url];this.MD3TagGroups={};for(var n in t){var r=t[n];var i=(new e.Group).setLocX(r[0][0]).setLocY(r[0][1]).setLocX(r[0][1]).setRotMatrix(r[1]);this.addGroup(i);this.MD3TagGroups[n]=i}};e.MD3.prototype.parseTags=function(){var e=this.headers.OFS_TAGS;var t=112;var n=this.MD3Tags[this.url]={};for(var r=0;r<this.headers.NUM_TAGS;r++){var i=this.getStringAt(e+r*t,64).replace(/[0-9_]/g,"");var s=e+r*t+64;var o=[this.getFloat32At(s)*10,this.getFloat32At(s+4)*10,this.getFloat32At(s+8)*10];var u=s+12;var a=[this.getFloat32At(u),this.getFloat32At(u+4),this.getFloat32At(u+8),0,this.getFloat32At(u+12),this.getFloat32At(u+16),this.getFloat32At(u+20),0,this.getFloat32At(u+24),this.getFloat32At(u+28),this.getFloat32At(u+32),0,0,0,0,1];n[i]=[o,a]}};e.MD3.prototype.parseFrames=function(){var e=this.headers.OFS_FRAMES+40;var t=56;var n={};var r=false;var i=0;for(var s=0;s<this.headers.NUM_FRAMES;s++){var o=this.getStringAt(e+s*t,16).replace(/[0-9_]/g,"");if(r&&r!=o){n[r]=[i,s-1];i=s}r=o}n[r]=[i,s-3];this.MD3Animations[this.url]=n};e.MD3.prototype.parseHeader=function(){this.headers={};for(var e=0;e<this.headerNames.length;e++){this.headers[this.headerNames[e]]=this.getSint32At(e*4+76)}};e.MD3.prototype.parseSurfaces=function(){this.surfaceHeaders=[];var t=this.headers.OFS_SURFACES;for(var n=0;n<this.headers.NUM_SURFACES;n++){var r=t+72;var i=this.surfaceHeaders[n]={offset:t};var s=0;for(var o=r;o<r+36;o=o+4){i[this.surfaceHeaderNames[s++]]=this.getSint32At(o)}var u=this.parseNormVerts(n);var a=this.parseUVs(n);var f=this.parseFaces(n);var l=this.createMesh(u[0],u[1],a,f);var c=new e.Object;if(!this.MD3Materials[n])this.MD3Materials[n]=new e.Material;c.setMaterial(this.MD3Materials[n]);c.setMesh(l);this.surfaces.push(c);t+=this.surfaceHeaders[n].OFS_END}};e.MD3.prototype.createMesh=function(t,n,r,i){var s=new e.Mesh;for(var o=0;o<t.length;o++){s.setPositions(t[o],o).setNormals(n[o],o)}s.setFaces(i).setUV(r);return s};e.MD3.prototype.parseFaces=function(e){var t=this.surfaceHeaders[e];var n=[];var r=t.offset+t.OFS_TRIANGLES;var i=12*t.NUM_TRIANGLES;for(var s=r;s<r+i;s=s+12){n.push(this.getSint32At(s));n.push(this.getSint32At(s+4));n.push(this.getSint32At(s+8))}return n};e.MD3.prototype.parseUVs=function(e){var t=this.surfaceHeaders[e];var n=[];var r=t.offset+t.OFS_ST;var i=8*t.NUM_VERTS;for(var s=r;s<r+i;s=s+8){n.push(this.getFloat32At(s));n.push(1-this.getFloat32At(s+4))}return n};e.MD3.prototype.parseNormVerts=function(e){var t=this.surfaceHeaders[e];var n=[];var r=[];var i=t.offset+t.OFS_XYZNORMAL;var s=8*t.NUM_VERTS;for(var o=0;o<t.NUM_FRAMES;o++){var u=[];var a=[];for(var f=i+o*s;f<i+(o+1)*s;f=f+8){u.push(this.getSint16At(f)/64);u.push(this.getSint16At(f+2)/64);u.push(this.getSint16At(f+4)/64);var l=this.decodeNormal(this.byteArray[f+6],this.byteArray[f+7]);a.push(l[0]);a.push(l[1]);a.push(l[2])}n[o]=u;r[o]=a}return[n,r]};e.MD3.prototype.decodeNormal=function(e,t){var n=e*2*Math.PI/255;var r=t*2*Math.PI/255;var i=Math.cos(n);var s=Math.sin(n);var o=Math.cos(r);var u=Math.sin(r);return[-i*u,-s*u,o]};e.MD3.prototype.getAttachPoints=function(){var e=[];for(var t in this.MD3TagGroups)e.push(t);return e};e.MD3.prototype.getSint16At=function(e){var t=this.byteArray[e]|this.byteArray[e+1]<<8;if(t>32768)t=t-65536;return t};e.MD3.prototype.getSint32At=function(e){var t=this.byteArray[e]|this.byteArray[e+1]<<8|this.byteArray[e+2]<<16|this.byteArray[e+3]<<24;if(t>2147483648)t=t-4294967296;return t};e.MD3.prototype.getFloat32At=function(e){var t=this.byteArray[e];var n=this.byteArray[e+1];var r=this.byteArray[e+2];var i=this.byteArray[e+3];sign=1-2*(i>>7),exponent=(i<<1&255|r>>7)-127,mantissa=(r&127)<<16|n<<8|t;if(mantissa==0&&exponent==-127){return 0}if(exponent==-127){return sign*mantissa*Math.pow(2,-126-23)}return sign*(1+mantissa*Math.pow(2,-23))*Math.pow(2,exponent)};e.MD3.prototype.getStringAt=function(e,t){var n="";for(var r=e;r<e+t;r++){if(this.byteArray[r]==0)break;n+=String.fromCharCode(this.byteArray[r])}return n};e.MD3.prototype.addMD3=function(e){if(!this.loaded){this.addEventListener("loaded",function(){this.addMD3(e)});return}if(this.MD3TagGroups){var t=e.MD3Tag;if(t&&this.MD3TagGroups[t]){this.MD3TagGroups[t].addGroup(e)}else{this.addGroup(e)}}else{this.MD3Children.push(e)}return this};e.MD3.prototype.setMD3Tag=function(e){this.MD3Tag=e;return this};e.MD3.prototype.setMD3Frame=function(e){var t=this.MD3EndFrame-this.MD3StartFrame;if(t==0)return;if(this.MD3Loop){e=e%t;var n=(Math.floor(e)+1)%t}else{e=Math.min(t,e);n=Math.min(t,Math.floor(e)+1);if(e==t){this.fireEvent("md3AnimFinished",{})}}var r=e%1;if(e<1&&this.MD3LastAnimFrame){e=this.MD3LastAnimFrame-this.MD3StartFrame}else{this.MD3LastAnimFrame=null;this.lastMD3Frame=Math.floor(e)+this.MD3StartFrame}for(var i=0;i<this.surfaces.length;i++){this.surfaces[i].setMeshFrame1(Math.floor(e)+this.MD3StartFrame);this.surfaces[i].setMeshFrame2(n+this.MD3StartFrame);this.surfaces[i].setMeshBlendFactor(r)}};e.MD3.prototype.animate=function(t,n){if(!t)t=+(new Date);if(this.headers){var r=(t-this.MD3Started)/1e3*this.MD3FrameRate;this.setMD3Frame(r)}e.Object.prototype.animate.call(this,t,n)};e.MD3.prototype.setMaterial=function(e,t){if(!t)t=0;this.MD3Materials[t]=e;if(this.surfaces[t])this.surfaces[t].setMaterial(e)};var n=function(e){return function(t){this.setMaterial(t,e)}};for(var r=1;r<32;r++){e.MD3.prototype["setMaterial"+r]=n(r)}e.Group.prototype.addMD3=e.Group.prototype.addGroup;e.Scene.prototype.addMD3=e.Scene.prototype.addGroup})(GLGE);if(!window["GLGE"]){window["GLGE"]={}}(function(e){e.FILTER_POST=0;e.FILTER_SKY=1;e.Filter2d=function(t){e.Assets.registerAsset(this,t)};e.augment(e.QuickNotation,e.Filter2d);e.Filter2d.prototype.renderDepth=false;e.Filter2d.prototype.renderNormal=false;e.Filter2d.prototype.renderEmit=false;e.Filter2d.prototype.persist=false;e.Filter2d.prototype.passes=null;e.Filter2d.prototype.textures=null;e.Filter2d.prototype.uniforms=null;e.Filter2d.prototype.buffers=null;e.Filter2d.prototype.filterType=e.FILTER_POST;e.Filter2d.prototype.depthBufferWidth=null;e.Filter2d.prototype.depthBufferHeight=null;e.Filter2d.prototype.emitBufferWidth=null;e.Filter2d.prototype.emitBufferHeight=null;e.Filter2d.prototype.normalBufferWidth=null;e.Filter2d.prototype.normalBufferHeight=null;e.Filter2d.prototype.setFilterType=function(e){this.filterType=e;return this};e.Filter2d.prototype.getFilterType=function(){return this.filterType};e.Filter2d.prototype.addTexture=function(e){if(!this.textures)this.textures=[];this.textures.push(e)};e.Filter2d.prototype.removeTexture=function(e){var t=this.textures.indexOf(e);if(t>-1)this.textures.splice(t,1)};e.Filter2d.prototype.createBuffer=function(e,t,n){if(!t)t=e.canvas.width;if(!n)n=e.canvas.height;var r=e.createFramebuffer();var i=e.createRenderbuffer();var s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s);var o=new Uint8Array(t*n*4);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,n,0,e.RGBA,e.UNSIGNED_BYTE,o);e.bindFramebuffer(e.FRAMEBUFFER,r);e.bindRenderbuffer(e.RENDERBUFFER,i);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,n);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,i);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);e.bindTexture(e.TEXTURE_2D,null);return[r,i,s]};e.Filter2d.prototype.getFrameBuffer=function(e){if(!this.passes)return null;if(!this.gl)this.gl=e;if(!this.buffers){this.buffers=this.createBuffer(e)}return this.buffers[0]};e.Filter2d.prototype.getEmitBuffer=function(e){if(!this.passes)return null;if(!this.gl)this.gl=e;if(!this.emitBuffers){this.emitBuffers=this.createBuffer(e,this.getEmitBufferWidth(),this.getEmitBufferHeight())}return this.emitBuffers[0]};e.Filter2d.prototype.setEmitBufferWidth=function(e){this.emitBufferWidth=e;this.emitBuffers=null};e.Filter2d.prototype.getEmitBufferWidth=function(){return this.emitBufferWidth?this.emitBufferWidth:this.gl.canvas.width};e.Filter2d.prototype.setEmitBufferHeight=function(e){this.emitBufferHeight=e;this.emitBuffers=null};e.Filter2d.prototype.getEmitBufferHeight=function(){return this.emitBufferHeight?this.emitBufferHeight:this.gl.canvas.height};e.Filter2d.prototype.getDepthBuffer=function(e){if(!this.passes)return null;if(!this.gl)this.gl=e;if(!this.depthBuffers){this.depthBuffers=this.createBuffer(e,this.getDepthBufferWidth(),this.getDepthBufferHeight())}return this.depthBuffers[0]};e.Filter2d.prototype.setDepthBufferWidth=function(e){this.depthBufferWidth=e;this.depthBuffers=null};e.Filter2d.prototype.getDepthBufferWidth=function(){return this.depthBufferWidth?this.depthBufferWidth:this.gl.canvas.width};e.Filter2d.prototype.setDepthBufferHeight=function(e){this.depthBufferHeight=e;this.depthBuffers=null};e.Filter2d.prototype.getDepthBufferHeight=function(){return this.depthBufferHeight?this.depthBufferHeight:this.gl.canvas.height};e.Filter2d.prototype.setNormalBufferWidth=function(e){this.normalBufferWidth=e;this.normalBuffers=null};e.Filter2d.prototype.getNormalBufferWidth=function(){return this.normalBufferWidth?this.normalBufferWidth:this.gl.canvas.width};e.Filter2d.prototype.setNormalBufferHeight=function(e){this.normalBufferHeight=e;this.normalBuffers=null};e.Filter2d.prototype.getNormalBufferHeight=function(){return this.normalBufferHeight?this.normalBufferHeight:this.gl.canvas.height};e.Filter2d.prototype.getNormalBuffer=function(e){if(!this.gl)this.gl=e;if(!this.normalBuffers){this.normalBuffers=this.createBuffer(e,this.getNormalBufferWidth(),this.getNormalBufferHeight())}return this.normalBuffers[0]};e.Filter2d.prototype.setUniform=function(e,t,n){if(!this.uniforms)this.uniforms={};this.uniforms[t]={type:e,value:n}};e.Filter2d.prototype.getUniform=function(e){if(!this.uniforms)this.uniforms={};return this.uniforms[e].value};e.Filter2d.prototype.getUniformType=function(e){if(!this.uniforms)this.uniforms={};return this.uniforms[e].type};e.Filter2d.prototype.addPassFile=function(e){var t=new XMLHttpRequest;var n=this;if(t){t.open("GET",e,false);t.send("");n.addPass(t.responseText)}};e.Filter2d.prototype.addPass=function(e,t,n){if(!this.passes)this.passes=[];this.passes.push({GLSL:e,height:n,width:t})};e.Filter2d.prototype.createPersistTexture=function(e){this.persistTexture=e.createTexture();e.bindTexture(e.TEXTURE_2D,this.persistTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.canvas.width,e.canvas.height,0,e.RGBA,e.UNSIGNED_BYTE,null)};e.Filter2d.prototype.GLRender=function(t,n){t.disable(t.BLEND);if(!n)n=null;if(this.passes){for(var r=0;r<this.passes.length;r++){if(this.passes.length-1==r){t.bindFramebuffer(t.FRAMEBUFFER,n)}else{if(!this.passes[r].buffer)this.passes[r].buffer=this.createBuffer(t,this.passes[r].width,this.passes[r].height);t.bindFramebuffer(t.FRAMEBUFFER,this.passes[r].buffer[0])}var i=this.passes[r].width?this.passes[r].width:t.canvas.width;var s=this.passes[r].height?this.passes[r].height:t.canvas.height;t.viewport(0,0,i,s);t.clearDepth(1);t.depthFunc(t.LEQUAL);t.clearColor(0,0,0,0);t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);if(!this.passes[r].program){this.passes[r].program=this.GLCreateShader(t,this.passes[r].GLSL)}t.useProgram(this.passes[r].program);t.program=this.passes[r].program;for(var o=0;o<8;o++)t.disableVertexAttribArray(o);attribslot=e.getAttribLocation(t,this.passes[r].program,"position");if(!this.posBuffer)this.createPlane(t);t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer);t.enableVertexAttribArray(attribslot);t.vertexAttribPointer(attribslot,this.posBuffer.itemSize,t.FLOAT,false,0,0);this.GLSetUniforms(t,r);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.GLfaces);t.drawElements(t.TRIANGLES,this.GLfaces.numItems,t.UNSIGNED_SHORT,0)}if(this.persist){if(!this.persistTexture)this.createPersistTexture(t);t.bindTexture(t.TEXTURE_2D,this.persistTexture);t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.canvas.width,t.canvas.height,0)}}};e.Filter2d.prototype.clearPersist=function(e){if(!this.persistTexture)this.createPersistTexture(e);e.bindTexture(e.TEXTURE_2D,this.persistTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.canvas.width,e.canvas.height,0,e.RGBA,e.UNSIGNED_BYTE,null);e.bindTexture(e.TEXTURE_2D,null)};var t=new Float32Array(16);e.Filter2d.prototype.GLSetUniforms=function(n,r){if(this.filterType==e.FILTER_SKY){var i=e.transposeMat4(e.mulMat4(e.inverseMat4(n.scene.camera.matrix),e.inverseMat4(n.scene.camera.pMatrix)));e.mat4gl(i,t);e.setUniformMatrix(n,"Matrix4fv",e.getUniformLocation(n,this.passes[r].program,"invViewProj"),false,t)}for(var s in this.uniforms){var o=this.uniforms[s];if(o.type=="Matrix4fv"){e.setUniformMatrix(n,"Matrix4fv",e.getUniformLocation(n,this.passes[r].program,s),false,o.value)}else{e.setUniform(n,o.type,e.getUniformLocation(n,this.passes[r].program,s),o.value)}}var u=0;if(this.buffers){if(r==0){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.buffers[2]);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_RENDER"),u);u++;if(this.persist){if(r==0){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.persistTexture);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_PERSIST"),u);u++}if(this.renderDepth){if(r==0){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.depthBuffers[2]);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_DEPTH"),u);u++}if(this.renderEmit){if(r==0){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.emitBuffers[2]);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_EMIT"),u);u++}if(this.renderNormal){if(r==0){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.normalBuffers[2]);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_NORMAL"),u);u++}for(var a=0;a<this.passes.length;a++){if(this.passes[a].buffer){n.activeTexture(n["TEXTURE"+u]);n.bindTexture(n.TEXTURE_2D,this.passes[a].buffer[2]);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)}e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,"GLGE_PASS"+a),u);u++}}if(!this.textures)this.textures=[];for(var a=0;a<this.textures.length;a++){n.activeTexture(n["TEXTURE"+(a+u)]);this.textures[a].doTexture(n,null);var f="TEXTURE"+a;if(this.textures[a].name)f=this.textures[a].name;e.setUniform(n,"1i",e.getUniformLocation(n,this.passes[r].program,f),a+u)}};e.Filter2d.prototype.createPlane=function(e){if(!this.posBuffer)this.posBuffer=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,this.posBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,.5,-1,1,.5,-1,-1,.5,1,-1,.5]),e.STATIC_DRAW);this.posBuffer.itemSize=3;this.posBuffer.numItems=4;if(!this.GLfaces)this.GLfaces=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.GLfaces);e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,3,0]),e.STATIC_DRAW);this.GLfaces.itemSize=1;this.GLfaces.numItems=6};e.Filter2d.prototype.GLCreateShader=function(t,n){var r=[];r.push("uniform mat4 invViewProj;\n");r.push("attribute vec3 position;\n");r.push("varying vec2 texCoord;\n");r.push("varying vec3 rayCoord;\n");r.push("void main(void){\n");r.push("vec4 near=invViewProj * vec4(position.xy,-1.0,1.0);\n");r.push("near/=near.w;\n");r.push("vec4 far=invViewProj * vec4(position.xy,1.0,1.0);\n");r.push("far/=far.w;\n");r.push("rayCoord=normalize(far.xyz-near.xyz);\n");r.push("texCoord=(position.xy+vec2(1.0,1.0))/2.0;\n");r.push("gl_Position = vec4(position.xyz,1.0);\n");r.push("}\n");var i=e.getGLShader(t,t.VERTEX_SHADER,r.join(""));var s=e.getGLShader(t,t.FRAGMENT_SHADER,n);return e.getGLProgram(t,i,s)}})(GLGE);(function(e){e.FilterGlow=function(t){this.setEmitBufferWidth(256);this.setEmitBufferHeight(256);e.Assets.registerAsset(this,t)};e.augment(e.Filter2d,e.FilterGlow);e.FilterGlow.prototype.renderEmit=true;e.FilterGlow.prototype.blur=1.2;e.FilterGlow.prototype.intensity=3;e.FilterGlow.prototype.fxaacutoff=2;e.FilterGlow.prototype.fxaastartintensity=0;e.FilterGlow.prototype.setEmitBufferWidth=function(t){e.Filter2d.prototype.setEmitBufferWidth.call(this,t);this.createPasses();return this};e.FilterGlow.prototype.setEmitBufferHeight=function(t){e.Filter2d.prototype.setEmitBufferHeight.call(this,t);this.createPasses();return this};e.FilterGlow.prototype.setBlur=function(e){this.blur=e;this.createPasses();return this};e.FilterGlow.prototype.setIntensity=function(e){this.intensity=e;this.createPasses();return this};e.FilterGlow.prototype.setFXAA=function(e){this.useFXAA=e;this.createPasses();return this};e.FilterGlow.prototype.setFXAACutoff=function(e){this.fxaacutoff=e;this.createPasses();return this};e.FilterGlow.prototype.setFXAAStartIntensity=function(e){this.fxaastartintensity=e;this.createPasses();return this};e.FilterGlow.prototype.createPasses=function(){var e=[];e.push("precision highp float;");e.push("uniform sampler2D GLGE_EMIT;");e.push("varying vec2 texCoord;");e.push("float blurSize="+(1/this.emitBufferWidth*this.blur).toFixed(10)+";");e.push("float rand(vec2 co){;");e.push("return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);");e.push("}");e.push("void main(void){");e.push("vec4 color=vec4(0.0,0.0,0.0,0.0);");e.push("float rnd=1.0-rand(texCoord.xy)*4.0*blurSize;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 4.0*blurSize, texCoord.y)) * 0.05 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 3.0*blurSize, texCoord.y)) * 0.09 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - 2.0*blurSize, texCoord.y)) * 0.12 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x - blurSize, texCoord.y)) * 0.15 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x, texCoord.y)) * 0.18 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + blurSize, texCoord.y)) * 0.15 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 2.0*blurSize, texCoord.y)) * 0.12 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 3.0*blurSize, texCoord.y)) * 0.09 * rnd;");e.push("color += texture2D(GLGE_EMIT, vec2(texCoord.x + 4.0*blurSize, texCoord.y)) * 0.05 * rnd;");e.push("gl_FragColor = vec4(color.rgb,1.0);");e.push("}");var t=[];t.push("precision highp float;");t.push("uniform sampler2D GLGE_PASS0;");t.push("uniform sampler2D GLGE_RENDER;");t.push("uniform sampler2D GLGE_EMIT;");t.push("varying vec2 texCoord;");t.push("float blurSize="+(1/this.emitBufferHeight*this.blur).toFixed(10)+";");t.push("float rand(vec2 co){;");t.push("return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);");t.push("}");t.push("void main(void){");t.push("vec4 color=vec4(0.0,0.0,0.0,0.0);");t.push("float rnd=1.0-rand(texCoord.xy)*4.0*blurSize;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 4.0*blurSize)) * 0.05 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 3.0*blurSize)) * 0.09 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - 2.0*blurSize)) * 0.12 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y - blurSize)) * 0.15 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y)) * 0.18 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + blurSize)) * 0.15 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 2.0*blurSize)) * 0.12 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 3.0*blurSize)) * 0.09 * rnd;");t.push("color += texture2D(GLGE_PASS0, vec2(texCoord.x, texCoord.y + 4.0*blurSize)) * 0.05 * rnd;");t.push("gl_FragColor = vec4(color.rgb*"+this.intensity.toFixed(5)+"+texture2D(GLGE_RENDER,texCoord).rgb,1.0);");t.push("}");this.passes=[];this.addPass(e.join(""));this.addPass(t.join(""));if(this.useFXAA){var n=[];n.push("precision highp float;");n.push("uniform sampler2D GLGE_PASS1;");n.push("varying vec2 texCoord;");n.push("vec2 inverse_buffer_size=vec2(1.0/1280.0,1.0/720.0);");n.push("#define FXAA_REDUCE_MIN   (1.0/128.0)");n.push("#define FXAA_REDUCE_MUL   (1.0/16.0)");n.push("#define FXAA_SPAN_MAX     8.0");n.push("void  main(){");n.push(" vec3 rgbNW = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(-1.0,-1.0)) * inverse_buffer_size).xyz;");n.push("  vec3 rgbNE = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(1.0,-1.0)) * inverse_buffer_size).xyz;");n.push("   vec3 rgbSW = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(-1.0,1.0)) * inverse_buffer_size).xyz;");n.push("   vec3 rgbSE = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(1.0,1.0)) * inverse_buffer_size).xyz;");n.push("    vec3 rgbM  = texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size).xyz;");n.push(" vec3 luma = vec3(0.299, 0.587, 0.114);");n.push("   float lumaNW = dot(rgbNW, luma);");n.push(" float lumaNE = dot(rgbNE, luma);");n.push(" float lumaSW = dot(rgbSW, luma);");n.push(" float lumaSE = dot(rgbSE, luma);");n.push(" float lumaM  = dot(rgbM,  luma);");n.push(" float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));");n.push("   float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));");n.push("   vec2 dir;");n.push("    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));");n.push("    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));");n.push("    float dirReduce = max(");n.push("   (lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),");n.push("  FXAA_REDUCE_MIN);");n.push("    float rcpDirMin = 1.0/(min(abs(dir.x), abs(dir.y)) + dirReduce);");n.push(" dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),");n.push("  max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),");n.push("    dir * rcpDirMin)) * inverse_buffer_size;");n.push(" vec3 rgbA = 0.5 * (");n.push("  texture2D(GLGE_PASS1,   gl_FragCoord.xy  * inverse_buffer_size + dir * (1.0/3.0 - 0.5)).xyz +");n.push("    texture2D(GLGE_PASS1,   gl_FragCoord.xy  * inverse_buffer_size + dir * (2.0/3.0 - 0.5)).xyz);");n.push("    vec3 rgbB = rgbA * 0.5 + 0.25 * (");n.push("    texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size + dir *  - 0.5).xyz +");n.push("  texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size + dir * 0.5).xyz);");n.push(" float lumaB = dot(rgbB, luma);");n.push("   if((lumaB < lumaMin) || (lumaB > lumaMax)) gl_FragColor = vec4(rgbA,1.0);");n.push("        else gl_FragColor = vec4(rgbB,1.0);");n.push("  if(length(rgbM)>"+this.fxaacutoff.toFixed(2)+") gl_FragColor = vec4(rgbM,1.0);");n.push("   if(length(rgbM)<"+this.fxaastartintensity.toFixed(2)+") gl_FragColor = vec4(rgbM,1.0);");n.push("}");this.addPass(n.join("\n"))}}})(GLGE);(function(e){e.FilterAO=function(){this.setUniform("1f","cavitygamma",1/3);this.setUniform("1f","whiteMul",2);this.setUniform("1f","aogamma",1/3);this.setUniform("1f","maxDist",.025);this.passes=[]};e.augment(e.Filter2d,e.FilterAO);e.FilterAO.prototype.renderNormal=true;e.FilterAO.prototype.quality=1;e.FilterAO.prototype.range=80;e.FilterAO.prototype.samples=16;e.FilterAO.prototype.useRender=true;e.FilterAO.prototype.getNormalBufferHeight=function(){return this.normalBufferHeight?this.normalBufferHeight:this.gl.canvas.height*this.quality|0};e.FilterAO.prototype.getNormalBufferWidth=function(){return this.normalBufferWidth?this.normalBufferWidth:this.gl.canvas.width*this.quality|0};e.FilterAO.prototype.setUseRender=function(e){this.useRender=e;this.normalBuffers=null;this.passes=[];return this};e.FilterAO.prototype.setSamples=function(e){this.samples=e;this.normalBuffers=null;this.passes=[];return this};e.FilterAO.prototype.setQuality=function(e){this.quality=e;this.normalBuffers=null;this.passes=[];return this};e.FilterAO.prototype.setRange=function(e){this.range=e;if(this.gl){this.setUniform("1f","blurX",this.range/this.getNormalBufferWidth()*this.quality/this.samples);this.setUniform("1f","blurY",this.range/this.getNormalBufferHeight()/this.samples)}return this};e.FilterAO.prototype.setCavityGamma=function(e){this.setUniform("1f","cavitygamma",1/e);return this};e.FilterAO.prototype.setAmbientMultiplier=function(e){this.setUniform("1f","whiteMul",e);return this};e.FilterAO.prototype.setAmbientGamma=function(e){this.setUniform("1f","aogamma",1/e);return this};e.FilterAO.prototype.setMaximumDistance=function(e){this.setUniform("1f","maxDist",e);return this};e.FilterAO.prototype.GLRender=function(t,n){this.gl=t;if(this.passes.length==0){this.createPasses()}return e.Filter2d.prototype.GLRender.call(this,t,n)};e.FilterAO.prototype.createPasses=function(){if(!this.gl)return;var e=this.getNormalBufferWidth();var t=this.getNormalBufferHeight();var n=this.samples/4|0;var r=[];for(var i=-n,s=0;i<=n;i++,s++){var o=n-Math.abs(i)+1;r[s]=o/(n*n+n)}r[n]=0;this.setUniform("1f","blurX",this.range/e*this.quality/this.samples);this.setUniform("1f","blurY",this.range/t/this.samples);var u=[];u.push("precision highp float;");u.push("uniform sampler2D GLGE_NORMAL;");u.push("uniform float maxDist;");u.push("varying vec2 texCoord;");u.push("uniform float blurX;");u.push("float rand(vec2 co){");u.push("return (fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;");u.push("}");u.push("void main(void){");u.push("vec4 n=texture2D(GLGE_NORMAL,texCoord.xy).rgba;");u.push("vec4 color=vec4(0.0,0.0,0.0,n.a);");u.push("float blurSize=blurX/(n.a*n.a+1.0);");u.push("float offset=rand(texCoord.xy)*blurSize+texCoord.x;");u.push("vec3 samp;");u.push("float delta;");for(var i=-n,s=0;i<=n;i++,s++){if(i==0)continue;u.push("samp = texture2D(GLGE_NORMAL, vec2("+i+".0*blurSize+offset, texCoord.y)).rga;");u.push("delta=abs(n.a-samp.b);");u.push("if(delta<maxDist){");u.push("delta/=maxDist;");u.push("color.b -= (samp.r-0.5) * "+r[s]+" * "+(2*i/Math.abs(i)|0)+".0;");u.push("color.rg += samp.rg * "+r[s]+" * (1.0-delta);");u.push("color.rg += n.rg  * "+r[s]+" * delta;");u.push("}else{");u.push("color.rg +=n.rg * "+r[s]+";");u.push("}")}u.push("color.b = (color.b+1.0)*0.5;");u.push("gl_FragColor = color;");u.push("}");var a=[];a.push("precision highp float;");a.push("uniform sampler2D GLGE_PASS0;");a.push("uniform sampler2D GLGE_RENDER;");a.push("uniform sampler2D GLGE_NORMAL;");a.push("varying vec2 texCoord;");a.push("uniform float blurY;");a.push("uniform float cavitygamma;");a.push("uniform float whiteMul;");a.push("uniform float aogamma;");a.push("uniform float maxDist;");a.push("float rand(vec2 co){");a.push("return (fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453)-0.5)*2.0;");a.push("}");a.push("void main(void){");a.push("vec4 color=vec4(0.0,0.0,0.0,1.0);");a.push("vec4 samp=vec4(0.0);");a.push("float random=rand(texCoord.xy);");if(this.quality<1){a.push("vec2 displace=vec2("+.5/e+","+.5/t+")*random;");a.push("vec4 n=texture2D(GLGE_PASS0, texCoord.xy+displace);")}else{a.push("vec4 n=texture2D(GLGE_PASS0, texCoord.xy);")}a.push("float delta;");a.push("float blurSize=blurY/(n.a*n.a+1.0);");a.push("float offset=random*blurSize+texCoord.y;");for(var i=-n,s=0;i<=n;i++,s++){if(i==0)continue;if(this.quality<1){a.push("samp = texture2D(GLGE_PASS0, vec2(texCoord.x, "+i+".0*blurSize + offset)+displace);")}else{a.push("samp = texture2D(GLGE_PASS0, vec2(texCoord.x, "+i+".0*blurSize + offset));")}a.push("delta=abs(n.a-samp.a);");a.push("if(delta<maxDist){");a.push("delta/=maxDist;");a.push("color.a -= (samp.g-0.5) * "+r[s]+" * "+(i*2/Math.abs(i)|0)+".0;");a.push("color.rg += samp.rg  * "+r[s]+" * (1.0-delta);");a.push("color.rg += n.rg * "+r[s]+" * delta;");a.push("}else{");a.push("color.rg += n.rg * "+r[s]+";");a.push("}")}a.push("color.a = (color.a+1.0)*n.b;");a.push("color.a = pow(color.a,cavitygamma);");if(this.quality<1){a.push("float dif =  length(color.rg-texture2D(GLGE_NORMAL, texCoord.xy+displace).rg);");a.push("samp =  texture2D(GLGE_NORMAL, texCoord.xy+displace+"+1/this.gl.canvas.height+").rgba;");a.push("if(abs(n.a-samp.a)<maxDist) dif =  max(length(color.rg-samp.rg),dif);");a.push("samp =  texture2D(GLGE_NORMAL, texCoord.xy+displace-"+1/this.gl.canvas.height+").rgba;");a.push("if(abs(n.a-samp.a)<maxDist) dif =  max(length(color.rg-samp.rg),dif);")}else{a.push("float dif =  length(color.rg-texture2D(GLGE_NORMAL, texCoord.xy).rg);")}a.push("float result = 1.0-((dif*(color.a-0.5)*2.0)+1.0)*0.5;");a.push("result = pow(min(result*whiteMul,1.0),aogamma);");a.push("gl_FragColor = vec4(vec3(result),1.0);");if(this.useRender)a.push("gl_FragColor = vec4(texture2D(GLGE_RENDER, texCoord.xy).rgb*gl_FragColor.r,1.0);");a.push("}");var f=[];f.push("precision highp float;");f.push("uniform sampler2D GLGE_PASS1;");f.push("varying vec2 texCoord;");f.push("vec2 inverse_buffer_size=vec2(1.0/"+this.gl.canvas.width.toFixed(1)+",1.0/"+this.gl.canvas.height.toFixed(1)+");");f.push("#define FXAA_REDUCE_MIN   (1.0/128.0)");f.push("#define FXAA_REDUCE_MUL   (1.0/16.0)");f.push("#define FXAA_SPAN_MAX     8.0");f.push("void  main(){");f.push("  vec3 rgbNW = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(-1.0,-1.0)) * inverse_buffer_size).xyz;");f.push("  vec3 rgbNE = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(1.0,-1.0)) * inverse_buffer_size).xyz;");f.push("   vec3 rgbSW = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(-1.0,1.0)) * inverse_buffer_size).xyz;");f.push("   vec3 rgbSE = texture2D(GLGE_PASS1,  (gl_FragCoord.xy + vec2(1.0,1.0)) * inverse_buffer_size).xyz;");f.push("    vec3 rgbM  = texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size).xyz;");f.push(" vec3 luma = vec3(0.299, 0.587, 0.114);");f.push("   float lumaNW = dot(rgbNW, luma);");f.push(" float lumaNE = dot(rgbNE, luma);");f.push(" float lumaSW = dot(rgbSW, luma);");f.push(" float lumaSE = dot(rgbSE, luma);");f.push(" float lumaM  = dot(rgbM,  luma);");f.push(" float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));");f.push("   float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));");f.push("   vec2 dir;");f.push("    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));");f.push("    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));");f.push("    float dirReduce = max(");f.push("   (lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),");f.push("  FXAA_REDUCE_MIN);");f.push("    float rcpDirMin = 1.0/(min(abs(dir.x), abs(dir.y)) + dirReduce);");f.push(" dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),");f.push("  max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),");f.push("    dir * rcpDirMin)) * inverse_buffer_size;");f.push(" vec3 rgbA = 0.5 * (");f.push("  texture2D(GLGE_PASS1,   gl_FragCoord.xy  * inverse_buffer_size + dir * (1.0/3.0 - 0.5)).xyz +");f.push("    texture2D(GLGE_PASS1,   gl_FragCoord.xy  * inverse_buffer_size + dir * (2.0/3.0 - 0.5)).xyz);");f.push("    vec3 rgbB = rgbA * 0.5 + 0.25 * (");f.push("    texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size + dir *  - 0.5).xyz +");f.push("  texture2D(GLGE_PASS1,  gl_FragCoord.xy  * inverse_buffer_size + dir * 0.5).xyz);");f.push(" float lumaB = dot(rgbB, luma);");f.push("   if((lumaB < lumaMin) || (lumaB > lumaMax)) gl_FragColor = vec4(rgbA,1.0);");f.push("        else gl_FragColor = vec4(rgbB,1.0);");f.push("  if(length(rgbM)>10.0) gl_FragColor = vec4(rgbM,1.0);");f.push("}");this.passes=[];this.addPass(u.join(""),e,t);this.addPass(a.join(""));this.addPass(f.join("\n"))}})(GLGE);if(typeof GLGE=="undefined"){GLGE={}}(function(e){function n(e,t){var r=null;if(e.getAttribute("id")==t)return e;for(var i=0;i<e.childNodes.length;i++){if(e.childNodes[i].nodeType==1){r=n(e.childNodes[i],t);if(r!=null)break}}return r}e.ColladaDocuments=[];e.Collada=function(t){e.Group.call(this);this.children=[];this.actions={};this.boneIdx=0;this.actionsIdx=0;e.Assets.registerAsset(this,t)};e.augment(e.Group,e.Collada);e.Collada.prototype.type=e.G_NODE;e.Collada.prototype.useLights=false;e.Collada.prototype.useCamera=false;e.Collada.prototype.useBinaryAlpha=false;e.Collada.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,7)=="https://"){return e}else{if(!t){t=window.location.href}if(t.indexOf("://")==-1){return t.slice(0,t.lastIndexOf("/"))+"/"+e}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.Collada.prototype.getElementById=function(e){if(!this.idcache){var t=this.getElementsByTagName("*");var n;this.idcache={};for(var r=0;r<t.length;r++){n=t[r].getAttribute("id");if(n!="")this.idcache[n]=t[r]}}return this.idcache[e]};e.Collada.prototype.parseArray=function(e){var t;var n=e.firstChild;var r="";var i=[];var s;var o;while(n){s=(r+n.nodeValue).replace(/\s+/g," ").replace(/^\s+/g,"").split(" ");n=n.nextSibling;if(s[0]=="")s.unshift();if(n)r=s.pop();for(o=0;o<s.length;o++)if(s[o]!="")i.push(s[o])}return i};e.Collada.prototype.isSketchupFile=function(){var e=this.xml.getElementsByTagName("asset");if(!e||e.length==0)return false;for(var t=0;t<e.length;++t){var n=e[t].getElementsByTagName("contributor");if(!n||n.length==0)return false;for(var r=0;r<n.length;++r){var i=n[r].getElementsByTagName("authoring_tool");if(!i||i.length==0)return false;for(var s=0;s<i.length;++s){var o=i[s].firstChild.nodeValue;if(o.indexOf("Google")==0){return true}}}}return false};e.Collada.prototype.setUseBinaryAlpha=function(e){this.useBinaryAlpha=e;return this};e.Collada.prototype.setUseCamera=function(e){this.useCamera=e;return this};e.Collada.prototype.getUseCamera=function(){return this.useCamera};e.Collada.prototype.setUseLights=function(e){this.useLights=e;return this};e.Collada.prototype.getUseLights=function(e){return this.useLights};e.Collada.prototype.setDocument=function(t,n,r){this.url=t;this.loadedCallback=r;if(t.indexOf("#")!=-1){this.rootId=t.substr(t.indexOf("#")+1);t=t.substr(0,t.indexOf("#"))}if(n)t=this.getAbsolutePath(t,n);this.docURL=t;if(e.ColladaDocuments[t]){this.xml=e.ColladaDocuments[t]}else{var i=new XMLHttpRequest;if(i){i.overrideMimeType("text/xml");var s=t;var o=this;i.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){this.responseXML.getElementById=o.getElementById;o.loaded(s,this.responseXML)}else{e.error("Error loading Document: "+s+" status "+this.status)}}};i.open("GET",t,true);i.send("")}}};e.Collada.prototype.getSource=function(e){var t=this.xml.getElementById(e);if(!t)return[];if(!t.jsArray||this.badAccessor){var n;if(t.tagName=="vertices"){n=[];var r=t.getElementsByTagName("input");for(var i=0;i<r.length;i++){n[i]=this.getSource(r[i].getAttribute("source").substr(1));n[i].block=r[i].getAttribute("semantic")}}else{var s=t.getElementsByTagName("technique_common")[0].getElementsByTagName("accessor")[0];var o=this.xml.getElementById(s.getAttribute("source").substr(1));var u=o.tagName;n=this.parseArray(o);stride=parseInt(s.getAttribute("stride"));offset=parseInt(s.getAttribute("offset"));if(!offset)offset=0;if(!stride)stride=1;count=parseInt(s.getAttribute("count"));var a=s.getElementsByTagName("param");var f=[];for(var i=0;i<a.length;i++){if(a[i].hasAttribute("name")||this.exceptions.badAccessor||this.badAccessor)f.push({type:a[i].getAttribute("type"),name:a[i].getAttribute("name")});else f.push(false)}n={array:n,stride:stride,offset:offset,count:count,pmask:f,type:u}}t.jsArray=n}return t.jsArray};var t={};e.Collada.prototype.getMeshes=function(n,r){if(!t[this.url])t[this.url]=[];if(t[this.url][n])return t[this.url][n];var i,s;var o;var u;var a;var f;var l;var c;var h;var p;var d;var v=this.xml.getElementById(n);if(!v){e.error("Collada.getMeshes returning [], id: "+n);return[]}var m=v.getElementsByTagName("mesh");if(!m){e.error("Collada.getMeshes returning [], id: "+n);return[]}meshNode=null;if(m.length){meshNode=m[0]}else{e.error("Collada.getMeshes returning [], id: "+n)}var g=[];if(!meshNode)return g;var y=meshNode.getElementsByTagName("polylist");for(i=0;i<y.length;i++){c=this.parseArray(y[i].getElementsByTagName("p")[0]);vcount=this.parseArray(y[i].getElementsByTagName("vcount")[0]);var b=y[i].getElementsByTagName("input");var w=0;for(s=0;s<b.length;s++)w=Math.max(w,b[s].getAttribute("offset"));var E=[];var S=0;for(s=0;s<vcount.length;s++){for(var x=0;x<vcount[s]-2;x++){for(var T=0;T<=w;T++){E.push(c[S+T])}for(T=0;T<=w;T++){E.push(c[S+(w+1)*(x+1)+T])}for(T=0;T<=w;T++){E.push(c[S+(w+1)*(x+2)+T])}}S=S+(w+1)*vcount[s]}y[i].getElementsByTagName("p")[0].data=E}var N=meshNode.getElementsByTagName("polygons");for(i=0;i<N.length;i++){var C=N[i].getElementsByTagName("p");var E=[];for(var k=0;k<C.length;k++){var c=this.parseArray(C[k]);var b=N[i].getElementsByTagName("input");var w=0;for(s=0;s<b.length;s++)w=Math.max(w,b[s].getAttribute("offset"));var S=0;for(x=0;x<c.length/(w+1)-2;x++){for(T=0;T<=w;T++){E.push(c[S+T])}for(T=0;T<=w;T++){E.push(c[S+(w+1)*(x+1)+T])}for(T=0;T<=w;T++){E.push(c[S+(w+1)*(x+2)+T])}}S=S+(w+1)*(c.length/(w+1))}if(C.length>0)N[i].getElementsByTagName("p")[0].data=E}var L=[];var E=meshNode.getElementsByTagName("triangles");for(i=0;i<y.length;i++){L.push(y[i])}for(i=0;i<N.length;i++){if(N[i].getElementsByTagName("p").length>0)L.push(N[i])}for(i=0;i<E.length;i++){L.push(E[i])}for(i=0;i<L.length;i++){u=L[i].getElementsByTagName("input");f=[];l=[];a=[];h={};for(s=0;s<u.length;s++){u[s].data=this.getSource(u[s].getAttribute("source").substr(1));p=u[s].getAttribute("semantic");if(p=="TEXCOORD"){d=u[s].getAttribute("set");if(!d)d=0;p=p+d}if(p=="VERTEX"){for(var k=0;k<u[s].data.length;k++){h[u[s].data[k].block]=[]}}u[s].block=p;u[s].offset=parseInt(u[s].getAttribute("offset"));h[p]=[];a.push(u[s])}if(L[i].getElementsByTagName("p")[0].data)c=L[i].getElementsByTagName("p")[0].data;else c=this.parseArray(L[i].getElementsByTagName("p")[0]);for(var s=0;s<a.length;s++){if(a[s].block!="VERTEX"){a[s].data=[a[s].data];a[s].data[0].block=a[s].block}}var w=0;for(s=0;s<a.length;s++){w=Math.max(a[s].offset+1,w)}for(x=0;x<c.length;x=x+w){for(s=0;s<a.length;s++){for(var k=0;k<a[s].data.length;k++){var p=a[s].data[k].block;var A=a[s].data[k].stride;for(T=0;T<a[s].data[k].stride;T++){if(a[s].data[k].pmask[T]){h[p].push(a[s].data[k].array[c[x+a[s].offset]*a[s].data[k].stride+T+a[s].data[k].offset])}}if(r&&p=="POSITION"){for(T=0;T<r.count;T++){f.push(r.vertexJoints[c[x+a[s].offset]*r.count+T]);l.push(r.vertexWeight[c[x+a[s].offset]*r.count+T])}}if(p=="POSITION"&&A==1){h[p].push(0);h[p].push(0)}if(p=="POSITION"&&A==2)h[p].push(0);if(p=="TEXCOORD0"&&A==3)h[p].pop();if(p=="TEXCOORD1"&&A==3)h[p].pop()}}}c=[];var O=e.Mesh.WINDING_ORDER_CLOCKWISE;if(!h.NORMAL){console.log("Autogenerating normals, do not know facings");h.NORMAL=[];for(s=0;s<h.POSITION.length;s=s+9){var M=e.subVec3([h.POSITION[s],h.POSITION[s+1],h.POSITION[s+2]],[h.POSITION[s+3],h.POSITION[s+4],h.POSITION[s+5]]);var _=e.subVec3([h.POSITION[s+6],h.POSITION[s+7],h.POSITION[s+8]],[h.POSITION[s],h.POSITION[s+1],h.POSITION[s+2]]);var D=e.toUnitVec3(e.crossVec3(e.toUnitVec3(_),e.toUnitVec3(M)));h.NORMAL.push(D[0]);h.NORMAL.push(D[1]);h.NORMAL.push(D[2]);h.NORMAL.push(D[0]);h.NORMAL.push(D[1]);h.NORMAL.push(D[2]);h.NORMAL.push(D[0]);h.NORMAL.push(D[1]);h.NORMAL.push(D[2])}var P=h.POSITION.length/3;for(s=0;s<P;s++)c.push(s)}else{O=e.Mesh.WINDING_ORDER_CLOCKWISE;for(s=0;s<h.POSITION.length;s=s+9){var M=e.subVec3([h.POSITION[s],h.POSITION[s+1],h.POSITION[s+2]],[h.POSITION[s+3],h.POSITION[s+4],h.POSITION[s+5]]);var _=e.subVec3([h.POSITION[s+6],h.POSITION[s+7],h.POSITION[s+8]],[h.POSITION[s],h.POSITION[s+1],h.POSITION[s+2]]);var D=e.crossVec3(_,M);var H=0;for(var B=0;B<9;B+=3){if(D[0]*h.NORMAL[s+B]+D[1]*h.NORMAL[s+B+1]+D[2]*h.NORMAL[s+B+2]<0){H-=1}else H+=1}if(H<0){var P=h.POSITION.length/3;c.push(s/3);c.push(s/3+2);c.push(s/3+1)}else{c.push(s/3);c.push(s/3+1);c.push(s/3+2)}}}if(!this.isSketchupFile())O=e.Mesh.WINDING_ORDER_UNKNOWN;function j(e,t){return e>t?t:e}var F=21843;F*=3;var I=(c.length-c.length%F)/F+(c.length%F?1:0);var q=[];var R=3;var U=3;var z=2;for(var W=0;W<I;++W){q.push(new e.Mesh(undefined,O));q[W].setPositions(h.POSITION.slice(F*W*R,j(F*R*(W+1),h.POSITION.length)));q[W].setNormals(h.NORMAL.slice(F*W*U,j(F*(W+1)*U,h.POSITION.length)));if(h.TEXCOORD0)q[W].setUV(h.TEXCOORD0.slice(F*W*z,j(F*(W+1)*z,h.TEXCOORD0.length)));if(!h.TEXCOORD0&&h.TEXCOORD1)q[W].setUV(h.TEXCOORD1.slice(F*W*z,j(F*(W+1)*z,h.TEXCOORD1.length)));if(h.TEXCOORD1)q[W].setUV2(h.TEXCOORD1.slice(F*W*z,j(F*(W+1)*z,h.TEXCOORD1.length)))}if(r){if(r.count>8){var X=[];var V=[];for(var x=0;x<l.length;x=x+r.count){var $=[];for(T=0;T<r.count;T++){$.push({weight:l[x+T],joint:f[x+T]})}$.sort(function(e,t){return parseFloat(t.weight)-parseFloat(e.weight)});for(T=0;T<8;T++){X.push($[T].joint);V.push($[T].weight)}}f=X;l=V;r.count=8}for(var W=0;W<I;++W){q[W].setJoints(r.joints);q[W].setInvBindMatrix(r.inverseBindMatrix);var J=j(F*(W+1)*r.count,f.length);var K=F*W*r.count;q[W].setVertexJoints(f.slice(K,J),r.count);q[W].setVertexWeights(l.slice(K,J),r.count)}}for(var W=0;W<I;++W){q[W].setFaces(c.slice(0,j(F*(W+1),c.length)-F*W));q[W].matName=L[i].getAttribute("material");g.push(q[W])}}t[this.url][n]=g;return g};e.Collada.prototype.getFloat4=function(e,t){var n=e.getElementsByTagName("newparam");for(var r=0;r<n.length;r++){if(n[r].getAttribute("sid")==t){return n[r].getElementsByTagName("float4")[0].firstChild.nodeValue;break}}return null};e.Collada.prototype.getFloat=function(e,t){var n=e.getElementsByTagName("newparam");for(var r=0;r<n.length;r++){if(n[r].getAttribute("sid")==t){return n[r].getElementsByTagName("float")[0].firstChild.nodeValue;break}}return null};e.Collada.prototype.getSampler=function(e,t){var n=e.getElementsByTagName("newparam");for(var r=0;r<n.length;r++){if(n[r].getAttribute("sid")==t){return n[r].getElementsByTagName("sampler2D")[0].getElementsByTagName("source")[0].firstChild.nodeValue;break}}return null};e.Collada.prototype.getSurface=function(e,t){var n=e.getElementsByTagName("newparam");for(var r=0;r<n.length;r++){if(n[r].getAttribute("sid")==t){return n[r].getElementsByTagName("surface")[0].getElementsByTagName("init_from")[0].firstChild.nodeValue;break}}return null};e.Collada.prototype.getImage=function(e){var t=this.xml.getElementById(e);if(!t)return;return this.getAbsolutePath(t.getElementsByTagName("init_from")[0].firstChild.nodeValue,this.docURL)};e.Collada.prototype.createMaterialLayer=function(t,n,r,i,s){var o;var u=this.getSurface(r,this.getSampler(r,t.getAttribute("texture")));if(!u)u=t.getAttribute("texture");o=this.getImage(u);var a=new e.Texture;a.setSrc(o);n.addTexture(a);var f=new e.MaterialLayer;f.setTexture(a);f.setMapto(i);if(t.hasAttribute("texcoord")&&s[t.getAttribute("texcoord")]){if(s[t.getAttribute("texcoord")]==1){f.setMapinput(e.UV2)}else if(s[t.getAttribute("texcoord")]==0){f.setMapinput(e.UV1)}else{e.error("GLGE only supports 2 texture sets\n");f.setMapinput(e.UV1)}}else{e.error("Collada material does not specify texture coordinates, but it may have them: defaulting to set 0\n");f.setMapinput(e.UV1)}if(t.getElementsByTagName("blend_mode")[0]){var l=t.getElementsByTagName("blend_mode")[0].firstChild.nodeValue;if(l=="MULTIPLY")f.setBlendMode(e.BL_MUL)}n.addMaterialLayer(f)};var r={};e.Collada.prototype.getMaterial=function(t,i){if(!r[this.url]){r[this.url]={}}else if(r[this.url][t]){return r[this.url][t]}var s=this.xml.getElementsByTagName("library_materials")[0];var o=n(s,t);if(!o){var u=new e.Material;r[this.url][t]=u;return u}var a=o.getElementsByTagName("instance_effect")[0].getAttribute("url").substr(1);var f=this.xml.getElementById(a);var l=f.getElementsByTagName("profile_COMMON")[0];var c=l.getElementsByTagName("technique")[0];var u=new e.Material;u.setBinaryAlpha(this.useBinaryAlpha);u.setSpecular(0);r[this.url][t]=u;var h;var p;var d=c.getElementsByTagName("ambient");if(d.length>0){h=d[0].firstChild;do{switch(h.tagName){case"color":p=h.firstChild.nodeValue.replace(/\s+/g," ").split(" ");u.setAmbient({r:p[0],g:p[1],b:p[2]});break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).replace(/\s+/g," ").split(" ");u.setAmbient({r:p[0],g:p[1],b:p[2]});break;case"texture":this.createMaterialLayer(h,u,l,e.M_AMBIENT,i);break}}while(h=h.nextSibling)}var v=c.getElementsByTagName("diffuse");if(v.length>0){h=v[0].firstChild;do{switch(h.tagName){case"color":p=h.firstChild.nodeValue.replace(/\s+/g," ").split(" ");u.setColor({r:p[0],g:p[1],b:p[2]});break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).replace(/\s+/g," ").split(" ");u.setColor({r:p[0],g:p[1],b:p[2]});break;case"texture":this.createMaterialLayer(h,u,l,e.M_COLOR,i);break}}while(h=h.nextSibling)}var m=c.getElementsByTagName("bump");if(m.length>0){h=m[0].firstChild;do{switch(h.tagName){case"texture":this.createMaterialLayer(h,u,l,e.M_NOR,i);break}}while(h=h.nextSibling)}var g=c.getElementsByTagName("shininess");if(g.length>0){u.setSpecular(1);h=c.getElementsByTagName("shininess")[0].firstChild;do{switch(h.tagName){case"float":if(parseFloat(h.firstChild.nodeValue)>1)u.setShininess(parseFloat(h.firstChild.nodeValue));else u.setShininess(parseFloat(h.firstChild.nodeValue)*128);break;case"param":var y=parseFloat(this.getFloat(l,h.getAttribute("ref")));if(y>1)u.setShininess(y);else u.setShininess(y*128);break;case"texture":this.createMaterialLayer(h,u,l,e.M_SHINE,i);break}}while(h=h.nextSibling)}var b=c.getElementsByTagName("specular");if(b.length>0){u.setSpecular(1);h=b[0].firstChild;do{switch(h.tagName){case"color":p=h.firstChild.nodeValue.replace(/\s+/g," ").split(" ");u.setSpecularColor({r:p[0],g:p[1],b:p[2]});break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).replace(/\s+/g," ").split(" ");u.setSpecularColor({r:p[0],g:p[1],b:p[2]});break;case"texture":this.createMaterialLayer(h,u,l,e.M_SPECCOLOR,i);break}}while(h=h.nextSibling)}var w=c.getElementsByTagName("emission");if(w.length>0){h=w[0].firstChild;do{switch(h.tagName){case"color":p=h.firstChild.nodeValue.split(" ");u.setEmit({r:p[0],g:p[1],b:p[2]});break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).split(" ");u.setEmit(p[0]);break;case"texture":this.createMaterialLayer(h,u,l,e.M_EMIT,i);break}}while(h=h.nextSibling)}var E=c.getElementsByTagName("reflective");if(E.length>0){h=E[0].firstChild;do{switch(h.tagName){case"color":p=h.firstChild.nodeValue.replace(/\s+/g," ").split(" ");break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).replace(/\s+/g," ").split(" ");break;case"texture":this.createMaterialLayer(h,u,l,e.M_REFLECT,i);break}}while(h=h.nextSibling)}var S=c.getElementsByTagName("transparency");if(S.length>0){h=S[0].firstChild;do{switch(h.tagName){case"float":if(h.firstChild.nodeValue<1){u.setAlpha(parseFloat(h.firstChild.nodeValue));u.trans=true}break;case"param":break}}while(h=h.nextSibling)}var x=c.getElementsByTagName("transparent");if(x.length>0){var T=x[0].getAttribute("opaque");if(!T)T="A_ONE";h=x[0].firstChild;do{switch(h.tagName){case"float":var N=parseFloat(h.firstChild.nodeValue);if(N<1){u.setAlpha(parseFloat(h.firstChild.nodeValue));u.trans=true}break;case"color":p=h.firstChild.nodeValue.replace(/\s+/g," ").split(" ");var N=this.getMaterialAlpha(p,T,1);if(N<1){u.setAlpha(N);u.trans=true}break;case"param":p=this.getFloat4(l,h.getAttribute("ref")).replace(/\s+/g," ").split(" ");var N=this.getMaterialAlpha(p,T,1);if(N<1){u.setAlpha(N);u.trans=true}break;case"texture":this.createMaterialLayer(h,u,l,e.M_ALPHA,i);u.trans=true;break}}while(h=h.nextSibling)}return u};e.Collada.prototype.getMaterialAlpha=function(e,t,n){var r;switch(t){case"A_ONE":r=parseFloat(e[3])*n;break;case"A_ZERO":r=1-parseFloat(e[3])*n;break;case"RGB_ONE":var i=parseFloat(e[0])*.212671+parseFloat(e[1])*.71516+parseFloat(e[2])*.072169;r=i*n;break;case"RGB_ZERO":var i=parseFloat(e[0])*.212671+parseFloat(e[1])*.71516+parseFloat(e[2])*.072169;r=1-i*n;break}return r};e.Collada.prototype.setMaterialOntoMesh=function(t,n){var r=n.getElementsByTagName("instance_material");var i={};for(var s=0;s<r.length;s++){var o=r[s].getElementsByTagName("bind_vertex_input");var u={};for(var a=0;a<o.length;a++){if(o[a].hasAttribute("input_set")){u[o[a].getAttribute("semantic")]=o[a].getAttribute("input_set")}else{function f(e){var t="";for(var n=e.length-1;n>=0;--n)if(e[n]>="0"&&e[n]<="9")t=e[n]+t;if(t.length==0)return"0";return t}u[o[a].getAttribute("semantic")]=f(o[a].getAttribute("semantic"))}}mat=this.getMaterial(r[s].getAttribute("target").substr(1),u);i[r[s].getAttribute("symbol")]=mat}var l=new e.Object;for(s=0;s<t.length;s++){if(i[t[s].matName]&&i[t[s].matName].trans){l.setZtransparent(true);l.setPickable(false)}var c=new e.MultiMaterial;c.setMesh(t[s]);if(!i[t[s].matName]){i[t[s].matName]=new e.Material;i[t[s].matName].setColor("lightgrey")}c.setMaterial(i[t[s].matName]);l.addMultiMaterial(c)}l.setSkeleton(this);n.GLGEObj=l};e.Collada.prototype.getInstanceGeometry=function(t){if(t.GLGEObj&&false){var n=new e.ObjectInstance;n.setObject(t.GLGEObj);return n}else{var r=t.getAttribute("url").substr(1);var i=this.getMeshes(r);this.setMaterialOntoMesh(i,t);t.GLGEObj.id=r;return t.GLGEObj}};e.Collada.prototype.getAnimationSampler=function(t,n){var r=30;var i=this.xml.getElementById(t).getElementsByTagName("input");var s={};var o=[];var u,a;for(var f=0;f<i.length;f++){u=this.getSource(i[f].getAttribute("source").substr(1));a=i[f].getAttribute("semantic");o.push({block:a,data:u})}for(var l=0;l<o.length;l++){a=o[l].block;s[a]={};s[a].data=[];s[a].names=[];for(var c=0;c<o[l].data.array.length;c=c+o[l].data.stride){var h=0;for(f=0;f<o[l].data.pmask.length;f++){if(o[l].data.pmask[f]){s[a].names.push(o[l].data.pmask[f].name);if(o[l].data.pmask[f].type=="float4x4"){s[a].stride=16;for(var p=0;p<16;p++){s[a].data.push(o[l].data.array[p+c+o[l].data.offset+f])}}else{h++;s[a].stride=h;s[a].data.push(o[l].data.array[c+o[l].data.offset+f])}}}}}var d;var v=[];for(var f=0;f<s["OUTPUT"].stride;f++){v.push(new e.AnimationCurve)}for(var f=0;f<s["INPUT"].data.length;f++){for(var p=0;p<s["OUTPUT"].stride;p++){v[p].name=s["OUTPUT"].names[p];if(s["INTERPOLATION"]&&s["INTERPOLATION"].data[f]=="BEZIER"&&!s["IN_TANGENT"]){s["INTERPOLATION"].data[f]="LINEAR"}if(!s["INTERPOLATION"]||s["INTERPOLATION"].data[f]=="LINEAR"){d=new e.LinearPoint;d.setX(s["INPUT"].data[f]*r);var m=parseFloat(s["OUTPUT"].data[f*s["OUTPUT"].stride+p]);if(m==-180)m=-179.9;if(m==180)m=179.9;if(this.exceptions["flipangle"]&&n){if(v[p].lastval){if(Math.abs(v[p].lastval-(360+m))<Math.abs(v[p].lastval-m)){m=360+m}else if(Math.abs(v[p].lastval-(m-360))<Math.abs(v[p].lastval-m)){m=m-360}}}d.setY(m);v[p].lastval=m;v[p].addPoint(d)}if(s["INTERPOLATION"]&&s["INTERPOLATION"].data[f]=="BEZIER"){d=new e.BezTriple;d.setX1(s["IN_TANGENT"].data[(f*s["OUTPUT"].stride+p)*2]*r);d.setY1(s["IN_TANGENT"].data[(f*s["OUTPUT"].stride+p)*2+1]);d.setX2(Math.round(s["INPUT"].data[f]*r));d.setY2(s["OUTPUT"].data[f*s["OUTPUT"].stride+p]);d.setX3(s["OUT_TANGENT"].data[(f*s["OUTPUT"].stride+p)*2]*r);d.setY3(s["OUT_TANGENT"].data[(f*s["OUTPUT"].stride+p)*2+1]);v[p].addPoint(d)}}}return v};e.Collada.prototype.getAnimationVector=function(t){var n=0;var r=this.xml.getElementById(t[0].target[0]);var i=t[0].target[0].toString();if(!r){var i=i.substring(i.indexOf("_")+1);r=this.xml.getElementById(i)}if(!r){var i=i.substring(i.indexOf("_")+1);r=this.xml.getElementById(i)}if(!r){e.error("unable to find targetNode:"+i+" within collada document");return new e.AnimationVector}var s=r.firstChild;var o=[];var u={};do{switch(s.tagName){case"matrix":case"translate":case"rotate":case"scale":def={type:s.tagName,data:this.parseArray(s),animations:[]};if(s.hasAttribute("sid"))u[s.getAttribute("sid")]=def;o.push(def);break}s=s.nextSibling}while(s);var a={};for(var f=0;f<t.length;f++){var i=t[f].target;var l=this.getAnimationSampler(t[f].source,/ANGLE/i.test(i));for(p=0;p<l.length;p++){n=Math.max(n,l[p].keyFrames[l[p].keyFrames.length-1].x)}if(i[1].indexOf(".")!=-1){var c=i[1].split(".");switch(c[1]){case"X":u[c[0]].animations[0]=l[0];break;case"Y":u[c[0]].animations[1]=l[0];break;case"Z":u[c[0]].animations[2]=l[0];break;case"ANGLE":u[c[0]].animations[3]=l[0];break}}else if(i[1].indexOf("(")!=-1){var h=i[1].split("(");sidtarget=h.shift();if(h.length>1)h=parseInt(h[0])+4*parseInt(h[1]);else h=parseInt(h[0]);u[sidtarget].animations[h]=l[0]}else{for(var p=0;p<l.length;p++){switch(l[p].name){case"X":u[i[1]].animations[0]=l[p];break;case"Y":u[i[1]].animations[1]=l[p];break;case"Z":u[i[1]].animations[2]=l[p];break;case"ANGLE":u[i[1]].animations[3]=l[p];break;default:u[i[1]].animations[p]=l[p];break}}}}var d=new e.AnimationVector;d.setFrames(n);var v=new e.AnimationCurve;v.setChannel("QuatX");var m=new e.AnimationCurve;m.setChannel("QuatY");var g=new e.AnimationCurve;g.setChannel("QuatZ");var y=new e.AnimationCurve;y.setChannel("QuatW");var b=new e.AnimationCurve;b.setChannel("LocX");var w=new e.AnimationCurve;w.setChannel("LocY");var E=new e.AnimationCurve;E.setChannel("LocZ");var S=new e.AnimationCurve;S.setChannel("ScaleX");var x=new e.AnimationCurve;x.setChannel("ScaleY");var T=new e.AnimationCurve;T.setChannel("ScaleZ");d.addAnimationCurve(v);d.addAnimationCurve(m);d.addAnimationCurve(g);d.addAnimationCurve(y);d.addAnimationCurve(b);d.addAnimationCurve(w);d.addAnimationCurve(E);d.addAnimationCurve(S);d.addAnimationCurve(x);d.addAnimationCurve(T);var N=null;for(var C=0;C<n;C++){var k=e.identMatrix();for(var f=0;f<o.length;f++){switch(o[f].type){case"matrix":var L=[o[f].animations[0]?o[f].animations[0].getValue(C):o[f].data[0],o[f].animations[1]?o[f].animations[1].getValue(C):o[f].data[1],o[f].animations[2]?o[f].animations[2].getValue(C):o[f].data[2],o[f].animations[3]?o[f].animations[3].getValue(C):o[f].data[3],o[f].animations[4]?o[f].animations[4].getValue(C):o[f].data[4],o[f].animations[5]?o[f].animations[5].getValue(C):o[f].data[5],o[f].animations[6]?o[f].animations[6].getValue(C):o[f].data[6],o[f].animations[7]?o[f].animations[7].getValue(C):o[f].data[7],o[f].animations[8]?o[f].animations[8].getValue(C):o[f].data[8],o[f].animations[9]?o[f].animations[9].getValue(C):o[f].data[9],o[f].animations[10]?o[f].animations[10].getValue(C):o[f].data[10],o[f].animations[11]?o[f].animations[11].getValue(C):o[f].data[11],o[f].animations[12]?o[f].animations[12].getValue(C):o[f].data[12],o[f].animations[13]?o[f].animations[13].getValue(C):o[f].data[13],o[f].animations[14]?o[f].animations[14].getValue(C):o[f].data[14],o[f].animations[15]?o[f].animations[15].getValue(C):o[f].data[15]];k=e.mulMat4(k,e.Mat4(L));break;case"rotate":var A=[o[f].animations[0]?o[f].animations[0].getValue(C):o[f].data[0],o[f].animations[1]?o[f].animations[1].getValue(C):o[f].data[1],o[f].animations[2]?o[f].animations[2].getValue(C):o[f].data[2],o[f].animations[3]?o[f].animations[3].getValue(C):o[f].data[3]];k=e.mulMat4(k,e.angleAxis(A[3]*.017453278,[A[0],A[1],A[2]]));break;case"translate":var O=[o[f].animations[0]?o[f].animations[0].getValue(C):o[f].data[0],o[f].animations[1]?o[f].animations[1].getValue(C):o[f].data[1],o[f].animations[2]?o[f].animations[2].getValue(C):o[f].data[2]];k=e.mulMat4(k,e.translateMatrix(O[0],O[1],O[2]));break;case"scale":var M=[o[f].animations[0]?o[f].animations[0].getValue(C):o[f].data[0],o[f].animations[1]?o[f].animations[1].getValue(C):o[f].data[1],o[f].animations[2]?o[f].animations[2].getValue(C):o[f].data[2]];k=e.mulMat4(k,e.scaleMatrix(M[0],M[1],M[2]));break}}scale=e.matrix2Scale(k);k=e.mulMat4(k,e.scaleMatrix(1/scale[0],1/scale[1],1/scale[2]));quat=e.rotationMatrix2Quat(k);if(N){if(N[0]*quat[0]+N[1]*quat[1]+N[2]*quat[2]+N[3]*quat[3]<0){quat[0]=quat[0]*-1;quat[1]=quat[1]*-1;quat[2]=quat[2]*-1;quat[3]=quat[3]*-1}}N=quat;point=new e.LinearPoint;point.setX(C);point.setY(quat[0]);v.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(quat[1]);m.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(quat[2]);g.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(quat[3]);y.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(k[3]);b.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(k[7]);w.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(k[11]);E.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(scale[0].toFixed(4));S.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(scale[1].toFixed(4));x.addPoint(point);point=new e.LinearPoint;point.setX(C);point.setY(scale[2].toFixed(4));T.addPoint(point)}return d};var i={};e.Collada.prototype.getAnimations=function(){if(i[this.url]){this.actions=i[this.url]}else{var t=this.xml.getElementsByTagName("animation_clip");var n=this.xml.getElementsByTagName("animation");if(t.length==0){n.name="default";var r=[n]}else{var r=[];for(var s=0;s<t.length;s++){var o=[];var u=t[s].getElementsByTagName("instance_animation");for(var a=0;a<u.length;a++){o.push(this.xml.getElementById(u[a].getAttribute("url").substr(1)))}o.name=t[s].getAttribute("id");r.push(o)}}for(var f=0;f<r.length;f++){var n=r[f];var l,c,h;var p={};for(var s=0;s<n.length;s++){l=n[s].getElementsByTagName("channel");for(var a=0;a<l.length;a++){var c=l[a].getAttribute("target").split("/");h=l[a].getAttribute("source").substr(1);if(!p[c[0]])p[c[0]]=[];p[c[0]].push({source:h,target:c})}}var d=new e.Action;for(var c in p){var v=this.getAnimationVector(p[c]);var m=this.xml.getElementById(c);if(!m){c=c.substring(c.indexOf("_")+1);m=this.xml.getElementById(c)}if(!m){c=c.substring(c.indexOf("_")+1);m=this.xml.getElementById(c)}if(!m){e.error("unable to find targetNode:"+c+" within collada document");continue}for(var s=0;s<m.GLGEObjects.length;s++){var g=new e.ActionChannel;var y=m.GLGEObjects[s].getName();g.setTarget(y);g.setAnimation(v);d.addActionChannel(g)}}this.addColladaAction({name:n.name,action:d})}}i[this.url]=this.actions;for(var b in this.actions){this.setAction(this.actions[b],0,true);break}};e.Collada.prototype.addColladaAction=function(e){this.actions[e.name]=e.action};e.Collada.prototype.getColladaActions=function(){return this.actions};e.Collada.prototype.getInstanceController=function(t){var n=new e.Object;var r=this.xml.getElementById(t.getAttribute("url").substr(1));if(!r){e.error("unable to find id:"+t.getAttribute("url").substr(1)+" within collada document");return n}var i=t.getElementsByTagName("skeleton");var s=r.getElementsByTagName("joints")[0];var o=s.getElementsByTagName("input");var u;if(r.getElementsByTagName("bind_shape_matrix").length>0){u=this.parseArray(r.getElementsByTagName("bind_shape_matrix")[0])}else{u=e.identMatrix()}var a=[u];var f=new e.Group;this.addGroup(f);var s=[f];var l;for(var c=0;c<o.length;c++){if(o[c].getAttribute("semantic")=="JOINT"){var h=this.getSource(o[c].getAttribute("source").substr(1));if(h.type=="IDREF_array"){var p=h.array.length!=0;for(var d=0;d<h.array.length;d=d+h.stride){var v=this.getNode(this.xml.getElementById(h.array[d]),true);var m=v.getName();if(!this.xml.getElementById(h.array[d])){e.error("Bone is not specified "+h.array[d]);a=[u=e.identMatrix()]}else p=false;s.push(m)}if(p)a=[u=e.identMatrix()]}else if(h.type=="Name_array"){var g={};var y,m;if(i.length==0){var b=this.xml.getElementsByTagName("node");for(d=0;d<b.length;d++){y=b[d].getAttribute("sid");if(y){g[y]=b[d]}m=b[d].getAttribute("name");if(m&&!g[m]){g[m]=b[d]}}}else{for(var w=0;w<i.length;w++){var E=this.xml.getElementById(i[w].firstChild.nodeValue.substr(1));y=E.getAttribute("sid");if(y)g[y]=E;var b=E.getElementsByTagName("*");for(d=0;d<b.length;d++){y=b[d].getAttribute("sid");if(y){g[y]=b[d]}m=b[d].getAttribute("name");if(m&&!g[m]){g[m]=b[d]}}}}for(var d=0;d<h.array.length;d=d+h.stride){if(h.array[d]!=""){var m=this.getNode(g[h.array[d]],true).getName();s.push(m)}}}}}for(var c=0;c<o.length;c++){if(o[c].getAttribute("semantic")=="INV_BIND_MATRIX"){var S=this.getSource(o[c].getAttribute("source").substr(1));for(var d=0;d<S.array.length;d=d+S.stride){l=S.array.slice(d,d+16);a.push(e.mulMat4(e.Mat4(l),e.Mat4(u.slice(0,16))))}}}var x=r.getElementsByTagName("vertex_weights")[0];o=x.getElementsByTagName("input");var T=[];var N={};for(var w=0;w<o.length;w++){O=o[w].getAttribute("semantic");o[w].data=this.getSource(o[w].getAttribute("source").substr(1));o[w].block=O;N[O]=[];var C=o[w].getAttribute("offset");if(!T[C])T[C]=[];T[C].push(o[w])}var k=this.parseArray(x.getElementsByTagName("vcount")[0]);var L=this.parseArray(x.getElementsByTagName("v")[0]);var A=0;for(var c=0;c<k.length;c++)if(k[c])A=Math.max(A,parseInt(k[c]));vPointer=0;var O;for(var c=0;c<k.length;c++){for(var M=0;M<k[c];M++){for(var d=0;d<T.length;d++){for(var _=0;_<T[d].length;++_){O=T[d][_].block;for(w=0;w<T[d][_].data.stride;w++){if(T[d][_].data.pmask[w]){if(O!="JOINT"){N[O].push(T[d][_].data.array[parseInt(L[vPointer])+parseInt(T[d][_].data.offset)])}else{N[O].push(parseInt(L[vPointer]))}vPointer++}}}}}for(M=M;M<A;M++){for(var d=0;d<T.length;d++){for(var _=0;_<T[d].length;++_){O=T[d][_].block;N[O].push(0)}}}}if(!this.badAccessor&&N["JOINT"].length==0){this.badAccessor=true;return this.getInstanceController(t)}for(var c=0;c<N["JOINT"].length;c++){N["JOINT"][c]++}if(this.exceptions.negjoints){for(var c=0;c<N["JOINT"].length;c++){if(N["JOINT"][c]==0){N["WEIGHT"][c]=0}}}var D={vertexJoints:N["JOINT"],vertexWeight:N["WEIGHT"],joints:s,inverseBindMatrix:a,count:A};var P=this.getMeshes(r.getElementsByTagName("skin")[0].getAttribute("source").substr(1),D);this.setMaterialOntoMesh(P,t);return t.GLGEObj};e.Collada.prototype.getInstanceLight=function(t){var n=t.getElementsByTagName("technique_common")[0].getElementsByTagName("*")[0];var r=new e.Light;var i=n.getElementsByTagName("color");if(i.length>0){var s=i[0].firstChild.nodeValue.split(" ");var o="rgb("+(s[0]*255|0)+","+(s[1]*255|0)+","+(s[2]*255|0)+")";r.setColor(o)}switch(n.tagName){case"point":r.setType(e.L_POINT);case"spot":var u=n.getElementsByTagName("constant_attenuation");if(u.length>0)r.setAttenuationConstant(parseFloat(u[0].firstChild.nodeValue));var a=n.getElementsByTagName("linear_attenuation");if(a.length>0)r.setAttenuationLinear(parseFloat(a[0].firstChild.nodeValue));var f=n.getElementsByTagName("quadratic_attenuation");if(f.length>0)r.setAttenuationQuadratic(parseFloat(f[0].firstChild.nodeValue));if(n.tagName=="spot"){r.setType(e.L_SPOT)}else{break}var l=n.getElementsByTagName("falloff_exponent");if(l.length>0){var c=parseFloat(l[0].firstChild.nodeValue);if(c<1.0001)c*=128;r.setSpotExponent(c)}var h=n.getElementsByTagName("falloff_angle");if(h.length>0)r.setSpotCosCutOff(Math.cos(parseFloat(h[0].firstChild.nodeValue)/180*Math.PI));break}return r};e.Collada.prototype.addColladaCamera=function(e){e.matrix=null;e.parent=this;this.children.push(e);this.hasCamera=true;return this};e.Collada.prototype.getNode=function(t,n){if(!n&&t.GLGEObject){r=t.GLGEObject;delete this.GLGEObject;return r}if(n&&t&&t.GLGEObjects){return t.GLGEObjects[0]}var r=new e.Group;var i="bone"+ ++this.boneIdx;r.setName(i);if(!t){return r}if(!t.GLGEObjects)t.GLGEObjects=[];t.GLGEObjects.push(r);var s=t.firstChild;var o=e.identMatrix();var u;if(s)do{switch(s.tagName){case"node":r.addGroup(this.getNode(s));break;case"instance_node":r.addGroup(this.getNode(this.xml.getElementById(s.getAttribute("url").substr(1))));break;case"instance_visual_scene":r.addGroup(this.getNode(this.xml.getElementById(s.getAttribute("url").substr(1))));break;case"instance_light":if(this.useLights)r.addLight(this.getInstanceLight(this.xml.getElementById(s.getAttribute("url").substr(1))));break;case"instance_geometry":r.addObject(this.getInstanceGeometry(s));break;case"instance_controller":r.addObject(this.getInstanceController(s));break;case"instance_camera":if(!this.useCamera)break;r.addColladaCamera(this.getNode(this.xml.getElementById(s.getAttribute("url").substr(1))));break;case"optics":if(!this.useCamera)break;var a=s.getElementsByTagName("technique_common");if(a&&a.length>0){a=a[0].getElementsByTagName("perspective");if(a&&a.length>0){var f=a[0].getElementsByTagName("yfov");if(f&&f.length>0){r.yFov=parseFloat(f[0].textContent)}var l=a[0].getElementsByTagName("znear");if(l&&l.length>0){r.zNear=parseFloat(l[0].textContent)}var c=a[0].getElementsByTagName("zfar");if(c&&c.length>0){r.zFar=parseFloat(c[0].textContent)}}}break;case"matrix":o=this.parseArray(s);break;case"translate":u=this.parseArray(s);o=e.mulMat4(o,e.translateMatrix(u[0],u[1],u[2]));break;case"rotate":u=this.parseArray(s);o=e.mulMat4(o,e.angleAxis(u[3]*.017453278,[u[0],u[1],u[2]]));break;case"scale":u=this.parseArray(s);o=e.mulMat4(o,e.scaleMatrix(u[0],u[1],u[2]));break}}while(s=s.nextSibling);r.setLoc(o[3],o[7],o[11]);var h=e.Mat4([o[0],o[1],o[2],0,o[4],o[5],o[6],0,o[8],o[9],o[10],0,0,0,0,1]);r.setRotMatrix(h);if(n)t.GLGEObject=r;return r};e.Collada.prototype.initVisualScene=function(){var t=this.xml.getElementsByTagName("asset");var n="Z_UP";if(t.length){var r=t[0].getElementsByTagName("up_axis");if(r.length){r=r[0];var i=r.firstChild.nodeValue;if(i.length)n=i}}var s=this;if(n[0]!="Y"&&n[0]!="y"){s=new e.Group;this.addChild(s);if(n[0]!="Z"&&n[0]!="z"){s.setRotMatrix(e.Mat4([0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1]))}else{s.setRotMatrix(e.Mat4([1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]))}}if(!this.rootId){var o=this.xml.getElementsByTagName("scene");if(o.length>0){s.addGroup(this.getNode(o[0]))}else{e.error("Please indicate the asset to render in Collada Document"+this.url)}}else{var u=this.xml.getElementById(this.rootId);if(u){s.addGroup(this.getNode(u))}else{e.error("Asset "+this.rootId+" not found in document"+this.url)}}if(this.useCamera){var a;var f=function(e){if(e.hasCamera){a=e;return}if(!e.children){return}for(var t=0;t<e.children.length&&!a;t++){f(e.children[t])}};f(s);if(a){pp=s.parent.parent;pp.camera.locX=a.locX;pp.camera.locY=a.locY;pp.camera.locZ=a.locZ;if(a.children&&a.children.length>0){var l=a.children[0];if(l.yFov){pp.camera.fovy=l.yFov;pp.camera.pMatrix=null}if(l.zNear){pp.camera.near=l.zNear}if(l.zFar){pp.camera.far=l.zFar}}pp.camera.matrix=null;pp.camera.rotmatrix=a.rotmatrix;pp.camera.lookAt=null}}};var s={"default":{},"COLLADA Mixamo exporter":{badAccessor:true},"FBX COLLADA exporter":{badAccessor:true},"Blender2.5":{flipangle:true,negjoints:true}};e.Collada.prototype.getExceptions=function(){if(this.xml.getElementsByTagName("authoring_tool").length>0&&this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue=="COLLADA Mixamo exporter"){return s["COLLADA Mixamo exporter"]}if(this.xml.getElementsByTagName("authoring_tool").length>0&&this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue=="FBX COLLADA exporter"){return s["FBX COLLADA exporter"]}if(this.xml.getElementsByTagName("authoring_tool").length>0&&/Blender 2.5/.test(this.xml.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue)){return s["Blender2.5"]}};e.Collada.prototype.loaded=function(e,t){this.xml=t;if(t.getElementsByTagName("authoring_tool").length>0)this.exceptions=s[t.getElementsByTagName("authoring_tool")[0].firstChild.nodeValue];this.exceptions=this.getExceptions();if(!this.exceptions)this.exceptions=s["default"];this.initVisualScene();this.getAnimations();if(this.loadedCallback){this.loadedCallback(this)}var n=this;setTimeout(function(){n.fireEvent("loaded",{url:this.url});if(n.isComplete())n.fireEvent("downloadComplete",{})},1)};e.Scene.prototype.addCollada=e.Scene.prototype.addGroup;e.Group.prototype.addCollada=e.Group.prototype.addGroup;if(e.Document){e.Document.prototype.getCollada=function(t){if(!t.object){t.object=new(e[this.classString(t.tagName)]);t.object.setDocument(t.getAttribute("document"),this.getAbsolutePath(this.rootURL,null));t.removeAttribute("document");this.setProperties(t)}return t.object}}})(GLGE);if(!GLGE){var GLGE={}}(function(e){e.HeightMap=function(e,t,n,r,s,o,u,a,f){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.canvas.width=t;this.canvas.height=n;this.minX=r;this.maxX=s;this.minY=o;this.maxY=u;this.minZ=a;this.maxZ=f;var l=new Image;l.heightmap=this;l.onload=function(e){this.heightmap.context.drawImage(this,0,0);this.heightmap.data=this.heightmap.context.getImageData(0,0,this.heightmap.canvas.width,this.heightmap.canvas.height).data;this.heightmap.minImgValue=this.heightmap.data[0];this.heightmap.maxImgValue=this.heightmap.data[0];for(i=0;i<this.heightmap.data.length;i+=4){if(this.heightmap.data[i]<this.heightmap.minImgValue){this.heightmap.minImgValue=this.heightmap.data[i]}if(this.heightmap.data[i]>this.heightmap.maxImgValue){this.heightmap.maxImgValue=this.heightmap.data[i]}}};l.src=e};e.HeightMap.prototype.canvas=null;e.HeightMap.prototype.context=null;e.HeightMap.prototype.minZ=null;e.HeightMap.prototype.maxZ=null;e.HeightMap.prototype.minY=null;e.HeightMap.prototype.maxY=null;e.HeightMap.prototype.minX=null;e.HeightMap.prototype.maxX=null;e.HeightMap.prototype.data=null;e.HeightMap.prototype.getPixelAt=function(e,t){if(this.data){return(this.data[(this.canvas.width*t+e)*4]-this.minImgValue)/(this.maxImgValue-this.minImgValue)*(this.maxZ-this.minZ)+this.minZ}else{return 0}};e.HeightMap.prototype.getHeightAt=function(e,t){var n;if(this.lastx!=undefined&&e==this.lastx&&t==this.lasty){n=this.lastValue}else{var r=Math.round((e-this.minX)/(this.maxX-this.minX)*this.canvas.width);var i=Math.round((t-this.minY)/(this.maxY-this.minY)*this.canvas.height);n=this.getPixelAt(r,i);this.lastValue=n}this.lastx=e;this.lasty=t;return n};e.KeyInput=function(){if(!document.keyStates)document.keyStates=[];document.addEventListener("keydown",this.onKeyDown,false);document.addEventListener("keyup",this.onKeyUp,false)};e.KeyInput.prototype.isKeyPressed=function(e){if(document.keyStates[e])return true;else return false};var t=null;e.KeyInput.prototype.onKeyDown=function(e){document.keyStates[e.keyCode]=true};e.KeyInput.prototype.onKeyUp=function(e){document.keyStates[e.keyCode]=false};e.MouseInput=function(e){this.element=e;this.element.mouseX=0;this.element.mouseY=0;if(!this.element.buttonState)this.element.buttonState=[];e.addEventListener("mousemove",this.onMouseMove,false);e.addEventListener("mousedown",this.onMouseDown,false);e.addEventListener("mouseup",this.onMouseUp,false)};e.MouseInput.prototype.element=null;e.MouseInput.prototype.onMouseMove=function(e){this.mouseX=e.clientX;this.mouseY=e.clientY};e.MouseInput.prototype.onMouseDown=function(e){this.buttonState[e.button]=true};e.MouseInput.prototype.onMouseUp=function(e){this.buttonState[e.button]=false};e.MouseInput.prototype.isButtonDown=function(e){if(this.element.buttonState[e])return true;else return false};e.MouseInput.prototype.getMousePosition=function(){return{x:this.element.mouseX,y:this.element.mouseY}};e.MI_LEFT=0;e.MI_MIDDLE=1;e.MI_RIGHT=2;e.KI_BACKSPACE=8;e.KI_TAB=9;e.KI_ENTER=13;e.KI_SHIFT=16;e.KI_CTRL=17;e.KI_ALT=18;e.KI_PAUSE_BREAK=19;e.KI_CAPS_LOCK=20;e.KI_ESCAPE=27;e.KI_PAGE_UP=33;e.KI_PAGE_DOWN=34;e.KI_END=35;e.KI_HOME=36;e.KI_LEFT_ARROW=37;e.KI_UP_ARROW=38;e.KI_RIGHT_ARROW=39;e.KI_DOWN_ARROW=40;e.KI_INSERT=45;e.KI_DELETE=46;e.KI_0=48;e.KI_1=49;e.KI_2=50;e.KI_3=51;e.KI_4=52;e.KI_5=53;e.KI_6=54;e.KI_7=55;e.KI_8=56;e.KI_9=57;e.KI_A=65;e.KI_B=66;e.KI_C=67;e.KI_D=68;e.KI_E=69;e.KI_F=70;e.KI_G=71;e.KI_H=72;e.KI_I=73;e.KI_J=74;e.KI_K=75;e.KI_L=76;e.KI_M=77;e.KI_N=78;e.KI_O=79;e.KI_P=80;e.KI_Q=81;e.KI_R=82;e.KI_S=83;e.KI_T=84;e.KI_U=85;e.KI_V=86;e.KI_W=87;e.KI_X=88;e.KI_Y=89;e.KI_Z=90;e.KI_LEFT_WINDOW_KEY=91;e.KI_RIGHT_WINDOW_KEY=92;e.KI_SELECT_KEY=93;e.KI_NUMPAD_0=96;e.KI_NUMPAD_1=97;e.KI_NUMPAD_2=98;e.KI_NUMPAD_3=99;e.KI_NUMPAD_4=100;e.KI_NUMPAD_5=101;e.KI_NUMPAD_6=102;e.KI_NUMPAD_7=103;e.KI_NUMPAD_8=104;e.KI_NUMPAD_9=105;e.KI_MULTIPLY=106;e.KI_ADD=107;e.KI_SUBTRACT=109;e.KI_DECIMAL_POINT=110;e.KI_DIVIDE=111;e.KI_F1=112;e.KI_F2=113;e.KI_F3=114;e.KI_F4=115;e.KI_F5=116;e.KI_F6=117;e.KI_F7=118;e.KI_F8=119;e.KI_F9=120;e.KI_F10=121;e.KI_F11=122;e.KI_F12=123;e.KI_NUM_LOCK=144;e.KI_SCROLL_LOCK=145;e.KI_SEMI_COLON=186;e.KI_EQUAL_SIGN=187;e.KI_COMMA=188;e.KI_DASH=189;e.KI_PERIOD=190;e.KI_FORWARD_SLASH=191;e.KI_GRAVE_ACCENT=192;e.KI_OPEN_BRACKET=219;e.KI_BACK_SLASH=220;e.KI_CLOSE_BRAKET=221;e.KI_SINGLE_QUOTE=222;e.KI_SPACE=32;if(!window.requestAnimationFrame){window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()}})(GLGE);(function(e){e.Scene.prototype.physicsGravity=[0,0,-9.8,0];e.Scene.prototype.getPhysicsNodes=function(t){if(!t)t=[];if(this.jigLibObj)t.push(this);if(this.children){for(var n=0;n<this.children.length;n++){e.Scene.prototype.getPhysicsNodes.call(this.children[n],t)}}return t};e.Scene.prototype.physicsPick=function(t,n,r){if(!this.physicsSystem)this.physicsTick(0,true);var i=this.makeRay(t,n);if(!i)return;var s=this.physicsSystem.getCollisionSystem();var o=new jigLib.JSegment(i.origin,e.scaleVec3(i.coord,-1e3));var u={};if(s.segmentIntersect(u,o,r?r.jigLibObj:null)){return{object:u.rigidBody.GLGE,normal:u.normal,distance:u.frac*1e3,position:u.position}}else{return false}};e.Scene.prototype.physicsPickObject=function(t,n,r){if(!this.physicsSystem)this.physicsTick(0,true);var i=this.makeRay(t,n);if(!i)return;var s=r.jigLibObj;var o=new jigLib.JSegment(i.origin,e.scaleVec3(i.coord,-1e3));var u={};if(s.segmentIntersect(u,o)){return{normal:u.normal,distance:u.frac*1e3,position:u.position}}else{return false}};e.Scene.prototype.segmentTest=function(e,t,n){if(!this.physicsSystem||!this.physicsSystem._collisionSystem)return false;var r=new jigLib.JSegment(e,t);var i={};if(this.physicsSystem._collisionSystem.segmentIntersect(i,r,n?n.jigLibObj:null)){var s=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return{object:i.rigidBody.GLGE,normal:i.normal,distance:i.frac*s,position:i.position}}return false};e.Scene.prototype.physicsTick=function(e,t){var n=this.getPhysicsNodes();if(!this.physicsSystem){this.physicsSystem=jigLib.PhysicsSystem.getInstance();this.physicsSystem.setGravity(this.physicsGravity);for(var r=0;r<n.length;r++){if(n[r].jigLibObj)this.physicsSystem.addBody(n[r].jigLibObj)}var i=this;this.addEventListener("childAdded",function(e){if(e.obj.jigLibObj)i.physicsSystem.addBody(e.obj.jigLibObj)});this.addEventListener("childRemoved",function(e){if(e.obj.jigLibObj)i.physicsSystem.removeBody(e.obj.jigLibObj)})}for(var r=0;r<n.length;r++){if(n[r].jigLibObj){n[r].preProcess(e)}}if(!t)this.physicsSystem.integrate(e)};e.Scene.prototype.setGravity=function(e){this.physicsGravity=e;if(this.physicsSystem){this.physicsSystem.setGravity(e)}return this};e.Scene.prototype.getGravity=function(e){return this.physicsSystem.getGravity(e)};e.Group.prototype.addPhysicsPlane=e.Group.prototype.addChild;e.Group.prototype.addPhysicsBox=e.Group.prototype.addChild;e.Group.prototype.addPhysicsSphere=e.Group.prototype.addChild;e.Group.prototype.addPhysicsMesh=e.Group.prototype.addChild;e.Scene.prototype.addPhysicsPlane=e.Group.prototype.addChild;e.Scene.prototype.addPhysicsBox=e.Group.prototype.addChild;e.Scene.prototype.addPhysicsSphere=e.Group.prototype.addChild;e.Scene.prototype.addPhysicsMesh=e.Group.prototype.addChild})(GLGE);(function(e){e.PhysicsAbstract=function(e){this.children=[]};e.augment(e.Group,e.PhysicsAbstract);e.PHYSICS_ALL=1;e.PHYSICS_LOC=2;e.PhysicsAbstract.prototype.physicsType=e.PHYSICS_ALL;e.PhysicsAbstract.prototype.sync=true;e.PhysicsAbstract.prototype.setType=function(e){this.physicsType=e;return this};e.PhysicsAbstract.prototype.getType=function(e){return this.physicsType};e.PhysicsAbstract.prototype.preProcess=function(e){if(this.sync){var t=this.getModelMatrix();this.jigLibObj.moveTo([t[3],t[7],t[11],0]);if(this.physicsType==1){var n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);var r=Math.sqrt(t[4]*t[4]+t[5]*t[5]+t[6]*t[6]);var i=Math.sqrt(t[8]*t[8]+t[9]*t[9]+t[10]*t[10]);this.jigLibObj.setOrientation(new jigLib.Matrix3D([t[0]/n,t[1]/n,t[2]/n,0,t[4]/r,t[5]/r,t[6]/r,0,t[8]/i,t[9]/i,t[10]/i,0,0,0,0,1]))}this.sync=false}};e.PhysicsAbstract.prototype.get_transform=function(){return new jigLib.Matrix3D(this.getModelMatrix())};e.PhysicsAbstract.prototype.updateMatrix=function(){this.globalMatrix=null;this.sync=true;e.Placeable.prototype.updateMatrix.call(this)};e.PhysicsAbstract.prototype.getModelMatrix=function(){if(this.globalMatrix)return this.globalMatrix;return e.Placeable.prototype.getModelMatrix.call(this)};e.PhysicsAbstract.prototype.set_transform=function(t){t=t.glmatrix;var n=[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]];this.locX=t[3];this.locY=t[7];this.locZ=t[11];n=e.mulMat4(n,this.getScaleMatrix());if(this.physicsType!=1){var r=this.getModelMatrix();n[0]=r[0];n[1]=r[1];n[2]=r[2];n[4]=r[4];n[5]=r[5];n[6]=r[6];n[8]=r[8];n[9]=r[9];n[10]=r[10]}this.globalMatrix=n;if(this.children){for(var i=0;i<this.children.length;i++){this.children[i].updateMatrix()}}return this};e.PhysicsAbstract.prototype.setVelocity=function(t,n){if(!this.getMovable())e.error("Cannot set velocity on static object");this.jigLibObj.setVelocity(t,n);return this};e.PhysicsAbstract.prototype.setVelocityX=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getVelocity([0,0,0]);n[0]=+t;this.jigLibObj.setVelocity(n);return this};e.PhysicsAbstract.prototype.setVelocityY=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getVelocity([0,0,0]);n[1]=+t;this.jigLibObj.setVelocity(n);return this};e.PhysicsAbstract.prototype.setVelocityZ=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getVelocity([0,0,0]);n[2]=+t;this.jigLibObj.setVelocity(n);return this};e.PhysicsAbstract.prototype.getVelocity=function(){return this.jigLibObj.getVelocity([0,0,0])};e.PhysicsAbstract.prototype.getVelocityX=function(){return this.jigLibObj.getVelocity([0,0,0])[0]};e.PhysicsAbstract.prototype.getVelocityY=function(){return this.jigLibObj.getVelocity([0,0,0])[1]};e.PhysicsAbstract.prototype.getVelocityZ=function(){return this.jigLibObj.getVelocity([0,0,0])[2]};e.PhysicsAbstract.prototype.setAngularVelocity=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");this.jigLibObj.setAngVel(t);return this};e.PhysicsAbstract.prototype.setAngularVelocityX=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getAngVel();n[0]=+t;this.jigLibObj.setAngVel(n);return this};e.PhysicsAbstract.prototype.setAngularVelocityY=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getAngVel();n[1]=+t;this.jigLibObj.setAngVel(n);return this};e.PhysicsAbstract.prototype.setAngularVelocityZ=function(t){if(!this.getMovable())e.error("Cannot set velocity on static object");var n=this.jigLibObj.getAngVel();n[2]=+t;this.jigLibObj.setAngVel(n);return this};e.PhysicsAbstract.prototype.getAngularVelocity=function(){return this.jigLibObj.getAngVel()};e.PhysicsAbstract.prototype.getAngularVelocityX=function(){return this.jigLibObj.getAngVel()[0]};e.PhysicsAbstract.prototype.getAngularVelocityY=function(){return this.jigLibObj.getAngVel()[1]};e.PhysicsAbstract.prototype.getAngularVelocityZ=function(){return this.jigLibObj.getAngVel()[2]};e.PhysicsAbstract.prototype.setMovable=function(e){this.jigLibObj.set_movable(e);return this};e.PhysicsAbstract.prototype.getMovable=function(){return this.jigLibObj.get_movable()};e.PhysicsAbstract.prototype.setFriction=function(e){this.jigLibObj.set_friction(e);return this};e.PhysicsAbstract.prototype.getFriction=function(){return this.jigLibObj.get_friction()};e.PhysicsAbstract.prototype.setMass=function(e){this.jigLibObj.set_mass(e);return this};e.PhysicsAbstract.prototype.getMass=function(){return this.jigLibObj.get_mass()};e.PhysicsAbstract.prototype.setRestitution=function(e){this.jigLibObj.set_restitution(e);return this};e.PhysicsAbstract.prototype.getRestitution=function(){return this.jigLibObj.get_restitution()};e.PhysicsAbstract.prototype.addBodyForce=function(e,t){this.jigLibObj.addBodyForce(e,t);return this};e.PhysicsAbstract.prototype.addWorldForce=function(e,t){this.jigLibObj.addWorldForce(e,t);return this};e.PhysicsAbstract.prototype.addWorldTorque=function(e){this.jigLibObj.addWorldTorque(e);return this};e.PhysicsAbstract.prototype.addBodyTorque=function(e){this.jigLibObj.addBodyTorque(e);return this};e.PhysicsAbstract.prototype.setLinearVelocityDamping=function(e){this.jigLibObj.set_linVelocityDamping(e);return this};e.PhysicsAbstract.prototype.getRotationalVelocityDamping=function(e){return this.jigLibObj.get_rotVelocityDamping()};e.PhysicsAbstract.prototype.getLinearVelocityDamping=function(e){return this.jigLibObj.get_linVelocityDamping()};e.PhysicsAbstract.prototype.setRotationalVelocityDamping=function(e){this.jigLibObj.set_rotVelocityDamping(e);return this};e.PhysicsAbstract.prototype.clearForces=function(){this.jigLibObj.clearForces();return this}})(GLGE);(function(e){e.PhysicsBox=function(t){this.jigLibObj=new jigLib.JBox(this,this.width,this.height,this.depth);this.jigLibObj.GLGE=this;this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION,function(e){this.GLGE.fireEvent("collision",{obj:e.collisionBody.GLGE,impulse:e.collisionImpulse})});e.PhysicsAbstract.call(this,t)};e.augment(e.PhysicsAbstract,e.PhysicsBox);e.PhysicsBox.prototype.width=1;e.PhysicsBox.prototype.height=1;e.PhysicsBox.prototype.depth=1;e.PhysicsBox.prototype.className="PhysicsBox";e.PhysicsBox.prototype.setWidth=function(e){this.width=e;var t=this.jigLibObj.get_sideLengths();t[0]=+e;this.jigLibObj.set_sideLengths(t);return this};e.PhysicsBox.prototype.setHeight=function(e){this.height=e;var t=this.jigLibObj.get_sideLengths();t[1]=+e;this.jigLibObj.set_sideLengths(t);return this};e.PhysicsBox.prototype.setDepth=function(e){this.depth=e;var t=this.jigLibObj.get_sideLengths();t[2]=+e;this.jigLibObj.set_sideLengths(t);return this};e.PhysicsBox.prototype.getWidth=function(){return this.jigLibObj.get_sideLengths()[0]};e.PhysicsBox.prototype.getHeight=function(){return this.jigLibObj.get_sideLengths()[1]};e.PhysicsBox.prototype.getDepth=function(){return this.jigLibObj.get_sideLengths()[2]}})(GLGE);(function(e){e.PhysicsMesh=function(t){this.jigLibObj=new jigLib.JTriangleMesh(null,100,.1);this.jigLibObj.GLGE=this;this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION,function(e){this.GLGE.fireEvent("collision",{obj:e.collisionBody.GLGE,impulse:e.collisionImpulse})});this.dirty=true;this.addEventListener("matrixUpdate",this.makeDirty);this.addEventListener("childMatrixUpdate",this.makeDirty);this.addEventListener("childAdded",this.makeDirty);this.addEventListener("childRemoved",this.makeDirty);e.PhysicsAbstract.call(this,t)};e.augment(e.PhysicsAbstract,e.PhysicsMesh);e.PhysicsMesh.prototype.className="PhysicsMesh";e.PhysicsMesh.prototype.forceUpdate=function(){this.dirty=true;return this};e.PhysicsMesh.prototype.makeDirty=function(e){this.dirty=true};e.PhysicsMesh.prototype.preProcess=function(){if(this.dirty){var e=this.getTriangles();this.jigLibObj.createMesh(e.verts,e.faces);this.dirty=false}};e.PhysicsMesh.prototype.getTriangles=function(){var t=this.getObjects();var n=[];var r=[];for(var i=0;i<t.length;i++){if(t[i].multimaterials){var s=t[i].getModelMatrix();for(var o=0;o<t[i].multimaterials.length;o++){var u=t[i].multimaterials[o].getMesh();var a=n.length;if(u){for(var f=0;f<u.positions.length;f=f+3){var l=[u.positions[f],u.positions[f+1],u.positions[f+2],1];var c=e.mulMat4Vec4(s,l);n.push([c[0],c[1],c[2],1])}var h=u.faces.data;if(h){var p=h.length;p=(p/3|0)*3;for(var f=0;f<p;f=f+3){r.push([+h[f]+a,+h[f+1]+a,+h[f+2]+a])}}else{for(var f=0;f<u.positions.length/3;f=f+3){r.push([f+a,f+1+a,f+2+a])}}}}}}return{verts:n,faces:r}}})(GLGE);(function(e){e.PHYSICS_XAXIS=[1,0,0,0];e.PHYSICS_YAXIS=[0,1,0,0];e.PHYSICS_ZAXIS=[0,0,1,0];e.PHYSICS_NEGXAXIS=[-1,0,0,0];e.PHYSICS_NEGYAXIS=[0,-1,0,0];e.PHYSICS_NEGZAXIS=[0,0,-1,0];e.PhysicsPlane=function(t){this.jigLibObj=new jigLib.JPlane(this,this.normal,this.distance);this.jigLibObj.GLGE=this;this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION,function(e){this.GLGE.fireEvent("collision",{obj:e.collisionBody.GLGE,impulse:e.collisionImpulse})});e.PhysicsAbstract.call(this,t)};e.augment(e.PhysicsAbstract,e.PhysicsPlane);e.PhysicsPlane.prototype.normal=[0,0,1,0];e.PhysicsPlane.prototype.distance=0;e.PhysicsPlane.prototype.className="PhysicsPlane";e.PhysicsPlane.prototype.setNormal=function(e){this.normal=e;this.jigLibObj.set_normal(e);return this};e.PhysicsPlane.prototype.setDistance=function(e){this.distance=e;this.jigLibObj.set_distance(e);return this};e.PhysicsPlane.prototype.getNormal=function(){return this.jigLibObj.get_normal()};e.PhysicsPlane.prototype.getDistance=function(){return this.jigLibObj.get_distance()}})(GLGE);(function(e){e.PhysicsSphere=function(t){this.jigLibObj=new jigLib.JSphere(this,this.radius);this.jigLibObj.GLGE=this;this.jigLibObj.addEventListener(jigLib.JCollisionEvent.COLLISION,function(e){this.GLGE.fireEvent("collision",{obj:e.collisionBody.GLGE,impulse:e.collisionImpulse})});e.PhysicsAbstract.call(this,t)};e.augment(e.PhysicsAbstract,e.PhysicsSphere);e.PhysicsSphere.prototype.radius=1;e.PhysicsSphere.prototype.className="PhysicsSphere";e.PhysicsSphere.prototype.setRadius=function(e){this.physicsRadius=+e;this.jigLibObj.set_radius(+e);return this};e.PhysicsSphere.prototype.getRadius=function(e){return this.jigLibObj.get_radius()}})(GLGE);(function(e){e.PhysicsConstraintPoint=function(){};e.augment(e.QuickNotation,e.PhysicsConstraintPoint);e.augment(e.JSONLoader,e.PhysicsConstraintPoint);e.PhysicsConstraintPoint.constraint=null;e.PhysicsConstraintPoint.prototype.className="PhysicsConstraintPoint";e.PhysicsConstraintPoint.prototype.setBody1=function(e){this.body1=e;this.updateConstraint();return this};e.PhysicsConstraintPoint.prototype.setBody2=function(e){this.body2=e;this.updateConstraint();return this};e.PhysicsConstraintPoint.prototype.setBodyPos1=function(e){if(typeof e=="string")e=e.split(",");this.bodypos1=[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])];this.updateConstraint();return this};e.PhysicsConstraintPoint.prototype.setBodyPos2=function(e){if(typeof e=="string")e=e.split(",");this.bodypos2=[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])];this.updateConstraint();return this};e.PhysicsConstraintPoint.prototype.updateConstraint=function(){if(this.body1&&this.body2&&this.bodypos1&&this.bodypos2){if(this.constraint){if(this.parent&&this.parent.physicsSystem)this.parent.physicsSystem.removeConstraint(this.constraint);this.body1.removeConstraint(this.constraint);this.body2.removeConstraint(this.constraint)}this.constraint=new jigLib.JConstraintPoint(this.body1.jigLibObj,this.bodypos1,this.body2.jigLibObj,this.bodypos2);if(this.parent&&this.parent.physicsSystem)this.parent.physicsSystem.addConstraint(this.constraint)}};e.Scene.prototype.addPhysicsConstraintPoint=function(e){if(!this.constraints)this.constraints=[];this.constraints.push(e);if(this.physicsSystem)this.physicsSystem.addConstraint(e.constraint);return this};e.Scene.prototype.removePhysicsConstraintPoint=function(e){if(!this.constraints)this.constraints=[];if(this.constraints.indexOf(e)>-1){this.constraints.push(e);if(this.physicsSystem)this.physicsSystem.removeConstraint(e.constraint)}return this}})(GLGE);(function(e){e.PhysicsCar=function(t){e.PhysicsBox.call(this,t);this.wheels=[];this.setRotationalVelocityDamping([.1,.6,.1]);this.setLinearVelocityDamping([.996,.92,.996]);return this};e.augment(e.PhysicsBox,e.PhysicsCar);e.PhysicsCar.prototype.className="PhysicsCar";e.Group.prototype.addPhysicsCar=e.Group.prototype.addChild;e.Scene.prototype.addPhysicsCar=e.Group.prototype.addChild;e.PhysicsCar.prototype.drive=function(e){for(var t=0;t<this.wheels.length;t++){var n=this.wheels[t];if(n.powered)n.drive(e)}return this};e.PhysicsCar.prototype.brake=function(e){for(var t=0;t<this.wheels.length;t++){if(this.wheels[t].powered)this.wheels[t].brake(e)}return this};e.PhysicsCar.prototype.addPhysicsWheel=function(t){this.wheels.push(t);return e.PhysicsBox.prototype.addChild.call(this,t)};e.PhysicsCar.prototype.removeWheel=function(t){var n=this.wheels.indexOf(t);if(n>-1)this.wheels.splice(n,1);return e.PhsyicsBox.prototype.addChild.call(this,t)};e.PhysicsCar.prototype.getScene=function(){var e=this;while(e.parent)e=e.parent;return e};e.PhysicsCar.prototype.preProcess=function(t){var n=this.getScene();var r=this.getVelocity();var i=this.getMass();var s=this.wheels;for(var o=0;o<s.length;o++){var u=s[o];var a=u.getModelMatrix();var f=e.toUnitVec3([a[2],a[6],a[10]]);var l=e.toUnitVec3([a[1],a[5],a[9]]);var c=e.toUnitVec3([a[0],a[4],a[8]]);var h=[a[3],a[7],a[11]];var p=u.radius;var d=u.travel;var v=u.spring;var m=u.sideFriction;var g=u.frontFriction;var y=0;var b=n.segmentTest(h,e.scaleVec3(l,-d-p),this);if(b){var w=b.distance-p;if(w<d){y=(d-w)/d*v;this.addWorldForce(e.scaleVec3(l,y),h);u.innerGroup.setLocY(p-b.distance)}var E=m;var S=e.scaleVec3(f,-e.dotVec3(f,r)*E);this.addWorldForce(S,h)}else{u.innerGroup.setLocY(-d)}var x=y*g;var T=x*t*t/p;var N=0;if(u.oldPos){var C=e.dotVec3(e.subVec3(h,u.oldPos),c)/p;var N=C/t-u.angVel;if(N<-T)N=-T;if(N>T)N=T}if(u.driveForce){var k=u.driveForce*(1-u.braking);if(k<-x)k=x;if(k>x)k=x;this.addWorldForce(e.scaleVec3(c,k),h);N+=u.driveForce/i*t/p}if(u.braking){var L=e.dotVec3(r,c);var A=-u.braking*L/t;if(A<-x)A=-x;if(A>x)A=x;this.addWorldForce(e.scaleVec3(c,A),h)}u.angVel+=N;if(u.brake)u.angVel*=1-u.braking;u.innerGroup.setRotZ(u.innerGroup.getRotZ()-u.angVel*t);u.angVel*=.995;u.oldPos=h}e.PhysicsBox.prototype.preProcess.call(this,t)};e.PhysicsWheel=function(t){e.Group.call(this,t);this.innerGroup=new e.Group;e.Group.prototype.addChild.call(this,this.innerGroup);return this};e.augment(e.Group,e.PhysicsWheel);e.PhysicsWheel.prototype.radius=1;e.PhysicsWheel.prototype.travel=.75;e.PhysicsWheel.prototype.angVel=0;e.PhysicsWheel.prototype.spring=90;e.PhysicsWheel.prototype.braking=0;e.PhysicsWheel.prototype.driveForce=0;e.PhysicsWheel.prototype.powered=false;e.PhysicsWheel.prototype.sideFriction=3;e.PhysicsWheel.prototype.frontFriction=3;e.PhysicsWheel.prototype.className="PhysicsWheel";e.PhysicsWheel.prototype.addChild=function(e){return this.innerGroup.addChild(e)};e.PhysicsWheel.prototype.removeChild=function(e){return this.innerGroup.removeChild(e)};e.PhysicsWheel.prototype.addGroup=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.addCollada=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.addObject=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.addMD2=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.addMD3=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.addWavefront=e.PhysicsWheel.prototype.addChild;e.PhysicsWheel.prototype.setPowered=function(e){this.powered=e;return this};e.PhysicsWheel.prototype.setRadius=function(e){this.radius=e;return this};e.PhysicsWheel.prototype.setSpring=function(e){this.spring=e;return this};e.PhysicsWheel.prototype.setTravel=function(e){this.travel=e;return this};e.PhysicsWheel.prototype.setFrontFriction=function(e){this.frontFriction=e;return this};e.PhysicsWheel.prototype.setSideFriction=function(e){this.sideFriction=e;return this};e.PhysicsWheel.prototype.setWheelRotation=function(e){this.setRotY(e);return this};e.PhysicsWheel.prototype.getWheelRotation=function(e){return this.getRotY()};e.PhysicsWheel.prototype.getRadius=function(){return this.radius};e.PhysicsWheel.prototype.getSpring=function(){return this.spring};e.PhysicsWheel.prototype.getTravel=function(){return this.travel};e.PhysicsWheel.prototype.getFrontFriction=function(){return this.frontFriction};e.PhysicsWheel.prototype.getSideFriction=function(){return this.sideFriction};e.PhysicsWheel.prototype.drive=function(e){this.driveForce=e;return this};e.PhysicsWheel.prototype.brake=function(e){this.braking=e;return this}})(GLGE);(function(e){e.Wavefront=function(t){this.multimaterials=[];this.materials={};this.instances=[];this.queue=[];this.idMaterials=[];e.Object.call(this,t);e.Assets.registerAsset(this,t)};e.augment(e.Object,e.Wavefront);e.Wavefront.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,8)=="https://"){return e}else{if(!t){t=window.location.href}if(t.indexOf("?")>0){t=t.substr(0,t.indexOf("?"))}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.Wavefront.prototype.loadMaterials=function(e){if(!this.loading){this.loadFile(e,null,function(e,t){this.parseMaterials(t.split("\n"));if(this.queue.length>0){var n=this.queue.pop();this.loadMaterials(n,this.src)}else{this.parseMesh();this.fireEvent("loaded",{})}})}else{this.queue.push(e)}};e.Wavefront.prototype.parseMaterials=function(t){var n=0;var r=0;var i=0;var s;while(r<t.length){if(t[r].substr(0,6)=="newmtl"){var o=t[r].replace(/^\s+|\s+$/g,"").replace(/\s+/g," ").split(" ");var u=new e.Material;s=t[n].substr(7);n=r+1;while(t[n].substr(0,6)!="newmtl"){o=t[n].replace(/^\s+|\s+$/g,"").replace(/\s+/g," ").split(" ");if(o.length>1){switch(o[0]){case"Kd":u.setColorR(parseFloat(o[1]));u.setColorG(parseFloat(o[2]));u.setColorB(parseFloat(o[3]));break;case"Ks":u.setSpecularColor({r:parseFloat(o[1]),g:parseFloat(o[2]),b:parseFloat(o[3])});break;case"Ns":u.setShininess(parseFloat(o[1]));break;case"d":this.setZtransparent(true);u.setAlpha(parseFloat(o[1]));break;case"map_Kd":var a=new e.MaterialLayer;a.setMapto(e.M_COLOR);a.setMapinput(e.UV1);var f=new e.Texture;var l=1;while(o[l][0]=="-")l=l+2;f.setSrc(this.getAbsolutePath(o[l],this.relativeTo));u.addTexture(f);a.setTexture(f);u.addMaterialLayer(a);break;case"map_Ks":case"map_spec":var a=new e.MaterialLayer;a.setMapto(e.M_SPECULAR);a.setMapinput(e.UV1);var f=new e.Texture;var l=1;while(o[l][0]=="-")l=l+2;f.setSrc(this.getAbsolutePath(o[l],this.relativeTo));u.addTexture(f);a.setTexture(f);u.addMaterialLayer(a);break;case"bump":case"map_bump":var a=new e.MaterialLayer;a.setMapto(e.M_NOR);a.setMapinput(e.UV1);var f=new e.Texture;var l=1;while(o[l][0]=="-")l=l+2;f.setSrc(this.getAbsolutePath(o[l],this.relativeTo));u.addTexture(f);a.setTexture(f);u.addMaterialLayer(a);break}}n++;if(n>=t.length)break}r=n-1;this.materials[i]=u;this.idMaterials.push(s);i++}r++}};e.Wavefront.prototype.loadFile=function(t,n,r){this.loading=true;if(!r)r=this.loaded;if(!n&&this.relativeTo)n=this.relativeTo;t=this.getAbsolutePath(t,n);if(!this.relativeTo)this.relativeTo=t;var i=new XMLHttpRequest;var s=this;if(i){i.overrideMimeType("text/plain");i.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){s.loading=false;r.call(s,t,this.responseText)}else{e.error("Error loading Document: "+t+" status "+this.status)}}};i.open("GET",t,true);i.send("")}};e.Wavefront.prototype.setSrc=function(e,t){this.src=this.getAbsolutePath(e,t);this.loadFile(this.src,t)};e.Wavefront.prototype.loaded=function(e,t){this.file=objArray=t.split("\n");var n=false;for(var r=0;r<objArray.length;r++){var i=objArray[r].split(" ");if(i.length>1){if(i[0]=="mtllib"){n=true;this.loadMaterials(i[1])}}}if(!n){this.parseMesh();this.fireEvent("loaded",{})}};e.Wavefront.prototype.createMultiMaterial=function(t,n,r,i,s,o,u,a){var f=[];var l=[];var c=[];var h=[];var p=[];var d={};for(var v=0;v<o.length;v++){var m=t[o[v]];var g=d[m];if(typeof g==="undefined"||!a){p.push(m);d[m]=p.length-1;h.push(p.length-1)}else{h.push(d[m])}}o=h;for(v=0;v<p.length;v++){if(p[v].indexOf("/")>0)var y=p[v].split("/");else var y=[p[v]];if(!r[y[0]-1])e.error(y[0]);f.push(r[y[0]-1][1]);f.push(r[y[0]-1][2]);f.push(r[y[0]-1][3]);if(y[1]){c.push(s[y[1]-1][1]);c.push(s[y[1]-1][2])}if(y[2]){l.push(i[y[2]-1][1]);l.push(i[y[2]-1][2]);l.push(i[y[2]-1][3])}}if(f.length/3>65024){var b=[];var w=[];var E=[];for(var v=0;v<o.length;v++){b.push(f[o[v]*3],f[o[v]*3+1],f[o[v]*3+2]);if(l.length>0)w.push(l[o[v]*3],l[o[v]*3+1],l[o[v]*3+2]);if(c.length>0)E.push(c[o[v]*2],c[o[v]*2+1])}f=b;l=w;c=E;o=[]}var S=new e.MultiMaterial;var x=new e.Mesh;x.setPositions(f);if(l.length>0)x.setNormals(l);if(c.length>0)x.setUV(c);if(o.length>0)x.setFaces(o);S.setMesh(x);S.setMaterial(u);this.addMultiMaterial(S)};e.Wavefront.prototype.parseMesh=function(){objArray=this.file;var t=[];var n=[];var r=[];var i=[];var s=[];var o={};var u=0;var a=true;var f=new e.Material;for(var l=0;l<objArray.length;l++){if(objArray[l][0]!="#"){var c=objArray[l].replace(/^\s+|\s+$/g,"").replace(/\s+/g," ").split(" ");if(c.length>0){switch(c[0]){case"s":if(c[1]=="1")a=true;else a=false;case"o":if(i.length>0){this.createMultiMaterial(s,o,n,r,t,i,f,a);i=[];f=new e.Material}break;case"usemtl":if(i.length>0){this.createMultiMaterial(s,o,n,r,t,i,f,a);i=[]}if(this.idMaterials.indexOf(c[1])==-1)f=this.materials[0];else f=this.materials[this.idMaterials.indexOf(c[1])];break;case"v":n.push(c);break;case"vt":t.push(c);break;case"vn":r.push(c);break;case"f":var h=[];for(var p=1;p<c.length;p++){var d=o[c[p]];if(typeof d==="undefined"||!a){s.push(c[p]);d=s.length-1;o[c[p]]=d}h.push(d)}for(p=0;p<h.length-2;p++){i.push(h[0]-u);i.push(h[1+p]-u);i.push(h[2+p]-u)}break}}}}this.createMultiMaterial(s,o,n,r,t,i,f,a)};e.Document.prototype.getWavefront=function(t){if(!t.object){var n=this.getAbsolutePath(this.rootURL,null);t.object=new(e[this.classString(t.tagName)]);t.object.setSrc(t.getAttribute("src"),n);t.removeAttribute("src");this.setProperties(t)}return t.object}})(GLGE);var LZMA=LZMA||{};LZMA.OutWindow=function(){this._windowSize=0};LZMA.OutWindow.prototype.create=function(e){if(!this._buffer||this._windowSize!==e){this._buffer=[]}this._windowSize=e;this._pos=0;this._streamPos=0};LZMA.OutWindow.prototype.flush=function(){var e=this._pos-this._streamPos;if(e!==0){while(e--){this._stream.writeByte(this._buffer[this._streamPos++])}if(this._pos>=this._windowSize){this._pos=0}this._streamPos=this._pos}};LZMA.OutWindow.prototype.releaseStream=function(){this.flush();this._stream=null};LZMA.OutWindow.prototype.setStream=function(e){this.releaseStream();this._stream=e};LZMA.OutWindow.prototype.init=function(e){if(!e){this._streamPos=0;this._pos=0}};LZMA.OutWindow.prototype.copyBlock=function(e,t){var n=this._pos-e-1;if(n<0){n+=this._windowSize}while(t--){if(n>=this._windowSize){n=0}this._buffer[this._pos++]=this._buffer[n++];if(this._pos>=this._windowSize){this.flush()}}};LZMA.OutWindow.prototype.putByte=function(e){this._buffer[this._pos++]=e;if(this._pos>=this._windowSize){this.flush()}};LZMA.OutWindow.prototype.getByte=function(e){var t=this._pos-e-1;if(t<0){t+=this._windowSize}return this._buffer[t]};LZMA.RangeDecoder=function(){};LZMA.RangeDecoder.prototype.setStream=function(e){this._stream=e};LZMA.RangeDecoder.prototype.releaseStream=function(){this._stream=null};LZMA.RangeDecoder.prototype.init=function(){var e=5;this._code=0;this._range=-1;while(e--){this._code=this._code<<8|this._stream.readByte()}};LZMA.RangeDecoder.prototype.decodeDirectBits=function(e){var t=0,n=e,r;while(n--){this._range>>>=1;r=this._code-this._range>>>31;this._code-=this._range&r-1;t=t<<1|1-r;if((this._range&4278190080)===0){this._code=this._code<<8|this._stream.readByte();this._range<<=8}}return t};LZMA.RangeDecoder.prototype.decodeBit=function(e,t){var n=e[t],r=(this._range>>>11)*n;if((this._code^2147483648)<(r^2147483648)){this._range=r;e[t]+=2048-n>>>5;if((this._range&4278190080)===0){this._code=this._code<<8|this._stream.readByte();this._range<<=8}return 0}this._range-=r;this._code-=r;e[t]-=n>>>5;if((this._range&4278190080)===0){this._code=this._code<<8|this._stream.readByte();this._range<<=8}return 1};LZMA.initBitModels=function(e,t){while(t--){e[t]=1024}};LZMA.BitTreeDecoder=function(e){this._models=[];this._numBitLevels=e};LZMA.BitTreeDecoder.prototype.init=function(){LZMA.initBitModels(this._models,1<<this._numBitLevels)};LZMA.BitTreeDecoder.prototype.decode=function(e){var t=1,n=this._numBitLevels;while(n--){t=t<<1|e.decodeBit(this._models,t)}return t-(1<<this._numBitLevels)};LZMA.BitTreeDecoder.prototype.reverseDecode=function(e){var t=1,n=0,r=0,i;for(;r<this._numBitLevels;++r){i=e.decodeBit(this._models,t);t=t<<1|i;n|=i<<r}return n};LZMA.reverseDecode2=function(e,t,n,r){var i=1,s=0,o=0,u;for(;o<r;++o){u=n.decodeBit(e,t+i);i=i<<1|u;s|=u<<o}return s};LZMA.LenDecoder=function(){this._choice=[];this._lowCoder=[];this._midCoder=[];this._highCoder=new LZMA.BitTreeDecoder(8);this._numPosStates=0};LZMA.LenDecoder.prototype.create=function(e){for(;this._numPosStates<e;++this._numPosStates){this._lowCoder[this._numPosStates]=new LZMA.BitTreeDecoder(3);this._midCoder[this._numPosStates]=new LZMA.BitTreeDecoder(3)}};LZMA.LenDecoder.prototype.init=function(){var e=this._numPosStates;LZMA.initBitModels(this._choice,2);while(e--){this._lowCoder[e].init();this._midCoder[e].init()}this._highCoder.init()};LZMA.LenDecoder.prototype.decode=function(e,t){if(e.decodeBit(this._choice,0)===0){return this._lowCoder[t].decode(e)}if(e.decodeBit(this._choice,1)===0){return 8+this._midCoder[t].decode(e)}return 16+this._highCoder.decode(e)};LZMA.Decoder2=function(){this._decoders=[]};LZMA.Decoder2.prototype.init=function(){LZMA.initBitModels(this._decoders,768)};LZMA.Decoder2.prototype.decodeNormal=function(e){var t=1;do{t=t<<1|e.decodeBit(this._decoders,t)}while(t<256);return t&255};LZMA.Decoder2.prototype.decodeWithMatchByte=function(e,t){var n=1,r,i;do{r=t>>7&1;t<<=1;i=e.decodeBit(this._decoders,(1+r<<8)+n);n=n<<1|i;if(r!==i){while(n<256){n=n<<1|e.decodeBit(this._decoders,n)}break}}while(n<256);return n&255};LZMA.LiteralDecoder=function(){};LZMA.LiteralDecoder.prototype.create=function(e,t){var n;if(this._coders&&this._numPrevBits===t&&this._numPosBits===e){return}this._numPosBits=e;this._posMask=(1<<e)-1;this._numPrevBits=t;this._coders=[];n=1<<this._numPrevBits+this._numPosBits;while(n--){this._coders[n]=new LZMA.Decoder2}};LZMA.LiteralDecoder.prototype.init=function(){var e=1<<this._numPrevBits+this._numPosBits;while(e--){this._coders[e].init()}};LZMA.LiteralDecoder.prototype.getDecoder=function(e,t){return this._coders[((e&this._posMask)<<this._numPrevBits)+((t&255)>>>8-this._numPrevBits)]};LZMA.Decoder=function(){this._outWindow=new LZMA.OutWindow;this._rangeDecoder=new LZMA.RangeDecoder;this._isMatchDecoders=[];this._isRepDecoders=[];this._isRepG0Decoders=[];this._isRepG1Decoders=[];this._isRepG2Decoders=[];this._isRep0LongDecoders=[];this._posSlotDecoder=[];this._posDecoders=[];this._posAlignDecoder=new LZMA.BitTreeDecoder(4);this._lenDecoder=new LZMA.LenDecoder;this._repLenDecoder=new LZMA.LenDecoder;this._literalDecoder=new LZMA.LiteralDecoder;this._dictionarySize=-1;this._dictionarySizeCheck=-1;this._posSlotDecoder[0]=new LZMA.BitTreeDecoder(6);this._posSlotDecoder[1]=new LZMA.BitTreeDecoder(6);this._posSlotDecoder[2]=new LZMA.BitTreeDecoder(6);this._posSlotDecoder[3]=new LZMA.BitTreeDecoder(6)};LZMA.Decoder.prototype.setDictionarySize=function(e){if(e<0){return false}if(this._dictionarySize!==e){this._dictionarySize=e;this._dictionarySizeCheck=Math.max(this._dictionarySize,1);this._outWindow.create(Math.max(this._dictionarySizeCheck,4096))}return true};LZMA.Decoder.prototype.setLcLpPb=function(e,t,n){var r=1<<n;if(e>8||t>4||n>4){return false}this._literalDecoder.create(t,e);this._lenDecoder.create(r);this._repLenDecoder.create(r);this._posStateMask=r-1;return true};LZMA.Decoder.prototype.init=function(){var e=4;this._outWindow.init(false);LZMA.initBitModels(this._isMatchDecoders,192);LZMA.initBitModels(this._isRep0LongDecoders,192);LZMA.initBitModels(this._isRepDecoders,12);LZMA.initBitModels(this._isRepG0Decoders,12);LZMA.initBitModels(this._isRepG1Decoders,12);LZMA.initBitModels(this._isRepG2Decoders,12);LZMA.initBitModels(this._posDecoders,114);this._literalDecoder.init();while(e--){this._posSlotDecoder[e].init()}this._lenDecoder.init();this._repLenDecoder.init();this._posAlignDecoder.init();this._rangeDecoder.init()};LZMA.Decoder.prototype.decode=function(e,t,n){var r=0,i=0,s=0,o=0,u=0,a=0,f=0,l,c,h,p,d,v;this._rangeDecoder.setStream(e);this._outWindow.setStream(t);this.init();while(n<0||a<n){l=a&this._posStateMask;if(this._rangeDecoder.decodeBit(this._isMatchDecoders,(r<<4)+l)===0){c=this._literalDecoder.getDecoder(a++,f);if(r>=7){f=c.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(i))}else{f=c.decodeNormal(this._rangeDecoder)}this._outWindow.putByte(f);r=r<4?0:r-(r<10?3:6)}else{if(this._rangeDecoder.decodeBit(this._isRepDecoders,r)===1){h=0;if(this._rangeDecoder.decodeBit(this._isRepG0Decoders,r)===0){if(this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(r<<4)+l)===0){r=r<7?9:11;h=1}}else{if(this._rangeDecoder.decodeBit(this._isRepG1Decoders,r)===0){p=s}else{if(this._rangeDecoder.decodeBit(this._isRepG2Decoders,r)===0){p=o}else{p=u;u=o}o=s}s=i;i=p}if(h===0){h=2+this._repLenDecoder.decode(this._rangeDecoder,l);r=r<7?8:11}}else{u=o;o=s;s=i;h=2+this._lenDecoder.decode(this._rangeDecoder,l);r=r<7?7:10;d=this._posSlotDecoder[h<=5?h-2:3].decode(this._rangeDecoder);if(d>=4){v=(d>>1)-1;i=(2|d&1)<<v;if(d<14){i+=LZMA.reverseDecode2(this._posDecoders,i-d-1,this._rangeDecoder,v)}else{i+=this._rangeDecoder.decodeDirectBits(v-4)<<4;i+=this._posAlignDecoder.reverseDecode(this._rangeDecoder);if(i<0){if(i===-1){break}return false}}}else{i=d}}if(i>=a||i>=this._dictionarySizeCheck){return false}this._outWindow.copyBlock(i,h);a+=h;f=this._outWindow.getByte(0)}}this._outWindow.flush();this._outWindow.releaseStream();this._rangeDecoder.releaseStream();return true};LZMA.Decoder.prototype.setDecoderProperties=function(e){var t,n,r,i,s;if(e.size<5){return false}t=e.readByte();n=t%9;t=~~(t/9);r=t%5;i=~~(t/5);if(!this.setLcLpPb(n,r,i)){return false}s=e.readByte();s|=e.readByte()<<8;s|=e.readByte()<<16;s+=e.readByte()*16777216;return this.setDictionarySize(s)};LZMA.decompress=function(e,t,n,r){var i=new LZMA.Decoder;if(!i.setDecoderProperties(e)){throw"Incorrect stream properties"}if(!i.decode(t,n,r)){throw"Error in data stream"}return true};LZMA.decompressFile=function(e,t){var n=new LZMA.Decoder,r;if(!n.setDecoderProperties(e)){throw"Incorrect stream properties"}r=e.readByte();r|=e.readByte()<<8;r|=e.readByte()<<16;r+=e.readByte()*16777216;e.readByte();e.readByte();e.readByte();e.readByte();if(!n.decode(e,t,r)){throw"Error in data stream"}return true};var CTM=CTM||{};CTM.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053};CTM.Flags={NORMALS:1};CTM.File=function(e){this.load(e)};CTM.File.prototype.load=function(e){this.header=new CTM.FileHeader(e);this.body=new CTM.FileBody(this.header);this.getReader().read(e,this.body)};CTM.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case CTM.CompressionMethod.RAW:e=new CTM.ReaderRAW;break;case CTM.CompressionMethod.MG1:e=new CTM.ReaderMG1;break;case CTM.CompressionMethod.MG2:e=new CTM.ReaderMG2;break}return e};CTM.FileHeader=function(e){e.readInt32();this.fileFormat=e.readInt32();this.compressionMethod=e.readInt32();this.vertexCount=e.readInt32();this.triangleCount=e.readInt32();this.uvMapCount=e.readInt32();this.attrMapCount=e.readInt32();this.flags=e.readInt32();this.comment=e.readString()};CTM.FileHeader.prototype.hasNormals=function(){return this.flags&CTM.Flags.NORMALS};CTM.FileBody=function(e){var t=e.triangleCount*3,n=e.vertexCount*3,r=e.hasNormals()?e.vertexCount*3:0,i=e.vertexCount*2,s=e.vertexCount*4,o=0;var u=new ArrayBuffer((t+n+r+i*e.uvMapCount+s*e.attrMapCount)*4);this.indices=new Uint32Array(u,0,t);this.vertices=new Float32Array(u,t*4,n);if(e.hasNormals()){this.normals=new Float32Array(u,(t+n)*4,r)}if(e.uvMapCount){this.uvMaps=[];for(o=0;o<e.uvMapCount;++o){this.uvMaps[o]={uv:new Float32Array(u,(t+n+r+o*i)*4,i)}}}if(e.attrMapCount){this.attrMaps=[];for(o=0;o<e.attrMapCount;++o){this.attrMaps[o]={attr:new Float32Array(u,(t+n+r+i*e.uvMapCount+o*s)*4,s)}}}};CTM.FileMG2Header=function(e){e.readInt32();this.vertexPrecision=e.readFloat32();this.normalPrecision=e.readFloat32();this.lowerBoundx=e.readFloat32();this.lowerBoundy=e.readFloat32();this.lowerBoundz=e.readFloat32();this.higherBoundx=e.readFloat32();this.higherBoundy=e.readFloat32();this.higherBoundz=e.readFloat32();this.divx=e.readInt32();this.divy=e.readInt32();this.divz=e.readInt32();this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx;this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy;this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz};CTM.ReaderRAW=function(){};CTM.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices);this.readVertices(e,t.vertices);if(t.normals){this.readNormals(e,t.normals)}if(t.uvMaps){this.readUVMaps(e,t.uvMaps)}if(t.attrMaps){this.readAttrMaps(e,t.attrMaps)}};CTM.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32();e.readArrayInt32(t)};CTM.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32();e.readArrayFloat32(t)};CTM.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32();e.readArrayFloat32(t)};CTM.ReaderRAW.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();t[n].filename=e.readString();e.readArrayFloat32(t[n].uv)}};CTM.ReaderRAW.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();e.readArrayFloat32(t[n].attr)}};CTM.ReaderMG1=function(){};CTM.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices);this.readVertices(e,t.vertices);if(t.normals){this.readNormals(e,t.normals)}if(t.uvMaps){this.readUVMaps(e,t.uvMaps)}if(t.attrMaps){this.readAttrMaps(e,t.attrMaps)}};CTM.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length);CTM.restoreIndices(t,t.length)};CTM.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t,1);LZMA.decompress(e,e,n,n.data.length)};CTM.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length)};CTM.ReaderMG1.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();t[n].filename=e.readString();e.readInt32();var r=new CTM.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,r,r.data.length)}};CTM.ReaderMG1.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();e.readInt32();var r=new CTM.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,r,r.data.length)}};CTM.ReaderMG2=function(){};CTM.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new CTM.FileMG2Header(e);this.readVertices(e,t.vertices);this.readIndices(e,t.indices);if(t.normals){this.readNormals(e,t)}if(t.uvMaps){this.readUVMaps(e,t.uvMaps)}if(t.attrMaps){this.readAttrMaps(e,t.attrMaps)}};CTM.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length);var r=this.readGridIndices(e,t);CTM.restoreVertices(t,this.MG2Header,r,this.MG2Header.vertexPrecision)};CTM.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32();e.readInt32();var n=new Uint32Array(t.length/3);var r=new CTM.InterleavedStream(n,1);LZMA.decompress(e,e,r,r.data.length);CTM.restoreGridIndices(n,n.length);return n};CTM.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t,3);LZMA.decompress(e,e,n,n.data.length);CTM.restoreIndices(t,t.length)};CTM.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32();e.readInt32();var n=new CTM.InterleavedStream(t.normals,3);LZMA.decompress(e,e,n,n.data.length);var r=CTM.calcSmoothNormals(t.indices,t.vertices);CTM.restoreNormals(t.normals,r,this.MG2Header.normalPrecision)};CTM.ReaderMG2.prototype.readUVMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();t[n].filename=e.readString();var r=e.readFloat32();e.readInt32();var i=new CTM.InterleavedStream(t[n].uv,2);LZMA.decompress(e,e,i,i.data.length);CTM.restoreMap(t[n].uv,2,r)}};CTM.ReaderMG2.prototype.readAttrMaps=function(e,t){var n=0;for(;n<t.length;++n){e.readInt32();t[n].name=e.readString();var r=e.readFloat32();e.readInt32();var i=new CTM.InterleavedStream(t[n].attr,4);LZMA.decompress(e,e,i,i.data.length);CTM.restoreMap(t[n].attr,4,r)}};CTM.restoreIndices=function(e,t){var n=3;if(t>0){e[2]+=e[0]}for(;n<t;n+=3){e[n]+=e[n-3];if(e[n]===e[n-3]){e[n+1]+=e[n-2]}else{e[n+1]+=e[n]}e[n+2]+=e[n]}};CTM.restoreGridIndices=function(e,t){var n=1;for(;n<t;++n){e[n]+=e[n-1]}};CTM.restoreVertices=function(e,t,n,r){var i,s,o,u,a,f=new Uint32Array(e.buffer,e.byteOffset,e.length),l=t.divx,c=l*t.divy,h=2147483647,p=0,d=0,v=0,m=n.length;for(;d<m;v+=3){o=i=n[d++];a=~~(o/c);o-=~~(a*c);u=~~(o/l);o-=~~(u*l);s=f[v];if(i===h){s+=p}e[v]=t.lowerBoundx+o*t.sizex+r*s;e[v+1]=t.lowerBoundy+u*t.sizey+r*f[v+1];e[v+2]=t.lowerBoundz+a*t.sizez+r*f[v+2];h=i;p=s}};CTM.restoreNormals=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p=new Uint32Array(e.buffer,e.byteOffset,e.length),d=0,v=e.length,m=3.141592653589793*.5;for(;d<v;d+=3){r=p[d]*n;i=p[d+1];if(i===0){e[d]=t[d]*r;e[d+1]=t[d+1]*r;e[d+2]=t[d+2]*r}else{if(i<=4){s=(p[d+2]-2)*m}else{s=(p[d+2]*4/i-2)*m}i*=n*m;o=r*Math.sin(i);u=o*Math.cos(s);a=o*Math.sin(s);f=r*Math.cos(i);c=t[d+1];l=t[d]-t[d+2];h=Math.sqrt(2*c*c+l*l);if(h>1e-20){l/=h;c/=h}e[d]=t[d]*f+(t[d+1]*c-t[d+2]*l)*a-c*u;e[d+1]=t[d+1]*f-(t[d+2]+t[d])*c*a+l*u;e[d+2]=t[d+2]*f+(t[d]*l+t[d+1]*c)*a+c*u}}};CTM.restoreMap=function(e,t,n){var r,i,s=new Uint32Array(e.buffer,e.byteOffset,e.length),o=0,u,a=e.length;for(;o<t;++o){r=0;for(u=o;u<a;u+=t){i=s[u];r+=i&1?-(i+1>>1):i>>1;e[u]=r*n}}};CTM.calcSmoothNormals=function(e,t){var n=new Float32Array(t.length),r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;for(m=0,g=e.length;m<g;){r=e[m++]*3;i=e[m++]*3;s=e[m++]*3;f=t[i]-t[r];h=t[s]-t[r];l=t[i+1]-t[r+1];p=t[s+1]-t[r+1];c=t[i+2]-t[r+2];d=t[s+2]-t[r+2];o=l*d-c*p;u=c*h-f*d;a=f*p-l*h;v=Math.sqrt(o*o+u*u+a*a);if(v>1e-10){o/=v;u/=v;a/=v}n[r]+=o;n[r+1]+=u;n[r+2]+=a;n[i]+=o;n[i+1]+=u;n[i+2]+=a;n[s]+=o;n[s+1]+=u;n[s+2]+=a}for(m=0,g=n.length;m<g;m+=3){v=Math.sqrt(n[m]*n[m]+n[m+1]*n[m+1]+n[m+2]*n[m+2]);if(v>1e-10){n[m]/=v;n[m+1]/=v;n[m+2]/=v}}return n};CTM.isLittleEndian=function(){var e=new ArrayBuffer(2),t=new Uint8Array(e),n=new Uint16Array(e);t[0]=1;return n[0]===1}();CTM.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this.offset=CTM.isLittleEndian?3:0;this.count=t*4;this.len=this.data.length};CTM.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e;this.offset+=this.count;if(this.offset>=this.len){this.offset-=this.len-4;if(this.offset>=this.count){this.offset-=this.count+(CTM.isLittleEndian?1:-1)}}};CTM.Stream=function(e){this.data=e;this.offset=0};CTM.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23);CTM.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126);CTM.Stream.prototype.readByte=function(){return this.data.charCodeAt(this.offset++)&255};CTM.Stream.prototype.readInt32=function(){var e=this.readByte();e|=this.readByte()<<8;e|=this.readByte()<<16;return e|this.readByte()<<24};CTM.Stream.prototype.readFloat32=function(){var e=this.readByte();e+=this.readByte()<<8;var t=this.readByte();var n=this.readByte();e+=(t&127)<<16;var r=(n&127)<<1|(t&128)>>>7;var i=n&128?-1:1;if(r===255){return e!==0?NaN:i*Infinity}if(r>0){return i*(1+e*this.TWO_POW_MINUS23)*Math.pow(2,r-127)}if(e!==0){return i*e*this.TWO_POW_MINUS126}return i*0};CTM.Stream.prototype.readString=function(){var e=this.readInt32();this.offset+=e;return this.data.substr(this.offset-e,e)};CTM.Stream.prototype.readArrayInt32=function(e){var t=0,n=e.length;while(t<n){e[t++]=this.readInt32()}return e};CTM.Stream.prototype.readArrayFloat32=function(e){var t=0,n=e.length;while(t<n){e[t++]=this.readFloat32()}return e};(function(e){e.OpenCTM=function(t){this.multimaterials=[];this.materials={};this.instances=[];this.queue=[];this.idMaterials=[];e.Object.call(this,t);e.Assets.registerAsset(this,t)};e.augment(e.Object,e.OpenCTM);e.OpenCTM.prototype.getAbsolutePath=function(e,t){if(e.substr(0,7)=="http://"||e.substr(0,7)=="file://"||e.substr(0,7)=="https://"){return e}else{if(!t){t=window.location.href}if(t.indexOf("?")>0){t=t.substr(0,t.indexOf("?"))}var n=t.split("/");var r=n[2];var i=n[0];var s=[];for(var o=3;o<n.length-1;o++){s.push(n[o])}if(e.substr(0,1)=="/"){s=[]}var u=e.split("/");for(o=0;o<u.length;o++){if(u[o]=="..")s.pop();else if(u[o]!="")s.push(u[o])}return i+"//"+r+"/"+s.join("/")}};e.OpenCTM.prototype.loadFile=function(t,n,r){this.loading=true;if(!r)r=this.loaded;if(!n&&this.relativeTo)n=this.relativeTo;t=this.getAbsolutePath(t,n);if(!this.relativeTo)this.relativeTo=t;var i=new XMLHttpRequest;var s=this;if(i){i.overrideMimeType("text/plain; charset=x-user-defined");i.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){s.loading=false;r.call(s,t,this.responseText)}else{e.error("Error loading Document: "+t+" status "+this.status)}}};i.open("GET",t,true);i.send("")}};e.OpenCTM.prototype.setSrc=function(e,t){this.src=this.getAbsolutePath(e,t);this.loadFile(this.src,t)};e.OpenCTM.prototype.loaded=function(e,t){var n=new CTM.Stream(t);var r=new CTM.File(n);this.parseMesh(r);this.fireEvent("loaded",{})};e.OpenCTM.prototype.parseMesh=function(t){var n=t.body.vertices;var r=t.body.normals||[];var i=t.body.uvMaps?t.body.uvMaps[0].uv:[];var s=t.body.indices||[];if(n.length/3>65024){var o=[];var u=[];var a=[];for(var f=0;f<s.length;f++){o.push(n[s[f]*3],n[s[f]*3+1],n[s[f]*3+2]);if(r.length>0)u.push(r[s[f]*3],r[s[f]*3+1],r[s[f]*3+2]);if(i.length>0)a.push(i[s[f]*2],i[s[f]*2+1])}n=o;r=u;i=a;s=[]}var l=new e.Mesh;l.setPositions(n);if(r.length>0)l.setNormals(r);if(i.length>0)l.setUV(i);if(s.length>0)l.setFaces(s);this.setMesh(l)};e.Document.prototype.getOpenCTM=function(t){if(!t.object){var n=this.getAbsolutePath(this.rootURL,null);t.object=new(e[this.classString(t.tagName)]);t.object.setSrc(t.getAttribute("src"),n);t.removeAttribute("src");this.setProperties(t)}return t.object};e.Scene.prototype.addOpenCTM=e.Scene.prototype.addObject})(GLGE);(function(e){if(typeof e.GUI=="undefined"){e.GUI={}}(function(t){t.useLibrary=function(e){if(e=="jQuery"&&jQuery){t.Progressbar.prototype.setValue=function(e){$(this.domRoot).progressbar({value:e})};t.Progressbar.prototype.init=function(){$(this.domRoot).progressbar({value:0})}}};t.Widget=function(){this.domRoot=document.createElement("div");this.domRoot.setAttribute("class","glge-gui-widget-root");this.init()};t.Widget.prototype.domRoot=null;t.Widget.prototype.init=function(){};t.Progressbar=function(){this.baseclass.call(this);this.domRoot.className+=" glge-gui-progressbar"};t.Progressbar.prototype.value=0;t.Progressbar.prototype.setValue=function(e){this.value=e};e.augment(t.Widget,t.Progressbar)})(e.GUI)})(GLGE);(function(e){if(typeof e.GUI=="undefined"){e.GUI={}}(function(e){e.Gadget=function(){this.domGadgetRoot=document.createElement("div");this.domGadgetRoot.setAttribute("class","glge-gui-gadget-root");this.domGadgetRoot.style.position="absolute";this.domGadgetRoot.style.top="0px";this.domGadgetOuterWrapper=document.createElement("div");this.domGadgetOuterWrapper.setAttribute("class","glge-gui-gadget-OuterWrapper");this.domGadgetOuterWrapper.style.position="relative";this.domGadgetRoot.appendChild(this.domGadgetOuterWrapper);this.domGadgetInnerWrapper=document.createElement("div");this.domGadgetInnerWrapper.setAttribute("class","glge-gui-gadget-InnerWrapper");this.domGadgetInnerWrapper.style.position="relative";this.domGadgetOuterWrapper.appendChild(this.domGadgetInnerWrapper);this.domGadgetObject=document.createElement("div");this.domGadgetObject.setAttribute("class","glge-gui-gadget");this.domGadgetObject.style.position="relative";this.domGadgetInnerWrapper.appendChild(this.domGadgetObject);this.domGadgetFooter=document.createElement("div");this.domGadgetFooter.setAttribute("class","glge-gui-gadget-footer");this.domGadgetFooter.style.clear="both";this.domGadgetRoot.appendChild(this.domGadgetFooter);this.position={};this.position.x="middle";this.position.y="middle";this.updatePosition()};e.Gadget.prototype.domGadgetRoot=null;e.Gadget.prototype.domGadgetOuterWrapper=null;e.Gadget.prototype.domGadgetInnerWrapper=null;e.Gadget.prototype.domGadgetObject=null;e.Gadget.prototype.domGadgetFooter=null;e.Gadget.prototype.domGadgetParent=null;e.Gadget.prototype.position=null;e.Gadget.prototype.setPosition=function(e){if(e){if(e.x)this.position.x=e.x;if(e.y)this.position.y=e.y}this.updatePosition()};e.Gadget.prototype.updatePosition=function(){if(!this.domGadgetParent)return;var e="";if(document.defaultView&&document.defaultView.getComputedStyle)e=document.defaultView.getComputedStyle(this.domGadgetParent,null).getPropertyValue("position");else if(this.domGadgetParent.currentStyle)e=this.domGadgetParent.currentStyle["position"];if(e=="absolute"){this.domGadgetRoot.style.width="100%";this.domGadgetRoot.style.height="100%";this.domGadgetRoot.style.display="table";this.domGadgetOuterWrapper.style.display="table-cell";if(this.position.y=="top"){this.domGadgetOuterWrapper.style.verticalAlign="top"}else if(this.position.y=="middle"){this.domGadgetOuterWrapper.style.verticalAlign="middle"}else if(this.position.y=="bottom"){this.domGadgetOuterWrapper.style.verticalAlign="bottom"}if(this.position.x=="left"){this.domGadgetInnerWrapper.style.cssFloat="left";this.domGadgetInnerWrapper.style.left="0px";this.domGadgetObject.style.cssFloat="left";this.domGadgetObject.style.left="0px"}else if(this.position.x=="middle"){this.domGadgetInnerWrapper.style.cssFloat="right";this.domGadgetInnerWrapper.style.right="50%";this.domGadgetObject.style.cssFloat="left";this.domGadgetObject.style.right="-50%"}else if(this.position.x=="right"){this.domGadgetInnerWrapper.style.cssFloat="right";this.domGadgetInnerWrapper.style.right="0px";this.domGadgetObject.style.cssFloat="right";this.domGadgetObject.style.right="0px"}}else{if(this.position.y=="top"){this.domGadgetRoot.style.top=this.domGadgetParent.offsetTop}else if(this.position.y=="middle"){this.domGadgetRoot.style.top=this.domGadgetParent.offsetTop+this.domGadgetParent.offsetHeight/2-this.domGadgetRoot.offsetHeight/2}else if(this.position.y=="bottom"){this.domGadgetRoot.style.top=this.domGadgetParent.offsetTop+this.domGadgetParent.offsetHeight-this.domGadgetRoot.offsetHeight}if(this.position.x=="left"){this.domGadgetRoot.style.left=this.domGadgetParent.offsetLeft}else if(this.position.x=="middle"){this.domGadgetRoot.style.left=this.domGadgetParent.offsetLeft+this.domGadgetParent.offsetWidth/2-this.domGadgetRoot.offsetWidth/2}else if(this.position.x=="right"){this.domGadgetRoot.style.left=this.domGadgetParent.offsetLeft+this.domGadgetParent.offsetWidth-this.domGadgetRoot.offsetWidth}}};e.Gadget.prototype.addToDOM=function(e,t){this.domGadgetParent=e;this.domGadgetParent.appendChild(this.domGadgetRoot);this.setPosition(t)}})(e.GUI)})(GLGE);(function(e){(function(t){t.Preloader=function(){this.baseclass.call(this);this.domGadgetObject.innerHTML="<h1>Loading</h1>";this.domGadgetObject.className+=" glge-gui-gadget-preloader";this.progressBar=new t.Progressbar;this.domGadgetObject.appendChild(this.progressBar.domRoot);this.domPercentageLabel=document.createElement("div");this.domPercentageLabel.setAttribute("class","glge-gui-gadget-preloader-percentage");this.domPercentageLabel.innerHTML="<div style='float:left;'>0%</div><div style='float:right;'>100%</div></div>";this.domGadgetObject.appendChild(this.domPercentageLabel);this.domInfoBox=document.createElement("div");this.domInfoBox.setAttribute("class","glge-gui-gadget-preloader-info");this.domInfoBox.setAttribute("style","clear:both;");this.domGadgetObject.appendChild(this.domInfoBox);this.domStateLabel=document.createElement("div");this.domInfoBox.appendChild(this.domStateLabel);this.domBytesLabel=document.createElement("div");this.domInfoBox.appendChild(this.domBytesLabel);this.domFilesLabel=document.createElement("div");this.domInfoBox.appendChild(this.domFilesLabel);this.domLastFileLabel=document.createElement("div");this.domInfoBox.appendChild(this.domLastFileLabel)};t.Preloader.prototype.progressBar=null;t.Preloader.prototype.documentLoader=null;t.Preloader.prototype.domInfoBox=null;t.Preloader.prototype.domStateLabel=null;t.Preloader.prototype.domBytesLabel=null;t.Preloader.prototype.domFilesLabel=null;t.Preloader.prototype.domLastFileLabel=null;t.Preloader.prototype.domPercentageLabel=null;t.Preloader.prototype.setDocumentLoader=function(e){this.documentLoader=e;var t=this;this.documentLoader.addEventListener("downloadComplete",function(e){t.complete(e)});this.documentLoader.addEventListener("progress",function(e){t.progress(e)});this.documentLoader.addEventListener("stateChange",function(e){t.stateChange(e)});this.documentLoader.addEventListener("fileLoaded",function(e){t.fileLoaded(e)})};t.Preloader.prototype.addToDOM=function(e,t){this.stateChange(this.documentLoader.state);this.progress({progress:0,loadedBytes:0,loadedFiles:0,totalFiles:0,totalBytes:0});this.fileLoaded({});this.baseclass.addToDOM.call(this,e,t)};t.Preloader.prototype.progress=function(e){this.progressBar.setValue(e.progress);this.domBytesLabel.innerHTML=e.loadedBytes+" of "+e.totalBytes+" Bytes loaded";this.domFilesLabel.innerHTML=e.loadedFiles+" of "+e.totalFiles+" Files loaded"};t.Preloader.prototype.complete=function(e){this.progressBar.setValue(100);var t=this;setTimeout(function(){t.domGadgetRoot.parentNode.removeChild(t.domGadgetRoot)},300)};t.Preloader.prototype.stateChange=function(e){switch(e){case 0:case 1:this.domStateLabel.innerHTML="Step 1 of 2: Loading XML";break;case 2:case 3:this.domStateLabel.innerHTML="Step 2 of 2: Loading Textures";break}};t.Preloader.prototype.fileLoaded=function(e){if(e.url){var t=e.url;if(t.length>40){t=t.slice(-37);t="..."+t}this.domLastFileLabel.innerHTML='Last file loaded: "'+t+'"'}else if(this.domLastFileLabel.innerHTML=="")this.domLastFileLabel.innerHTML="Last file loaded: <i>none</i>"};e.augment(t.Gadget,t.Preloader)})(e.GUI)})(GLGE);(function(e){e.FilePreloader=function(){this.files=[]};e.augment(e.Events,e.FilePreloader);e.FilePreloader.prototype.loadedBytes=0;e.FilePreloader.prototype.totalBytes=0;e.FilePreloader.prototype.numLoadedFiles=0;e.FilePreloader.prototype.numTotalFiles=0;e.FilePreloader.prototype.sizesCount=0;e.FilePreloader.prototype.progress=0;e.FilePreloader.prototype.files=null;e.FilePreloader.prototype.addFile=function(e,t,n){this.files.push({url:e,loaded:false,size:-1,bytesLoaded:0,type:t,callback:n,content:null,preloader:this});this.numTotalFiles++};e.FilePreloader.prototype.addFileRef=function(e){this.files.push(e);this.numTotalFiles++};e.FilePreloader.prototype.accumulateFileSize=function(e){var t=new XMLHttpRequest;t.preloader=this;t.active=true;t.file=e;t.overrideMimeType("text/xml");t.onreadystatechange=function(){if(this.readyState>1&&t.active){this.active=false;this.file.size=parseFloat(this.getResponseHeader("Content-length"));this.preloader.totalBytes+=this.file.size;if(++this.preloader.sizesCount>=this.preloader.files.length)this.preloader.loadFiles();this.abort();this.onreadystatechange=null}};t.open("GET",e.url,true);t.send("")};e.FilePreloader.prototype.start=function(){for(i in this.files)this.accumulateFileSize(this.files[i])};e.FilePreloader.prototype.loadFiles=function(){for(i in this.files){var e=this.files[i];if(e.type=="image"){var t=new Image;e.content=t;var n=this;t.file=e;t.onload=function(){n.fileLoaded(this.file,this.file.size)};t.src=e.url}else{var r=new XMLHttpRequest;r.overrideMimeType("text/xml");r.preloader=this;r.file=e;var s=setInterval(function(){if(r.readyState==3){var t=r.responseText.length-e.bytesLoaded;e.bytesLoaded=r.responseText.length;r.preloader.update(t)}},100);r.onreadystatechange=function(){if(this.readyState>=4){clearInterval(s);this.file.content=this.responseXML;var e=this.responseText.length-this.file.bytesLoaded;this.preloader.update(e);this.preloader.fileLoaded(this.file,e)}};r.open("GET",e.url,true);r.send()}}};e.FilePreloader.prototype.update=function(e){this.loadedBytes+=e;this.progress=100*this.loadedBytes/this.totalBytes;this.fireEvent("progress",{progress:this.progress,stepBytes:e,loadedBytes:this.loadedBytes,totalBytes:this.totalBytes,loadedFiles:this.numLoadedFiles,totalFiles:this.numTotalFiles})};e.FilePreloader.prototype.fileLoaded=function(e,t){this.numLoadedFiles++;e.loaded=true;e.bytesLoaded=e.size;if(this.numLoadedFiles>=this.files.length){this.progress=100;this.fireEvent("downloadComplete",{file:e,stepBytes:t})}else{this.update(t)}this.fireEvent("fileLoaded",{file:e,stepBytes:t});if(e.callback)e.callback(e)};e.FilePreloader.prototype.getLoadedFiles=function(){var e=[];for(i in this.files)if(this.files[i].loaded)e.push(this.files[i]);return e};e.FilePreloader.prototype.getFile=function(e){for(i in this.files)if(this.files[i].url==e)return this.files[i];return-1}})(GLGE);(function(e){e.DocumentPreloader=function(t,n){this.imagePreloader=new e.FilePreloader;this.document=t;if(n.XMLQuota)this.XMLQuota=n.XMLQuota;else this.XMLQuota=.2;this.imageQuota=1-this.XMLQuota;if(n.XMLBytes)this.XMLBytes=n.XMLBytes;else if(n.numXMLFiles)this.numXMLFiles=n.numXMLFiles;else this.numXMLFiles=3};e.augment(e.Events,e.DocumentPreloader);e.DocumentPreloader.prototype.progress=0;e.DocumentPreloader.prototype.imageQuota=0;e.DocumentPreloader.prototype.XMLQuota=0;e.DocumentPreloader.prototype.XMLBytes=-1;e.DocumentPreloader.prototype.totalBytes=-1;e.DocumentPreloader.prototype.loadedBytes=0;e.DocumentPreloader.prototype.numXMLFiles=3;e.DocumentPreloader.prototype.state=0;e.DocumentPreloader.prototype.imagePreloader=null;e.DocumentPreloader.prototype.document=null;e.DocumentPreloader.prototype.addImage=function(e){this.imagePreloader.addFile(e,"image")};e.DocumentPreloader.prototype.loadImages=function(){this.changeState(2);if(this.progress<this.XMLQuota*100)this.progress=this.XMLQuota*100;var e=this;this.imagePreloader.addEventListener("progress",function(t){e.updateProgress.call(e,t)});this.imagePreloader.addEventListener("downloadComplete",function(t){e.finish.call(e,t)});this.imagePreloader.addEventListener("fileLoaded",function(t){e.fireEvent("fileLoaded",t.file)});this.imagePreloader.start()};e.DocumentPreloader.prototype.updateProgress=function(e){if(this.state<2){if(this.XMLBytes>0){this.loadedBytes+=e.stepBytes;this.progress=this.XMLQuota*100*this.loadedBytes/this.XMLBytes}else{this.progress+=this.XMLQuota*100/this.numXMLFiles;if(this.progress>this.XMLQuota*100)this.progress=this.XMLQuota*100}}else{this.progress=this.XMLQuota*100+this.imageQuota*this.imagePreloader.progress}this.fireEvent("progress",{progress:this.progress,stepBytes:e.stepBytes,loadedBytes:e.loadedBytes,totalBytes:e.totalBytes,loadedFiles:e.loadedFiles,totalFiles:e.totalFiles})};e.DocumentPreloader.prototype.loadXMLFile=function(t){this.changeState(1);var n=new e.FilePreloader;n.addFile(t,"xml");var r=this;if(this.XMLBytes>0)n.addEventListener("progress",function(e){r.updateProgress.call(r,e)});else n.addEventListener("downloadComplete",function(e){r.updateProgress.call(r,e)});var i=this.document;n.addEventListener("fileLoaded",function(e){e.file.content.getElementById=i.getElementById;i.loaded(e.file.url,e.file.content);r.fireEvent("fileLoaded",e.file)});n.start()};e.DocumentPreloader.prototype.changeState=function(e){this.state=e;this.fireEvent("stateChange",e)};e.DocumentPreloader.prototype.finish=function(e){this.changeState(3);this.progress=100;this.fireEvent("downloadComplete")}})(GLGE)